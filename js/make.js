dac($("box"),""),Res.loadUp=()=>setTimeout(()=>{let t=$("loading");t.style.background="#0000",t._h(),ac($("box")),$E.loadComp()},$("loading").style.background||!$E.edit?200:400),"ply,blt,sp,wp,spk,chr,lsr,jr,spr,tp,bd,arr,xa,blk,tile,blkm,pf,bbl,kbl,ice,wt1,wt2,wt3,wt4,twt,lava,wj,sbl,crt,cvy,ld,rp,trg,btn,dbt,sw,swr,mb,tj,dj,sj,ij,lg,hg,fs,ss,gu,gd,tree,cld,moon,star,grs,pst,dko,dkf,son,sof,sg,ist,ifg,txt".split(",").for((t,o)=>Res.sprList[o]={s:t}),Res.sprList.len=Lib.thm.reduce((t,o)=>t+!!o,0),$E.loadComp=()=>CIW.onready(()=>$E.openGame());{let t=[Res.loadBg({id:0,m:0})];setTimeout(()=>Au.init(),50),Res.sndList.for(o=>t.push(Res.loadSnd(o))),Res.sprList.for((o,i)=>t.push(Res.loadSpr(o.s,Lib.thm[i]))),Res.fontList.for(o=>t.push(Res.loadFont(o))),Res.loadMax=t.length,Promise.all(t).catch(t=>{console.error(t),Res.fail(),dac($("box"),"")}),$E.tab.for((t,o)=>t.onclick=()=>{$E.nowTab!==o&&(!o||$E._r?($E.nowTab=o,css($E.tab,{borderColor:""},o,{borderColor:"#5af"}),$("page").style.transform=`translateX(-${25*o}%)`):UI.alert("请先选择房间！"))}),$("rbtn")._h();let o=$("btn").ch,i=$("rbtn").ch;const e=(t=1)=>{if(t&&!$E.GAME.N)return void UI.alert("请填写游戏名！");$E._r&&$E._r.enc();let o={N:$E.GAME.N,C:$E.GAME.C,R:[],VAR:$E.GAME.VAR,RID:$E.RoomID};for(let t=$E.GAME.R.length;t--;)o.R[t]=$E.GAME.R[t].save();return o};o[0].onclick=()=>{if(!$E.GAME.R.length)return UI.alert("当前游戏没有房间");let t=$("screen");css(t,{background:"none",pointerEvents:"none"}),$t("canvas",t).for(t=>t._h()),$("htrack")._h(),$("vtrack")._h(),$("btn")._h(),$("rbtn")._s(),dac($("L"),""),$("BGM").pause(),$E.edit=!1,Res.check($E._R).then(()=>{$R=new Core.$R(e(0),1),$R.init(),$E.loadComp=()=>$R?.start($E._r?.ind)},()=>{UI.alert("游戏资源加载失败，请检查网络连接"),o[0].reset()})},o[0].reset=()=>{$E.edit=!0;let t=$("screen");css(t,{background:"",pointerEvents:""}),$t("canvas",t).for(t=>t._s()),$("htrack")._s(),$("vtrack")._s(),$("btn")._s(),$("rbtn")._h(),ac($("L")),css($("loading"),{background:"#0000",display:"none"}),ac($("box"))},o[1].onclick=$E.openGame,o[2].onclick=()=>{let t=e();t&&($E.GAME.id&&(t.id=$E.GAME.id),CIW.put("proj",t).then(t=>{$E.GAME.id=t.target.result,UI.alert("保存成功！")},t=>{console.error(t),UI.alert("保存失败！")}))},o[3].onclick=()=>{$E._r&&UI.confirm("确定清空整个房间？").then(t=>{t.i||($E.C.addUndo(),$E._r.obj="|||||||||||",$E._r.dec(),$E.$O&&$E.$P())})},o[4].onclick=()=>(new UI.M).t("支持文件格式：").t("- Cloud I Wanna 游戏工程文件 (.ciwp)").t("- Cloud I Wanna 旧版地图文件 (.iw)").t("- Jtool 地图文件 (.jmap)").b("选择文件","取消").then(t=>{t.i||UI.file(".ciwp,.iw,.jmap","DataURL").then(([t,o])=>{if(".iw"===o.slice(-3)){if(!$E._r)return UI.alert("请先选择房间！");$E.importIw(t)}else if(".jmap"===o.slice(-5)){if(!$E._r)return UI.alert("请先选择房间！");$E.importJmap(t)}else Ipc.zip(t.split(",")[1],0,t=>{let o=new FileReader;o.readAsText($M.b2b(t)),o.onload=()=>{try{let t=JSON.parse(o.result);(new UI.M).t("请选择打开方式：").b("替换当前游戏","与当前游戏合并").then(o=>{if(o.i){if($E._R.length+t.R.length>128)return UI.alert("房间数量过多，导入失败！");let o=[];for(let t=128;t--;)o.push(0);$E._R.for(t=>o[t.id]=1),t.R.for(t=>{t.type<2&&$E._R.find(o=>o.type===t.type)||(t.id=o.indexOf(0),t.id<128&&t.id>=0&&(o[t.id]=1,$E.addRoom(new $E.Room(t.type,t))))}),UI.alert("合并游戏可能引起传送门房间引用错误，请注意检查修改")}else $E.setGame(t)})}catch{UI.alert("文件解析错误！")}}})})}),o[5].onclick=()=>{let t=e();t&&Ipc.zip(JSON.stringify(t),1,o=>$M.openURL(URL.createObjectURL($M.b2b(o)),0,t.N+".ciwp"))},o[6].onclick=()=>UI.alert("此功能暂未开放"),css(o[7].ch,{color:"#888"},2,{}),o[7].onclick=function(t){let o=t.target,i=[...this.ch];if("SPAN"===o.tagName){let t=Number(o.innerText);if(!isNaN(t))return css(i.slice(2),{color:"#888"}),o.style.color="",$E.grid.set(t),$E.grid.draw()}$E.grid.show=!$E.grid.show,css(i.slice(0,2),{color:$E.grid.show?"":"#888"}),$E.grid.draw()},i[0].onclick=()=>{if($E._r)for(let t=Res.sprList.len;t--;){let o=Res.spr[Res.sprList[t].s];o.splice(0,o.length,...$R.G.R[$E._r.ind].Spr[Res.sprList[t].s])}$R.exit(),o[0].reset()};let r=$c("cat");r[0].ap(UI.I("游戏名",{l:32},330).on(t=>$E.GAME.N=t));let d=UI.p(UI.ico("add")+i18n("添加全局变量"));d.onclick=()=>$E.addVar(),css(d,{display:"inline-block",marginLeft:"7px",cursor:"pointer"});let s=El("p").tx("全局变量");s.ap(UI.help("变量"),UI.span("（存档时，全局变量会被储存）",0,15)),r[1].ap(s,El("div",0,{id:"vars"}),d),r[2].firstChild.ap(UI.help("游戏房间"));let l=El("div");["空白","游戏中","模板库","本地模板"].for(t=>l.ap(El("div","setcat").tx(t),El("div","setpage"))),l.style.height="426px",UI.bindCat(l),l.clr=()=>{l.now&&(l.now.id="",l.now=null,l.newR=null)},l.chk=(t,o)=>{$E._R.find(t=>t.type===o)?(dac(t),t===l.now&&l.clr()):ac(t)},l.set=(t,o,i)=>{let e=$("thmSrc");e&&(e.id=""),t.id="thmSrc",l.newR=o,l.now=t,l.tab=i},l.get=t=>{let o=t.save();return{type:o.type,w:o.w,h:o.h,obj:o.obj,bg:o.bg,spr:o.spr,col:o.col}};let n=$c("setpage",l);css(n,{bottom:"64px"}),["标题界面","通关界面","普通房间","耐久房间","选关界面"].for((t,o)=>{let i=n[0].ap(El("div","thm").tx(t));i.onclick=()=>l.set(i,o,0)}),n[0].set=function(){for(let t=2;t--;)l.chk(this.ch[t],t)},n[1].set=function(){l.clr(),this.innerHTML="",$E._R.for(t=>{let o=this.ap(El("div","thm").tx(t.name));o.r=l.get(t),t.type<2&&l.chk(o,t.type),o.onclick=()=>l.set(o,o.r,1)})},l.pv=t=>{let o=El("div","thm"),i=o.ap(El("div","thm-pv"));css(i,{width:"200px",height:"152px",background:`url(${CDU(t.p)})`});let e=o.ap(El("p").tx(t.n));return t.createdAt||(e.ap(UI.span(UI.ico("trash"))).onclick=i=>{i.stopPropagation(),UI.confirm("确定要删除此模板？").then(i=>{i.i||CIW.del("tpl",t.id).then(()=>{o===l.now&&l.clr(),o.remove()})})},e.ap(UI.span(UI.ico("upload"))).onclick=o=>{o.stopPropagation(),UI.confirm("确定要将此模板上传到模板库？").then(o=>{if(!o.i){let o=DB.O("Template");for(let i in t)"id"!==i&&o.set(i,t[i]);o.save().then(o=>{CIW.put("tpl",{...t,id:o.id,createdAt:o.createdAt}),UI.alert("上传成功！")},t=>UI.alert("上传失败！"))}})},css(e.ch,{margin:"4px",pointerEvents:"auto",color:"initial"})),o.r={type:t.t,w:t.w,h:t.h,obj:t.o,bg:t.b,spr:t.c??[]},t.k&&(o.r.col=t.k),o.onclick=()=>l.set(o,o.r,o.tab),o},n[2].set=function(){this.loaded?$c("thm",this).for(t=>{t.r.type<2&&l.chk(t,t.r.type)}):CIW.find("tpl").then(t=>{let o=new Date(0);t.for(t=>{if(!t.createdAt)return;let i=this.ap(l.pv(t));i.tab=2,i.r.type<2&&l.chk(i,i.r.type);let e=new Date(t.createdAt);e>o&&(o=e)}),this.loaded=!0,DB.Q("Template").greaterThan("createdAt",o).find().then(t=>t.for(t=>{let o=t.toJSON();o.id=o.objectId,delete o.objectId,delete o.ACL,delete o.updatedAt;let i=this.ap(l.pv(o));i.tab=2,i.r.type<2&&l.chk(i,i.r.type),CIW.put("tpl",o)}))})},n[3].ids=[],n[3].set=function(){$c("thm",this).for(t=>{t.r.type<2&&l.chk(t,t.r.type)}),CIW.find("tpl").then(t=>{new Date(0);t.for(t=>{if(t.createdAt)return;if(this.ids.includes(t.id))return;let o=this.ap(l.pv(t));o.tab=3,this.ids.push(t.id),o.r.type<2&&l.chk(o,o.r.type)})})},$("crtr").onclick=t=>{new UI.M(800,512).h("新建房间").cb().ap(l).b("确定","取消").then(t=>{l.now&&(l.now.id=""),t.i||void 0!==l.newR&&null!==l.newR&&(l.newR.w?$E.addRoom(new $E.Room(2,l.newR)).firstChild.click():$E.addRoom(new $E.Room(l.newR)).firstChild.click())}),l.now?(l.now.id="thmSrc",n[l.tab].set()):l.firstChild.onclick()},r[3].ap(UI.I("房间名",{l:8},80).on(t=>{$E._r.name=t,$c("room")[$E._r.ind].firstChild.tx(t)}),UI.I("房间大小",{type:"number",m:800,M:4e3,s:32},40).on(t=>$E._r.setWH(t)),UI.I("×",{m:608,M:3040,s:32},40).on(t=>$E._r.setWH(0,t)),UI.C("出房间外",0,"死亡","砖块","穿屏","左右穿屏","上下穿屏").on(t=>$E._r.out=t),UI.C("视野模式",0,"单面","跟随").on(t=>$E._r.view=t),UI.B("保存为模板房间",1).on(()=>{let t=$E._r.save(),o={t:t.type,w:t.w,h:t.h,o:t.obj,b:t.bg,c:t.spr,p:MDU($E.capture(.25,8))};t.col&&(o.k=t.col),JSON.stringify(o.c)===JSON.stringify(Lib.thm)&&delete o.c,UI.prompt("请输入模板名称").then(t=>{t.i||(o.n=t.v,o.id=Date.now().toString(36),CIW.put("tpl",o).then(t=>UI.alert("保存成功！")))})}));let c=UI.C("背景",0,"纯色","渐变","图片"),E=El("div","rl"),a=El("div","rl"),p=El("div","grad"),h=p.ap(El("div"));css([E,a],{paddingLeft:"8px"}),h.crt=function(t,o,i){let e=this.ap(El("div","gradc"));css(e,{left:t,background:o}),e.s=i,e.onmousedown=function(t){let o=this.pN;t.button?o.ch.length>2&&(this.remove(),o.ref()):(this.d=t.x-this.offsetLeft,o.d=this)},e.ondblclick=function(t){css(UI.ipc,{left:`${t.x}px`,top:`${t.y}px`}),UI.ipc.onchange=()=>{this.style.background=UI.ipc.value,this.s=UI.ipc.value.slice(1)+this.s.slice(6),this.pN.ref()},UI.ipc.value="#"+this.s.slice(0,6),setTimeout(()=>UI.ipc.click(),1)}},h.ref=function(){let t=this.ch,o=[];for(let i=0;i<t.length;i++)o.push(t[i].s);this.pN.set(o.toString(),1,1)},h.onmousedown=function(t){if(t.target!==this||t.button)return;let o=this.getBoundingClientRect(),i=((t.x-o.left)/160).toFixed(2),e=this.pN;e.set(e.v+",ffffff "+i,1,1),this.crt(100*i+"%","#ffffff","ffffff "+i)},h.onmousemove=function(t){if(this.d){let o=Math.mM((t.x-this.d.d)/160,0,1).toFixed(2);this.ch;this.d.style.left=100*o+"%",this.d.s=this.d.s.slice(0,7)+o,this.ref()}},h.onmouseleave=h.onmouseup=function(){this.d=null},p.set=function(t,o,i){let e=t.split(","),r="",d=this.firstChild;if(!o)for(let t=d.ch.length;t--;)d.ch[t].remove();e.sort((t,o)=>t.slice(7)-o.slice(7)),this.v=t,e.for(t=>{let i=100*t.slice(7)+"%",e="#"+t.slice(0,6);r+=e+" "+i+",",o||d.crt(i,e,t)}),this.style.background="linear-gradient(90deg,"+r.slice(0,-1)+")",i&&Res.loadBg({m:3+this.pS().v,g:(1===this.pS().v?this.nS().v+":":"")+this.v}).then(t=>{$E._r.setBg(t),$E._r.drawBg()})},p.set("000000 0,ffffff 1"),E.ap(UI.C("模式",0,"线性","径向").on(t=>{let o=E.ch[2],i=$E._r.bg.g.split(":"),e=(1===t?o.v+":":"")+i[i.length-1];Res.loadBg({m:t+3,g:e}).then(t=>{$E._r.setBg(t),$E._r.drawBg()}),1===t?o._s():o._h()}),p,UI.I("角度",{type:"number",m:0,M:360,value:270}).on(t=>Res.loadBg({m:4,g:t+":"+$E._r.bg.g.split(":")[1]}).then(t=>{$E._r.setBg(t),$E._r.drawBg()}))),E.firstChild.style.display="inline-block",E.firstChild.set(1),a.ap(UI.span("图片"),UI.B2("从画风库中选择").on(()=>$E.ThmLib.showSpr("bg")),UI.C("模式",0,"平铺","固定","拉伸").on(t=>{$E._r.bg.m=t/2<<0,$E._r.drawBg()}),UI.R("色调",0,359,0).on(t=>$E._r.colBg(t,"","","")),UI.R("亮度",0,100,50).on(t=>$E._r.colBg("","",t,"")),UI.R("饱和度",0,100,50).on(t=>$E._r.colBg("",t,"","")),UI.R("对比度",-100,100,50).on(t=>$E._r.colBg("","","",t))),css(a.ch[2],{float:"right",marginRight:"10px"}),c.style.display="inline-block",c.on((t,o)=>{let i=c.nS(2);i._h(),E._h(),a._h();const e=$E._r.bg;switch(t){case 1:i._s(),1!==o&&i.f(i.c(i.lastChild.style.background)||"#fff");break;case 2:E._s();let t=E.ch;if(5===e.m?t[2]._h():t[2]._s(),1===o){if(4===e.m){let o=e.g.split(":");t[1].set(o[1]),t[2].set(o[0])}else t[1].set(e.g);t[0].set(e.m-3)}else t[1].set(t[1].v,0,1);break;case 4:a._s();let r=a.ch;if(1===o){let t=(e.g||"").split(",");r[1].v=e.id,r[2].set(1<<e.m),r[3].set(t[0]),r[5].set(t[1]),r[4].set(t[2]),r[6].set(t[3])}else{let t={id:r[1].v??0,m:r[2].v/2<<0,g:r[3].v+","+r[5].v+","+r[4].v+","+r[6].v};dac($("box"),""),Res.loadBg(t,1).then(t=>{$E._r.setBg(t),$E._r.drawBg(),ac($("box"))},Res.fail)}}$E.fixH(r[4])});let f=El("div","rl");$E.tileCol=f,f._h(),Object.defineProperty(f,"spr",{get(){return this._spr},set(t){t!==this._spr&&(this._spr=t,t?(this.loadCol(t),this._s()):(this._h(),css($c("spr"),{outline:""})),$E.fixH($c("cat")[4]))}}),f.check=t=>{let o=t.split(",");return!(0!=o[0]||50!=o[1]&&""!==o[1]||50!=o[2]&&""!==o[2]||50!=o[3]&&""!==o[3])},f.setCol=function(...t){if(this.spr&&Res.spr[this.spr]){if($E._r.col){for(let o in $E._r.col){let i=$E._r.col[o].split("|");if(i.includes(this.spr)){if(o.split(",").for((o,i)=>{""===t[i]&&(t[i]=o)}),i.length>1){let t=[];i.for(o=>{o!==this.spr&&t.push(o)}),$E._r.col[o]=t.join("|")}else delete $E._r.col[o];break}}t=t.join(",");let o=!0;for(let i in $E._r.col)if(i===t){$E._r.col[i]+="|"+this.spr,o=!1;break}o&&!this.check(t)&&($E._r.col[t]=this.spr)}else t=t.join(","),this.check(t)||($E._r.col={},$E._r.col[t]=this.spr);this.col=t,Res.colSpr(Res.spr[this.spr],t).then(()=>{$E.drawThn($("tile").spr[this.spr],Res.spr[this.spr]),$E.sfO.redraw()})}},f.loadCol=function(t){let o=[0,50,50,50],i=this.ch;if(this.col="",$E._r.col)for(let i in $E._r.col){if($E._r.col[i].split("|").includes(t)){i.split(",").for((t,i)=>{""!==t&&(o[i]=Number(t))}),this.col=i;break}}i[2].set(o[0]),i[3].set(o[2]),i[4].set(o[1]),i[5].set(o[3])};let w=El("div");w.id="tile",w.spr={},w.skip=["pst","dko","dkf","son","sof","sg","ist","ifg","txt"];for(let t in Res.spr)w.skip.includes(t)||(w.spr[t]=w.ap(El("canvas","spr",{width:32,height:32})),w.spr[t].spr=t,w.spr[t].onclick=function(t){let o=t.ctrlKey?f.col:void 0;if(css($c("spr"),{outline:""}),css(this,{zIndex:1,outline:"1px solid #fd0"}),f.spr=this.spr,void 0!==o){o=(o||"0,50,50,50").split(","),f.setCol(...o);let t=f.ch;t[2].set(o[0]),t[3].set(o[2]),t[4].set(o[1]),t[5].set(o[3])}});f.ap(UI.span("设置贴图"),UI.B2("从画风库中选择").on(()=>$E.ThmLib.showSpr(f.spr)),UI.R("色调",0,359,0).on(t=>f.setCol(t,"","","")),UI.R("亮度",0,100,50).on(t=>f.setCol("","",t,"")),UI.R("饱和度",0,100,50).on(t=>f.setCol("",t,"","")),UI.R("对比度",-100,100,50).on(t=>f.setCol("","","",t)),UI.p("*按住ctrl点击其它贴图可使其应用当前调色")),r[4].ap(UI.span("预设画风"),UI.B2("从画风库中选择").on(()=>$E.ThmLib.show()),El("br"),c,UI.span(" "),UI.Col("颜色").on(t=>{$E._r.setBg({m:3,g:t}),$E._r.drawBg()}),E,a,UI.p("贴图"),w,f),r[5].ap(UI.I("网易云音乐ID",0,112).on(t=>{t&&(b.src=`https://music.163.com/song/media/outer/url?id=${t}.mp3`),$E._r.bgm=t}),UI.span("（注:音乐ID在音乐链接中,如:https://music.163.com/#/song?id=<b>22776365</b>）"));let u=r[5].ap(El("div",0,{id:"bgm",innerHTML:"<div class='play'></div><div class='vol'></div><div class='volc'><div></div><div></div></div>"})).ch,b=doc.body.ap(El("audio"));b.id="BGM",b.onerror=()=>UI.alert("音乐载入出错：音乐ID错误或音乐版权受限"),b.setVol=t=>{b.volume=Math.pow(2,t/100)-1;let o=u[2].ch;o[0].style.background=`linear-gradient(90deg,#e12828 ${t}%,#ccc 0)`,o[1].style.left=t+"%"},u[0].onclick=function(){this.hC("p")?(this.rC("p"),b.pause()):(this.aC("p"),b.play())},u[1].onclick=function(){this.hC("m")?(this.rC("m"),b.muted=!1):(this.aC("m"),b.muted=!0)},u[2].ch[1].onmousedown=function(t){this.pN.downX=t.x-this.offsetLeft},u[2].onmousemove=function(t){if(void 0!==this.downX){let o=Math.mM(t.x-this.downX,0,100);Au.setVol(o),b.setVol(o),App.setConf("play","volume",o)}},u[2].onmouseleave=u[2].onmouseup=function(){this.downX=void 0},r[7].ap($E.BObj("ply","玩家","ply"),$E.BObj("gov","GameOver","txt",[0,1,1])),r[8].ap($E.Obj(0),$E.Obj(1,1),$E.Obj(2,1)),r[9].ap($E.Obj(3,1),$E.Obj(4),$E.Obj(5,1),$E.Obj(6,1),$E.Obj(50,1)),r[10].ap($E.Obj(7,1,1),$E.Obj(8,1),$E.Obj(9,1),$E.Obj(10),$E.Obj(11,0,1),$E.Obj(12)),r[11].ap($E.Obj(13,1,1),$E.Obj(14,1,1),$E.Obj(15),$E.Obj(16),$E.Obj(49),$E.Obj(17),$E.Obj(18),$E.Obj(19),$E.Obj(20),$E.Obj(21,1,0,1),$E.Obj(22),$E.Obj(23,0,1,2),$E.Obj(24,0,1,2),$E.Obj(25,0,0,1)),r[12].ap($E.Obj(26),$E.Obj(27),$E.Obj(28),$E.Obj(29),$E.Obj(30),$E.Obj(31),$E.Obj(32),$E.Obj(33),$E.Obj(34),$E.Obj(35)),r[13].ap($E.Obj(36,1),$E.Obj(37,0,1),$E.Obj(38,0,0,1)),r[14].ap($E.Obj(39),$E.Obj(40,1,1),$E.Obj(41),$E.Obj(42),$E.Obj(43,1),$E.Obj(44,1,0,2),$E.Obj(45,1),$E.Obj(46,1),$E.Obj(47,1),$E.Obj(48,1,0,2)),r[18].firstChild.ap(UI.help("物体属性")),r[19].firstChild.ap(UI.help("图层"));for(let t=0;t<12;t++)r[19].ap(UI.span(`${UI.ico("layer")} ${i18n("图层")}${t} `),UI.S("显示",1,1).on((o,i)=>{$E.C.vLy(t,o),o&&"sw"!==i.nS().lastChild.className||$E.C.lkLy(t,!o)}),UI.S(" "+i18n("锁定"),0,1).on(o=>$E.C.lkLy(t,o)),El("br"));r.for(t=>$E.fixH(t,t=>{t.hC("f")&&t.aC("old"),t.firstChild.onclick=()=>t.hC("fold")?t.rC("fold"):t.aC("fold")}));let R=$("htrack"),m=$("vtrack");$("hbar").onmousedown=function(t){this.pN.drag=t.x-this.style.transform.slice(11,-3)},$("vbar").onmousedown=function(t){this.pN.drag=t.y-this.style.transform.slice(11,-3)},R.onmousemove=function(t){this.drag&&($E._r.editX=Math.mM((t.x-this.drag)/this.clientWidth*$E._r.w<<0,0,$E._r.w-800),$E._r.setBar())},m.onmousemove=function(t){this.drag&&($E._r.editY=Math.mM((t.y-this.drag)/this.clientHeight*$E._r.h<<0,0,$E._r.h-608),$E._r.setBar())},R.onmouseleave=R.onmouseup=m.onmouseleave=m.onmouseup=function(){this.drag=0},Lib.obj.for(t=>{for(let o=t.spr.length;o--;)t.spr[o]=Res.spr[t.spr[o]]})}$E.importIw=t=>{UI.alert("旧版地图导入功能正在开发中")},$E.importJmap=t=>{let o=atob(t.split(",")[1]).split("\n");if(o[11]){$E.C.addUndo(),$E._r.obj="|||||||||||",$E._r.dec(),$E.$O&&$E.$P();const t=o[4].split(" "),i=[0,Lib.obj[3],Lib.obj[4],Lib.obj[7],{...Lib.obj[7],ang:270},{...Lib.obj[7],ang:90},{...Lib.obj[7],ang:180},{...Lib.obj[7],scx:.5,scy:.5},{...Lib.obj[7],ang:270,scx:.5,scy:.5},{...Lib.obj[7],ang:90,scx:.5,scy:.5},{...Lib.obj[7],ang:180,scx:.5,scy:.5},Lib.obj[8],Lib.obj[2],Lib.obj[13],Lib.obj[16],Lib.obj[15],{...Lib.obj[14],ang:180},Lib.obj[14],Lib.obj[9],Lib.obj[50],Lib.obj[0],Lib.obj[1],Lib.obj[25],Lib.obj[49]];for(let o=0;o<t.length;o++){let e=Number(t[o++]),r=Number(t[o++]);if(i[t[o]]){let d=new $E.Object(e,r,i[t[o]]);$E.sfO.dirty(d.R[0],d.LT[1],d.w,d.h)}}$E._r.setNum(),$E.sfO.update()}else UI.alert("文件解析错误！")},$E.C={mX:0,mY:0,mTX:0,mTY:0,mPX:0,mPY:0,mB:0,lkLy(t,o){$E._r.ly[t].lock=o},vLy(t,o){$E._r.ly[t].vis=o,$E.sfO.redraw()},pRc:(t,o,i,e,r,d)=>t>=i&&o>=e&&t<r&&o<d,cRc:(t,o,i,e,r,d,s,l)=>t+i>r&&t<r+s&&o+e>d&&o<d+l,atPosDep:(t,o,i)=>$E._r.ly[i].lock?null:$E._r.ly[i].find(i=>i.x===t&&i.y===o),colPosDep(t,o,i){if($E._r.ly[i].lock)return-1;for(let e=$E._r.ly[i].length;e--;){let r=$E._r.ly[i][e],d=r.R,s=d[0],l=d[1];if(s<=t&&s+r.w>t&&l<=o&&l+r.h>o)return e}return-1},colPosObj(t,o){for(let i=$E._r.ly.length;i--;){let e=this.colPosDep(t,o,i);if(-1!==e)return $E._r.ly[i][e]}return null},cXY(){const t=$E._O;let o=this.mX,i=this.mY;return t&&t.a&&(1===t.a?(o+=16,i+=t.o.spr[0].y?16:0):2===t.a&&(i+=Math.round(32-t.o.spr[0].h*(t.o.scy||1)))),[o,i]},dMouse(t,o,i,e,r,d,s,l){if($E.pro.lock)return;const n=$E._O,c=$E.sfE;let E=c.R-c.L,a=c.B-c.T;if(E>0&&a>0&&(c.clearRect(c.L,c.T,E,a),c.L=1/0,c.T=1/0,c.R=-1/0,c.B=-1/0),!i&&n&&($E.$O&&$E.$O.some(t=>{let o=t.R,i=o[0],e=o[1];return this.pRc(this.mTX,this.mTY,i,e,i+t.w,e+t.h)})&&(i=!0),!i)){void 0===e&&(e=t,r=o,d=32,s=32,l=32);let i=e+d,E=r+s;n.o.spr.for(t=>{for(let o=r;o<E;o+=l)for(let r=e;r<i;r+=l)if("blk"===t.name||"tile"===t.name)(n.o.scx<1||n.o.scy<1)&&$E.eSmth(c),c.drawImage(t[0],0,0,32,32,r,o,32*n.o.scx,32*n.o.scy),$E.dSmth(c),c.dirty(r,o,32*n.o.scx,32*n.o.scy);else{let i=n.o.scx||1,e=n.o.scy||1;void 0!==n.o.ang?$E.Object.drawEx(c,t,0,r,o,i,e,n.o.ang):1!==i?$E.Object.drawSc(c,t,0,r,o,i,e):c.drawImage(t[0],r-t.x,o-t.y),c.dirty(r-t.x*i,o-t.y*e,t.w*i,t.h*e)}})}$E.$O&&(c.strokeStyle="#000",$E.$O.for(t=>{let o=t.R[0],i=t.LT[1],e=t.w,r=t.h;c.strokeRect(o-.5,i-.5,e+1,r+1),c.strokeRect(o-2.5,i-2.5,e+5,r+5),c.dirty(o-3,i-3,e+6,r+6)}),c.strokeStyle="#fd5",$E.$O.for(t=>c.strokeRect(t.R[0]-1.5,t.LT[1]-1.5,t.w+3,t.h+3))),i&&void 0!==e&&(c.strokeStyle="#000",c.strokeRect(e-.5,r-.5,d+1,s+1),c.strokeRect(e-2.5,r-2.5,d+5,s+5),c.strokeStyle="#fd5",c.strokeRect(e-1.5,r-1.5,d+3,s+3),c.dirty(e-3,r-3,d+6,s+6))},delPos(t,o){let i=this.colPosObj(t,o),e=!1;if(i){let t=i.dep;if($E.$O)for(let t=$E.$O.length;t--;)if($E.$O[t]===i){$E.$O.splice(t,1),$E.$P($E.$O.length?$E.$O:0),e=!$E.$O,this.dMouse(0,0,1);break}$E._r.ly[t].rm(i),$E._r.setNum(),$E.sfO.update()}return e},moveEditO(t,o){$E.$O.for(i=>{let{w:e,h:r}=i;$E.sfO.dirty(i.R[0],i.LT[1],e,r),i.x+=t,i.y+=o,i.tile&&$E.Object.rTile(i.x-t,i.y-o,e,r,i),$E.sfO.dirty(i.LT[0],i.LT[1],e,r)}),$E.sfO.update(),this.dMouse(0,0,1)},addUndo(){if(!$E._r)return;let t=$E._r,o=t.enc();o!==t.undo[t.undo.length-1]&&(t.redo.length=0,t.undo.push(o),t.undo.length>App.getConf("edit","undoDepth")&&t.undo.shift())},undo(){if(!$E._r)return;let t=$E._r,o=t.undo.pop(),i=t.enc();o===i&&(o=t.undo.pop()),o&&(t.redo.push(i),t.obj=o,t.dec(),$E.$O&&($E.$P(),$E.C.dMouse(0,0,1)))},redo(){if(!$E._r)return;let t=$E._r,o=t.redo.pop();o&&(t.undo.push(t.enc()),t.obj=o,t.dec())},clipBoard:[],copy(t){this.clipBoard.length=0;let o=1/0,i=1/0;t.for(t=>{t.x<o&&(o=t.x),t.y<i&&(i=t.y)}),t.for(t=>this.clipBoard.push({x:t.x-o,y:t.y-i,ind:t.ind,add:JSON.parse(JSON.stringify(t.add))}))},paste(t,o){this.clipBoard.length&&($E.pro.lock=!1,this.addUndo(),$E.$O=[],this.clipBoard.for(i=>{let e={...Lib.obj[i.ind]};e.add={...Lib.obj[i.ind].add,...i.add},$E.$O.push(new $E.Object(t+i.x,o+i.y,e))}),$E._r.setNum(),$E.sfO.redraw(),$E.$P($E.$O),this.dMouse(0,0,1))}};{const t=$("screen");t.get=()=>{let o=$E.sfE.canvas.getBoundingClientRect();t.left=o.left,t.top=o.top},window.onresize=t.get,t.get(),t.onmousedown=o=>{if(!$E.edit)return;const i=$E.C;if(i.mB=o.button,i.mB&&o.preventDefault(),o.stopPropagation(),$E._r)if(t.dX=i.mX,t.dY=i.mY,t.drag=!0,0===i.mB){if(o.ctrlKey){let t=i.colPosObj(i.mTX,i.mTY);t&&$E.$O&&$E.$O.includes(t)||(t?$E.pro.lock?($E.pro.lock=!1,$E.$O=[t]):$E.$O?$E.$O.push(t):$E.$O=[t]:$E.$O=null,i.dMouse(0,0,1),$E.$O?($E.tab[3].click(),$E.$P($E.$O)):$E.$P())}else if($E.$O){let t=i.colPosObj(i.mTX,i.mTY);$E.$O.includes(t)?($E.$O.drag=t,i.addUndo()):($E.$P(),i.dMouse(0,0,1))}if($E._O&&!$E.$O&&!o.ctrlKey&&!o.shiftKey){let[o,e]=i.cXY(),r=$E._O.dep;if($E._r.ly[r].lock)UI.alert("物体所在图层已"+($E._r.ly[r].vis?"锁定":"隐藏")),t.drag=!1,t.out=!0;else if(!i.atPosDep(o,e,r)){i.addUndo();let t=new $E.Object(o,e,$E._O.o);$E._r.setNum(),$E.sfO.dirty(t.R[0],t.LT[1],t.w,t.h),$E.sfO.update()}}}else if(2===i.mB){if(o.ctrlKey){if($E.$O&&!$E.pro.lock){let t=i.colPosObj(i.mTX,i.mTY);if(t)for(let o=$E.$O.length;o--;)if($E.$O[o]===t){$E.$O.splice(o,1),$E.$P($E.$O.length?$E.$O:0),i.dMouse(0,0,1);break}}}else if(i.addUndo(),i.delPos(i.mTX,i.mTY)||$E.$O){$E.$O&&$E.$P();let[t,o]=i.cXY();i.dMouse(t,o)}}else 1===i.mB&&(t.style.cursor="grab")},t.outf=()=>{const o=$E.C;if(t.drag=!1,t.style.cursor="",$E.$O&&($E.$O.drag=null),!o.mB){if(t.slc){$E.$O&&!$E.pro.lock||($E.pro.lock=!1,$E.$O=[]);let[i,e,r,d]=t.slR();for(let t=$E._r.ly.length;t--;)if(!$E._r.ly[t].lock)for(let s=$E._r.ly[t].length;s--;){let l=$E._r.ly[t][s],[n,c]=l.R;o.cRc(n,c,l.w,l.h,i,e,r,d)&&!$E.$O.includes(l)&&$E.$O.push(l)}return $E.$P($E.$O.length?$E.$O:0),t.slc=!1,o.dMouse(0,0,1),!0}if(t.fill){let i=$E._O.dep,e=t.fR;if(!$E._r.ly[i].lock){let t=e[0]+e[2],r=e[1]+e[3],d=e[4];o.addUndo();for(let s=e[1];s<r;s+=d)for(let r=e[0];r<t;r+=d)if(!o.atPosDep(r,s,i)){let t=new $E.Object(r,s,$E._O.o);$E.sfO.dirty(t.R[0],t.LT[1],t.w,t.h)}$E._r.setNum()}return t.fill=!1,o.dMouse(0,0,1),$E.sfO.update(),!0}}},t.onmouseup=o=>{$E.edit&&(o.preventDefault(),t.outf())},window.addEventListener("mouseup",()=>t.drag=!1),t.slR=()=>{let o,i,e=$E.C.mX-t.dX,r=$E.C.mY-t.dY;return e>0?o=t.dX:(o=$E.C.mX,e=-e),r>0?i=t.dY:(i=$E.C.mY,r=-r),[o,i,e+$E.grid.value,r+$E.grid.value]},t.onmousemove=o=>{if(!$E.edit)return;if(o.stopPropagation(),t.out=!1,!$E._r)return;const i=$E.C,e=$E.$O,r=$E.grid.value;let d="";if(i.mTX=o.x-t.left-32+($E._r?$E._r.editX:0)<<0,i.mTY=o.y-t.top-32+($E._r?$E._r.editY:0)<<0,i.mPX=i.mX,i.mPY=i.mY,i.mX=o.altKey?i.mTX:Math.floor(i.mTX/r)*r,i.mY=o.altKey?i.mTY:Math.floor(i.mTY/r)*r,UI.showTips(i.mX+","+i.mY,o.x+8,o.y-32),t.drag)if(0===i.mB)if(o.ctrlKey)i.mPX===i.mX&&i.mPY===i.mY&&t.slc||(t.slc=!0,i.dMouse(0,0,1,...t.slR())),e&&(e.drag=null);else{if(e&&e.drag){let t=i.mX-e.drag.x,o=i.mY-e.drag.y;(t||o)&&i.moveEditO(t,o)}t.slc&&(t.slc=!1,i.dMouse(0,0,1))}else if(2===i.mB)o.ctrlKey||i.delPos(i.mTX,i.mTY);else if(1===i.mB){let t=Math.mM($E._r.editX-o.movementX,0,$E._r.w-800),i=Math.mM($E._r.editY-o.movementY,0,$E._r.h-608);t===$E._r.editX&&i===$E._r.editY||($E._r.editX=t,$E._r.editY=i,$E._r.setBar()),d="grab"}if($E._O&&!o.ctrlKey&&(i.mPX!==i.mX||i.mPY!==i.mY)){let[r,d]=i.cXY();if(t.drag&&0===i.mB&&1!==$E._O.o.ind&&!e)if(o.shiftKey)t.fR=t.slR(),t.fR[4]=($E._O.o.scx||1)*("小砖"===$E._O.name?16:32)<<0,t.fR[0]+=r-i.mX,t.fR[1]+=d-i.mY,i.dMouse(r,d,0,...t.fR),t.fill=!0;else{t.fill=!1,i.dMouse(r,d);let o=$E._O.dep;if(!i.atPosDep(r,d,o)&&!$E._r.ly[o].lock){let t=new $E.Object(r,d,$E._O.o);$E._r.setNum(),$E.sfO.dirty(t.R[0],t.LT[1],t.w,t.h),$E.sfO.update()}}else e&&e.drag||(i.dMouse(r,d),t.fill=!1)}t.style.cursor=d},t.onwheel=t=>{if($E.edit&&$E._O){let o=.25*Math.sign(t.wheelDelta);if($E._O.o.scx+o>=.5&&$E._O.o.scx+o<=5){$E._O.o.scx+=o,$E._O.o.scy+=o;let[t,i]=$E.C.cXY();$E.C.dMouse(t,i),UI.showTips($E.C.mX+","+$E.C.mY+" ×"+$E._O.o.scx.toFixed(2))}}},t.onmouseout=()=>{$E.edit&&(UI.tip._h(),t.out=!0,t.outf()||$E.C.dMouse(0,0,1))},doc.addEventListener("keydown",o=>{let i=doc.activeElement.tagName;if("TEXTAREA"===i||"INPUT"===i||!$E.edit)return;const e=!o.repeat,r=o.keyCode;switch(r){case 9:e&&$E._r&&$E.tab[($E.nowTab+1)%4].click();break;case 17:e&&!t.out&&$E._O&&(t.fill=!1,$E.C.dMouse(0,0,1));break;case 90:o.ctrlKey&&(o.preventDefault(),o.shiftKey?$E.C.redo():$E.C.undo());break;case 87:case 65:case 83:case 68:if(e)if(o.ctrlKey)if(65===r){$E.pro.lock=!1,$E.$O=[];for(let t=$E._r.ly.length;t--;)if(!$E._r.ly[t].lock)for(let o=$E._r.ly[t].length;o--;)$E.$O.push($E._r.ly[t][o]);$E.$P($E.$O.length?$E.$O:0),$E.C.dMouse(0,0,1)}else 83===r&&$("btn").ch[2].click();else if($E._O&&void 0!==$E._O.o.ang){let[o,i]=$E.C.cXY(),e=87===r?0:65===r?90:83===r?180:270;switch($E._O.o.spr[0].name){case"btn":case"arr":e=(e+90)%360;break;case"wj":e=(e+270)%360}$E._O.lastChild.style.transform=`rotate(-${e}deg)`,$E._O.o.ang=e,t.out||$E.C.dMouse(o,i)}break;case 67:e&&o.ctrlKey&&$E.$O&&!$E.pro.lock&&$E.C.copy($E.$O);break;case 86:e&&o.ctrlKey&&!t.out&&$E._r&&$E.C.paste(...$E.C.cXY());break;case 71:e&&$("setg").click();break;case 37:case 38:case 39:case 40:o.preventDefault(),$E.$O&&(e&&$E.C.addUndo(),$E.C.moveEditO(37===r?-$E.grid.value:39===r?$E.grid.value:0,38===r?-$E.grid.value:40===r?$E.grid.value:0));break;case 8:case 46:e&&$E.$O&&!$E.pro.lock&&($E.C.addUndo(),$E.$O.for(t=>$E._r.ly[t.dep].rm(t)),$E._r.setNum(),$E.sfO.update(),$E.$P(),$E.C.dMouse(0,0,1))}}),doc.addEventListener("keyup",o=>{if($E.edit)switch(o.keyCode){case 17:if(!t.out&&$E._O){let[t,o]=$E.C.cXY();$E.C.dMouse(t,o)}else t.slc&&(t.slc=!1,$E.C.dMouse(0,0,1))}})}