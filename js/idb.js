const IDB=class{constructor(e,t,r){this.ready=[],this.rd=!1,this.watch=new Set,this.cls=r.split(",").map(e=>{let t=e.split("."),r=t[0],s={a:"+"===r[0]};return s.a&&(r=r.slice(1)),"-"===r[0]&&(r=r.slice(1),this.watch.add(r)),s.n=r,t.length>1&&(s.k=t.slice(1)),s});let s=indexedDB.open(e,t);s.onerror=e=>UI.$a("0{1s}"),s.onsuccess=()=>{this.db=s.result,this.ready.for(e=>e()),delete this.ready,this.rd=!0,Object.freeze(this)},s.onupgradeneeded=()=>{this.db=s.result,this.cls.for(e=>{if(!this.db.objectStoreNames.contains(e.n)){let t=this.db.createObjectStore(e.n,{keyPath:"id",autoIncrement:e.a});e.k&&e.k.for(e=>t.createIndex(e,e))}})}}onready(e){this.rd?e():this.ready.push(e)}size(e){let t=0;for(let r in e)switch(t+=r.length??4,e[r]?.constructor){case void 0:break;case Number:t+=4;break;case Blob:t+=e[r].size;break;case Object:case Array:t+=this.size(e[r]);break;default:t+=e[r].length??0}return t}#e(e,t){return this.db.transaction(e,t?"readwrite":"readonly").objectStore(e)}put(e,t){return new Promise((r,s)=>{let n=this.db.transaction(e,"readwrite"),o=null;n.objectStore(e).put(t).onsuccess=e=>o=e,n.oncomplete=()=>{this.watch.has(e)&&App.addStorage(e,this.size(t)),r(o)},n.onerror=s})}putAll(e,t,r){return new Promise((s,n)=>{if(!t.length)return s();let o=this.db.transaction(e,"readwrite"),a=o.objectStore(e);t.for(e=>{let t=a.put(e);r&&t.then(r)}),o.oncomplete=s,o.onerror=n})}clear(e){return new Promise((t,r)=>{let s=this.#e(e,1).clear();s.onsuccess=r=>{this.watch.has(e)&&App.setStorage(e,0),t(r)},s.onerror=r})}del(e,t){return new Promise(async(r,s)=>{if(this.watch.has(e)){let r=await this.get(e,t);App.addStorage(e,-this.size(r))}let n=this.#e(e,1).delete(t);n.onsuccess=r,n.onerror=s})}get(e,t){return new Promise((r,s)=>{let n=this.#e(e).get(t);n.onsuccess=e=>n.result?r(n.result):s(e),n.onerror=s})}find(e,t,r){return new Promise((s,n)=>{let o,a=this.#e(e),i=[];if(t){let e,r=t.match(/\w\b|[=><]|\b\w+/g);switch(r[1]){case"=":e=IDBKeyRange.only(r[2]);break;case">":e=IDBKeyRange.lowerBound(r[2],1);break;case"<":e=IDBKeyRange.upperBound(r[2],1)}o=a.index(r[0]).openCursor(e)}else o=a.openCursor();o.onsuccess=()=>{let e=o.result;e?(r&&!r(e.value)||i.push(e.value),e.continue()):s(i)},o.onerror=n})}async fetch(e,t,r,s,n){try{if(!r)throw 0;return await this.get(r,e)}catch{let o=DB.Q(t);s&&o.select(s),n&&o.include(n);let a=(await o.get(e)).toJSON();return a.id=a.objectId,delete a.objectId,delete a.ACL,r&&this.put(r,a),a}}},CIW=new IDB("CIW",8,"+proj,-img.c,-thm,-snd,-bgm,game,-cover,save.u,+msg.u,-avatar,-font,-tpl"),Local=new IDB("Local",3,"f,c");