const IDB=class{constructor(e,t,r){this.cls=r.split(",").map(e=>{let t=e.split("."),r={a:"+"===t[0][0]};return r.n=r.a?t[0].slice(1):t[0],t.length>1&&(r.k=t.slice(1)),r}),this.ready=[],this.rd=!1;let n=indexedDB.open(e,t);n.onerror=e=>UI.alert("加载错误：无法打开数据库"),n.onsuccess=()=>{this.db=n.result,this.ready.for(e=>e()),delete this.ready,this.rd=!0},n.onupgradeneeded=()=>{this.db=n.result,this.cls.for(e=>{if(!this.db.objectStoreNames.contains(e.n)){let t=this.db.createObjectStore(e.n,{keyPath:"id",autoIncrement:e.a});e.k&&e.k.for(e=>t.createIndex(e,e))}})}}onready(e){this.rd?e():this.ready.push(e)}#open(e,t){return this.db.transaction(e,t?"readwrite":"readonly").objectStore(e)}put(e,t){return new Promise((r,n)=>{let s=this.db.transaction(e,"readwrite"),o=null;s.objectStore(e).put(t).onsuccess=e=>o=e,s.oncomplete=()=>r(o),s.onerror=n})}putAll(e,t,r){return new Promise((n,s)=>{if(!t.length)return n();let o=this.db.transaction(e,"readwrite"),c=o.objectStore(e);t.for(e=>{let t=c.put(e);r&&t.then(r)}),o.oncomplete=n,o.onerror=s})}clear(e){return new Promise((t,r)=>{let n=this.#open(e,1).clear();n.onsuccess=t,n.onerror=r})}del(e,t){return new Promise((r,n)=>{let s=this.#open(e,1).delete(t);s.onsuccess=r,s.onerror=n})}get(e,t){return new Promise((r,n)=>{let s=this.#open(e).get(t);s.onsuccess=e=>s.result?r(s.result):n(e),s.onerror=n})}find(e,t,r){return new Promise((n,s)=>{let o,c=this.#open(e),a=[];if(t){let e,r=t.match(/\w\b|[=><]|\b\w+/g);switch(r[1]){case"=":e=IDBKeyRange.only(r[2]);break;case">":e=IDBKeyRange.lowerBound(r[2],1);break;case"<":e=IDBKeyRange.upperBound(r[2],1)}o=c.index(r[0]).openCursor(e)}else o=c.openCursor();o.onsuccess=()=>{let e=o.result;e?(r&&!r(e.value)||a.push(e.value),e.continue()):n(a)},o.onerror=s})}async fetch(e,t,r,n,s){try{if(!r)throw 0;return await this.get(r,e)}catch{let o=DB.Q(t);n&&o.select(n),s&&o.include(s);let c=(await o.get(e)).toJSON();return c.id=c.objectId,delete c.objectId,delete c.ACL,r&&this.put(r,c),c}}},CIW=new IDB("CIW",8,"+proj,img.c,thm,snd,bgm,game,cover,save.u,+msg.u,avatar,font,tpl"),Local=new IDB("Local",3,"f,c");