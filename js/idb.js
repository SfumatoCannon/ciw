const IDB=class{constructor(e,t,r){this.cls=r.split(",").map(e=>{let t=e.split("."),r={a:"+"===t[0][0]};return r.n=r.a?t[0].slice(1):t[0],t.length>1&&(r.k=t.slice(1)),r}),this.ready=[],this.rd=!1;let s=indexedDB.open(e,t);s.onerror=e=>{UI.alert("加载错误：无法打开数据库"),console.error(e)},s.onsuccess=()=>{this.db=s.result,this.ready.for(e=>e()),delete this.ready,this.rd=!0},s.onupgradeneeded=()=>{this.db=s.result,this.cls.for(e=>{if(!this.db.objectStoreNames.contains(e.n)){let t=this.db.createObjectStore(e.n,{keyPath:"id",autoIncrement:e.a});e.k&&e.k.for(e=>t.createIndex(e,e))}})}}onready(e){this.rd?e():this.ready.push(e)}#open(e,t){return this.db.transaction(e,t?"readwrite":"readonly").objectStore(e)}put(e,t){return new Promise((r,s)=>{let n=this.#open(e,1).put(t);n.onsuccess=r,n.onerror=s})}putS(e,t){this.onready(()=>this.put(e,t))}clear(e){return new Promise((t,r)=>{let s=this.#open(e,1).clear();s.onsuccess=t,s.onerror=r})}del(e,t){return new Promise((r,s)=>{let n=this.#open(e,1).delete(t);n.onsuccess=r,n.onerror=s})}get(e,t){return new Promise((r,s)=>{let n=this.#open(e).get(t);n.onsuccess=e=>n.result?r(n.result):s(e),n.onerror=s})}find(e,t,r){return new Promise((s,n)=>{let o,c=this.#open(e),a=[];if(t){let e,r=t.match(/\w\b|[=><]|\b\w+/g);switch(r[1]){case"=":e=IDBKeyRange.only(r[2]);break;case">":e=IDBKeyRange.lowerBound(r[2],1);break;case"<":e=IDBKeyRange.upperBound(r[2],1)}o=c.index(r[0]).openCursor(e)}else o=c.openCursor();o.onsuccess=()=>{let e=o.result;e?(r&&!r(e.value)||a.push(e.value),e.continue()):s(a)},o.onerror=n})}async fetch(e,t,r,s,n){try{if(!r)throw 0;return await this.get(r,e)}catch{let o=DB.Q(t);s&&o.select(s),n&&o.include(n);let c=(await o.get(e)).toJSON();return c.id=c.objectId,delete c.objectId,delete c.ACL,r&&this.put(r,c),c}}},CIW=new IDB("CIW",7,"+proj,bg,spr.n,img.c,thm,snd,bgm,game,cover,save.u,+msg.u,avatar,font,tpl"),Local=new IDB("Local",3,"f,c");