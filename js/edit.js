const $E={edit:!0,nowTab:0,_R:null,RoomID:0,GAME:null,_r:null,_O:null,$O:null,showInvis:App.gC("edit","showInvis"),tab:$t("div",$("tab")),async fixH(t,i){let s=t.pd;if(t.pd=!0,await doc.fonts.ready,!s){t.pd=!1;let i=t.className;t.className="cat",t.style.height="auto",t.style.height=t.clientHeight+"px",t.className=i}i?.(t)},setGame(t){$E.clrSf($E.sfB),$E.clrSf($E.sfE),$E.sfO.clear(),$E.sfG.setTransform(1,0,0,1,0,0),$E.sfG.clearRect(0,0,864,672),$E._r=null,$E.RoomID=t.RID??0,$c("room").for(t=>t.remove()),$E.GAME&&$E.GAME.id&&(t.id=$E.GAME.id),$E.GAME=t,$E._R=[],t.R.for(t=>{let i=new $E.Room(2,t);$E.addRoom(i)}),t.R=$E._R;let i=$c("cat"),s=i[0].ch,e=i[1].ch,r=$c("room");s[1].set(t.N||""),e[1].set(t.S||1),$("vars").innerHTML="";for(let i in t.VAR)$E.addVar(i);$E.fixH($c("cat")[1]),$E.tab[0].click(),r.length?r[0].firstChild.click():($("crtr")._s(),$E.fixH($("room"))),Res.loc=t._s,saveCache=null,this.modified=!1},openGame(){CIW.find("proj").then(t=>{let i="";t.for((t,s)=>i+=`<div class='proj' id='${s}'><div class='dots'>${t.N}</div><span>创建日期 ${t._c??"未知"}</span><span>上次修改 ${t._u??t._c??"未知"}</span><div class='del'>${UI.ico("trash")}</div></div>`);let s=new UI.M(400).h("打开项目").a(`${i}<div class='proj'>${UI.ico("add")}${i18n("新建游戏")}</div>`),e=$c("proj");$E.GAME&&s.cb(),e.for(i=>{i.id&&(i.lastChild.onclick=s=>{s.stopPropagation(),UI.confirm("确定要删除此游戏？").then(s=>{s.i||CIW.del("proj",t[i.id].id).then(t=>i.remove())})}),i.onclick=()=>{const e=()=>{$E.GAME=null,$E.setGame(i.id?t[i.id]:{_a:[USER.id],_c:Date.cD(new Date),_s:[],R:[],VAR:{}}),s.close(),$E._O=null,$E.$P()};$E.modified?UI.confirm("当前项目未保存，是否放弃当前修改？").then(t=>{t.i||e()}):e()}})})},exportGame(t=1){if(t&&!this.GAME.N)return void UI.alert("请填写游戏名！");this._r&&this._r.enc(1);const i=this.GAME;let s={_s:i._s,N:i.N,R:[],VAR:i.VAR,S:i.S};t&&(s._a=i._a,s._c=i._c,s._u=Date.cD(new Date),s.C=i.C,s.RID=this.RoomID);for(let t=i.R.length;t--;)s.R[t]=i.R[t].save();return s},set modified(t){this.savedGame=t?"":JSON.stringify(this.exportGame(0))},get modified(){return!!this.GAME&&this.savedGame!==JSON.stringify(this.exportGame(0))},addVar(t,i){let s=$("vars").ap(El("div","rl")),e=UI.I("变量名: ",{l:8,value:t??""},96),r=UI.I("默认值:",{type:"number",value:$E.GAME.VAR[t]??i??0,m:-999,M:999},48),d=El("div","ab del");i&&($E.GAME.VAR[t]=i),t&&(e.val=t),e.style.marginRight="16px",e.on(function(t){return(t=t.trim())?void 0!==$E.GAME.VAR[t]?(UI.alert("此变量名已被使用！"),void this.set("")):(this.set(t),delete $E.GAME.VAR[this.val],void($E.GAME.VAR[this.val=t]=this.nS().v)):(UI.alert("无效的变量名！"),void this.set(""))}),r.on(function(t){let i=this.pS().v;i&&($E.GAME.VAR[i]=t)}),d.innerHTML=UI.ico("trash"),css(d,{top:"5px",right:"8px"}),d.onclick=function(){delete $E.GAME.VAR[this.pS(2).v],s.remove(),$E.fixH($("vars").pN)},s.ap(e,r,d),$E.fixH($c("cat")[1])},async loadTh(t,i,s){Res.reset();for(let t=Res.sprList.length-Res.sprList.len;t--;)Res.push();this.tileCol.spr=null,this.clrSf(this.sfB),this.sfO.clear();let e=[Res.loadBg(t.bg)];for(let i=0;i<t.spr.length;i++){let s="";for(let e in t.col)t.col[e].split("|").includes(Res.sprList[i])&&(s=e);e.push(Res.loadSpr(Res.sprList[i],t.spr[i],s))}try{let s=(await Promise.all(e))[0];this.loadComp=i?()=>{for(let t in Res.spr)this.setTile(Res.spr[t]);i(s)}:()=>{for(let t in Res.spr)this.setTile(Res.spr[t]);this._r.col=t.col,this._r.spr=t.spr,this._r.setBg(s),this.setBg(s),this._r.drawBg(),this.sfO.redraw()}}catch{Res.fail(),s?s():(this._r.drawBg(),this.sfO.redraw())}},setTile(t){let i=$("tile");i.spr[t.name]&&this.drawThn(i.spr[t.name],t)},drawThn(t,i,s=1){let e,r=t.getContext("2d"),{w:d,h}=i;if("lsr"===i.name){h=32;let t=El("canvas",0,{width:d,height:h}),s=t.getContext("2d");s.drawImage(i[1],0,0,d,32),s.drawImage(i[0],0,0),e=t}else e=i[0];if(s&&r.clearRect(0,0,32,32),d<32&&h<=32||h<32&&d<=32)r.drawImage(e,i.x?16-(d>>1):0,"tp"===i.name||"grs"===i.name?32-h:i.y?16-(h>>1):0,d,h);else if(d>32){let t=Math.min(32/d,32/h);d*=t,h*=t,r.drawImage(e,16-(d>>1),"grs"===i.name?32-h:16-(h>>1),d,h)}else r.drawImage(e,0,0)},Obj(t,i,s,e){let r=Lib.obj[t],d=El("div","obj"),h=El("canvas",0,{width:32,height:32});d.ap(El("div"),El("p","a-cen").tx(r.n),h),d.o=JSON.parse(JSON.stringify(r)),i&&(d.o.scx=d.o.scy=1),s&&(d.o.ang=0),d.a=e??0,d.dep=d.o.add.dep,d.onclick=()=>{$E._O&&($E._O.style.borderColor=""),d.style.borderColor="#fd0",$E._O=d,$E.pro.lock=!1},d.onmouseover=()=>$E.C.hObj=d,d.onmouseout=()=>$E.C.hObj=null,d.setKey=(i,s)=>{i?(d.id="hObj"+i,d.firstChild.tx(i-48),d.firstChild._s(),s&&App.sC("edit","key"+i,t)):(d.id="",d.firstChild._h())};for(let i=48;i<58;i++)if(t===App.gC("edit","key"+i)){d.setKey(i);break}let o=d.o.spr;for(let t=o.length;t--;)o[t]=Res.spr[o[t]],o[t].on(()=>{for(let t of o){if(!t.ready)break;$E.drawThn(h,t,0)}});return d},BObj(t,i,s,e){let r=UI.B2(i).on(t=>{$E.$P();let i=$E._r.bobj[t.buildIn.id];"gov"===t.buildIn.id?i.drawTxt():($E.sfE.dirty(-32,-32,$E._r.w+64,$E._r.h+64),$E.C.dMouse(0,0,1)),$E.tab[3].click(),$E.$O=[i],$E.$P($E.$O,t.buildIn)});return r.id="bi-"+t,r.buildIn={id:t,name:i,spr:Res.spr[s],add:e??[]},r},Room:class{constructor(t,i){if(0===t||i&&0===i.type){let t=$c("room");for(let i=$E._R.length;i--;)$E._R[i].ind++,t[i].ind++;this.ind=0,$E._R.unshift(this)}else this.ind=$E._R.push(this)-1;this.objNum=0,this.ly=[];for(let t=12;t--;)this.ly[t]=$E.Layer(t,$E.sfO);if(this.editX=this.editY=0,this.undo=[],this.redo=[],this.bg={id:0,m:0},this.spr=[...Lib.thm],this.bgm={m:0},i?(Object.assign(this,i),this.type?this.decB(i.bobj):delete this.bobj,this.spr.length<Res.sprList.length&&(this.spr=[...Lib.thm])):(this.type=t,this.obj="|||||||||||",this.w=800,this.h=608,this.bgm={m:0},t&&this.decB()),!this.name)switch(this.type){case 0:this.name="rTitle";break;case 1:this.name="rEnd";break;default:this.name="Room"+ ++$E.RoomID}if(void 0===this.id){let t=[];for(let i=128;i--;)t.push(0);for(let i=$E._R.length-1;i--;)t[$E._R[i].id]=1;this.id=t.indexOf(0)}}getType(){return["标题界面","通关界面","普通房间","耐久房间","选关界面"][this.type]}setNum(){$c("room")[this.ind].ch[3].tx(this.objNum,"个物体")}setWH(t,i){2!==this.type&&4!==this.type||(t&&(this.w=t),i&&(this.h=i),$c("room")[this.ind].ch[2].tx(this.w+"×"+this.h),this.editX+800>this.w&&(this.editX=this.w-800),this.editY+608>this.h&&(this.editY=this.h-608),this.setBar())}setBar(){css($("hbar"),{width:8e4/this.w+"%",transform:`translateX(${this.editX/this.w*864}px)`}),css($("vbar"),{height:60800/this.h+"%",transform:`translateY(${this.editY/this.h*672}px)`}),$E.resetTransform($E.sfB),$E.resetTransform($E.sfE),$E.sfO.translate(this.editX-32,this.editY-32),$E.sfO.redraw(),$E.sfE.dirty(this.editX-32,this.editY-32,864,672),this.drawBg(),$E.sfG.canvas.style.display||$E.grid.draw(),($E.$O||$E._O)&&$E.C.dMouse(0,0,1)}setFill(){3!==this.bg.m&&(this.bgFill=$E.sfB.createPattern(this.bg.c,"repeat"))}setBg(t){this.bg=t,this.setFill()}drawBg(){let t=$E.sfB;switch($E.clrSf(t),this.bg.m){case 0:t.fillStyle=this.bgFill,t.fillRect(0,0,this.w,this.h);break;case 2:t.drawImage(this.bg.c,0,0,this.w,this.h);break;case 3:t.fillStyle=this.bg.g,t.fillRect(this.editX,this.editY,800,608);break;default:t.fillStyle=this.bgFill,t.save(),t.translate(this.editX,this.editY),t.fillRect(0,0,800,608),t.restore()}}colBg(t,i,s,e){this.bg.g||(this.bg.g=",,,");let r=this.bg.g.split(",");""!==t&&(r[0]=t),""!==i&&(r[1]=i),""!==s&&(r[2]=s),""!==e&&(r[3]=e),this.bg.g=Res.color.gen(r),Res.color.draw(this.bg.c,this.bg.i,this.bg.g),this.setFill(),this.drawBg()}encN(t){return String.fromCharCode(t+Core.dec.bias)}encKey(t){let i=0;for(let s=t.length;s--;)i+=t.charCodeAt(s)-96<<5*s;return this.encN(i)}encNum(t){let i=t<0?-t:t,s=0;for(;s<2&&i<<0!==i;s++)i*=10;return i+=1e4*s,this.encN(t<0?3e4+i:i)}encStr(t){return Core.dec.iStr+t+Core.dec.iStr}encArr(t){let i=Core.dec.iArr+this.encN(t.length);return t.for(t=>{switch(typeof t){case"object":i+=this.encArr(t);break;case"string":i+=this.encStr(t);break;default:i+=this.encNum(t)}}),i}enc(t){let i=[],s=0;const e=$E.C.cRc;for(let t=0,r=this.ly.length;t<r;t++){let r=[],d=[];Lib.obj.for(t=>{r.push(""),d.push(0)}),this.ly[t].for(t=>{if(!e(t.R[0],t.LT[1],t.w,t.h,-32,-32,this.w+64,this.h+64))return;t.sid=d[t.ind]++,r[t.ind]+=this.encNum(t.x)+this.encNum(t.y),s++;let i="";for(let s in t.add){if("dep"===s)continue;let e=t.add[s];if("til"===s&&(e=t.autoTile?t.tileInd:1e3+t.tileInd),"object"==typeof e)e.length&&JSON.stringify(e)!==JSON.stringify(Lib.obj[t.ind].add[s])&&(i+=this.encKey(s)+this.encArr(e));else{if(void 0===Lib.obj[t.ind].add[s]&&("scx"===s&&1===e||"scy"===s&&1===e||"ang"===s&&0===e||"hd"===s&&0===e||"al"===s&&1===e))continue;e!==Lib.obj[t.ind].add[s]&&(i+="string"==typeof e?this.encKey(s)+this.encStr(e):this.encKey(s)+this.encNum(e))}}i&&(r[t.ind]+=Core.dec.iPro+i+Core.dec.iPro)}),i[t]="",r.for((s,e)=>{s&&(i[t]+=Core.dec.iObj+this.encN(e)+s),e&&(d[e]+=d[e-1])}),this.ly[t].for(t=>{t.ind&&(t.sid+=d[t.ind-1])})}return t&&s!==this.objNum&&(this.objNum=s,this.setNum()),this.obj=i.join("|")}dec(){let t=$E._r;try{$E._r=this,this.objNum=0,this.ly[0].length=0,Core.dec.room(this.obj,t=>this.ly[t].length=0,(t,i,s,e)=>new $E.Object(i,s,e)),$E._r=t,this.setNum(),t===this&&($E.sfO.redraw(),this.drawBg())}catch(i){console.error(i),UI.alert("房间内容解析错误"),$E._r=t,this.objNum=0,this.ly.for(t=>t.length=0),this.setNum(),t===this&&($E.sfO.redraw(),this.drawBg())}}encB(){if(0===this.type)return"";let t={};for(let i in this.bobj)t[i]={add:this.bobj[i].add};return JSON.stringify(t)}decB(t){const i={ply:{id:"ply",add:{jump:2,sJump:1,gravDir:270,sGravDir:1,conShoot:0,adMove:0,life:1}},gov:{id:"gov",w:800,h:608,lib:29,svg:1,set txt1(t){this.add.txt1=t,this.drawTxt()},set txt2(t){this.add.txt2=t,this.drawTxt()},set scx(t=1){this.add.scx=t,this.drawTxt(1)},set scy(t=1){this.add.scy=t,this.drawTxt(1)},set ang(t){this.add.ang=t,this.drawTxt(1)},add:{txt1:"Game Over",ftf1:9,fts1:80,ftt1:1,fta1:1,ftc1:"#ffffff",fsd1:8,fsc1:"#000000",fst1:3,fkc1:"#000000",txt2:"--------------------------------\nPress R to Try Again",ftf2:9,fts2:28,ftt2:1,fta2:1,ftc2:"#ffffff",fsd2:0,fsc2:"#000000",fst2:2,fkc2:"#000000",al:0,tml:[[1,[[.01,20],[1.05,[0,1],30]]]]},drawTxt(t){if(console.log("drawTxt"+t),t)return this.svg.onload();this.svg=new Image,this.svg.onload=()=>{$E.sfE.canvas.style.opacity=1,$E.sfE.save(),$E.sfE.setTransform(1,0,0,1,0,0),$E.sfE.clearRect(0,0,864,672),$E.sfE.translate(432,336),(this.add.hd||this.add.al<1)&&($E.sfE.globalAlpha=this.add.hd?.5:.5+this.add.al/2),this.add.scx&&$E.sfE.scale(this.add.scx,this.add.scy),this.add.ang&&$E.sfE.rotate(-this.add.ang*Math.DR),$E.sfE.drawImage(this.svg,-400,-304),$E.sfE.restore(),$E.sfE.dirty(-32,-32,$E._r.w+64,$E._r.h+64)},this.svg.src=Res.svgGO(this.add)}}};if(this.bobj=i,t){"string"==typeof t&&(t=JSON.parse(t));for(let i in t)this.bobj[i]&&Object.assign(this.bobj[i].add,t[i].add)}}purge(){this.enc(1),this.ly.for(t=>t.length=0)}save(){let t={...this,bg:{m:this.bg.m}};t.bg.m<3&&(t.bg.id=this.bg.id),this.bg.g&&"0,50,50,50"!==this.bg.g&&(t.bg.g=this.bg.g),this.type&&(t.bobj=this.encB()),delete t.ind,delete t.ly,delete t.undo,delete t.redo,delete t.bgFill,delete t.editX,delete t.editY;for(let i in t)null!==t[i]&&void 0!==t[i]||delete t[i];return t}},roomUp:(t,i)=>{let s=t.room,e=i.room?.ind??$E._R.length-1;for(let t=s.ind-1;t>=e;t--){let i=$E._R[t];$E._R[t+1]=i,i.ind++}$E._R[s.ind=e]=s,i.before(t)},roomDown:(t,i)=>{let s=t.room,e=i.room?.ind??0;for(let t=s.ind+1;t<=e;t++){let i=$E._R[t];$E._R[t-1]=i,i.ind--}$E._R[s.ind=e]=s,i.after(t)}};$E.addRoom=t=>{if((t.id<0||$E._R.length>127)&&($("crtr")._h(),t.id>127))return;let i=$("room"),s=El("div","room",{innerHTML:`<b><div></div><span>${t.name}</span></b><p>${i18n(t.getType())}</p><p>${t.w}×${t.h}</p><p>${t.objNum}${i18n("个物体")}</p>`,room:t});s.firstChild.onclick=()=>{$E._r&&$c("room now")[0].rC("now"),s.aC("now"),$E.setRoom(s.room,()=>{$E._r=null,s.rC("now")})},s.firstChild.firstChild.onmousedown=function(t){t.stopPropagation(),s.style.borderColor=this.style.background="#5c9",i.drag=s,i.dragY=t.y,i.dragI=s.room.ind,i.style.cursor="move",css($c("room"),{pointerEvents:"none"})};let e=El("div","p-btn",{innerHTML:UI.ico("copy")}),r=El("div","del",{innerHTML:UI.ico("trash")});return e.style.float="none",s.ap(e,r),t.type<2?dac(e):e.onclick=()=>{let t=s.room.save();delete t.id,$E.roomUp($E.addRoom(new $E.Room(t.type,t)),s.nS())},r.onclick=()=>{if($E._R.length<=1)return UI.alert("游戏不能没有房间！");UI.confirm("确定删除此房间？").then(t=>{if(t.i)return;let i=s.room.ind;$E._R.splice(i,1);let e=$E._r?i==$E._r.ind:0;$("crtr")._s();for(let t=Number(i);t<$E._R.length;t++)$E._R[t].ind--;e&&$c("room")[(0===i)<<0].firstChild.click(),$E.RoomID--,s.remove()})},0===t.type?(s.firstChild.firstChild.style.pointerEvents="none",i.firstChild.after(s)):$("crtr").before(s),$E.fixH(i),s},$E.setBg=t=>{let i=$c("cat")[4].ch;switch(t.m){case 0:case 1:case 2:i[8].ch[2].set(1<<t.m);break;case 3:i[6].set(t.g)}i[4].set(3===t.m?1:t.m>3?2:4,1)},$E.setRoom=(t,i)=>{t!==$E._r&&($E.clrSf($E.sfE),$E.sfG.clearRect(0,0,896,704),$E.loadTh({spr:t.spr,col:t.col,bg:t.bg},i=>{$E._r&&$E._r.purge(),$E._r=t,$E._r.setBg(i),$E.setBg(i);let s=$c("cat"),e=s[3].ch,r=s[5].ch,d=s[19].ch;if(e[1].set(t.name),e[2].set(t.w),e[3].set(t.h),e[4].set(t.out||1),e[5].set(t.view||1),2===t.type||4===t.type)for(let t=2;t<6;t++)ac(e[t]);else for(let t=2;t<6;t++)dac(e[t]);if(r[2].set(t.bgm.m),r[2].f(t.bgm.m),0===t.type)for(let t=1;t<3;t++)dac(s[7].ch[t]);else for(let t=1;t<3;t++)ac(s[7].ch[t]);for(let i=0;i<12;i++)d[4*i+2].set(t.ly[i].vis),d[4*i+3].set(t.ly[i].lock);t.dec(),$E.$O&&$E.$P(),t.setBar(),$E.fixH(e[0].pN)},i))},$E.Object=class{#x;#y;constructor(t,i,s){this.#x=t,this.#y=i,this.LT=[t,i],this.ind=s.ind,this.spr=s.spr,this.add=JSON.parse(JSON.stringify(s.add)),s.scx&&1!==s.scx&&(this.add.scx=this.add.scy=s.scx),s.ang&&(this.add.ang=s.ang),this.WH=!!s.add.w,this.calcRect(),s.add.txt&&(this.add.txt="",this.txt=s.add.txt),0===s.ind&&$E._r.ly[7].forv(t=>{0===t.ind&&$E._r.ly[7].rm(t)}),void 0!==this.dep&&($E._r.ly[this.dep].add(this),$E._r.objNum++),this.spr[0].tile&&(this.ti=[this.add.til/1e3<<0,this.add.til%1e3])}get x(){return this.#x}set x(t){this.LT[0]+=t-this.#x,this.#x=t}get y(){return this.#y}set y(t){this.LT[1]+=t-this.#y,this.#y=t}get dep(){return this.add.dep}set dep(t){t!==this.add.dep&&($E._r.ly[this.add.dep].rm(this),this.add.dep=t,$E._r.ly[t].add(this))}get autoTile(){return void 0!==this.tb&&this.add.til/1e3<<0==0}set autoTile(t){if(t)this.tb=0,this.tc=[0,0,0,0],this.add.til=0,$E.Object.blkTile(this);else if(this.tile){let t=this.autoTile;this.add.til=1e3+this.tileInd,t&&$E.Object.dbTile(this.#x,this.#y,this.w,this.h,this.dep)}else this.tb=0,this.tc=[0,0,0,0],this.add.til=1e3}get tile(){return void 0!==this.tb}get tileInd(){let t=0;for(let i=0;i<4;i++)3===this.tc[i]&&(t|=1<<i);return t=(t<<4)+this.tb,isNaN(t)?void 0:t}get ti(){let t=this.tileInd;if(void 0===t)throw"Error tile";return[this.autoTile?0:1,t.toString(2).padStart(8,"00000000")]}set ti(t){if(0===t[0])this.autoTile=!0;else{this.autoTile=!1;let i=t[1].length?Number("0b"+t[1]):t[1];isNaN(i)&&(i=0),this.tb=i%16;for(let t=0;t<4;t++)this.tc[t]=i&1<<t+4?3:0;this.add.til=1e3+i}}get scx(){return this.add.scx}set scx(t=1){this.add.scx=t,this.calcRect()}get scy(){return this.add.scy}set scy(t=1){this.add.scy=t,this.calcRect()}get ang(){return this.add.ang}set ang(t){this.add.ang=t,this.calcRect()}get txt(){return this.add.txt}set txt(t){if(this.WH)if(t.length){if(!this.add.txt.length){let t=this.add.w,i=this.add.h;this.spr=[[El("canvas",0,{width:t,height:i})]],this.spr[0].x=this.spr[0].y=0,this.spr[0].w=t,this.spr[0].h=i,this.ctx=this.spr[0][0].getContext("2d"),this.svg=new Image,this.svg.onload=()=>setTimeout(t=>{Res.fontList.load||(Res.fontList.load=!0),$E.edit&&t&&(t.spr[0].w=t.spr[0][0].width=t.add.w,t.spr[0].h=t.spr[0][0].height=t.add.h,t.ctx.drawImage(t.svg,0,0),$E.sfO.dirty(t.LT[0],t.LT[1],t.w,t.h),$E.sfO.update())},Res.fontList.load?0:20,this)}}else t="文本区域 Text Area";this.add.txt=t,this.ctx&&this.drawTxt()}drawTxt(){this.svg.src=Res.svgTxt(this.add)}dSpr(t,i,s){void 0!==this.add.ang?$E.Object.drawEx(t,i,s,this.#x,this.#y,this.scx||1,this.scy||1,this.add.ang):this.scx?$E.Object.drawSc(t,i,s,this.#x,this.#y,this.scx,this.scy):t.drawImage(i[s],this.#x-i.x,this.#y-i.y)}draw(t){if($E.showInvis)this.add.hd?t.globalAlpha=.5:this.add.al<1&&(t.globalAlpha=.5+.5*this.add.al);else{if(this.add.hd||0===this.add.al)return;this.add.al<1&&(t.globalAlpha=this.add.al)}if(10===this.ind){t.drawImage(this.spr[0][0],this.#x-this.spr[0].x,this.#y-this.spr[0].y);let i=this.add.ang*Math.DR||0,s=1/this.add.num*Math.PI2,e=this.scx||1,r=this.scy||1,d=16/Math.tan(s/2)*e+16*r,h=this.#x-16*e,o=this.#y-16*r;for(let a=0;a<this.add.num;a++){let a=d*Math.cos(i),l=d*Math.sin(i);$E.Object.drawEx(t,Res.spr.spk,0,h+a,o-l,e,r,i/Math.PI*180-90),i+=s}}else if(11===this.ind){let i=Res.spr.lsr;t.save(),t.translate(this.#x,this.#y),void 0!==this.ang&&t.rotate(-this.ang*Math.DR),this.scx&&t.scale(this.scx,this.scy),t.drawImage(i[1],-i.x,0,i.w,this.add.len),t.drawImage(i[0],-i.x,0),t.restore()}else if(22===this.ind){let i=this.spr[0];t.save(),t.translate(this.#x,this.#y),void 0!==this.ang&&t.rotate(-this.ang*Math.DR),this.scx&&t.scale(this.scx,this.scy);let s=this.add.len;if(s<i.h)t.drawImage(i[1],0,i.h-s,i.w,s,-i.x,0,i.w,s);else{t.drawImage(i[1],-i.x,s-i.h);for(let e=s-i.h;e>0;e-=32)e>=32?t.drawImage(i[0],0,0,i.w,32,-i.x,e-32,i.w,32):t.drawImage(i[0],0,32-e,i.w,e,-i.x,0,i.w,e)}t.restore()}else if(this.tile&&this.spr[0].length>1){switch(this.spr[0].length){case 2:this.dSpr(t,this.spr[0],(this.tb>7)<<0);break;case 4:-1===this.tc.indexOf(3)?this.dSpr(t,this.spr[0],(3==(3&this.tb))+((12==(12&this.tb))<<1)):this.dSpr(t,this.spr[0],0);break;case 20:this.dSpr(t,this.spr[0],this.tb);for(let i=0;i<4;i++)3===this.tc[i]&&this.dSpr(t,this.spr[0],16+i)}for(let i=1;i<this.spr.length;i++)this.dSpr(t,this.spr[i],0)}else void 0!==this.add.ang?this.spr.for(i=>$E.Object.drawEx(t,i,0,this.#x,this.#y,this.scx||1,this.scy||1,this.add.ang)):this.scx?this.spr.for(i=>$E.Object.drawSc(t,i,0,this.#x,this.#y,this.scx,this.scy)):this.spr.for(i=>t.drawImage(i[0],this.#x-i.x,this.#y-i.y));t.globalAlpha<1&&(t.globalAlpha=1)}get R(){return this.WH||this.sprW===this.spr[0].w&&this.sprH===this.spr[0].h||this.calcRect(),this.LT}calcRect(){if(10===this.ind){let t=this.add.scx||1,i=this.add.scy||1,s=1/this.add.num*Math.PI2,e=16/Math.tan(s/2)*t+32*i;return this.w=Math.round(2*e),this.h=this.w,this.LT[0]=Math.round(this.#x-e),void(this.LT[1]=Math.round(this.#y-e))}if(11===this.ind||22===this.ind){let t=this.add.scx||1,i=this.add.scy||1,s=this.add.ang||0,e=this.spr[0].x*t,r=11===this.ind?Math.max(this.add.len,Res.spr.lsr.h*i):this.add.len*i,d=Math.cos(s*Math.DR),h=Math.sin(s*Math.DR);return void(s<=90?(this.LT[0]=Math.round(this.#x-d*e),this.LT[1]=Math.round(this.#y-h*e),this.w=Math.round(d*e*2+h*r),this.h=Math.round(h*e*2+d*r)):s<=180?(this.LT[0]=Math.round(this.#x+d*e),this.LT[1]=Math.round(this.#y-h*e+d*r),this.w=Math.round(-d*e*2+h*r),this.h=Math.round(h*e*2-d*r)):s<=270?(this.LT[0]=Math.round(this.#x+d*e+h*r),this.LT[1]=Math.round(this.#y+h*e+d*r),this.w=Math.round(-d*e*2-h*r),this.h=Math.round(-h*e*2-d*r)):(this.LT[0]=Math.round(this.#x-d*e+h*r),this.LT[1]=Math.round(this.#y+h*e),this.w=Math.round(d*e*2-h*r),this.h=Math.round(-h*e*2+d*r)))}let t=this.add.scx||1,i=this.add.scy||1,{x:s,y:e}=this.spr[0],r=this.#x-s*t,d=this.#y-e*i;if(this.WH?(this.w=(this.add.w||32)*t,this.h=(this.add.h||32)*i):(this.sprW=this.spr[0].w,this.sprH=this.spr[0].h,this.w=this.sprW*t+.5<<0,this.h=this.sprH*i+.5<<0),this.add.ang){let t=this.w>>1,i=this.h>>1,s=this.add.ang*Math.DR,e=Math.sin(s),h=Math.cos(s),o=Math.round(Math.max(Math.abs(h*t+e*i),Math.abs(e*i-h*t))),a=Math.round(Math.max(Math.abs(h*i-e*t),Math.abs(e*t+h*i)));r+=t-o,d+=i-a,this.w=o<<1,this.h=a<<1}this.LT[0]=Math.round(r),this.LT[1]=Math.round(d)}static blkTile(t){if(!t.autoTile)return;let i=t.x,s=t.y,e=t.w,r=t.h,d=$E._r.ly[t.dep];for(let h=0;h<d.length;h++){let o=d[h];if(o.autoTile&&o.w===e&&o.h===r){let d=o.x,h=o.y,a=(d===i?1:d===i-e?2:d===i+e?3:0)|(h===s?4:h===s-r?8:h===s+r?12:0);if(5===a)continue;switch(a){case 6:o.tb|=1,t.tb|=2,o.tc[1]|=1,o.tc[3]|=1,t.tc[0]|=1,t.tc[2]|=1;break;case 7:o.tb|=2,t.tb|=1,o.tc[0]|=1,o.tc[2]|=1,t.tc[1]|=1,t.tc[3]|=1;break;case 9:o.tb|=4,t.tb|=8,o.tc[2]|=2,o.tc[3]|=2,t.tc[0]|=2,t.tc[1]|=2;break;case 13:o.tb|=8,t.tb|=4,o.tc[0]|=2,o.tc[1]|=2,t.tc[2]|=2,t.tc[3]|=2;break;case 10:o.tc[3]|=4,t.tc[0]|=4;break;case 11:o.tc[2]|=4,t.tc[1]|=4;break;case 14:o.tc[1]|=4,t.tc[2]|=4;break;case 15:o.tc[0]|=4,t.tc[3]|=4}3&a&&12&a&&$E.sfO.dirty(d,h,e,r)}}}static dbTile(t,i,s,e,r){let d=$E._r.ly[r];for(let r=0;r<d.length;r++){let h=d[r];if(h.autoTile&&h.w===s&&h.h===e){let r=h.x,d=h.y,o=(r===t?1:r===t-s?2:r===t+s?3:0)|(d===i?4:d===i-e?8:d===i+e?12:0);if(5===o){this.blkTile(h);break}switch(o){case 6:h.tb^=1,h.tc[1]^=1,h.tc[3]^=1;break;case 7:h.tb^=2,h.tc[0]^=1,h.tc[2]^=1;break;case 9:h.tb^=4,h.tc[2]^=2,h.tc[3]^=2;break;case 13:h.tb^=8,h.tc[0]^=2,h.tc[1]^=2;break;case 10:h.tc[3]^=4;break;case 11:h.tc[2]^=4;break;case 14:h.tc[1]^=4;break;case 15:h.tc[0]^=4}3&o&&12&o&&$E.sfO.dirty(r,d,s,e)}}}static rTile(t,i,s,e,r){r.autoTile&&(this.dbTile(t,i,s,e,r.dep),r.tb=0,r.tc=[0,0,0,0],this.blkTile(r))}static drawSc(t,i,s,e,r,d,h){(Math.abs(d)<1||Math.abs(h)<1)&&$E.eSmth(t),t.drawImage(i[s],e-i.x*d,r-i.y*h,i.w*d,i.h*h),$E.dSmth(t)}static drawEx(t,i,s,e,r,d,h,o){(Math.abs(d)<1||Math.abs(h)<1)&&$E.eSmth(t),o*=Math.DR;let a=Math.cos(o),l=Math.sin(o),n=(i.w>>1)*d,c=(i.h>>1)*h;t.setTransform(a,-l,l,a,e-i.x*d+n+32-$E._r.editX,r-i.y*h+c+32-$E._r.editY),t.drawImage(i[s],-n,-c,i.w*d,i.h*h),$E.dSmth(t),$E.resetTransform(t)}},$E.dSmth=t=>{t.imageSmoothingEnabled&&(t.imageSmoothingEnabled=!1)},$E.eSmth=t=>{t.imageSmoothingEnabled||(t.imageSmoothingEnabled=!0)},$E.Surface=class{constructor(t,i){this.ctx=t,$E.dSmth(t),this.cv=t.canvas,this.dep=i,this.w=this.cv.width,this.h=this.cv.height,this.L=0,this.T=0,this.R=this.w,this.B=this.h,this.tX=0,this.tY=0}dirty(t,i,s,e){t<this.L&&(this.L=t),i<this.T&&(this.T=i),t+s>this.R&&(this.R=t+s),i+e>this.B&&(this.B=i+e)}translate(t,i){this.tX=t,this.tY=i,this.ctx.setTransform(1,0,0,1,-t,-i)}clear(){this.ctx.clearRect(this.tX,this.tY,this.w,this.h)}updateRect(t,i,s,e){let r=$E._r.ly;this.ctx.save(),this.ctx.beginPath(),this.ctx.rect(t,i,s,e),this.ctx.clip();let d=$E.C.cRc;for(let h=0;h<r.length;h++)if(r[h].vis)for(let o=0;o<r[h].length;o++){let a=r[h][o];d(t,i,s,e,a.R[0],a.LT[1],a.w,a.h)&&a.draw(this.ctx)}this.ctx.restore(),this.L=Infinity,this.T=Infinity,this.R=-Infinity,this.B=-Infinity}redrawRect(t,i,s,e){this.ctx.clearRect(t,i,s,e),this.updateRect(t,i,s,e)}redraw(){this.redrawRect(this.tX,this.tY,this.w,this.h)}update(){let t=this.R-this.L,i=this.B-this.T;t<=0||i<=0||(this.ctx.clearRect(this.L,this.T,t,i),this.updateRect(this.L,this.T,t,i))}},$E.Layer=(t,i)=>{let s=[];return s.dep=t,s.sf=i,s.lock=!1,s.vis=!0,s.add=function(t){t.id=this.push(t)-1,this.vis&&this.sf.dirty(t.R[0],t.LT[1],t.w,t.h)},s.rm=function(t){this.vis&&this.sf.dirty(t.R[0],t.LT[1],t.w,t.h);let i=t.id;for(this.splice(i,1);i<this.length;i++)this[i].id--;$E._r.objNum--,t.tile&&$E.Object.dbTile(t.x,t.y,t.w,t.h,t.dep)},s},$E.resetTransform=t=>{let i=$E._r;t.setTransform(1,0,0,1,i?32-i.editX:32,i?32-i.editY:32)},$E.clrSf=t=>{let i=$E._r;t.clearRect(i?i.editX-32:-32,i?i.editY-32:-32,864,672)},$E.sfB=$("cv-bg").transferControlToOffscreen().getContext("2d"),$E.sfE=$("cv-edit").getContext("2d"),$E.sfG=$("cv-grid").getContext("2d"),$E.sfO=new $E.Surface($("cv-obj").transferControlToOffscreen().getContext("2d"),0),$E.grid={show:!1,fill:El("canvas"),bg32:El("canvas",0,{width:32,height:32}),init(){let t=this.bg32.getContext("2d");t.fillStyle="#60606090",t.fillRect(0,0,16,16),t.fillRect(16,16,16,16),t.fillStyle="#91919190",t.fillRect(0,16,16,16),t.fillRect(16,0,16,16),this.pat32=$E.sfG.createPattern(this.bg32,"repeat"),$E.sfG.strokeStyle="#ec0",this.al=App.gC("edit","gridOpacity"),this.set(32)},set(t){if(this.value=t,t<4)return;this.fill.width=this.fill.height=t;let i=this.fill.getContext("2d");i.clearRect(0,0,t,t),i.strokeStyle="#888",i.strokeRect(-1,-1,t+.5,t+.5),this.pat=$E.sfG.createPattern(this.fill,"repeat")},draw(){const t=$E.sfG;if(t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,864,672),!$E._r)return;let i=-$E._r.editX,s=-$E._r.editY,e=i+$E._r.w+32,r=s+$E._r.h+32;if(t.fillStyle=this.pat32,t.globalAlpha=1,i>-32&&t.fillRect(i,0,32,672),e<864&&t.fillRect(e,0,32,672),i+=32,i<0&&(i=0),e-=i,s>-32&&t.fillRect(i,s,e,32),r<672&&t.fillRect(i,r,e,32),this.show){t.setTransform(1,0,0,1,-$E._r.editX%32,-$E._r.editY%32),t.globalAlpha=this.al,this.value>=4&&(t.fillStyle=this.pat,t.fillRect(0,0,896,704));let i=32.5-($E._r.editX/32<<5),s=32.5-($E._r.editY/32<<5);for(;i<0;)i+=800;for(;s<0;)s+=608;t.beginPath(),t.moveTo(i,0),t.lineTo(i,704),t.moveTo(i+800,0),t.lineTo(i+800,704),t.moveTo(0,s),t.lineTo(896,s),t.moveTo(0,s+608),t.lineTo(896,s+608),t.stroke()}}},doc.fonts.ready.then(()=>{App.gC("run","smooth")||($("screen").style.imageRendering="pixelated"),$E.grid.init(),$E.sfE.canvas.style.opacity=.6,$E.dSmth($E.sfE),$E.dSmth($E.sfB),$E.dSmth($E.sfG),$E.sfE.L=Infinity,$E.sfE.T=Infinity,$E.sfE.R=-Infinity,$E.sfE.B=-Infinity,$E.sfE.dirty=$E.sfO.dirty}),$E.capture=(t=1,i=0)=>{let s=800*t,e=608*t,r=El("canvas",0,{width:s,height:e}),d=r.getContext("2d");d.drawImage($E.sfB.canvas,32,32,800,608,0,0,s,e),d.drawImage($E.sfO.cv,32,32,800,608,0,0,s,e);let h=r.toDataURL(),o=r.toDataURL("image/webp",1);return i&&(i<<=10,h.length>i&&o.length>i&&(o=r.toDataURL("image/webp",.9))),o.length<h.length?o:h};