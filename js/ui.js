const UI={bg:doc.body.ap(El("div","msg-bg",{n:0})),menu:doc.body.ap(El("div",0,{id:"menu"})),tip:doc.body.ap(El("div",0,{id:"mt"})),showMenu(){css(this.menu,{opacity:1,pointerEvents:"auto"}),this.menu.on=!0,$c("setcat",$("setting"))[0].click()},hideMenu(){css(this.menu,{opacity:0,pointerEvents:""}),css($("setting"),{opacity:0,transform:"",pointerEvents:""}),this.menu.on=!1},showTips(t,e,s){e&&(this.tip.style.transform=`translate(${e}px,${s}px)`),this.tip.tx(t).style.display="block"},bindCat(t){$c("setcat",t).for((e,s)=>{e.i=s,e.p=t,e.onclick=function(){css($c("setcat",this.p),{background:"",color:""},this.i,{background:"var(--bgl)",color:"var(--cs)"});let t=$c("setpage",this.p);css(t,{display:""},this.i,{display:"block"}),t[this.i].set(this.p.tab),this.p.tab=this}})},M:class{constructor(t,e,s="#0000"){css(UI.bg,{backgroundColor:s,opacity:1,pointerEvents:"auto"}),UI.menu.on||dac(UI.bg.ch,""),this.box=(UI.menu.on?UI.menu:UI.bg).ap(El("div","msg")),t&&(this.box.style.width=t+"px"),e&&(this.box.style.height=e+"px"),setTimeout(t=>{1&t.offsetWidth&&(t.style.width=t.offsetWidth-31+"px"),1&t.offsetHeight&&(t.style.height=t.offsetHeight-31+"px")},200,this.box),UI.bg.n++,this.r={}}t(...t){return t.for(t=>this.box.ap(El("p").tx(t))),this}b(...t){let e=this.box.ap(El("div","a-cen"));return t.for((t,s)=>{e.ap(El("div","btn").tx(t)).onclick=()=>{this.r.i=s,this.r.s=t,this.ok()}}),this}h(t){return this.box.ap(El("h1").tx(t)),this}a(t){return this.box.ap(El("div","msg-area",{innerHTML:t})),this}ip(t,e){let s=El("input");return s.value=t,e&&(s.type=e),this.box.ap(s).oninput=()=>this.r.v=s.value,this}cb(){return this.box.ap(El("div","msg-cb")).onclick=()=>this.close(),this}ap(t){return this.box.ap(t),this}then(t){this.fin=t}ok(){this.fin&&this.fin(this.r),this.close()}close(){if(css(this.box,{animation:"msg-close 0.4s forwards",animationPlayState:"running",pointerEvents:"none"}),--UI.bg.n||css(UI.bg,{opacity:0,pointerEvents:"none"}),setTimeout(this.des,500,this),this.box.pN!==UI.menu){let t=this.box.pS();t&&ac(t)}}des(t){t.box.remove()}},alert(t){return(new UI.M).t(t).b("确定")},confirm(t,e="确定",s="取消",i=1){return(new UI.M).t(t).b(i18n(e,i),i18n(s,i))},prompt(t,e=""){return(new UI.M).t(t).ip(e).b("确定","取消")},check(t,e="确定"){return(new UI.M).t(t).ip("").b(e)},ico(t){return`<svg><use href='#-${t}'></use></svg>`},p(t,e){let s=El("p",0,{innerHTML:i18n(t)});return e&&(s.style.margin=e),s},span(t,e,s){let i=El("span",0,{innerHTML:i18n(t)});return" "===t[t.length-1]&&(i.style.marginRight="16px"),e&&(i.style.color=e),s&&(i.style.fontSize=s+"px"),i},help(t,e){let s=El("span","help",{innerHTML:UI.ico("help")});return e&&(s.style.marginRight="16px"),s.h=t,s.onclick=function(t){t.stopPropagation(),App.help(this.h)},s},ipf:El("input",0,{type:"file"}),file(t,e){return new Promise((s,i)=>{UI.ipf.accept=t,UI.ipf._h(),UI.ipf.onchange=()=>{let t=new FileReader,n=UI.ipf.files[0].name;t["readAs"+e](UI.ipf.files[0]),t.onload=()=>s([t.result,n]),t.onerror=i},UI.ipf.value="",UI.ipf.click()})},on:t=>(t.on=e=>(t.f=e,t),t),S(t,e=!1,s=!1){let i=El("div").tx(t),n=El("div",e?"sw on":"sw");return s&&css(i,{display:"inline-block",marginRight:"12px"}),i.ap(n).onclick=t=>{i.v=!i.v,i.v?n.aC("on"):n.rC("on"),t&&i.f(i.v<<0,i)},i.set=t=>{!t!=!i.v&&n.onclick()},i.v=e,this.on(i)},B(t,e){let s=El("div",e?"btn s":"btn").tx(t);return s.set=t=>t?s.rC("gray"):s.aC("gray"),s.onclick=()=>{s.hC("gray")||s.f(s)},this.on(s)},B2(t){let e=El("div","btn2").tx(t);return e.onclick=()=>e.f(e),this.on(e)},C(...t){let e=El("div").tx(t[0]),s=e.ap(El("div","chs"));e.v=0,e.m=t[1],e.set=(i,n)=>{for(let n=2;n<t.length;n++)!(i&1<<n-2)!=!(e.v&1<<n-2)&&s.ch[n-2].onclick();n&&e.f(e.v,n)};for(let i=2;i<t.length;i++){let n=El("span").tx(t[i]);s.ap(n).onclick=t=>{if(!e.m&&e.v==1<<i-2)return;e.m?e.v^=1<<i-2:(e.v=1<<i-2,css(s.ch,{color:"",background:""}));let o=n.style.color;css(n,{color:o?"":"var(--cs)",background:o?"":"var(--bgl)"}),t&&e.f(e.v,t)}}return this.on(e)},option(t,e,s){let i=El("div","mb");return i._h(),i.hide=function(){this._h(),this.pN.hC("op")&&this.pN.pN.hide()},s.for((s,n)=>{let o=""===e?n:e+"."+(n+1),a=i.ap(El("div","op"));if(Array.isArray(s))if(a.tx(s[0]),a.aC("arr"),"function"==typeof s[1]){a.ap(El("div","mb")).hide=i.hide,a.f=s[1],a.j=o,a.p=t,a.onmouseover=function(e){if(e.target!==this)return;let s=this.ch[0],i=this.f();s.innerHTML="",i.for((e,i)=>{let n=e.split(":"),o=s.ap(El("div","op")).tx(n[0]);o.v=n[1]||this.j+"."+i,o.onclick=()=>{this.p.v=o.v,this.p.firstChild.tx(o.innerText),this.pN.hide(),this.p.f(t.v)}}),s._s()}}else a.ap(UI.option(t,o,s.slice(1))),a.onmouseover=function(t){t.target===this&&this.ch[0]._s()};else{let[e,n]=s.split(":");a.tx(e),a.v=n||o,a.onclick=()=>{t.v=a.v,t.firstChild.tx(a.innerText),i.hide(),t.f(t.v,a.innerText)}}}),i},O(...t){let e=El("div","sl"),s=UI.option(e,"",t);return s.onmouseleave=s.hide,e.ap(El("span")).tx("选择"),e.v=0,e.m=s,e.set=(t=0)=>{let i=Number(t),n=(s,i)=>{for(let o=0;o<s.length;o++){if(s[o].v==t)return void e.firstChild.tx(s[o].innerText);if(s[o].ch[0])if(s[o].f){let n=s[o].f();for(let s=0;s<n.length;s++){let[o,a]=n[s].split(":");if((a||i+"."+s)==t)return void e.firstChild.tx(o)}}else n(s[o].ch[0].ch,""===i?o:i+"."+o)}};e.v=isNaN(i)?t:i,n(s.ch,"")},e.onclick=()=>{if(s.style.display){let t=e.pN,i=0,n=0;for(;t!==doc.body&&!t.hC("setpage")&&!t.hC("page");)i+=t.offsetLeft,n+=t.offsetTop,t=t.pN;t.ap(s)._s(),css(s,{top:e.offsetTop+n+e.offsetHeight+"px",left:e.offsetLeft+i+"px"})}else s._h()},this.on(e)},I(t,e,s){let i=El("div","ip").tx(t),n=i.ap(El("input"));return s&&(n.style.width=s+"px"),i.set=t=>i.v="number"===n.type?Number(n.value=t):n.value=t,"~"!==t&&"×"!==t||(i.style.marginLeft="-5px",n.style.marginLeft="1px"),e&&(n.s=1,Object.assign(n,e),n.m||n.M?(n.type="number",n.step=.01,n.sf=n.s<.1?2:n.s<1?1:0,n.onmouseout=()=>UI.tip._h(),n.onchange=function(){let t=Number(this.value);isNaN(t)||(void 0!==this.m&&t<this.m&&(t=this.m),void 0!==this.M&&t>this.M&&(t=this.M),t=Math.round(t/this.s)*this.s,this.value=t.toFixed(this.sf))},n.onmouseover=function(){let{left:t,top:e}=this.getBoundingClientRect();UI.showTips(this.m.toFixed(this.sf)+"~"+this.M.toFixed(this.sf),t<<0,e-24<<0)}):n.l&&(n.oninput=function(){this.value.length>this.l&&(this.value=this.value.slice(0,this.l))}),i.v="number"===n.type?Number(n.value):n.value),n.addEventListener("change",()=>i.f(i.v="number"===n.type?Number(n.value):n.value)),this.on(i)},R(t,e,s,i){let n=El("div").tx(t),o=n.ap(El("div","rg")),a=o.ap(El("div","rgb")),l=n.ap(El("input")),r=n.ap(El("div","reset",{innerHTML:UI.ico("undo")}));return n.m=e,n.M=s,n.r=s-e,a.style.left=(i-e)/n.r*200+"px",n.d=i,n.v=i,l.value=i,a.onmousedown=t=>{a.d=!0,a.x=t.x-a.offsetLeft},r.onclick=()=>{n.v!=i&&(n.set(i),n.f(i))},o.onmouseleave=o.onmouseup=()=>{a.d&&(a.d=!1,n.f(n.v))},n.set=(t=n.d)=>{t=""===t?n.d:Number(t),l.value=n.v=t,a.style.left=(t-n.m)/n.r*200+"px"},o.onmousemove=t=>{a.d&&n.set(Math.round(Math.mM(t.x-a.x,0,200)/200*n.r+n.m))},l.onchange=()=>{let t=Number(l.value);isNaN(t)||(n.set(Math.round(Math.mM(t,n.m,n.M))),n.f(n.v))},this.on(n)},ipc:doc.body.ap(El("input",0,{id:"UIipc",type:"color"})),Col(t,e){let s=El("div","ip").tx(t),i=s.ap(El("div","col"));return i.style.background=e||"#fff",s.c=t=>{if("#"===t[0])return t;let e=t.match(/\d+/g);return((e[0]<<16)+(e[1]<<8)+(e[2]<<0)).toString(16).padStart(7,"#000000")},i.onclick=t=>{css(UI.ipc,{left:`${t.x}px`,top:`${t.y}px`}),UI.ipc.onchange=()=>{let t=UI.ipc.value;i.style.background=t,s.f(t)},UI.ipc.value=s.c(i.style.background),setTimeout(()=>UI.ipc.click(),1)},s.set=t=>i.style.background=t,this.on(s)},P(t,e,s,i){return new Promise((n,o)=>{UI.file("image/*","DataURL").then(a=>{let l=new Image;l.onload=()=>{if(l.width<t)return UI.alert(`${i18n("图片宽度不能小于")}${t}`),o();if(l.height<e)return UI.alert(`${i18n("图片高度不能小于")}${e}`),o();let a=l.width,r=l.height;for(;a>960||r>640;)a>>=1,r>>=1;let p=El("canvas","ab",{width:a,height:r}),c=El("canvas","ab",{width:t,height:e}),h=new UI.M(a+t+16,Math.max(r,e+100)+48).h(s).ap(p).ap(c).b("确定","取消");h.then(t=>{if(!t.i){let t,e=c.toDataURL("image/png");t=e.length>=10240?c.toDataURL("image/webp"):c.toDataURL("image/webp",1),n(t.length<e.length?t:e)}}),css(p,{left:"16px",top:"64px"}),css(c,{right:"16px",top:"64px"}),i&&(c.style.borderRadius="100%"),css(h.box.lastChild,{position:"absolute",left:a+16+"px",right:0,top:e+72+"px"});let u=p.getContext("2d"),d=c.getContext("2d");u.imageSmoothingQuality=d.imageSmoothingQuality="high",u.fillStyle="#000",u.fillRect(0,0,a,r),u.drawImage(l,0,0,a,r);let g=Math.min(a,r/e*t),f=Math.min(r,a/t*e),m=a-g>>1,v=r-f>>1,b=a-m-g,x=r-v-f,U=El("div","ab"),I=U.ap(El("div","ab"));h.ap(U),css(U,{left:"16px",top:"64px",width:a+"px",height:r+"px",overflow:"hidden"}),css(I,{left:m+"px",top:v+"px",right:b+"px",bottom:x+"px",border:"2px solid #fc0",outline:"960px solid #0007"}),I.L=m,I.T=v,I.R=b,I.B=x,I.mouse=function(t,e){let{left:s,top:i,right:n,bottom:o}=this.getBoundingClientRect(),a=t<s+16|(t>n-16)<<1|(e<i+16)<<2|(e>o-16)<<3,l="move";switch(a){case 5:case 10:l="nwse-resize";break;case 9:case 6:l="nesw-resize"}return this.style.cursor=l,a+1},I.draw=()=>d.drawImage(p,I.L,I.T,a-I.R-I.L,r-I.B-I.T,0,0,t,e),I.draw(),I.onmousedown=t=>I.drag=I.mouse(t.x,t.y),U.onmouseup=U.onmouseleave=()=>{I.drag=0,U.style.cursor="",I.draw()},U.onmousemove=s=>{if(I.drag&&1===s.buttons){let i=s.movementX,n=s.movementY,o=I.drag-1;switch(o){case 5:case 10:case 9:case 6:n=Math.abs(i)/t*e*(9===o||6===o?-Math.sign(i):Math.sign(i)),4&o?n<-I.T&&(n=-I.T):8&o&&n>I.B&&(n=I.B),i=Math.abs(n)/e*t*Math.sign(i),1&o?(i<-I.L&&(i=-I.L),I.L+=i):2&o&&(i>I.R&&(i=I.R),I.R-=i),a-I.R-I.L<t&&(1&o?I.L=a-I.R-t:I.R=a-I.L-t),4&o?I.T=r-I.B-(a-I.R-I.L)/t*e:I.B=r-I.T-(a-I.R-I.L)/t*e;break;default:i>I.R&&(i=I.R),i<-I.L&&(i=-I.L),n>I.B&&(n=I.B),n<-I.T&&(n=-I.T),I.L+=i,I.R-=i,I.T+=n,I.B-=n}css(I,{left:I.L+"px",top:I.T+"px",right:I.R+"px",bottom:I.B+"px"}),U.style.cursor=I.style.cursor}},I.onmousemove=function(t){this.drag||this.mouse(t.x,t.y)}},l.src=a[0]})})}},ROOT="https://cdn.jsdelivr.net/gh/vicklleall/ciw@"+$S.get("build")+"/",PNG="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA",WEBP="data:image/webp;base64,UklGR",CDU=t=>t.includes("data:")?"-"===t[0]?t.slice(1):t:"-"===t[0]?PNG+t.slice(1):WEBP+t,MDU=t=>"p"===t[11]?"-"+t.replace(PNG,""):t.replace(WEBP,""),App={platform:navigator.platform.includes("Win")?"win":navigator.platform.includes("Linux")?"linux":navigator.platform.includes("Mac")?"mac":null,dlupd(){if(!$S.sget("update"))return this.updfail();Promise.race([fetch(`${ROOT}app/version.json`,{cache:"no-store"}),new Promise((t,e)=>setTimeout(e,5e3,1))]).then(t=>{if(t.ok)return t.json();throw 0}).then(t=>{let e=$S.get("version").split(".");App.upd=0;for(let s in t){let i=t[s].split(".");for(let t=0;t<3;t++){let n=i[t]<<0,o=e[t]<<0;if(n<o)break;if(n>o){App.upd++,Ipc.dl(`${ROOT}app/${s}`,s,t=>{if(t){if(0==--App.upd){let t=$("l");t.className="",t.tx("下载更新完成，即将重启应用").style.width="auto",setTimeout(()=>console.log("update"),1e3)}}else App.upd>0&&(App.upd=-1,App.updfail())});break}}}}).catch(App.updfail)},updfail(){let t=$("l");t.className="",t.tx("自动更新失败").style.width="auto",UI.alert("自动更新失败，请前往官网下载更新").then(()=>window.open("https://ciw.vicklleall.com/"))},update(){UI.confirm("Cloud I Wanna 有新版本，是否立即更新？","是","否").then(t=>{t.i||LOC("update.html")})},config:{edit:{gridOpacity:.5,undoDepth:50},run:{fps:60}},getConf(t,e){return this.config[t][e]},setConf(t,e,s){this.config[t][e]=s,this.saveConf(t)},loadConf(t){try{return JSON.parse($S.get(t+"Conf"))}catch{return null}},saveConf(t){$S.set(t+"Conf",JSON.stringify(this.config[t]))},setDarkMode(t){let e=doc.body;e.className=t?"dark":"",$S.set("thm",e.className),console.log("bg:#"+(e.className?"23292f":"fff5c2")),$c("setpage")[1].set()},setFscr(){$S.sset("fscr",!$S.sget("fscr")),console.log("fscr"),$c("setpage")[1].set()},setWinSc(t){$S.sget("fscr")&&this.setFscr(),$S.set("sc",t),console.log("sc:"+t),$c("setpage")[1].set()},help(t){window.open(`?doc/${_lang}.html#${doc.body.className??""}#${i18n(t)??""}`)}};for(let t in App.config){let e=App.loadConf(t);e&&(App.config[t]=e)}{const t=UI.menu;for(let e=4;e--;)t.ap(El("div","menu"));UI.menu.ap(El("div"));let e=t.ch,s=$S.get("thm");s&&(doc.body.className=s),e[0].innerHTML=`${UI.ico("home")}<p>${i18n("返回主页")}</p>`,e[1].innerHTML=`${UI.ico("set")}<p>${i18n("应用设置")}</p>`,e[2].innerHTML=`${UI.ico("help")}<p>${i18n("帮助文档")}</p>`,e[3].innerHTML=`${UI.ico("exit")}<p>${i18n("退出应用")}</p>`,e[0].onclick=()=>location.search="home.html",e[1].onclick=()=>css($("setting"),{opacity:1,transform:"translate(-50%,-50%) scale(1.25)",pointerEvents:"auto"}),e[2].onclick=()=>App.help(),e[3].onclick=()=>console.log("close"),e[4].id="setting",e[4].innerHTML=`<h3>${UI.ico("set")} ${i18n("应用设置")}</h3>`,e[4].ap(El("div","msg-cb")).onclick=()=>css($("setting"),{opacity:0,transform:"",pointerEvents:""}),["常规","界面","游戏","制作"].for(t=>{e[4].ap(El("div","setcat").tx(t),El("div","setpage"))});let i=$c("setpage",e[4]);i[0].ap(UI.span("语言"),UI.O("中文:zh-cn","English:en-us").on(t=>{const e=t=>{$S.set("lang",t),UI.confirm("设置将在重启后生效，是否立即重启？").then(t=>{t.i||console.log("relaunch")})};if("zh-cn"===t)return e(t);Local.get("f",t+".json").then(s=>{try{JSON.parse(s.t),e(t)}catch{UI.alert("语言加载失败")}})}),El("br"),UI.span(i18n("已使用储存空间：")+"0 MB"),UI.help("应用相关",1),UI.B("清理缓存",1).on(t=>{t.set(),UI.confirm("应用将重启以完成缓存清理").then(e=>{e.i||Promise.allSettled(["cover","avatar","bgm"].map(CIW.clear)).then(()=>console.log("relaunch")),t.set(1)})}),El("br"),UI.span(i18n("当前版本：")+" "),UI.B("检查更新",1).on(t=>{t.set(),DB.Cloud.run("version",{v:$S.get("HASH")}).then(e=>{$S.get("version")===e?($S.sset("check",Date.now()),UI.alert("当前已经是最新版本")):($S.sset("update",e),App.update()),t.set(1)},e=>{t.set(1),9===e.code?($S.sset("update",e.message),App.update()):(UI.alert("检查更新失败"),console.error(e))})})),i[1].ap(UI.S(i18n("深色模式")+" (F3) ").on(App.setDarkMode),UI.S(i18n("全屏模式")+" (F4) ").on(App.setFscr),UI.C(i18n("窗口大小")+" (F5) ",0,"1440x810","1920x1080","2880x1620","1280x720").on(t=>App.setWinSc(8===t?.8889:4===t?2:2===t?1.3334:1))),i[2].ap(UI.C("游戏绘制帧率 ",0,60,30).on(t=>App.setConf("run","fps",2===t?30:60))),i[3].ap(UI.I("网格透明度 ",{m:.2,M:1,s:.1}).on(t=>App.setConf("edit","gridOpacity",t)),El("br"),UI.I("最大撤销次数 ",{m:0,M:500}).on(t=>App.setConf("edit","undoDepth",t))),i[0].set=function(){let t=this.ch;t[1].set(_lang),navigator.storage.estimate().then(e=>t[3].tx(i18n("已使用储存空间：")+(e.usage/1024/1024).toFixed(2)+" MB")),t[7].tx(i18n("当前版本：")+$S.get("version"))},i[1].set=function(){let t=this.ch,e=$S.get("sc");t[0].set(doc.body.className),t[1].set($S.sget("fscr")),t[2].set(.8889==e?8:2==e?4:1.3334==e?2:1)},i[2].set=function(){this.ch[0].set(30===App.getConf("run","fps")?2:1)},i[3].set=function(){let t=this.ch;t[0].set(App.getConf("edit","gridOpacity")),t[2].set(App.getConf("edit","undoDepth"))},UI.bindCat(e[4]),location.search.match(/login|home/)&&e[0]._h()}doc.addEventListener("keydown",t=>{if(!t.repeat)switch(t.keyCode){case 114:App.setDarkMode(!doc.body.className);break;case 115:App.setFscr();break;case 116:let t=[1.3334,2,.8889,1];App.setWinSc(t[(t.findIndex(t=>t==$S.get("sc"))+1)%4]);break;case 27:location.href.includes("update.html")||(UI.menu.on?UI.hideMenu:UI.showMenu)()}});const $U={Lv:[0,10,25,40,60,90,120,160,200,250,300,360,420,480,540,600,660,720,800,900,1e3],getLv(t){let e=this.Lv;for(let s=0;s<e.length;s++)if(t>=e[s]&&t<(e[s+1]??1/0))return[s,t-e[s],e[s+1]-e[s]||"??"]},getUsername(t,e){e||(e=El("div"));let s=t.get("w");return e.innerHTML=s?UI.ico("m-"+s.split(",")[0]):"",css(e.ap(El("span").tx(t.getUsername())),{userSelect:"text",marginLeft:(s?4:0)+"px"}),e},getUID(t){let e=El("div");return e.style.color="#789",e.ap(UI.span("UID:")),css(e.ap(UI.span(t)),{userSelect:"text",marginLeft:"4px"}),e},showUser(t){DB.Q(DB.User).select(["username","e","w","a","c"]).get(t).then(t=>{let e=El("div","rl"),s=e.ap(El("div","avatar")),i=e.ap(El("div","userInfo")),n=t.get("e"),o=t.get("a");s.style.cursor="auto",o&&CIW.fetch(o.id,"UserAvatar","avatar").then(t=>s.style.background=`url(${t.d})`),i.ap(this.getUsername(t),this.getUID(t.id),UI.span(`${i18n("等级 Lv.")}${this.getLv(n)[0]} `),UI.span(`${i18n("经验")} ${n} `),UI.span(`${i18n("通关数")} ${t.get("c")} `)),new UI.M(320).h("用户信息").ap(e).cb()})},pwDiag(t="",e="",s="",i=""){new UI.M(400).t("验证邮件已发送到您的邮箱，请注意查收").t("确认用户名：").ip(t).t("请输入新密码：").ip(e,"password").t("确认密码：").ip(s,"password").t("请输入邮件中的验证码：").ip(i).b("确定","取消").then(function(t){if(t.i)return;let e,s=$t("input",this.box),i=$c("btn",this.box)[0];25!==s[3].value.length&&(e="验证码长度错误"),s[1].value!==s[2].value&&(e="两次密码输入不一致"),(s[1].value.length<6||s[1].value.length>16)&&(e="密码应为6～16字符"),s[0].value.trim()||(e="请输入用户名");let n=s.map(t=>t.value);if(e)return UI.alert(e).then(()=>$U.pwDiag(...n));i.aC("gray");const o=t=>{let e=new URLSearchParams(new URL(t.responseURL).search),s=e.get("error");!s&&e.has("username")?(UI.alert("密码修改成功").then(()=>{location.href.includes("login.html")||LOC("login.html")}),this.close()):UI.alert(s.endsWith("invalid")?"用户名不匹配/验证码错误或已失效":"密码修改失败").then(()=>$U.pwDiag(...n)),i.rC("gray")};$M.xhr("POST","http://212.129.134.97:1337/apps/ciw-api/request_password_reset",0,`token=${encodeURIComponent(n[3])}&username=${encodeURIComponent(n[0])}&new_password=${encodeURIComponent(n[1])}`,"application/x-www-form-urlencoded").then(o,o)})},resetPw(t){DB.User.requestPasswordReset(t).then(()=>this.pwDiag(DB.User.current()?.getUsername()),t=>{switch(t.code){case 205:case 125:UI.alert("邮箱地址错误");break;default:UI.alert("请求发送失败")}})}};