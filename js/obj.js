Core.O=class{constructor(t,s){this.x=t,this.y=s,this.scx=1,this.scy=1,this.ang=0,this.ind=0,this.hspd=0,this.vspd=0,this.V=[0,0,0,0,0,0,0,0],this.B=[0,0,0,0],this.BV=[0,1,6,7],this.calc=!1,this.moved=!1,this._des=!1,this.colS=[],this.colO=[],this.test=0}set $x(t){t!==this.x&&(this.x=t,this.ctx.clr=!1,this.calc=!1,this.moved=!0)}set $y(t){t!==this.y&&(this.y=t,this.ctx.clr=!1,this.calc=!1,this.moved=!0)}set $scx(t){t!==this.scx&&(this.scx=t,this.w=t*this._w,1!==t&&(this.dSpr=this.ang?this.dSprEx:this.dSprSc),this.ctx.clr=!1,this.calc=!1,this.moved=!0)}set $scy(t){t!==this.scy&&(this.scy=t,this.h=t*this._h,1!==t&&(this.dSpr=this.ang?this.dSprEx:this.dSprSc),this.ctx.clr=!1,this.calc=!1,this.moved=!0)}set $ang(t){t!==this.ang&&(this.ang=t,this.dSpr=t?1===this.scx&&1===this.scy?this.dSprAng:this.dSprEx:1===this.scx&&1===this.scy?this.dSprN:this.dSprSc,this.ctx.clr=!1,this.calc=!1,this.moved=!0)}set $ago(t){this.angH=1&t?this.spr[0].w>>1:2&t?this.spr[0].w:0,this.angV=4&t?this.spr[0].h>>1:8&t?this.spr[0].h:0,this.ang&&(this.ctx.clr=!1,this.calc=!1,this.moved=!0)}get spd(){return(this.hspd**2+this.vspd**2)**.5}set spd(t){let s=this.spd;if(s){let i=t/s;this.hspd*=i,this.vspd*=i}else this.hspd=t,this.vspd=0}get dir(){let t=-Math.atan(this.vspd/this.hspd)/Math.DR;return this.hspd<0?t+180:t}set dir(t){let s=this.spd;s&&(t*=Math.DR,this.hspd=s*Math.cos(t),this.vspd=-s*Math.sin(t))}calcBox(){if(this.calc)return;this.calc=!0;let t=this.V,s=this.spr[0],i=this.x-s.boxL*this.scx,h=this.y-s.boxT*this.scy;if(0===this.ang)t[0]=i,t[1]=h,t[2]=t[0]+this.w,t[3]=t[1],t[4]=t[0],t[5]=t[1]+this.h,t[6]=t[2],t[7]=t[5];else{let e=this.ang*Math.DR,r=Math.cos(e),a=Math.sin(e),l=this.w*r,o=this.w*a,p=(this.angH-s.bL)*this.scx,c=(this.angV-s.bT)*this.scy;t[0]=i+p*(1-r)-c*a,t[1]=h+p*a+c*(1-r),t[2]=t[0]+l,t[3]=t[1]-o,t[4]=t[0]+this.h*a,t[5]=t[1]+this.h*r,t[6]=t[4]+l,t[7]=t[5]-o}let e=0,r=0,a=1,l=1;for(let s=0;s<8;s++)1&s?t[s]<t[a]?a=s:t[s]>t[l]&&(l=s):t[s]<t[e]?e=s:t[s]>t[r]&&(r=s);this.BV[0]=e,this.BV[1]=a,this.BV[2]=r,this.BV[3]=l,this.B[0]=t[e]+.5<<0,this.B[1]=t[a]+.5<<0,this.B[2]=t[r]+.5<<0,this.B[3]=t[l]+.5<<0}moveB(t,s){this.x+=t,this.y+=s;let i=this.V;for(let h=0;h<8;h++)i[h]+=1&h?s:t;this.B[0]=i[this.BV[0]]+.5<<0,this.B[1]=i[this.BV[1]]+.5<<0,this.B[2]=i[this.BV[2]]+.5<<0,this.B[3]=i[this.BV[3]]+.5<<0}#t(t,s,i,h,e,r=0,a=0){let l=e.spr[0],o=e.ang*Math.DR,p=Math.cos(o),c=Math.sin(o),n=e.scx,d=e.scy,m=e.angH*n,x=e.angV*d,g=-e.x-r+n*l.x-m+.5,u=-e.y-a+d*l.y-x+.5,y=l.mask[e.ind<<0],v=e._w,b=e._h,f=l.bL,B=l.bT;for(let e=s;e<h;e++)for(let s=t;s<i;s++){let t=(p*(s+g)-c*(e+u)+m)/n-f<<0;if(t<0||t>=v)continue;let i=(c*(s+g)+p*(e+u)+x)/d-B<<0;if(!(i<0||i>=b)&&y[i*v+t])return!0}}_meet(t,s,i,h,e,r,a){if(this.px||a.px){let l=Math.max(i,a.B[0]),o=Math.max(h,a.B[1]),p=Math.min(e,a.B[2]),c=Math.min(r,a.B[3]);if(this.px||this.ang%90!=0){if(a.px||a.ang%90!=0){let i=this.spr[0],h=this.ang*Math.DR,e=Math.cos(h),r=Math.sin(h),n=this.scx,d=this.scy,m=this.angH*n,x=this.angV*d,g=-this.x-t+n*i.x-m+.5,u=-this.y-s+d*i.y-x+.5,y=i.mask[this.ind<<0],v=this._w,b=this._h,f=i.bL,B=i.bT,R=1-this.px,S=a.spr[0],j=a.ang*Math.DR,M=Math.cos(j),w=Math.sin(j),k=a.scx,V=a.scy,O=a.angH*k,C=a.angV*V,L=-a.x+k*S.x-O+.5,_=-a.y+V*S.y-C+.5,D=S.mask[a.ind<<0],A=a._w,I=a._h,T=S.bL,P=S.bT,E=1-a.px;for(let t=o;t<c;t++)for(let s=l;s<p;s++){let i=(e*(s+g)-r*(t+u)+m)/n-f<<0;if(i<0||i>=v)continue;let h=(r*(s+g)+e*(t+u)+x)/d-B<<0;if(h<0||h>=b)continue;let a=(M*(s+L)-w*(t+_)+O)/k-T<<0;if(a<0||a>=A)continue;let l=(w*(s+L)+M*(t+_)+C)/V-P<<0;if(!(l<0||l>=I)&&(R|y[h*v+i])&(E|D[l*A+a]))return!0}return!1}return this.#t(l,o,p,c,this,t,s)}return this.#t(l,o,p,c,a)}if(this.ang%90||a.ang%90){let i=[],h=a.V;for(let h=0;h<8;)i[h]=this.V[h]+t,i[++h]=this.V[h++]+s;for(let t=0;t<2;t++){for(let t=2;t<6;t+=2){let s=i[t]-i[0],e=i[t+1]-i[1],r=s*(h[0]-i[0])+e*(h[1]-i[1]),a=r;for(let t=2;t<8;t+=2){let l=s*(h[t]-i[0])+e*(h[t+1]-i[1]);l<r?r=l:l>a&&(a=l)}if(a<=0||r>=s*s+e*e)return!1}h=i,i=a.V}return!0}return!0}meet(t,s,i){return this.calcBox(),$R.Col[i].meet(this,t,s,this.V[this.BV[0]]+t+.5<<0,this.V[this.BV[1]]+s+.5<<0,this.V[this.BV[2]]+t+.5<<0,this.V[this.BV[3]]+s+.5<<0)}meetAll(t,s,i){this.calcBox();let h=this.V[this.BV[0]]+t+.5<<0,e=this.V[this.BV[1]]+s+.5<<0,r=this.V[this.BV[2]]+t+.5<<0,a=this.V[this.BV[3]]+s+.5<<0,l=$R.Col[i].findAll(h,e,r,a),o=[];for(let i=l.length;i--;)l[i]!==this&&this._meet(t,s,h,e,r,a,l[i])&&o.push(l[i]);return o}meetO(t,s,i,h,e,r,a){return!!(e>a.B[0]&&r>a.B[1]&&i<a.B[2]&&h<a.B[3]&&this._meet(t,s,i,h,e,r,a))}meetObj(t,s,i){let h=this.V[this.BV[0]]+t+.5<<0,e=this.V[this.BV[1]]+s+.5<<0,r=this.V[this.BV[2]]+t+.5<<0,a=this.V[this.BV[3]]+s+.5<<0;for(let l=i.length;l--;)if(this.meetO(t,s,h,e,r,a,i[l]))return!0;return!1}colDir(t,s,i,h,e=0){let r=0,a=0,l=[...t];for(let t=l.length;t--;){let s=l[t];if(s.cm&&(this.updCol(s.obj+5,s),s.cm>1&&this.updCol(s.cm,s)),e&&(s.outInd===this.cm||s.outInd===this.obj+5)&&4!==s.test){l.splice(t,1);continue}let i=this.hsp-s.hsp,h=this.vsp-s.vsp;i<0?r=Math.min(r,i):i>0&&(r=Math.max(r,i)),h<0?a=Math.min(a,h):h>0&&(a=Math.max(a,h))}(r||a)&&l.length&&(e&&(r>0?r+=1:r<0&&(r-=1),a>0?a+=1:a<0&&(a-=1)),this.moveB(-r,-a),r&&this.meetObj(r,0,l)&&(r=s(r,l)),a&&this.meetObj(0,a,l)&&(a=i(a,l)),(r||a)&&this.meetObj(r,a,l)&&([r,a]=h(r,a)),(r||a)&&this.moveB(r,a))}updCol(t,s){let i=this;if(2===i.colS[t]){let h=i.colO[t];if(i.moved||h.moved){s||(s=i.meet(0,0,t));let e=i.obj+5,r=i.cm;s?s!==h&&(i.colO[t]=s,r&&(h.colS[e]=3,h.colO[e]=null,s.colO[e]=i,s.colS[e]&&3!==s.colS[e]||(s.colS[e]=1),r>1&&(h.colS[r]=3,h.colO[r]=null,s.colO[r]=i,s.colS[r]&&3!==s.colS[r]||(s.colS[r]=1)))):(i.colS[t]=3,i.colO[t]=null,r&&(h.colS[e]=3,h.colO[e]=null,r>1&&(h.colS[r]=3,h.colO[r]=null)))}}else if(!i.colS[t]){s||(s=i.meet(0,0,t));let h=i.obj+5,e=i.cm;s&&(i.colS[t]=1,i.colO[t]=s,e&&(s.colO[h]=i,s.colS[h]&&3!==s.colS[h]||(s.colS[h]=1),e>1&&(s.colO[e]=i,s.colS[e]&&3!==s.colS[e]||(s.colS[e]=1))))}return i.colS[t]}resetCol(){let t=this.colS;for(let s=t.length;s--;)1===t[s]?t[s]=2:3===t[s]&&(t[s]=0);this.test=0}dSprN(t,s,i){t.reset||t.resetC(),t.drawImage(s[i],this.x-s.x,this.y-s.y)}dSprSc(t,s,i){t.reset||t.resetC();let h=this.scx,e=this.scy;(h<1||e<1)&&(t.imageSmoothingEnabled=!0),t.drawImage(s[i],this.x-s.x*h,this.y-s.y*e,s.w*h,s.h*e),t.imageSmoothingEnabled&&(t.imageSmoothingEnabled=!1)}dSprAng(t,s,i){let h=this.ang*Math.DR,e=Math.cos(h),r=Math.sin(h),a=this.angH,l=this.angV;t.setTransform(e,-r,r,e,this.x-s.x+a-t.vX,this.y-s.y+l-t.vY),t.drawImage(s[i],-a,-l),t.reset=!1}dSprEx(t,s,i){let h=this.ang*Math.DR,e=Math.cos(h),r=Math.sin(h),a=this.scx,l=this.scy,o=this.angH,p=this.angV;(a<1||l<1)&&(t.imageSmoothingEnabled=!0),t.setTransform(e*a,-r*a,r*l,e*l,this.x+(o-s.x)*a-t.vX,this.y+(p-s.y)*l-t.vY),t.drawImage(s[i],-o,-p),t.imageSmoothingEnabled&&(t.imageSmoothingEnabled=!1),t.reset=!1}},Core.R=class extends Core.O{constructor(t,s,i,h,e){super(s,i),this.xp=s,this.yp=i,this.obj=t,this.dep=h,this.ly=$R.L[h],this.ctx=this.ly.sta,this.oid=this.ly.push(this),this.spr=e,this._w=this.spr[0].boxW,this._h=this.spr[0].boxH,this.al=1,this.hd=0,this.draw=this.dNormal,this.dSpr=this.dSprN,this.hsp=0,this.vsp=0,this.DEF=[],this.MOV=[],this.TML=[],this.tmlB=50,this.TRG=[[],[],[],[]],this.trgMap=[],this.VAR=[0,0,0,0],this.colP=[null,null],this.colId=[0,0],this.step0=this.timer=this.step1=this.move=this.step2=this.collision=this.resetStatus=this.#s,this.activate=10===t?this.actvGrp:this.actv,this.gscy=this.gscx=1,this.gag=0}init(t=!1){let s=!1,i=!1,h=!1;if(this.tile)switch(this.spr[0].length){case 1:this.tile=!1;break;case 2:this.tile=[(this.tb>7)<<0],this.draw=this.dTile;break;case 4:this.tile=[this.tc?0:(3==(3&this.tb))+((12==(12&this.tb))<<1)],this.draw=this.dTile;break;case 20:this.tile=[this.tb];for(let t=0;t<4;t++)this.tc&1<<t&&this.tile.push(16+t);this.draw=this.dTile}else this.spr[0].length>1&&(t=!0);if(this.mov&&this.mov.for(s=>{Lib.dmov[s[0]](this,s)&&(i=t=!0)}),this.tml&&(this.tml.for(h=>{let e=h[1];this.TML.push(e),e.run=h[0],e.time=0,e.node=0,e.for(h=>{Lib.dynAct.includes(h[0])&&(t=!0),Lib.colAct.includes(h[0])?i=!0:1.05===h[0]&&(s=!0),.02===h[0]&&(h.ct=0,0===h[2]&&(h[2]=Infinity)),h.f=h[0]===h[0]<<0?Lib.dmov[h[0]]:Lib.act[h[0]<<0][Math.round(100*h[0]%100-1)]})}),this.timer=this.#i),this.trg?.for(e=>{let r=[e[1]||Infinity,[1],e[2],e[3]],a=0;switch(this.TRG[e[0]].push(r),this.trgMap.push(r),r.ex=0,e[0]){case 0:this.step0=this.#h;break;case 1:this.step1=this.#e;break;case 2:this.step2=this.#r}e[2].for(t=>{2.01===t[0]&&(h=!0),t.f=Lib.trg[(t[0]<<0)-1][Math.round(100*t[0]%100-1)],t[1]?r[1][++a]=1:r[1][a]++}),e[3].for(h=>{Lib.dynAct.includes(h[0])&&(t=!0),Lib.colAct.includes(h[0])?i=!0:1.05===h[0]&&(s=!0),h.f=h[0]===h[0]<<0?Lib.dmov[h[0]]:Lib.act[h[0]<<0][Math.round(100*h[0]%100-1)]}),0==--r[1][r[1].length-1]&&r[1].splice(-1)}),this.def){let t=Lib.def[this.def];this.DEF.push(t[1].bind(this)),2===t[0]?i=!0:1===t[0]&&(s=!0)}if(10===this.obj)return this.draw=this.#s,this.move=this.#a,void(this.gpi||this.updGrp(1));switch(this.w=this.scx*this._w,this.obj){case 11:this.draw=this.dLaser,this._h=this.lso?this.len:0,this.h=this.scy*this._h,this.$ago=1;break;case 22:this.draw=this.dRope,this.h=this.scy*this.len,this.$ago=1;break;default:void 0===this.angH&&(this.$ago=5),this.h=this.scy*this._h}switch(this.calcBox(),(1===this.scx&&1===this.scy)<<1|!this.ang){case 0:this.dSpr=this.dSprEx;break;case 1:this.dSpr=this.dSprSc;break;case 2:this.dSpr=this.dSprAng}this.px=this.spr[0].px,this.spr[0].ims&&(this.DEF.push(Lib.def[0][1].bind(this)),s=!0),this.colMov=i,this.cm&&($R.Col[this.obj+5].add(this),this.cm>1&&$R.Col[this.cm].add(this),this.resetStatus=this.resetCol),h&&(this.resetStatus=this.resetCol),i?this.move=this.#l:s&&(this.move=this.#a),t&&(this.ctx=this.ly.dyn),this.moved=!1,this.al&&(this.ctx.clr=!1)}actv(t,s,i,h){(this.B[0]<i&&this.B[1]<h&&this.B[2]>t&&this.B[3]>s||11===this.dep)&&this.ly.add(this)}actvGrp(t,s,i,h){(this.B[0]<i&&this.B[1]<h&&this.B[2]>t&&this.B[3]>s||this.grpO.some(e=>e.B[0]<i&&e.B[1]<h&&e.B[2]>t&&e.B[3]>s||11===e.dep))&&(this.ly.add(this),this.grpO.for(e=>{e.B[0]<i&&e.B[1]<h&&e.B[2]>t&&e.B[3]>s||11===e.dep||e.ly.add(e)}))}destroy(){this._des=!0,this.ctx.clr=!1,this.cm&&(this.clearCol(0),this.clearCol(1)),10===this.obj&&this.grpO.for(t=>t.gpi="")}clearCol(t){let s=this.colP[t];if(s){let i=this.colId[t];for(s.splice(i,1);i<s.length;i++)s[i].colId[t]=i;let h=s?this.cm:this.obj+5;this.colO.for(t=>{t&&(t.colS[h]=3,t.colO[h]=null)})}}get sp(){return(this.hsp**2+this.vsp**2)**.5}get di(){let t=-Math.atan(this.vsp/this.hsp)/Math.DR;return this.hsp<0?t+180:t}outSld(){this.colDir(this.outObj,(t,s)=>{for(let i=Math.sign(t),h=Math.abs(t),e=0;e<h&&!this.meetObj(i,0,s);e++)this.moveB(i,0);return this.hspd=0},(t,s)=>{for(let i=Math.sign(t),h=Math.abs(t),e=0;e<h&&!this.meetObj(0,i,s);e++)this.moveB(0,i);return this.vspd=0},(t,s)=>(this.vspd=0,[t,Math.sign(s)]),1);let t=this.x-this.xp,s=this.y-this.yp;this.hsp+=t,this.vsp+=s,this.xp=this.x,this.yp=this.y,this.test=4,(t||s)&&(this.moved=!0,this.ctx.clr=!1,this.outObj=this.meetAll(0,0,this.outInd));for(let t=this.outObj.length;t--;){let s=this.outObj[t];(s.outInd===this.cm||s.outInd===this.obj+5)&&s.test<3&&(s.test||$R.outStk.push(s),s.outObj.includes(this)||s.outObj.push(this),s.test=2)}}out(){if(this.gpi)return;let t=0===this.outObj.length||this.moved;if(!t)for(let s=this.outObj.length;s--;)if(this.outObj[s].moved){t=!0;break}if(t&&(this.outObj=this.meetAll(0,0,this.outInd),this.outObj.length)){this.test=1;for(let t=this.outObj.length;t--;){let s=this.outObj[t];if(s.outInd!==this.cm&&s.outInd!==this.obj+5)return this.test=3,void $R.outStk.unshift(this)}$R.outStk.push(this)}}bounce(){if(this.gpi)return;let t=0===this.outObj.length||this.moved;if(!t)for(let s=this.outObj.length;s--;)if(this.outObj[s].moved){t=!0;break}if(t&&(this.outObj=this.meetAll(0,0,this.outInd),this.outObj.length)){this.colDir(this.outObj,t=>(this.hspd=-t,0),t=>(this.vspd=-t,0),(t,s)=>(t&&(this.hspd=-t),s&&(this.vspd=-s),[0,0]));let t=this.x-this.xp,s=this.y-this.yp;(t||s)&&(this.moved=!0,this.ctx.clr=!1),this.hsp+=t,this.vsp+=s,this.xp=this.x,this.yp=this.y}}updGrp(t=0){for(let s=this.grpO.length;s--;){let i=this.grpO[s];if(i._des){this.grpO.splice(s,1);continue}let h=this._gp[i._gn];if(this.csc&&(i.scx/=i.gscx,i.gscx=this.scx,i.$scx=i.scx*i.gscx,i.scy/=i.gscy,i.gscy=this.scy,i.$scy=i.scy*i.gscy),this.cag){if(i.ang-=i.gag,10!==i.obj&&this.ang){let t=i.spr[0].x,s=i.spr[0].y;if(i.angH!==t||i.angV!==s){let h=(i.angH-t)*i.scx,e=(i.angV-s)*i.scy,r=-this.ang*Math.DR,a=Math.cos(r),l=Math.sin(r);i.grpX=(h-a*h-l*e)/this.scx,i.grpY=(e+l*h-a*e)/this.scy}}i.gag=this.ang,i.$ang=i.ang+i.gag}let e=(h.x+i.grpX)*this.scx,r=(h.y+i.grpY)*this.scy;if(this.ang){let t=this.ang*Math.DR,s=Math.cos(t),i=Math.sin(t),h=-e*i+r*s;e=e*s+r*i,r=h}i.$x=this.x+e,i.$y=this.y+r,i.hsp=i.x-i.xp,i.vsp=i.y-i.yp,i.xp=i.x,i.yp=i.y,10===i.obj&&i.updGrp(t)}}#s(){}trigger(t){if(t[0]&&!t.ex){t.ex=1;let s=0;for(let i=0;i<t[1].length;++i){let h=t[1][i],e=1;for(let i=0;i<h;i++){let h=t[2][s+i];if(!h.f(this,h)){e=0;break}}if(e){--t[0],t[3].for(t=>t.f(this,t));break}s+=h}t.ex=0}}#i(){this.TML.for(t=>{if(t.run){for(;t.run&&0===t.time;){let s=t[t.node++];if(!s){t.run=0,t.time=0,t.node=0;break}s.f(this,s,t)}t.run&&t.time>0&&t.time--}})}#a(){for(let t=this.MOV.length;t--;)this.MOV[t]&&this.MOV[t](this)&&(this.MOV[t]=null);this.DEF.for(t=>t())}#l(){this.moved=!1,this.#a(),this.hsp=this.x-this.xp,this.vsp=this.y-this.yp,this.xp=this.x,this.yp=this.y}#h(){this.TRG[0].for(t=>this.trigger(t))}#e(){this.TRG[1].for(t=>this.trigger(t))}#r(){this.TRG[2].for(t=>this.trigger(t))}dNormal(){this.hd||0===this.al||(this.al<1&&(this.ctx.globalAlpha=this.al),this.spr.for(t=>this.dSpr(this.ctx,t,this.ind<<0)),this.al<1&&(this.ctx.globalAlpha=1))}dTile(){if(!this.hd&&0!==this.al){this.al<1&&(this.ctx.globalAlpha=this.al),this.tile.for(t=>this.dSpr(this.ctx,this.spr[0],t));for(let t=1;t<this.spr.length;t++)this.dSpr(this.ctx,this.spr[t],this.ind<<0);this.al<1&&(this.ctx.globalAlpha=1)}}dRope(){if(this.hd||0===this.al)return;this.al<1&&(this.ctx.globalAlpha=this.al),this.ctx.reset||this.ctx.resetC();let t=this.spr[0];if(this.ctx.translate(this.x,this.y),this.ang&&this.ctx.rotate(-this.ang*Math.DR),this.ctx.scale(this.scx,this.scy),this.len<t.h)this.ctx.drawImage(t[1],0,t.h-this.len,t.w,this.len,-t.x,0,t.w,this.len);else{let s=this.len-t.h;for(this.ctx.drawImage(t[1],-t.x,s);s>0;s-=32)s>=32?this.ctx.drawImage(t[0],0,0,t.w,32,-t.x,s-32,t.w,32):this.ctx.drawImage(t[0],0,32-s,t.w,s,-t.x,0,t.w,s)}this.ctx.reset=!1,this.al<1&&(this.ctx.globalAlpha=1)}dLaser(){if(this.hd&&!this.lso||0===this.al)return;this.al<1&&(this.ctx.globalAlpha=this.al),this.ctx.reset||this.ctx.resetC();let t=this.spr[0];this.ctx.translate(this.x,this.y),this.ang&&this.ctx.rotate(-this.ang*Math.DR),this.ctx.scale(this.scx,this.scy),this.lso&&this.ctx.drawImage(t[1],-t.x,0,t.w,this.h/this.scy),this.hd||this.ctx.drawImage(t[0],-t.x,0),this.ctx.reset=!1,this.al<1&&(this.ctx.globalAlpha=1)}},Core.Y=class extends Core.O{#o;constructor(t,s){super(t,s),$R.plyX=t,$R.plyY=s,this.#o=1,this.pSpr=this.spr=Res.spr.pli,this.ims=.2,this.px=0,this.ctx=$R.L[7].dyn,++this.ctx.n,this.ox=17,this.oy=23,this.moveSpd=3,this.maxVspd=9,this.jump1=-8.5,this.jump2=-7,this.grav=.4,this.fric=.5,this.ahspd=0,this.phspd=0,this.pvspd=0,this.onPlat=!1,this.onLadder=!1,this.onRope=null,this.meetRope=null,this.shoot=0,this.frozen=!1,$R.initPly(this),this.djump=this.jump,this.resetStatus=this.resetCol,this.clacLTRB(),this.calcBox()}calcBox(){this.V[0]=this.V[4]=this.B[0]=this.x+this._L,this.V[1]=this.V[3]=this.B[1]=this.y+this._T,this.V[2]=this.V[6]=this.B[2]=this.x+this._R,this.V[5]=this.V[7]=this.B[3]=this.y+this._B}clacLTRB(){switch(this.g_){case 270:this._T=-12*this.scy,this._B=9*this.scy,this._L=-5*this.#o,this._R=6*this.#o;break;case 90:this._T=-9*this.scy,this._B=12*this.scy,this._L=-5*this.#o,this._R=6*this.#o;break;case 0:this._T=-6*this.#o,this._B=5*this.#o,this._L=-12*this.scy,this._R=9*this.scy;break;case 180:this._T=-5*this.#o,this._B=6*this.#o,this._L=-9*this.scy,this._R=12*this.scy}}setGrav(t){if(t!==this.g_){if(this.vspd=0,this.ahspd=0,t%180==this.g_%180)switch(t){case 270:this.y+=4;break;case 90:this.y-=4;break;case 0:this.x+=4;break;case 180:this.x-=4}this.g_=t,this.ang=(t+90)%360,this.clacLTRB(),this.calcBox()}}meet(t,s,i){let h,e;switch(this.g_){case 270:h=t,e=s;break;case 90:h=t,e=-s;break;case 0:h=s,e=-t;break;case 180:h=-s,e=t}return $R.Col[i].meet(this,h,e,this.B[0]+h+.5<<0,this.B[1]+e+.5<<0,this.B[2]+h+.5<<0,this.B[3]+e+.5<<0)}meetObj(t,s,i){let h,e;switch(this.g_){case 270:h=t,e=s;break;case 90:h=t,e=-s;break;case 0:h=s,e=-t;break;case 180:h=-s,e=t}let r=this.B[0]+h+.5<<0,a=this.B[1]+e+.5<<0,l=this.B[2]+h+.5<<0,o=this.B[3]+e+.5<<0;for(let t=i.length;t--;)if(this.meetO(h,e,r,a,l,o,i[t]))return!0;return!1}meet0(t){return $R.Col[t].meet(this,0,0,this.B[0]+.5<<0,this.B[1]+.5<<0,this.B[2]+.5<<0,this.B[3]+.5<<0)}meet0All(t){let s=this.B[0]+.5<<0,i=this.B[1]+.5<<0,h=this.B[2]+.5<<0,e=this.B[3]+.5<<0,r=$R.Col[t].findAll(s,i,h,e),a=[];for(let t=r.length;t--;)this._meet(0,0,s,i,h,e,r[t])&&a.push(r[t]);return a}com(){if(0===this.shoot&&($C.P("z")||this.conShoot&&$C.C("z"))&&(Au.play("st"),this.shoot=5,new Core.B(this.x,this.y,this.scx,this.g_)),this.shoot&&this.shoot--,this.hspd&&this.g_%180){let t=this.meet(this.hspd,0,24);if(t&&0===t.vspd){let s=Math.sign(this.hspd);t.meet(s,0,2)||(t.hspd=t.meet(2*s,0,2)?s:2*s)}}}step(){if(this.frozen)return;this.calcBox(),this.grav=this.meet0(36)?.7:this.meet0(35)?.2:this._grav,this.moveSpd=this.meet0(38)?1:this.meet0(37)?6:this._moveSpd;let t=$C.C("R")||-$C.C("L");if(this.meet0(26)){let s=$C.C("D")||-$C.C("U");if(s&&(this.onLadder=!0),this.onLadder){if(this.spr=Res.spr.plb,this.ims=.2,this.djump=this.jump,t&&(this.scx=this.#o*t),this.hspd=this.moveSpd*t,this.vspd=this.moveSpd*s,this.grav=0,!$C.P("J"))return this.com();this.onLadder=!1,this.grav=.4,this.vspd=0}}else this.onLadder&&(this.onLadder=!1,this.grav=.4,this.vspd=0);let s=this.meet0(27);if(s){if(!this.onRope&&this.meetRope!==s){let t=((this.x-s.x)**2+(this.y-s.y)**2)**.5<<0;t>=0&&t<=s.h&&(this.onRope=s,this.meetRope=s,this.onRopeLen=t)}if(this.onRope){this.spr=Res.spr.plb,this.ims=.2,this.djump=this.jump,t&&(this.scx=this.#o*t),this.grav=0,this.vspd=0;let s=$C.C("D")||-$C.C("U"),i=this.onRope.ang*Math.DR,h=Math.sin(i),e=Math.cos(i);if(this.onRopeLen+=this.moveSpd*s,this.platMove(this.onRope.x+this.onRopeLen*h-this.x,this.onRope.y+this.onRopeLen*e-this.y),!($C.P("J")||this.onRopeLen<0||this.onRopeLen>this.onRope.h))return this.com();this.onRope=null,this.grav=.4,this.phspd=0,this.pvspd=0}}else this.meetRope=null,this.onRope&&(this.onRope=null,this.grav=.4,this.phspd=0,this.pvspd=0);let i=this.meet(0,1,2),h=0;if(!i){let t=this.meet(-1,0,19)||this.meet(1,0,19);if(t){let s=(t.ang-this.g_+270)%360;h=0===s?-1:180===s?1:0,h&&90===this.g_&&(h=-h)}}t?h&&t!==h||(this.scx=this.#o*t,this.hspd=this.moveSpd*t,this.spr=Res.spr.plr,this.ims=.5):(this.hspd=0,this.spr=Res.spr.pli,this.ims=.2),this.adMove&&i&&($C.P("a")&&(this.hspd-=1),$C.P("d")&&(this.hspd+=1));let e=this.meet(0,1,56);e?this.hspd+=e.csp:(e=this.meet(0,1,25),e&&(this.hspd-=e.csp)),this.onPlat?this.meet(0,4,3)||(this.onPlat=!1):i||(this.spr=this.vspd<0?Res.spr.plj:Res.spr.plf,this.ims=.2);let r=this.meet0(5);r&&(this.vspd>2&&(this.vspd=2),49===r.obj&&(this.djump=this.jump)),this.vspd>this.maxVspd&&(this.vspd=this.maxVspd),this.com(),this.jump&&$C.P("J")&&(i||this.onPlat||this.meet(0,1,3)||r&&16===r.obj?(this.vspd=this.jump1,this.djump=this.jump,this.spr=Res.spr.plj,this.ims=.2,Au.play("jp")):(this.djump>1||r&&17!==r.obj||-1===this.djump)&&(this.vspd=this.jump2,this.djump>1&&this.djump--,this.spr=Res.spr.plj,this.ims=.2,Au.play("jp",2))),this.vspd<0&&$C.R("J")&&(this.vspd*=.45),h&&(this.vspd=2,this.spr=Res.spr.plt,this.ims=.5,this.scx=this.#o*h,($C.P("R")&&1===h||$C.P("L")&&-1===h)&&(this.ims=.2,$C.C("J")?(this.spr=Res.spr.plj,this.vspd=-9,this.hspd=15*h,Au.play("wj")):(this.spr=Res.spr.plf,this.hspd=3*h)))}p2o(t,s){switch(this.g_){case 270:return[t,s];case 90:return[t,-s];case 0:return[s,-t];case 180:return[-s,t]}}platMove(t,s){switch(this.g_){case 270:this.phspd=t,this.pvspd=s;break;case 90:this.phspd=t,this.pvspd=-s;break;case 0:this.phspd=-s,this.pvspd=t;break;case 180:this.phspd=s,this.pvspd=-t}}applyMove(t,s){switch(this.g_){case 270:this.ahspd=t,this.vspd=s;break;case 90:this.ahspd=t,this.vspd=-s;break;case 0:this.ahspd=-s,this.vspd=t;break;case 180:this.ahspd=s,this.vspd=-t}}moveBy(t,s){switch(this.g_){case 270:this.x+=t,this.y+=s;break;case 90:this.x+=t,this.y-=s;break;case 0:this.y-=t,this.x+=s;break;case 180:this.y+=t,this.x-=s}}moveByB(t,s){this.moveBy(t,s),this.calcBox()}move(){if(this.frozen)return;let t=this.ind<<0;this.ind+=this.ims,this.ind>=this.spr.length&&(this.ind=0);let s=this.ind<<0!==t,i=this.B[0]+.5<<0,h=this.B[1]+.5<<0,e=this.B[2]+.5<<0,r=this.B[3]+.5<<0,a=this.meet(0,2,3);a&&(a.hsp||a.vsp)&&this.platMove(a.hsp,a.vsp),this.ahspd>0?(this.ahspd-=this.fric,this.ahspd<0&&(this.ahspd=0)):this.ahspd<0&&(this.ahspd+=this.fric,this.ahspd>0&&(this.ahspd=0)),this.hspd+=this.ahspd,this.vspd+=this.grav,this.moveBy(this.hspd+this.phspd,this.vspd+this.pvspd),this.calcBox();let l=this.meet0All(2);if(l.length){1!==this.colS[2]&&2!==this.colS[2]&&(this.colS[2]=1,this.colO[2]=l[0]),l.for(t=>{1!==t.colS[0]&&2!==t.colS[0]&&(t.colS[0]=1,t.colO[0]=this)});let t=0,s=0,i=0,h=0,e=0,r=0,[a,o]=this.p2o(this.hspd+this.phspd,this.vspd+this.pvspd);switch(l.for(e=>{let r=a-e.hsp,l=o-e.vsp;r<0?i=Math.min(i,r):r>0&&(t=Math.max(t,r)),l<0?h=Math.min(h,l):l>0&&(s=Math.max(s,l))}),this.g_){case 270:break;case 90:o=-o,[s,h]=[-h,-s];break;case 0:[a,o,t,s,i,h]=[-o,a,-h,t,-s,i];break;case 180:[a,o,t,s,i,h]=[o,-a,s,-i,h,-t]}if(t&&t!==a&&(t+=1,e=1),s&&s!==o&&(s+=1),i&&(i!==a&&(i-=1,r=-1),t||(t=i,i=0,e=r,r=0)),h&&(h!==o&&(h-=1),s||(s=h,h=0)),!t&&!s||this.meetObj(-t,-s,l)?!t&&!h||this.meetObj(-t,-h,l)?!i&&!s||this.meetObj(-i,-s,l)?!i&&!h||this.meetObj(-i,-h,l)?!a&&!o||this.meetObj(-a,-o,l)?(t=0,s=0):(t=a,s=o,e=0,this.moveByB(-a,-o)):(t=i,e=r,s=h,this.moveByB(-t,-s)):(t=i,e=r,this.moveByB(-t,-s)):(s=h,this.moveByB(-t,-s)):this.moveByB(-t,-s),t&&this.meet(t,0,2)){for(let s=Math.sign(t),i=Math.abs(t),h=0;h<i&&!this.meet(s,0,2);h++)this.moveByB(s,0);this.ahspd=this.hspd=t=0}if(s&&this.meet(0,s,2)){for(let t=Math.sign(s),i=Math.abs(s),h=0;h<i&&!this.meet(0,t,2);h++)this.moveByB(0,t);s>0?(this.djump=this.jump,this.vspd=0):this.vspd=o-s>0?o-s:0,s=0}(t||s)&&this.meet(t,s,2)&&(this.ahspd=this.hspd=0,t=e),(t||s)&&this.moveByB(t,s)}this.phspd=0,this.pvspd=0,a=this.meet0All(3);for(let t=a.length;t--;){let s=a[t];if(s.ang%180==(this.g_+90)%180)switch(this.g_){case 270:{let t=s.B[1];if(this.y-this.vspd/2<=t&&!this.meet(0,t-9-this.y,2)){let i=s.vspd>0?s.vspd:0;this.moveByB(0,t-9-this.y),this.vspd=i,this.onPlat=!0,this.djump=this.jump}break}case 90:{let t=s.B[3];if(this.y+this.vspd/2>=t&&!this.meet(0,this.y-t-9,2)){let i=s.vspd<0?-s.vspd:0;this.moveByB(0,this.y-t-9),this.vspd=i,this.onPlat=!0,this.djump=this.jump}break}case 0:{let t=s.B[0];if(this.x-this.vspd/2<=t&&!this.meet(0,t-9-this.x,2)){let i=s.hspd>0?s.hspd:0;this.moveByB(0,t-9-this.x),this.vspd=i,this.onPlat=!0,this.djump=this.jump}break}case 180:{let t=s.B[2];if(this.x+this.vspd/2>=t&&!this.meet(0,this.x-t-9,2)){let i=s.hspd<0?-s.hspd:0;this.moveByB(0,this.x-t-9),this.vspd=i,this.onPlat=!0,this.djump=this.jump}break}}}let o=$R._r;switch(o.out){case 4:case 8:if(this.x<0?this.x+=o.w:this.x>=o.w&&(this.x-=o.w),8===o.out){if(this.y<0||this.y>=o.h)return this.kill(!0);break}case 16:if(this.y<0?this.y+=o.h:this.y>=o.h&&(this.y-=o.h),4===o.out)break;if(this.x<0||this.x>=o.w)return this.kill(!0);break;default:if(this.x<0||this.y<0||this.x>=o.w||this.y>=o.h)return this.kill(!0)}if(this.moved=i!==this.B[0]+.5<<0||h!==this.B[1]+.5<<0||e!==this.B[2]+.5<<0||r!==this.B[3]+.5<<0,this.meet0(2))return this.kill(!0);if(this.meet0(4)&&this.kill())return;switch($R.plyX=this.x,$R.plyY=this.y,$R.saveMode){case 0:if(!$C.P("s"))break;case 2:let t=this.meet0(7);!t||0!==t.ind||0!==$R.saveMode&&$R.saveX===this.x&&$R.saveY===this.y||(t.ind=1.78125,t.ctx.clr=!1,$R.save())}let p=this.meet0(6);p&&(0===p.wr&&1===p.ws?(p.wx||p.wy?(this.x=p.wx,this.y=p.wy):(o.x||o.y)&&(this.x=o.x,this.y=o.y),this.calcBox(),this.moved=!0):$R.warp(p.wr,p.ws,p.wx,p.wy)),this.spr!==this.pSpr&&(s=!0,this.pSpr=this.spr),(this.moved||s)&&(this.ctx.clr=!1)}kill(t=!1){if(!t&&$R.god)return;this.colO.for(t=>{t&&(t.colS[0]=3,t.colO[0]=null)}),Au.play("dth");let s=new Core.R(0,400,304,11,$R._r.sprGO);return Object.assign(s,$R._r.bobj.gov),s.cm=0,s.init(!0),s.ly.add(s),$R.addDth(),$R.$=null,this.ctx.clr=!1,--this.ctx.n,!0}draw(){let t=this.ctx;switch(this.g_){case 270:t.setTransform(this.scx,0,0,this.scy,this.x-t.vX,this.y-t.vY);break;case 90:t.setTransform(this.scx,0,0,-this.scy,this.x-t.vX,this.y-t.vY);break;case 0:t.setTransform(0,-this.scx,this.scy,0,this.x-t.vX,this.y-t.vY);break;case 180:t.setTransform(0,this.scx,-this.scy,0,this.x-t.vX,this.y-t.vY)}$R.god&&(t.globalAlpha=.7),t.drawImage(this.spr[this.ind<<0],-this.ox,-this.oy),t.globalAlpha<1&&(t.globalAlpha=1),t.reset=!1}},Core.B=class extends Core.O{constructor(t,s,i,h){super(t+.5<<0,s+.5<<0),this.des=40,this.spr=Res.spr.blt,this.ctx=$R.L[7].dyn,++this.ctx.n,this.scx=i<0?-i:i,this.scy=this.scx,this.w=this.scx*this.spr.w+.5<<0,this.h=this.scy*this.spr.h+.5<<0;let e=this.w>>1,r=this.h>>1;switch(this.B=[t-e,s-r,t-e+this.w,s-r+this.h],$R.Col[1].obj.push(this),this.moved=!0,h){case 270:case 90:this.hspd=16*i<<0;break;case 0:this.vspd=16*-i<<0;break;case 180:this.vspd=16*i<<0}}meet(t){return $R.Col[t].meet(this,0,0,this.B[0],this.B[1],this.B[2],this.B[3])}destroy(){this.des=0,--this.ctx.n}step(){(this.meet(2)||this.meet(55)||this.meet(42))&&this.destroy()}move(){if(this.des>0&&$R.$&&1===$R.saveMode){let t=this.meet(7);t&&0===t.ind&&(t.ind=1.78125,t.ctx.clr=!1,$R.save(),this.destroy())}this.B[0]+=this.hspd,this.B[1]+=this.vspd,this.B[2]+=this.hspd,this.B[3]+=this.vspd,this.V[0]=this.V[4]=this.B[0],this.V[1]=this.V[3]=this.B[1],this.V[2]=this.V[6]=this.B[2],this.V[5]=this.V[7]=this.B[3],--this.des,this.ind=1-this.ind,this.ctx.clr=!1}draw(){this.ctx.reset||this.ctx.resetC(),this.ctx.drawImage(this.spr[this.ind],this.B[0],this.B[1],this.w,this.h)}},Core.P=class{constructor(t,s,i,h=7){this.x=t,this.y=s,this.spr=i,this.ind=0,this.w=i.w,this.h=i.h,this.angH=this.w>>1,this.angV=this.h>>1,this.ctx=$R.L[h].dyn,this._des=!1,$R.L[h].eff(this),this.al=1,this.scx=1,this.scy=1,this.ang=0,this.aspd=.1,this.xspd=0,this.yspd=0,this.hspd=0,this.vspd=0,this.grav=0,this.rot=0,this.dSpr=this.dSprN}init(){let t=1!==this.scx||1!==this.scy||this.xspd||this.yspd;this.ang||this.rot?this.dSpr=t?this.dSprEx:this.dSprAng:t&&(this.dSpr=this.dSprSc)}dSprN(t,s,i){t.reset||t.resetC(),t.drawImage(s[i],this.x-this.angH,this.y-this.angV)}dSprSc(t,s,i){let h=this.scx,e=this.scy;t.reset||t.resetC(),(Math.abs(h)<1||Math.abs(e)<1)&&(t.imageSmoothingEnabled=!0),t.drawImage(s[i],this.x-this.angH*h,this.y-this.angV*e,this.w*h,this.h*e),t.imageSmoothingEnabled&&(t.imageSmoothingEnabled=!1)}dSprAng(t,s,i){let h=this.ang*Math.DR,e=Math.cos(h),r=Math.sin(h);t.setTransform(e,-r,r,e,this.x-t.vX,this.y-t.vY),t.drawImage(s[i],-this.angH,-this.angV),t.reset=!1}dSprEx(t,s,i){let h=this.ang*Math.DR,e=Math.cos(h),r=Math.sin(h),a=this.scx,l=this.scy;(Math.abs(a)<1||Math.abs(l)<1)&&(t.imageSmoothingEnabled=!0),t.setTransform(e*a,-r*a,r*l,e*l,this.x-t.vX,this.y-t.vY),t.drawImage(s[i],-this.angH,-this.angV),t.imageSmoothingEnabled&&(t.imageSmoothingEnabled=!1),t.reset=!1}move(){this.vspd+=this.grav,this.x+=this.hspd,this.y+=this.vspd,this.al-=this.aspd,this.scx+=this.xspd,this.scy+=this.yspd,this.ang+=this.rot,(this.al<=0||this.scx<=0||this.scy<=0)&&(this._des=!0)}draw(){this.al<1&&(this.ctx.globalAlpha=this.al),this.dSpr(this.ctx,this.spr,this.ind),this.al<1&&(this.ctx.globalAlpha=1)}},Core.S=class extends Core.P{constructor(t,s,i,h=7){super(t,s,i[0],h),this.spr=i,this.draw=Core.O.prototype.dNormal}static from(t){if(0===t.al||11!==t.obj&&t.hd||11===t.obj&&t.hd&&!t.lso)return;let s=new Core.S(0,0,t.spr);if(s.ind=t.ind<<0,s.scx=t.scx,s.scy=t.scy,s.ang=t.ang,s.draw=t.draw,t.ang){let i=t.scx,h=t.scy,e=t.x+(t.angH-t.spr[0].x)*i,r=t.y+(t.angV-t.spr[0].y)*h,a=t.ang*Math.DR,l=Math.cos(a),o=Math.sin(a),p=i*(s.angH-t.angH),c=h*(s.angV-t.angV);s.x=e+l*p+o*c,s.y=r-o*p+l*c}else s.x=t.x+(s.angH-t.spr[0].x)*t.scx,s.y=t.y+(s.angV-t.spr[0].y)*t.scy;return t.tile?s.tile=t.tile:11===t.obj?(s.lso=t.lso,s.h=t.h):22===t.obj&&(s.len=t.len),s}},Core.D=class{static circle(t,s,i=0){let h=[],e=Math.PI2/t;for(let r=0;r<t;r++){let t=i+r*e;h.push({x:Math.cos(t)*s,y:-Math.sin(t)*s})}return h}static polygon(t,s,i,h=0){let e=[],r=Math.PI2/t,a=Math.cos(h)*i,l=-Math.sin(h)*i,o=Math.sin(r/2)*i*2/s;for(let i=0;i<t;i++){let t=Math.PI/2+h+(i+.5)*r,p=Math.cos(t)*o,c=Math.sin(t)*o;for(let t=0;t<s;t++)e.push({x:a,y:l}),a+=p,l-=c}return e}};