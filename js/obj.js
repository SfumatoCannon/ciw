_C.O=class{constructor(s,t){this.x=s,this.y=t,this.scx=1,this.scy=1,this.ang=0,this.ind=0,this.h_=0,this.v_=0,this.spd=0,this.dir=0,this.V=[0,0,0,0,0,0,0,0],this.B=[0,0,0,0],this.BV=[0,1,6,7],this.Bp=[0,0,0,0],this.Bc=[0,0,0,0],this.calc=!1,this.m_=0,this.colS=[],this._des=!1,this._inCol=!1}$d(){null!==this.spr[0]&&(this.ly.upd=!0)}cB(){this.calc||(this.calc=!0,_C.cB(this,this.w,this.h,this.boxL,this.boxT,this.V,this.B,this.BV))}moveB(s,t){this.x+=s,this.y+=t;let i=this.V;for(let h=0;h<8;h+=2)i[h]+=s,i[h+1]+=t;this.B[0]=Math.round(i[this.BV[0]]),this.B[1]=Math.round(i[this.BV[1]]),this.B[2]=Math.round(i[this.BV[2]]),this.B[3]=Math.round(i[this.BV[3]])}#s(s,t,i,h,e,r=0,p=0){let o=e.spr,n=e.ang*Math.DR,d=Math.cos(n),a=Math.sin(n),l=e.scx,c=e.scy,u=e.sprX,m=e.sprY,B=-e.x-r+.5,v=-e.y-p+.5,f=o.mask[e.ind<<0],y=e._w,x=e._h,M=o.bL,g=o.bT;for(let e=t;e<h;e++)for(let t=s;t<i;t++){let s=(d*(t+B)-a*(e+v))/l+u-M<<0;if(s<0||s>=y)continue;let i=(a*(t+B)+d*(e+v))/c+m-g<<0;if(!(i<0||i>=x)&&f[i*y+s])return!0}return!1}_meet(s,t,i,h,e,r,p){if(0===p.w||0===p.h)return!1;if(this.px||p.px){let o=Math.max(i,p.B[0]),n=Math.max(h,p.B[1]),d=Math.min(e,p.B[2]),a=Math.min(r,p.B[3]);if(!this.px&&this.ang%90==0)return this.#s(o,n,d,a,p);if(!p.px&&p.ang%90==0)return this.#s(o,n,d,a,this,s,t);let l=this.spr,c=this.ang*Math.DR,u=Math.cos(c),m=Math.sin(c),B=this.scx,v=this.scy,f=this.sprX,y=this.sprY,x=-this.x-s+.5,M=-this.y-t+.5,g=l.mask[this.ind<<0],R=this._w,b=this._h,V=l.bL,w=l.bT,k=1-this.px,C=p.spr,j=p.ang*Math.DR,O=Math.cos(j),_=Math.sin(j),L=p.scx,S=p.scy,D=p.sprX,X=p.sprY,Y=.5-p.x,T=.5-p.y,P=C.mask[p.ind<<0],A=p._w,G=p._h,$=C.bL,I=C.bT,z=1-p.px;for(let s=n;s<a;s++)for(let t=o;t<d;t++){let i=(u*(t+x)-m*(s+M))/B+f-V<<0;if(i<0||i>=R)continue;let h=(m*(t+x)+u*(s+M))/v+y-w<<0;if(h<0||h>=b)continue;let e=(O*(t+Y)-_*(s+T))/L+D-$<<0;if(e<0||e>=A)continue;let r=(_*(t+Y)+O*(s+T))/S+X-I<<0;if(!(r<0||r>=G)&&(k|g[h*R+i])&(z|P[r*A+e]))return!0}return!1}if(this.ang%90||p.ang%90){let i=[],h=p.V;for(let h=0;h<8;h+=2)i[h]=this.V[h]+s,i[h+1]=this.V[h+1]+t;for(let s=0;s<2;s++){for(let s=2;s<6;s+=2){let t=i[s]-i[0],e=i[s+1]-i[1],r=t*(h[0]-i[0])+e*(h[1]-i[1]),p=r;for(let s=2;s<8;s+=2){let o=t*(h[s]-i[0])+e*(h[s+1]-i[1]);o<r?r=o:o>p&&(p=o)}if(p<=0||r>=t*t+e*e)return!1}h=i,i=p.V}return!0}return!0}meet(s){return this.cB(),0===this.w||0===this.h?null:s<2?$R.Col.c[s].m(this,0,0,this.B[0],this.B[1],this.B[2],this.B[3]):$R.Col._.m(this,s-2)}meetAll(s){this.cB();let t=[];if(0===this.w||0===this.h)return t;if(s<2){let i=$R.Col.c[s].m(this,0,0,this.B[0],this.B[1],this.B[2],this.B[3]);i&&t.push(i)}else $R.Col._.f(this,s-2,t);return t}meetXY(s,t,i){return this.cB(),0===this.w||0===this.h?null:$R.Col._.mXY(this,i-2,s,t,Math.round(this.V[this.BV[0]]+s),Math.round(this.V[this.BV[1]]+t),Math.round(this.V[this.BV[2]]+s),Math.round(this.V[this.BV[3]]+t))}meetXYAll(s,t,i){this.cB();let h=[];return 0===this.w||0===this.h||$R.Col._.fXY(this,i-2,s,t,Math.round(this.V[this.BV[0]]+s),Math.round(this.V[this.BV[1]]+t),Math.round(this.V[this.BV[2]]+s),Math.round(this.V[this.BV[3]]+t),h),h}meetOXY(s,t,i){let h=Math.round(this.V[this.BV[0]]+s),e=Math.round(this.V[this.BV[1]]+t),r=Math.round(this.V[this.BV[2]]+s),p=Math.round(this.V[this.BV[3]]+t);return!!(r>i.B[0]&&p>i.B[1]&&h<i.B[2]&&e<i.B[3]&&this._meet(s,t,h,e,r,p,i))}meetObjXY(s,t,i){let h=Math.round(this.V[this.BV[0]]+s),e=Math.round(this.V[this.BV[1]]+t),r=Math.round(this.V[this.BV[2]]+s),p=Math.round(this.V[this.BV[3]]+t);for(let o=i.length;o--;){let n=i[o];if(r>n.B[0]&&p>n.B[1]&&h<n.B[2]&&e<n.B[3]&&this._meet(s,t,h,e,r,p,n))return!0}return!1}},_C.R=class extends _C.O{constructor(s,t,i,h,e){super(t,i),this.xp=t,this.yp=i,this.obj=s,this.dep=h,this.ly=$R.L[h],this.oid=this.ly.push(this),10===s?(this.cB=this.calcBoxG,this.activate=this.actvGrp,this.move=this.#t,this.draw=this.#i,this.$d=this.#i):(this.activate=this.actv,this.spr=e,this.px=0|this.spr.px,this._w=e.boxW,this._h=e.boxH,this.move=this.#i,this.draw=null===e[0]?this.#i:this.dNormal,this.dSpr=_C.dSprN,this.sprX=e.x,this.sprY=e.y,this.boxL=this.sprX-e.bL,this.boxT=this.sprY-e.bT),this.cmL=[],this.cmI=[],this.colMov=!1,this.al=1,this.hd=0,this.DEF=[],this.MOV=[],this.TML=[],this.tmlB=50,this.TRG=[[],[],[],[]],this.trgMap=[],this.VAR=[0,0,0,0],this.step0=this.timer=this.step1=this.step2=this.colli=this.#i,this.gscy=this.gscx=1,this.gag=0}set $x(s){s!==this.x&&(this.x=s,this.$d(),this.calc=!1,this.m_=2)}set $y(s){s!==this.y&&(this.y=s,this.$d(),this.calc=!1,this.m_=2)}set $scx(s){s!==this.scx&&(this.scx=s,this.w=s*this._w,this.$d(),this.calc=!1,this.m_=2)}set $scy(s){s!==this.scy&&(this.scy=s,this.h=s*this._h,this.$d(),this.calc=!1,this.m_=2)}set $ang(s){s!==this.ang&&(this.ang=s,this.$d(),this.calc=!1,this.m_=2)}set $h_(s){if(s!==this.h_)if(this.h_=s,this.v_){this.spd=(s*s+this.v_*this.v_)**.5;let t=-Math.atan(this.v_/s)/Math.DR;this.dir=(s<0?t+180:t+360)%360}else this.spd=s,s&&(this.dir=s<0?180:0)}set $v_(s){if(s!==this.v_)if(this.v_=s,this.h_){this.spd=(this.h_*this.h_+s*s)**.5;let t=-Math.atan(s/this.h_)/Math.DR;this.dir=(this.h_<0?t+180:t+360)%360}else this.spd=s,s&&(this.dir=s<0?90:270)}$hvspd(s,t){if((s!==this.h_||t!==this.v_)&&(this.h_=s,this.v_=t,this.spd=(s*s+t*t)**.5,this.spd)){let i=-Math.atan(t/s)/Math.DR;this.dir=(s<0?i+180:i+360)%360}}$dspd(s,t,i){if(s||t){let h=(s*s+t*t)**.5,e=-Math.atan(t/s)/Math.DR;this.dir=i<0?(s<0?e+360:e+180)%360:(s<0?e+180:e+360)%360,t=i*t/h,(s=i*s/h)===this.h_&&t===this.v_||(this.spd=Math.abs(i),this.h_=s,this.v_=t)}}set $spd(s){if(s!==this.spd){this.spd=s;let t=this.dir*Math.DR;this.h_=Math.cos(t)*s,this.v_=-Math.sin(t)*s}}set $dir(s){if(s!==this.dir&&(this.dir=s%360,this.spd)){let t=s*Math.DR;this.h_=Math.cos(t)*this.spd,this.v_=-Math.sin(t)*this.spd}}$spddir(s,t){if(s!==this.spd||t!==this.dir){this.spd=s,this.dir=t%360;let i=t*Math.DR;this.h_=Math.cos(i)*s,this.v_=-Math.sin(i)*s}}init(){let s=!1,t=!1,i=!1;if(this.mov&&this.mov.for(s=>{Lib.dmov[s[0]](this,s)&&(t=!0)}),this.tml&&(this.tml.for(i=>{const h=[];h.run=i[0],h.time=0,h.node=0,this.TML.push(h),i[1].for(i=>{const e={_:i};Lib.colAct.includes(i[0])?t=!0:1.05===i[0]?s=!0:.02===i[0]&&(0===i[2]&&(i[2]=Infinity),e.ct=0),i.f||(i.f=i[0]===i[0]<<0?Lib.dmov[i[0]]:Lib.act[i[0]<<0][Math.round(100*i[0]%100-1)]),h.push(e)})}),this.timer=this.#h),this.trg?.for(h=>{const e=[h[1]||Infinity,[1],h[2],h[3]];switch(this.TRG[h[0]].push(e),this.trgMap.push(e),e.ex=0,h[0]){case 0:this.step0=this.#e;break;case 1:this.step1=this.#r;break;case 2:this.step2=this.#p}let r=0;h[2].for(s=>{s[0]>2&&s[0]<2.05&&(i=!0,this.colS[s[2]]??={i:0,o:null,c:!1}),s.f||(s.f=Lib.trg[(s[0]<<0)-1][Math.round(100*s[0]%100-1)]),s[1]?e[1][++r]=1:e[1][r]++}),h[3].for(i=>{Lib.colAct.includes(i[0])?t=!0:1.05===i[0]&&(s=!0),i.f||(i.f=i[0]===i[0]<<0?Lib.dmov[i[0]]:Lib.act[i[0]<<0][Math.round(100*i[0]%100-1)])});let p=e[1].length-1;0==--e[1][p]&&p&&e[1].pop()}),this.def){const i=Lib.def[this.def];this.DEF.push(i[1].bind(this)),2===i[0]?t=!0:1===i[0]&&(s=!0)}if(t&&(this.colMov=t),10!==this.obj){if(this.tile)switch(this.spr.length){case 1:this.tile=!1;break;case 2:this.tile=[(this.tb>7)<<0],this.draw=this.dTile;break;case 4:this.tile=[this.tc?0:(3==(3&this.tb))+((12==(12&this.tb))<<1)],this.draw=this.dTile;break;case 20:this.tile=[this.tb];for(let s=0;s<4;s++)this.tc&1<<s&&this.tile.push(16+s);this.draw=this.dTile}switch(this.w=this.scx*this._w,this.obj){case 11:this.draw=this.dLaser,this._h=this.lso?this.len:0;break;case 22:this.draw=this.dRope,this._h=this.len}this.h=this.scy*this._h,this.initOxy(),this.cB(),this.m_=0;for(let s=0;s<4;s++)this.Bp[s]=this.B[s];this.spr.ims&&(this.DEF.push(Lib.def[0][1].bind(this)),s=!0),this.cm&&(this.cm>=2&&this.cmL.push(this.cm-2),this.cmL.push(this.obj+3),$R.Col._.add(this)),i&&(this.move=this.#o),(t||s)&&(this.move=this.#n)}else this.gpi||this.updGrp(1)}calcBoxG(){this.calc||(this.calc=!0,this.B[0]=Math.round(this.x),this.B[1]=Math.round(this.y),this.B[2]=this.B[0],this.B[3]=this.B[1])}actv(s,t,i,h){(this.B[0]<i&&this.B[1]<h&&this.B[2]>s&&this.B[3]>t||11===this.dep)&&this.ly.add(this)}actvGrp(s,t,i,h){(this.B[0]<i&&this.B[1]<h&&this.B[2]>s&&this.B[3]>t||this.grpO.some(e=>e.B[0]<i&&e.B[1]<h&&e.B[2]>s&&e.B[3]>t||11===e.dep))&&(this.ly.add(this),this.grpO.for(e=>{e.B[0]<i&&e.B[1]<h&&e.B[2]>s&&e.B[3]>t||11===e.dep||e.ly.add(e)}))}get hsp(){return this.x-this.xp}get vsp(){return this.y-this.yp}destroy(){this._des=!0,this.$d(),10===this.obj?this.grpO.for(s=>s.gpi=""):this.cmL.length&&$R.Col._.rm(this),this.m_=2}outRoom(){this.destroy()}uCI(s,t){let i=this.colS[s];i&&!i.c&&(0!==i.i&&3!==i.i||(i.i=1),i.o=t,i.c=!0)}uCO(s){this.cmL.for(t=>{if(s.colS[t+2]&&!s.colS[t+2].c){let i=s.colS[t+2];0!==i.i&&3!==i.i||(i.i=1),i.o=this,i.c=!0}})}uC(s){let t=this.colS[s];if(t.c)return t.i;if(0===t.i){let i=this.meet(s);i&&(t.i=1,t.o=i,this.uCO(i))}else if(2===t.i&&(this.m_||t.o.m_)){let i=this.meet(s);i?this.uCO(i):t.i=3,t.o=i}return t.c=!0,t.i}initOxy(){if(this.a){let s=this.a-1,t=this.spr;this.sprX=1&s?t.w>>1:2&s?t.w:0,this.sprY=4&s?t.h>>1:8&s?t.h:0,this.boxL=this.sprX-t.bL,this.boxT=this.sprY-t.bT}}moveOxy(s){let t,i;s?(t=1&--s?this.spr.w>>1:2&s?this.spr.w:0,i=4&s?this.spr.h>>1:8&s?this.spr.h:0):(t=this.spr.x,i=this.spr.y),_C.moveOxy(this,t,i),this.boxL=this.sprX-this.spr.bL,this.boxT=this.sprY-this.spr.bT}#d(){this.outIn&&($R.colS.push(this),this.outIn=!1)}out(){this.outD=this.gpi||this.MOV[3]||this.MOV[4]||this.MOV[5],this.outD||($R.colT.push(this),this._out())}_out(){for(let s=0;s<this.outO.length;s++){const t=this.meetAll(this.outO[s]);for(let i=0;i<t.length;i++){const h=t[i];this.uCO(h),h.uCO&&h.uCO(this);let e=0,r=0,p=0,o=0;if(this.px||h.px||this.ang%90||h.ang%90){let s=this.B[2]-this.Bp[2]-(h.B[0]-h.Bp[0]),t=this.B[0]-this.Bp[0]-(h.B[2]-h.Bp[2]),i=0;if((s>0||0===s&&t>0)&&this.Bp[0]<h.Bp[2]&&(i=Math.max(s,t)+2.5,this.meetOXY(-i,0,h)&&(i=0)),!i&&(t<0||0===t&&s<0)&&this.Bp[2]>h.Bp[0]&&(i=Math.min(s,t)-2.5,this.meetOXY(-i,0,h)&&(i=0)),i){let s=.5,t=Math.sign(i);for(;s<t*i&&this.meetOXY(s*-t,0,h);)s+=.5;p=s*t,e=this.h_-h.h_}let n=this.B[3]-this.Bp[3]-(h.B[1]-h.Bp[1]),d=this.B[1]-this.Bp[1]-(h.B[3]-h.Bp[3]),a=0;if((n>0||0===n&&d>0)&&this.Bp[1]<h.Bp[3]&&(a=Math.max(n,d)+2.5,this.meetOXY(0,-a,h)&&(a=0)),!a&&(d<0||0===d&&n<0)&&this.Bp[3]>h.Bp[1]&&(a=Math.min(n,d)-2.5,this.meetOXY(0,-a,h)&&(a=0)),a){let s=.5,t=Math.sign(a);for(;s<t*a&&this.meetOXY(0,s*-t,h);)s+=.5;o=s*t,r=this.v_-h.v_}}else this.Bp[2]<=h.Bp[0]?(p=this.B[2]-h.B[0],e=this.h_-h.h_):this.Bp[0]>=h.Bp[2]&&(p=this.B[0]-h.B[2],e=this.h_-h.h_),this.Bp[3]<=h.Bp[1]?(o=this.B[3]-h.B[1],r=this.v_-h.v_):this.Bp[1]>=h.Bp[3]&&(o=this.B[1]-h.B[3],r=this.v_-h.v_);if(p||o||e||r){p&&o&&(this.meetObjXY(-e,0,t)?e=p=0:this.meetObjXY(0,-r,t)&&(r=o=0));let i=!1;if(h.outO&&!h.outD)for(let s=0;s<this.cmL.length;s++)if(h.outO.includes(this.cmL[s]+2)){i=!0;break}if(p||e){let t=-p,h=-e*(1+this.outB[s]);i&&(t/=2,h/=2),this.outX*t>0?(t-this.outX)*t>0&&(this.outX=t):this.outX+=t,this.outH*h>0?(h-this.outH)*h>0&&(this.outH=h):this.outH+=h}if(o||r){let t=-o,h=-r*(1+this.outB[s]);i&&(t/=2,h/=2),this.outY*t>0?(t-this.outY)*t>0&&(this.outY=t):this.outY+=t,this.outV*h>0?(h-this.outV)*h>0&&(this.outV=h):this.outV+=h}this.#d()}}}}bounce(){this.gpi}updGrp(s=0){for(let t=this.grpO.length;t--;){let i=this.grpO[t];if(i._des){this.grpO.splice(t,1);continue}s&&this.colMov&&!i.colMov&&(i.colMov=!0,i.move=i.#n);let h=this._gp[i._gn];this.csc&&(i.scx/=i.gscx,i.gscx=this.scx,i.$scx=i.scx*i.gscx,i.scy/=i.gscy,i.gscy=this.scy,i.$scy=i.scy*i.gscy),this.cag&&(i.ang-=i.gag,i.gag=this.ang,i.$ang=i.ang+i.gag);let e=(h.x+i.grpX)*this.scx,r=(h.y+i.grpY)*this.scy;if(this.ang){let s=this.ang*Math.DR,t=Math.cos(s),i=Math.sin(s),h=-e*i+r*t;e=e*t+r*i,r=h}i.$x=this.x+e,i.$y=this.y+r,10===i.obj?i.updGrp(s):i.cmL.length&&i.m_>1&&$R.Col._.upd(i)}}#i(){}trigger(s){if(s[0]&&0===s.ex){s.ex=1;let t=0;for(let i=0;i<s[1].length;i++){let h=s[1][i],e=1;for(let i=0;i<h;i++){const h=s[2][t+i];if(!h.f(this,h)){e=0;break}}if(e){s[0]--,s[3].for(s=>s.f(this,s));break}t+=h}s.ex=0}}#h(){for(let s=0;s<this.TML.length;s++){const t=this.TML[s];if(t.run){for(;t.run&&0===t.time;){const s=t[t.node++];if(!s){t.run=0,t.time=0,t.node=0;break}s._.f(this,s._,t,s)}t.run&&t.time>0&&t.time--}}}#t(){this.m_=0;for(let s=this.MOV.length;s--;)this.MOV[s]&&this.MOV[s](this)&&(this.MOV[s]=null)}#n(){this.xp=this.x,this.yp=this.y;for(let s=0;s<4;s++)this.Bp[s]=this.B[s];this.m_=0,this.#o();for(let s=this.MOV.length;s--;)this.MOV[s]&&this.MOV[s](this)&&(this.MOV[s]=null);this.DEF.for(s=>s()),this.m_>1&&this.cmL.length&&$R.Col._.upd(this)}#o(){for(let s=this.colS.length;s--;){const t=this.colS[s];t&&(1===t.i?t.i=2:3===t.i&&(t.i=0),t.c=!1)}}#e(){for(let s=0;s<this.TRG[0].length;s++)this.trigger(this.TRG[0][s])}#r(){for(let s=0;s<this.TRG[1].length;s++)this.trigger(this.TRG[1][s])}#p(){for(let s=0;s<this.TRG[2].length;s++)this.trigger(this.TRG[2][s])}dNormal(){this.hd||0===this.al||0===this.scx||0===this.scy||this.dSpr(this.spr,this.ind<<0)}dTile(){this.hd||0===this.al||this.tile.for(s=>this.dSpr(this.spr,s))}dRope(){if(this.hd||0===this.al)return;let s=this.spr,t=this.len-32;for($R.rr.$S(s[1],this.x,this.y,-this.sprX,t,this.scx,this.scy,this.ang,this.al);t>0;t-=32)t>=32?$R.rr.$S(s[0],this.x,this.y,-this.sprX,t-32,this.scx,this.scy,this.ang,this.al):$R.rr.$E(s[0],0,32-t,s.w,t,this.x,this.y,-this.sprX,0,this.scx,this.scy,this.ang,this.al)}dLaser(){if(this.hd&&!this.lso||0===this.al)return;let s=this.spr;this.lso&&$R.rr.$S(s[1],this.x,this.y,-this.sprX,0,this.scx,this.h/s.h,this.ang,this.al),this.hd||$R.rr.$S(s[0],this.x,this.y,-this.sprX,0,this.scx,this.scy,this.ang,this.al)}},_C.Y=class extends _C.O{#a;constructor(s,t){super(s,t),$R.plyX=s,$R.plyY=t,this.#a=1,this.spr=$R._r.Spr.pli,this.ims=.2,this.px=0,this.ly=$R.L[7],this.ox=17,this.oy=23,this.moveSpd=3,this.maxVspd=9,this.jump1=-8.5,this.jump2=-7,this.grav=.4,this.fric=.5,this.ahspd=0,this.phspd=0,this.pvspd=0,this.onPlat=!1,this.onLadder=!1,this.onRope=null,this.meetRope=null,this.meetMov=null,this.shoot=0,this.frozen=!1,$R.initPly(this),this.dj=this.jump,this.state=new _C.State({ind:0,spr:this.spr,x:this.x,y:this.y,scx:this.scx,scy:this.scy,g:this.g_}),this.$d(),this.clacLTRB(),this.cB();for(let s=0;s<4;s++)this.Bp[s]=this.B[s]}cB(){this.V[0]=this.V[4]=this.x+this._L,this.V[1]=this.V[3]=this.y+this._T,this.V[2]=this.V[6]=this.x+this._R,this.V[5]=this.V[7]=this.y+this._B,this.B[0]=Math.round(this.V[0]),this.B[1]=Math.round(this.V[1]),this.B[2]=Math.round(this.V[6]),this.B[3]=Math.round(this.V[7])}clacLTRB(){switch(this.g_){case 270:this._T=-12*this.scy,this._B=9*this.scy,this._L=-5*this.#a,this._R=6*this.#a;break;case 90:this._T=-9*this.scy,this._B=12*this.scy,this._L=-5*this.#a,this._R=6*this.#a;break;case 0:this._T=-6*this.#a,this._B=5*this.#a,this._L=-12*this.scy,this._R=9*this.scy;break;case 180:this._T=-5*this.#a,this._B=6*this.#a,this._L=-9*this.scy,this._R=12*this.scy}}setGrav(s){if(s!==this.g_){if(this.v_=0,this.ahspd=0,s%180==this.g_%180)switch(s){case 270:this.y+=4;break;case 90:this.y-=4;break;case 0:this.x+=4;break;case 180:this.x-=4}this.g_=s,this.ang=(s+90)%360,this.clacLTRB(),this.cB(),this.m_=2}}meet(s,t,i){let h,e;switch(this.g_){case 270:h=s,e=t;break;case 90:h=s,e=-t;break;case 0:h=t,e=-s;break;case 180:h=-t,e=s}return $R.Col._.mXY(this,i-2,h,e,Math.round(this.V[0]+h),Math.round(this.V[1]+e),Math.round(this.V[6]+h),Math.round(this.V[7]+e))}meetAll(s,t,i){let h,e,r=[];switch(this.g_){case 270:h=s,e=t;break;case 90:h=s,e=-t;break;case 0:h=t,e=-s;break;case 180:h=-t,e=s}return $R.Col._.fXY(this,i-2,h,e,Math.round(this.V[0]+h),Math.round(this.V[1]+e),Math.round(this.V[6]+h),Math.round(this.V[7]+e),r),r}meetO(s,t,i,h,e,r,p){return!!(e>p.B[0]&&r>p.B[1]&&i<p.B[2]&&h<p.B[3]&&this._meet(s,t,i,h,e,r,p))}meetObj(s,t,i){let h,e;switch(this.g_){case 270:h=s,e=t;break;case 90:h=s,e=-t;break;case 0:h=t,e=-s;break;case 180:h=-t,e=s}let r=Math.round(this.V[0]+h),p=Math.round(this.V[1]+e),o=Math.round(this.V[6]+h),n=Math.round(this.V[7]+e);for(let s=i.length;s--;)if(this.meetO(h,e,r,p,o,n,i[s]))return!0;return!1}meet0(s){return $R.Col._.mXY(this,s-2,0,0,this.B[0],this.B[1],this.B[2],this.B[3])}meet0All(s){let t=[];return $R.Col._.fXY(this,s-2,0,0,this.B[0],this.B[1],this.B[2],this.B[3],t),t}com(){if(0===this.shoot&&($C.P("z")||this.conShoot&&$C.C("z"))&&(Au.play("st"),this.shoot=5,new _C.B(this.x,this.y,this.scx,this.g_)),this.shoot&&this.shoot--,this.h_&&this.g_%180){let s=this.meet(this.h_,0,24);if(s&&s.meetXY(0,1,2)){let t=Math.sign(this.h_);s.meetXY(t,0,2)||(s.uCI(0,this),s.$h_=s.meetXY(2*t,0,2)?t:2*t,s.MOV[0]=Lib.mov[0],s.MOV[5]=null)}}}step(){if(this.frozen)return;this.cB(),this.grav=this.meet0(36)?.7:this.meet0(35)?.2:this._grav,this.moveSpd=this.meet0(38)?1:this.meet0(37)?6:this._moveSpd;let s=$C.C("R")||-$C.C("L");if(this.meet0(26)){let t=$C.C("D")||-$C.C("U");if(t&&(this.onLadder=!0),this.onLadder){if(this.spr=$R._r.Spr.plb,this.ims=.2,this.dj=this.jump,s&&(this.scx=this.#a*s),this.h_=this.moveSpd*s,this.v_=this.moveSpd*t,this.grav=0,!$C.P("J"))return this.com();this.onLadder=!1,this.grav=.4,this.v_=0}}else this.onLadder&&(this.onLadder=!1,this.grav=.4,this.v_=0);let t=this.meet0(27);if(t){if(!this.onRope&&this.meetRope!==t){let s=((this.x-t.x)**2+(this.y-t.y)**2)**.5<<0;s>=0&&s<=t.h&&(this.onRope=t,this.meetRope=t,this.onRopeLen=s)}if(this.onRope){this.spr=$R._r.Spr.plb,this.ims=.2,this.dj=this.jump,s&&(this.scx=this.#a*s),this.grav=0,this.h_=0,this.v_=0;let t=$C.C("D")||-$C.C("U"),i=this.onRope.ang*Math.DR,h=Math.sin(i),e=Math.cos(i);if(this.onRopeLen+=this.moveSpd*t,this.platMove(this.onRope.x+this.onRopeLen*h-this.x,this.onRope.y+this.onRopeLen*e-this.y),!($C.P("J")||this.onRopeLen<0||this.onRopeLen>this.onRope.h))return this.com();this.onRope=null,this.grav=.4,this.phspd=0,this.pvspd=0}}else this.meetRope=null,this.onRope&&(this.onRope=null,this.grav=.4,this.phspd=0,this.pvspd=0);let i=this.meet(0,1,2),h=0;if(!i){let s=this.meet(-1,0,19)||this.meet(1,0,19);if(s){let t=(s.ang-this.g_+270)%360;h=0===t?-1:180===t?1:0,h&&(s.uCI(0,this),90===this.g_&&(h=-h))}}let e=this.meet(0,1,10);if(s){if(!h||s===h){if(this.scx=this.#a*s,e){let t=this.moveSpd*s,i=e.fra*this.moveSpd;Math.abs(this.h_-t)<i&&(this.h_=t),this.h_<t?this.h_+=i:this.h_>t&&(this.h_-=i)}else this.h_=this.moveSpd*s;this.spr=$R._r.Spr.plr,this.ims=.5}}else{if(e){let s=e.frd*this.moveSpd;Math.abs(this.h_-0)<s&&(this.h_=0),this.h_<0?this.h_+=s:this.h_>0&&(this.h_-=s)}else this.h_=0;this.spr=$R._r.Spr.pli,this.ims=.2}this.adMove&&i&&($C.P("a")&&(this.h_-=1),$C.P("d")&&(this.h_+=1));let r=this.meet(0,1,56);r?this.h_+=r.csp:(r=this.meet(0,1,25),r&&(this.h_-=r.csp)),this.onPlat?this.meet(0,4,3)||(this.onPlat=!1):i||(this.spr=this.v_<0?$R._r.Spr.plj:$R._r.Spr.plf,this.ims=.2);let p=this.meet0(5);if(p&&(this.v_>2&&(this.v_=2),49===p.obj&&(this.dj=this.jump)),this.v_>this.maxVspd&&(this.v_=this.maxVspd),this.com(),this.jump&&$C.P("J")&&(i||this.onPlat||this.meet(0,1,3)||p&&16===p.obj?(this.v_=this.jump1,this.dj=this.jump,this.spr=$R._r.Spr.plj,this.ims=.2,Au.play("jp")):(this.dj>1||p&&17!==p.obj||-1===this.dj)&&(this.v_=this.jump2,this.dj>1&&this.dj--,this.spr=$R._r.Spr.plj,this.ims=.2,Au.play("jp",2))),this.v_<0&&$C.R("J")&&(this.v_*=.45),h){if(this.v_=2,this.spr=$R._r.Spr.plt,this.ims=.5,this.scx=this.#a*h,!($C.P("R")&&1===h||$C.P("L")&&-1===h))return this.meetMov=null;this.ims=.2,$C.C("J")?(this.spr=$R._r.Spr.plj,this.v_=-9,this.h_=15*h,Au.play("wj")):(this.spr=$R._r.Spr.plf,this.h_=3*h)}this.meetMov=this.meetAll(0,2,2),this.meetAll(0,2,3).for(s=>this.meetMov.push(s))}p2o(s,t){switch(this.g_){case 270:return[s,t];case 90:return[s,-t];case 0:return[t,-s];case 180:return[-t,s]}}platMove(s,t){switch(this.g_){case 270:this.phspd=s,this.pvspd=t;break;case 90:this.phspd=s,this.pvspd=-t;break;case 0:this.phspd=-t,this.pvspd=s;break;case 180:this.phspd=t,this.pvspd=-s}}applyMove(s,t){switch(this.g_){case 270:this.ahspd=s,this.v_=t;break;case 90:this.ahspd=s,this.v_=-t;break;case 0:this.ahspd=-t,this.v_=s;break;case 180:this.ahspd=t,this.v_=-s}}moveB(s,t){switch(this.g_){case 270:this.x+=s,this.y+=t;break;case 90:this.x+=s,this.y-=t;break;case 0:this.y-=s,this.x+=t;break;case 180:this.y+=s,this.x-=t}this.cB()}move(){if(this.m_=0,this.frozen)return;if(this.ind+=this.ims,this.ind>=this.spr.length&&(this.ind=0),this.meetMov){let s=0,t=Infinity;this.meetMov.for(i=>{if(!i._des){let h=i.vsp;h<t&&(t=h,s=i.hsp)}}),Number.isFinite(t)||(t=0),(s||t)&&this.platMove(s,t)}this.ahspd>0?(this.ahspd-=this.fric,this.ahspd<0&&(this.ahspd=0)):this.ahspd<0&&(this.ahspd+=this.fric,this.ahspd>0&&(this.ahspd=0));for(let s=0;s<4;s++)this.Bp[s]=this.B[s];this.h_+=this.ahspd,this.v_+=this.grav;let s=this.h_+this.phspd,t=this.v_+this.pvspd;if(s||t){let i=this.B[0],h=this.B[1],e=this.B[2],r=this.B[3];this.moveB(s,t),i===this.B[0]&&h===this.B[1]&&e===this.B[2]&&r===this.B[3]||(this.m_=2)}}colli(){if(this.frozen)return;let s=this.B[0],t=this.B[1],i=this.B[2],h=this.B[3],e=this.meet0All(2);if(e.length){let s=0,t=0,i=0,h=0,r=0,p=0,[o,n]=this.p2o(this.h_+this.phspd,this.v_+this.pvspd);switch(e.for(e=>{let r=o-e.hsp,p=n-e.vsp;r<0?i=Math.min(i,r):r>0&&(s=Math.max(s,r)),p<0?h=Math.min(h,p):p>0&&(t=Math.max(t,p))}),this.g_){case 270:break;case 90:n=-n,[t,h]=[-h,-t];break;case 0:[o,n,s,t,i,h]=[-n,o,-h,s,-t,i];break;case 180:[o,n,s,t,i,h]=[n,-o,t,-i,h,-s]}if(s&&s!==o&&(s+=1,r=1),t&&t!==n&&(t+=1),i&&(i!==o&&(i-=1,p=-1),s||(s=i,i=0,r=p,p=0)),h&&(h!==n&&(h-=1),t||(t=h,h=0)),!s&&!t||this.meetObj(-s,-t,e)?!s&&!h||this.meetObj(-s,-h,e)?!i&&!t||this.meetObj(-i,-t,e)?!i&&!h||this.meetObj(-i,-h,e)?!o&&!n||this.meetObj(-o,-n,e)?(s=0,t=0):(s=o,t=n,r=0,this.moveB(-o,-n)):(s=i,r=p,t=h,this.moveB(-s,-t)):(s=i,r=p,this.moveB(-s,-t)):(t=h,this.moveB(-s,-t)):this.moveB(-s,-t),s&&this.meet(s,0,2)){for(let t=Math.sign(s),i=Math.abs(s),h=0;h<i&&!this.meet(t,0,2);h++)this.moveB(t,0);this.ahspd=this.h_=s=0}if(t&&this.meet(0,t,2)){for(let s=Math.sign(t),i=Math.abs(t),h=0;h<i&&!this.meet(0,s,2);h++)this.moveB(0,s);t>0?(this.dj=this.jump,this.v_=0):this.v_=n-t>0?n-t:0,t=0}(s||t)&&this.meet(s,t,2)&&(this.ahspd=this.h_=0,s=r),(s||t)&&this.moveB(s,t)}this.phspd=0,this.pvspd=0;let r=this.meet0All(3);for(let s=r.length;s--;){let t=r[s];if(t.ang%180==(this.g_+90)%180)switch(this.g_){case 270:{let i=t.B[1];if(this.y-this.v_/2<=i&&!this.meet(0,i-9-this.y,2)){let h=t.v_>0?t.v_:0;this.moveB(0,i-9-this.y),this.v_=h,this.onPlat=!0,this.dj=this.jump,s=0}break}case 90:{let i=t.B[3];if(this.y+this.v_/2>=i&&!this.meet(0,this.y-i-9,2)){let h=t.v_<0?-t.v_:0;this.moveB(0,this.y-i-9),this.v_=h,this.onPlat=!0,this.dj=this.jump,s=0}break}case 0:{let i=t.B[0];if(this.x-this.v_/2<=i&&!this.meet(0,i-9-this.x,2)){let h=t.h_>0?t.h_:0;this.moveB(0,i-9-this.x),this.v_=h,this.onPlat=!0,this.dj=this.jump,s=0}break}case 180:{let i=t.B[2];if(this.x+this.v_/2>=i&&!this.meet(0,this.x-i-9,2)){let h=t.h_<0?-t.h_:0;this.moveB(0,this.x-i-9),this.v_=h,this.onPlat=!0,this.dj=this.jump,s=0}break}}}let p=$R._r;switch(p.out){case 4:case 8:if(this.x<0?this.x+=p.w:this.x>=p.w&&(this.x-=p.w),8===p.out){if(this.y<0||this.y>=p.h)return this.kill(!0);break}case 16:if(this.y<0?this.y+=p.h:this.y>=p.h&&(this.y-=p.h),4===p.out)break;if(this.x<0||this.x>=p.w)return this.kill(!0);break;default:if(this.x<0||this.y<0||this.x>=p.w||this.y>=p.h)return this.kill(!0)}if(this.meet0(2))return this.kill(!0);if(this.meet0(4)&&this.kill())return;switch($R.plyX=this.x,$R.plyY=this.y,s===this.B[0]&&t===this.B[1]&&i===this.B[2]&&h===this.B[3]||(this.m_=2),$R.saveMode){case 0:if(!$C.P("s"))break;case 2:let s=this.meet0(7);!s||0!==s.ind||0!==$R.saveMode&&$R.saveX===this.x&&$R.saveY===this.y||(s.ind=1.78125,s.$d(),$R.save())}let o=this.meet0(6);o&&$R.warp(o.wr,o.ws,o.wx,o.wy);const n=this.state;n.ind=this.ind<<0,n.spr=this.spr,n.x=this.x,n.y=this.y,n.scx=this.scx,n.scy=this.scy,n.g=this.g_,n.$d()&&this.$d()}destroy(){this.$d(),this.m_=2,$R.$=null}kill(s=!1){if(!s&&$R.god)return;Au.play("dth");let t=new _C.R(0,400,304,11,$R._r.sprGO);return Object.assign(t,$R._r.bobj.gov),t.cm=0,t.init(!0),t.ly.add(t),$R.addDth(),this.destroy(),!0}draw(){$R.rr.$S(this.spr[this.ind<<0],this.x,this.y,-this.ox,-this.oy,90===this.g_?-this.scx:this.scx,this.scy,this.g_-270)}},_C.B=class extends _C.O{constructor(s,t,i,h){super(Math.round(s),Math.round(t)),this.des=40,this.spr=$R._r.Spr.blt,this.ly=$R.L[7],this.scx=i<0?-i:i,this.scy=this.scx,this.w=Math.round(this.scx*this.spr.w),this.h=Math.round(this.scy*this.spr.h);let e=this.w>>1,r=this.h>>1;this.B[0]=s-e,this.B[1]=t-r,this.B[2]=s-e+this.w,this.B[3]=t-r+this.h,this.V[0]=this.V[4]=this.B[0],this.V[1]=this.V[3]=this.B[1],this.V[2]=this.V[6]=this.B[2],this.V[5]=this.V[7]=this.B[3];for(let s=0;s<4;s++)this.Bp[s]=this.B[s];switch($R.Col.c[1].o.push(this),h){case 270:case 90:this.h_=16*i<<0;break;case 0:this.v_=16*-i<<0;break;case 180:this.v_=16*i<<0}this.m_=2}destroy(){this.des=0}meet(s){return $R.Col._.mXY(this,s-2,0,0,this.B[0],this.B[1],this.B[2],this.B[3])}meetDes(s){let t=this.meet(s);return t&&(t.uCI(1,this),this.destroy()),t}move(){for(let s=0;s<4;s++)this.Bp[s]=this.B[s];this.B[0]+=this.h_,this.B[1]+=this.v_,this.B[2]+=this.h_,this.B[3]+=this.v_,this.V[0]=this.V[4]=this.B[0],this.V[1]=this.V[3]=this.B[1],this.V[2]=this.V[6]=this.B[2],this.V[5]=this.V[7]=this.B[3],this.ind=1-this.ind,this.$d(),this.meetDes(2),this.meetDes(55),this.meetDes(42)}colli(){if(--this.des>0&&this.des&&$R.$&&1===$R.saveMode){let s=this.meet(7);s&&0===s.ind&&(s.ind=1.78125,s.$d(),$R.save(),s.uCI(1,this),this.destroy())}}draw(){$R.rr.$S(this.spr[this.ind],this.B[0],this.B[1],0,0,this.scx,this.scy)}},_C.P=class{constructor(s,t,i,h=7){this.x=s,this.y=t,this.spr=i,this.ind=0,this.sprX=i.w>>1,this.sprY=i.h>>1,this._des=null===i[0],$R.L[h].eff(this),this.al=1,this.scx=1,this.scxA=1,this.scy=1,this.scyA=1,this.ang=0,this.aspd=.1,this.xspd=0,this.yspd=0,this.h_=0,this.v_=0,this.grav=0,this.acc=0,this.rot=0,this.dSpr=_C.dSprN}move(){if(this.v_+=this.grav,this.acc&&(this.h_||this.v_)){let s=(this.h_*this.h_+this.v_*this.v_)**.5,t=(s+this.acc*Math.sign(s))/s;t<=0?(this.h_=0,this.v_=0):(this.h_*=t,this.v_*=t)}this.x+=this.h_,this.y+=this.v_,this.al-=this.aspd,this.scx+=this.xspd,this.scy+=this.yspd,this.ang+=this.rot,(this.al<=0||this.scx*this.scxA<=0||this.scy*this.scyA<=0)&&(this._des=!0)}draw(){this.dSpr(this.spr,this.ind)}static from(s){if(null===s.spr[0]||0===s.al||11!==s.obj&&s.hd||11===s.obj&&s.hd&&!s.lso)return;let t=new _C.P(s.x,s.y,s.spr,s.dep),i=t.sprX,h=t.sprY;return t.ind=s.ind<<0,t.scx=s.scx,t.scx<0&&(t.scxA=-1),t.scy=s.scy,t.scy<0&&(t.scyA=-1),t.ang=s.ang,t.draw=s.draw,t.sprX=s.sprX,t.sprY=s.sprY,_C.moveOxy(t,i,h),s.tile?t.tile=s.tile:11===s.obj?(t.lso=s.lso,t.h=s.h):22===s.obj&&(t.len=s.len),t}},_C.D=class{static circle(s,t,i,h=0){let e=Math.PI2/t;for(let r=0;r<t;r++){let t=h+r*e;s(Math.cos(t)*i,-Math.sin(t)*i)}}static polygon(s,t,i,h,e=0){let r=Math.PI2/t,p=Math.cos(e)*h,o=-Math.sin(e)*h,n=Math.sin(r/2)*h*2/i;for(let h=0;h<t;h++){let t=Math.PI/2+e+(h+.5)*r,d=Math.cos(t)*n,a=Math.sin(t)*n;for(let t=0;t<i;t++)s(p,o),p+=d,o-=a}}};