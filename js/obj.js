Core.Obj=class{constructor(s,t){this.x=s,this.y=t,this.scx=1,this.scy=1,this.ang=0,this.ind=0,this.hspd=0,this.vspd=0,this.V=[0,0,0,0,0,0,0,0],this.B=[0,0,0,0],this.calc=!1,this.moved=!1,this._des=!1,this.colS=[],this.colO=[]}set $x(s){s!==this.x&&(this.x=s,this.ctx.clr=!1,this.calc=!1,this.moved=!0)}set $y(s){s!==this.y&&(this.y=s,this.ctx.clr=!1,this.calc=!1,this.moved=!0)}set $scx(s){s!==this.scx&&(this.scx=s,this.w=s*this._w,1!==s&&(this.dSpr=this.ang?this.dSprEx:this.dSprSc),this.ctx.clr=!1,this.calc=!1,this.moved=!0)}set $scy(s){s!==this.scy&&(this.scy=s,this.h=s*this._h,1!==s&&(this.dSpr=this.ang?this.dSprEx:this.dSprSc),this.ctx.clr=!1,this.calc=!1,this.moved=!0)}set $ang(s){s!==this.ang&&(this.ang=s,this.dSpr=s?1===this.scx&&1===this.scy?this.dSprAng:this.dSprEx:1===this.scx&&1===this.scy?this.dSprN:this.dSprSc,this.ctx.clr=!1,this.calc=!1,this.moved=!0)}set $ago(s){this.angH=1&s?this.spr[0].w>>1:2&s?this.spr[0].w:0,this.angV=4&s?this.spr[0].h>>1:8&s?this.spr[0].h:0,this.ang&&(this.ctx.clr=!1,this.calc=!1,this.moved=!0)}get spd(){return(this.hspd**2+this.vspd**2)**.5}set spd(s){let t=this.spd;if(t){let i=s/t;this.hspd*=i,this.vspd*=i}else this.hspd=s,this.vspd=0}get dir(){let s=-Math.atan(this.vspd/this.hspd)/Math.DR;return this.hspd<0?s+180:s}set dir(s){let t=this.spd;t&&(s*=Math.DR,this.hspd=t*Math.cos(s),this.vspd=-t*Math.sin(s))}calcBox(){if(this.calc)return;this.calc=!0;let s=this.V,t=this.spr[0],i=this.x-t.boxL*this.scx,h=this.y-t.boxT*this.scy;if(0===this.ang)s[0]=i,s[1]=h,s[2]=s[0]+this.w,s[3]=s[1],s[4]=s[0],s[5]=s[1]+this.h,s[6]=s[2],s[7]=s[5];else{let e=this.ang*Math.DR,r=Math.cos(e),a=Math.sin(e),l=this.w*r,p=this.w*a,n=(this.angH-t.bL)*this.scx,o=(this.angV-t.bT)*this.scy;s[0]=i+n*(1-r)-o*a,s[1]=h+n*a+o*(1-r),s[2]=s[0]+l,s[3]=s[1]-p,s[4]=s[0]+this.h*a,s[5]=s[1]+this.h*r,s[6]=s[4]+l,s[7]=s[5]-p}let e=s[0],r=e,a=s[1],l=a;for(let t=0;t<8;t++)1&t?s[t]<a?a=s[t]:s[t]>l&&(l=s[t]):s[t]<e?e=s[t]:s[t]>r&&(r=s[t]);this.B[0]=e+.5<<0,this.B[1]=a+.5<<0,this.B[2]=r+.5<<0,this.B[3]=l+.5<<0}#pxCol(s,t,i,h,e,r=0,a=0){let l=e.spr[0],p=e.ang*Math.DR,n=Math.cos(p),o=Math.sin(p),c=e.scx,d=e.scy,x=e.angH*c,m=e.angV*d,g=-e.x-r+c*l.x-x+.5,y=-e.y-a+d*l.y-m+.5,v=l.mask[e.ind<<0],u=l.boxW,b=l.boxH,f=l.bL,B=l.bT;for(let r=t;r<h;r++)for(let t=s;t<i;t++){let s=(n*(t+g)-o*(r+y)+x)/c-f<<0;if(s<0||s>=u)continue;let i=(o*(t+g)+n*(r+y)+m)/d-B<<0;if(!(i<0||i>=b)&&v[i*u+s])return e}}_meet(s,t,i,h,e,r,a){if(!this.px&&!a.px){if(this.ang%90||a.ang%90){let i=[],h=a.V;for(let h=0;h<8;)i[h]=this.V[h]+s,i[++h]=this.V[h++]+t;for(let s=0;s<2;s++){for(let s=2;s<6;s+=2){let t=i[s]-i[0],e=i[s+1]-i[1],r=t*(h[0]-i[0])+e*(h[1]-i[1]),a=r;for(let s=2;s<8;s+=2){let l=t*(h[s]-i[0])+e*(h[s+1]-i[1]);l<r?r=l:l>a&&(a=l)}if(a<=0||r>=t*t+e*e)return}h=i,i=a.V}return a}return a}{let l=Math.max(i,a.B[0]),p=Math.max(h,a.B[1]),n=Math.min(e,a.B[2]),o=Math.min(r,a.B[3]);if(!this.px&&this.ang%90==0)return this.#pxCol(l,p,n,o,a);if(!a.px&&a.ang%90==0)return this.#pxCol(l,p,n,o,this,s,t);{let i=this.spr[0],h=this.ang*Math.DR,e=Math.cos(h),r=Math.sin(h),c=this.scx,d=this.scy,x=this.angH*c,m=this.angV*d,g=-this.x-s+c*i.x-x+.5,y=-this.y-t+d*i.y-m+.5,v=i.mask[this.ind<<0],u=i.boxW,b=i.boxH,f=i.bL,B=i.bT,R=1-this.px,w=a.spr[0],S=a.ang*Math.DR,M=Math.cos(S),k=Math.sin(S),C=a.scx,j=a.scy,L=a.angH*C,V=a.angV*j,D=-a.x+C*w.x-L+.5,_=-a.y+j*w.y-V+.5,A=w.mask[a.ind<<0],T=w.boxW,O=w.boxH,E=w.bL,H=w.bT,P=1-a.px;for(let s=p;s<o;s++)for(let t=l;t<n;t++){let i=(e*(t+g)-r*(s+y)+x)/c-f<<0;if(i<0||i>=u)continue;let h=(r*(t+g)+e*(s+y)+m)/d-B<<0;if(h<0||h>=b)continue;let l=(M*(t+D)-k*(s+_)+L)/C-E<<0;if(l<0||l>=T)continue;let p=(k*(t+D)+M*(s+_)+V)/j-H<<0;if(!(p<0||p>=O)&&(R|v[h*u+i])&(P|A[p*T+l]))return a}}}}meet(s=0,t=0,i){return this.calcBox(),$R.Col[i].meet(this,s,t,this.B[0]+s,this.B[1]+t,this.B[2]+s,this.B[3]+t)}meetAll(s=0,t=0,i){this.calcBox();let h=this.B[0]+s,e=this.B[1]+t,r=this.B[2]+s,a=this.B[3]+t,l=$R.Col[i].findAll(h,e,r,a),p=[];for(let i=l.length;i--;){if(l[i]===this)continue;let n=this._meet(s,t,h,e,r,a,l[i]);n&&p.push(n)}return p}meetO(s,t,i,h,e,r,a){if(e>a.B[0]&&r>a.B[1]&&i<a.B[2]&&h<a.B[3]&&this._meet(s,t,i,h,e,r,a))return a}resetCol(){let s=this.colS;for(let t=s.length;t--;)1===s[t]?s[t]=2:3===s[t]&&(s[t]=0)}dSprN(s,t,i){s.reset||s.resetC(),s.drawImage(t[i],this.x-t.x,this.y-t.y)}dSprSc(s,t,i){s.reset||s.resetC();let h=this.scx,e=this.scy;(Math.abs(h)<1||Math.abs(e)<1)&&(s.imageSmoothingEnabled=!0),s.drawImage(t[i],this.x-t.x*h,this.y-t.y*e,t.w*h,t.h*e),s.imageSmoothingEnabled&&(s.imageSmoothingEnabled=!1)}dSprAng(s,t,i){let h=this.ang*Math.DR,e=Math.cos(h),r=Math.sin(h),a=this.angH,l=this.angV;s.setTransform(e,-r,r,e,this.x-t.x+a-s.vX,this.y-t.y+l-s.vY),s.drawImage(t[i],-a,-l),s.reset=!1}dSprEx(s,t,i){let h=this.ang*Math.DR,e=Math.cos(h),r=Math.sin(h),a=this.scx,l=this.scy,p=this.angH,n=this.angV;(Math.abs(a)<1||Math.abs(l)<1)&&(s.imageSmoothingEnabled=!0),s.setTransform(e*a,-r*a,r*l,e*l,this.x+(p-t.x)*a-s.vX,this.y+(n-t.y)*l-s.vY),s.drawImage(t[i],-p,-n),s.imageSmoothingEnabled&&(s.imageSmoothingEnabled=!1),s.reset=!1}},Core.ObjRun=class extends Core.Obj{constructor(s,t,i,h,e){super(t,i),this.xp=t,this.yp=i,this.obj=s,this.dep=h,this.ly=$R.L[h],this.ctx=this.ly.sta,this.oid=this.ly.push(this),this.spr=e,this._w=this.spr[0].boxW,this._h=this.spr[0].boxH,this.al=1,this.hd=0,this.draw=this.dNormal,this.dSpr=this.dSprN,this.hsp=0,this.vsp=0,this.DEF=[],this.MOV=[],this.TML=[],this.TRG=[[],[],[]],this.VAR=[0,0,0,0],this.colP=[null,null],this.colId=[0,0],this.beginStep=this.timer=this.step=this.move=this.collison=this.endStep=this.resetStatus=this.#skip}init(){let s=!1,t=!1,i=!1,h=!1;if(this.tile)switch(this.spr[0].length){case 1:this.tile=!1;break;case 2:this.tile=[(this.tb>7)<<0],this.draw=this.dTile;break;case 4:this.tile=[this.tc?0:(3==(3&this.tb))+((12==(12&this.tb))<<1)],this.draw=this.dTile;break;case 20:this.tile=[this.tb];for(let s=0;s<4;s++)this.tc&1<<s&&this.tile.push(16+s);this.draw=this.dTile}else this.spr[0].length>1&&(s=!0);switch(this.mov&&this.mov.for(t=>{Lib.dmov[t[0]](this,t)&&(i=s=!0)}),this.tml&&(this.tml.for(h=>{let e=h[1];this.TML.push(e),e.run=h[0],e.time=0,e.node=0,e.for(h=>{Lib.dynAct.includes(h[0])&&(s=!0),Lib.colAct.includes(h[0])?i=!0:1.05===h[0]&&(t=!0),.02===h[0]&&(h.ct=0,0===h[2]&&(h[2]=Infinity)),h.f=h[0]===h[0]<<0?Lib.dmov[h[0]]:Lib.act[h[0]<<0][Math.round(100*h[0]%100-1)]})}),this.timer=this.#timer),this.trg?.for(e=>{let r=[e[1],[1],e[2],e[3]],a=0;switch(this.TRG[e[0]].push(r),e[0]){case 0:this.beginStep=this.#step0;case 1:this.step=this.#step1;case 2:this.endStep=this.#step2}e[2].for(s=>{2.01===s[0]&&(h=!0),s.f=Lib.trg[(s[0]<<0)-1][Math.round(100*s[0]%100-1)],s[1]?r[1][++a]=1:r[1][a]++}),e[3].for(h=>{Lib.dynAct.includes(h[0])&&(s=!0),Lib.colAct.includes(h[0])?i=!0:1.05===h[0]&&(t=!0),h.f=h[0]===h[0]<<0?Lib.dmov[h[0]]:Lib.act[h[0]<<0][Math.round(100*h[0]%100-1)]}),0==--r[1][r[1].length-1]&&r[1].splice(r[1].length-1)}),this.w=this.scx*this._w,this.obj){case 11:this.draw=this.dLaser,this.h=this.lso?this.scy*this.len:0,this.$ago=1;break;case 22:this.draw=this.dRope,this.h=this.scy*this.len,this.$ago=1;break;default:void 0===this.angH&&(this.$ago=5),this.h=this.scy*this._h}switch(this.calcBox(),(1===this.scx&&1===this.scy)<<1|!this.ang){case 0:this.dSpr=this.dSprEx;break;case 1:this.dSpr=this.dSprSc;break;case 2:this.dSpr=this.dSprAng}if(this.def){let s=Lib.def[this.def];this.DEF.push(s[1].bind(this)),2===s[0]?i=!0:1===s[0]&&(t=!0)}this.px=this.spr[0].px,this.spr[0].ims&&(this.DEF.push(Lib.def[0][1].bind(this)),t=!0),this.colMov=i,this.cm&&($R.Col[this.obj+5].add(this),this.cm>1&&$R.Col[this.cm].add(this),this.resetStatus=this.resetCol),h&&(this.resetStatus=this.resetCol),i?this.move=this.#movC:t&&(this.move=this.#mov),s&&(this.ctx=this.ly.dyn),this.moved=!1}activate(s,t,i,h){this.B[0]<i&&this.B[1]<h&&this.B[2]>s&&this.B[3]>t&&this.ly.add(this)}destroy(){this._des=!0,this.ctx.clr=!1,this.cm&&(this.clearCol(0),this.clearCol(1))}clearCol(s){let t=this.colP[s];if(t){let i=this.colId[s];for(t.splice(i,1);i<t.length;i++)t[i].colId[s]=i;let h=t?this.cm:this.obj+5;this.colO.for(s=>{s&&(s.colS[h]=3,s.colO[h]=null)})}}get sp(){return(this.hsp**2+this.vsp**2)**.5}get di(){let s=-Math.atan(this.vsp/this.hsp)/Math.DR;return this.hsp<0?s+180:s}#skip(){}#trigger(s){let t=this.TRG[s];for(let s=0;s<t.length;s++){let i=t[s],h=0;for(let e=0;e<i[1].length;e++){let r=i[1][e],a=1;for(let s=0;s<r;s++){let t=i[2][h+s];if(!t.f(this,t)){a=0;break}}if(a){i[3].for(s=>s.f(this,s)),--i[0]||t.splice(s--,1);break}h+=r}}}#timer(){this.TML.for(s=>{if(s.run){for(;s.run&&0===s.time;){let t=s[s.node++];if(!t){s.run=0,s.time=0,s.node=0;break}t.f(this,t,s)}s.run&&s.time>0&&s.time--}})}#mov(){for(let s=this.MOV.length;s--;)this.MOV[s]&&this.MOV[s](this)&&(this.MOV[s]=null);this.DEF.for(s=>s())}#movC(){this.moved=!1,this.#mov(),this.hsp=this.x-this.xp,this.vsp=this.y-this.yp,this.xp=this.x,this.yp=this.y}#step0(){this.#trigger(0)}#step1(){this.#trigger(1)}#step2(){this.#trigger(2)}dNormal(){this.hd||0===this.al||(this.al<1&&(this.ctx.globalAlpha=this.al),this.spr.for(s=>this.dSpr(this.ctx,s,this.ind<<0)),this.al<1&&(this.ctx.globalAlpha=1))}dGUI(){if(this.hd||0===this.al)return;this.al<1&&(this.ctx.globalAlpha=this.al);let s=this.ctx.vX,t=this.ctx.vY;this.ctx.vX=0,this.ctx.vY=0,this.spr.for(s=>this.dSpr(this.ctx,s,this.ind<<0)),this.ctx.vX=s,this.ctx.vY=t,this.al<1&&(this.ctx.globalAlpha=1)}dTile(){if(!this.hd&&0!==this.al){this.al<1&&(this.ctx.globalAlpha=this.al),this.tile.for(s=>this.dSpr(this.ctx,this.spr[0],s));for(let s=1;s<this.spr.length;s++)this.dSpr(this.ctx,this.spr[s],this.ind<<0);this.al<1&&(this.ctx.globalAlpha=1)}}dRope(){if(this.hd||0===this.al)return;this.al<1&&(this.ctx.globalAlpha=this.al),this.ctx.reset||this.ctx.resetC();let s=this.spr[0];if(this.ctx.translate(this.x,this.y),this.ang&&this.ctx.rotate(-this.ang*Math.DR),this.ctx.scale(this.scx,this.scy),this.len<s.h)this.ctx.drawImage(s[1],0,s.h-this.len,s.w,this.len,-s.x,0,s.w,this.len);else{let t=this.len-s.h;for(this.ctx.drawImage(s[1],-s.x,t);t>0;t-=32)t>=32?this.ctx.drawImage(s[0],0,0,s.w,32,-s.x,t-32,s.w,32):this.ctx.drawImage(s[0],0,32-t,s.w,t,-s.x,0,s.w,t)}this.ctx.reset=!1,this.al<1&&(this.ctx.globalAlpha=1)}dLaser(){if(this.hd&&!this.lso||0===this.al)return;this.al<1&&(this.ctx.globalAlpha=this.al),this.ctx.reset||this.ctx.resetC();let s=this.spr[0];this.ctx.translate(this.x,this.y),this.ang&&this.ctx.rotate(-this.ang*Math.DR),this.ctx.scale(this.scx,this.scy),this.lso&&this.ctx.drawImage(s[1],-s.x,0,s.w,this.h/this.scy),this.hd||this.ctx.drawImage(s[0],-s.x,0),this.ctx.reset=!1,this.al<1&&(this.ctx.globalAlpha=1)}},Core.ObjPly=class extends Core.Obj{#sc;constructor(s,t){super(s,t),$R.plyX=s,$R.plyY=t,this.#sc=1,this.pSpr=this.spr=Res.spr.pli,this.ims=.2,this.px=0,this.ctx=$R.L[7].dyn,this.ox=17,this.oy=23,this.moveSpd=3,this.maxVspd=9,this.jump1=-8.5,this.jump2=-7,this.grav=.4,this.fric=.5,this.ahspd=0,this.phspd=0,this.pvspd=0,this.onPlat=!1,this.onLadder=!1,this.onRope=null,this.meetRope=null,this.shoot=0,this.frozen=!1,$R.initPly(this),this.djump=this.jump,this.resetStatus=this.resetCol,this.clacLTRB(),this.calcBox()}calcBox(){this.V[0]=this.V[4]=this.B[0]=this.x+this._L,this.V[1]=this.V[3]=this.B[1]=this.y+this._T,this.V[2]=this.V[6]=this.B[2]=this.x+this._R,this.V[5]=this.V[7]=this.B[3]=this.y+this._B}clacLTRB(){switch(this.gravDir){case 270:this._T=-12*this.scy,this._B=9*this.scy,this._L=-5*this.#sc,this._R=6*this.#sc;break;case 90:this._T=-9*this.scy,this._B=12*this.scy,this._L=-5*this.#sc,this._R=6*this.#sc;break;case 0:this._T=-6*this.#sc,this._B=5*this.#sc,this._L=-12*this.scy,this._R=9*this.scy;break;case 180:this._T=-5*this.#sc,this._B=6*this.#sc,this._L=-9*this.scy,this._R=12*this.scy}}setGrav(s){if(s!==this.gravDir){if(this.vspd=0,this.ahspd=0,s%180==this.gravDir%180)switch(s){case 270:this.y+=4;break;case 90:this.y-=4;break;case 0:this.x+=4;break;case 180:this.x-=4}this.gravDir=s,this.ang=(s+90)%360,this.clacLTRB(),this.calcBox()}}meet(s=0,t=0,i){let h,e;switch(this.gravDir){case 270:h=s,e=t;break;case 90:h=s,e=-t;break;case 0:h=t,e=-s;break;case 180:h=-t,e=s}return $R.Col[i].meet(this,h,e,this.B[0]+h+.5<<0,this.B[1]+e+.5<<0,this.B[2]+h+.5<<0,this.B[3]+e+.5<<0)}meet0(s){return $R.Col[s].meet(this,0,0,this.B[0]+.5<<0,this.B[1]+.5<<0,this.B[2]+.5<<0,this.B[3]+.5<<0)}meet0All(s){let t=this.B[0]+.5<<0,i=this.B[1]+.5<<0,h=this.B[2]+.5<<0,e=this.B[3]+.5<<0,r=$R.Col[s].findAll(t,i,h,e),a=[];for(let s=r.length;s--;){let l=this._meet(0,0,t,i,h,e,r[s]);l&&a.push(l)}return a}com(){if(0===this.shoot&&($C.keyPrs("z")||this.conShoot&&$C.keyChk("z"))&&(Au.play("st"),this.shoot=5,new Core.ObjBlt(this.x,this.y,this.scx,this.gravDir)),this.shoot&&this.shoot--,this.hspd){let s=this.meet(this.hspd,0,24);s&&0===s.vspd&&(s.hspd=this.p2o(2*Math.sign(this.hspd),0)[0])}}step(){if(this.frozen)return;this.calcBox();let s=$C.keyChk("R")||-$C.keyChk("L");if(this.meet0(26)){let t=$C.keyChk("D")||-$C.keyChk("U");if(t&&(this.onLadder=!0),this.onLadder){if(this.spr=Res.spr.plb,this.ims=.2,this.djump=this.jump,s&&(this.scx=this.#sc*s),this.hspd=this.moveSpd*s,this.vspd=this.moveSpd*t,this.grav=0,!$C.keyPrs("J"))return this.com();this.onLadder=!1,this.grav=.4,this.vspd=0}}else this.onLadder&&(this.onLadder=!1,this.grav=.4,this.vspd=0);let t=this.meet0(27);if(t){if(!this.onRope&&this.meetRope!==t){let s=((this.x-t.x)**2+(this.y-t.y)**2)**.5<<0;s>=0&&s<=t.h&&(this.onRope=t,this.meetRope=t,this.onRopeLen=s)}if(this.onRope){this.spr=Res.spr.plb,this.ims=.2,this.djump=this.jump,s&&(this.scx=this.#sc*s),this.grav=0,this.vspd=0;let t=$C.keyChk("D")||-$C.keyChk("U"),i=this.onRope.ang*Math.DR,h=Math.sin(i),e=Math.cos(i);if(this.onRopeLen+=this.moveSpd*t,this.platMove(this.onRope.x+this.onRopeLen*h-this.x,this.onRope.y+this.onRopeLen*e-this.y),!($C.keyPrs("J")||this.onRopeLen<0||this.onRopeLen>this.onRope.h))return this.com();this.onRope=null,this.grav=.4,this.phspd=0,this.pvspd=0}}else this.meetRope=null,this.onRope&&(this.onRope=null,this.grav=.4,this.phspd=0,this.pvspd=0);let i=this.meet(0,1,2),h=0;if(!i){let s=this.meet(-1,0,19)||this.meet(1,0,19);if(s){let t=(s.ang-this.gravDir+270)%360;h=0===t?-1:180===t?1:0,h&&90===this.gravDir&&(h=-h)}}s?h&&s!==h||(this.scx=this.#sc*s,this.hspd=this.moveSpd*s,this.spr=Res.spr.plr,this.ims=.5):(this.hspd=0,this.spr=Res.spr.pli,this.ims=.2),this.adMove&&i&&($C.keyPrs("a")&&(this.hspd-=1),$C.keyPrs("d")&&(this.hspd+=1)),this.onPlat?this.meet(0,4,3)||(this.onPlat=!1):i||(this.spr=this.vspd<0?Res.spr.plj:Res.spr.plf,this.ims=.2);let e=this.meet0(5);e&&(this.vspd>2&&(this.vspd=2),49===e.obj&&(this.djump=this.jump)),this.vspd>this.maxVspd&&(this.vspd=this.maxVspd),this.com(),this.jump&&$C.keyPrs("J")&&(i||this.onPlat||this.meet(0,1,3)||e&&16===e.obj?(this.vspd=this.jump1,this.djump=this.jump,this.spr=Res.spr.plj,this.ims=.2,Au.play("jp")):(this.djump>1||e&&17!==e.obj||-1===this.djump)&&(this.vspd=this.jump2,this.djump>1&&this.djump--,this.spr=Res.spr.plj,this.ims=.2,Au.play("jp",2))),this.vspd<0&&$C.keyRls("J")&&(this.vspd*=.45),h&&(this.vspd=2,this.spr=Res.spr.plt,this.ims=.5,this.scx=this.#sc*h,($C.keyPrs("R")&&1===h||$C.keyPrs("L")&&-1===h)&&(this.ims=.2,$C.keyChk("J")?(this.spr=Res.spr.plj,this.vspd=-9,this.hspd=15*h,Au.play("wj")):(this.spr=Res.spr.plf,this.hspd=3*h)))}p2o(s,t){switch(this.gravDir){case 270:return[s,t];case 90:return[s,-t];case 0:return[t,-s];case 180:return[-t,s]}}platMove(s,t){switch(this.gravDir){case 270:this.phspd=s,this.pvspd=t;break;case 90:this.phspd=s,this.pvspd=-t;break;case 0:this.phspd=-t,this.pvspd=s;break;case 180:this.phspd=t,this.pvspd=-s}}applyMove(s,t){switch(this.gravDir){case 270:this.ahspd=s,this.vspd=t;break;case 90:this.ahspd=s,this.vspd=-t;break;case 0:this.ahspd=-t,this.vspd=s;break;case 180:this.ahspd=t,this.vspd=-s}}moveBy(s,t){switch(this.gravDir){case 270:this.x+=s,this.y+=t;break;case 90:this.x+=s,this.y-=t;break;case 0:this.y-=s,this.x+=t;break;case 180:this.y+=s,this.x-=t}}moveByB(s,t){this.moveBy(s,t),this.calcBox()}move(){if(this.frozen)return;let s=this.ind<<0;this.ind+=this.ims,this.ind>=this.spr.length&&(this.ind=0);let t=this.ind<<0!==s,i=this.B[0]+.5<<0,h=this.B[1]+.5<<0,e=this.B[2]+.5<<0,r=this.B[3]+.5<<0,a=this.meet(0,2,3);a&&(a.hsp||a.vsp)&&this.platMove(a.hsp,a.vsp),this.ahspd>0?(this.ahspd-=this.fric,this.ahspd<0&&(this.ahspd=0)):this.ahspd<0&&(this.ahspd+=this.fric,this.ahspd>0&&(this.ahspd=0)),this.hspd+=this.ahspd,this.vspd+=this.grav,this.moveBy(this.hspd+this.phspd,this.vspd+this.pvspd),this.calcBox();let l=this.meet0(2);if(l){1!==l.colS[0]&&2!==l.colS[0]&&(l.colS[0]=1,l.colO[0]=this),1!==this.colS[2]&&2!==this.colS[2]&&(this.colS[2]=1,this.colO[2]=l);let s=this.hspd+this.phspd,t=this.vspd+this.pvspd;if(this.moveByB(-s,-t),s&&this.meet(s,0,2)){for(let t=Math.sign(s),i=Math.abs(s),h=0;h<i&&!this.meet(t,0,2);h++)this.moveByB(t,0);this.ahspd=this.hspd=s=0}if(t&&this.meet(0,t,2)){for(let s=Math.sign(t),i=Math.abs(t),h=0;h<i&&!this.meet(0,s,2);h++)this.moveByB(0,s);t>0&&(this.djump=this.jump),this.vspd=t=0}(s||t)&&this.meet(s,t,2)&&(this.ahspd=this.hspd=s=0),this.moveByB(s,t)}this.phspd=0,this.pvspd=0,a=this.meet0All(3);for(let s=a.length;s--;){let t=a[s];if(t.ang%180==(this.gravDir+90)%180)switch(this.gravDir){case 270:{let s=t.B[1];if(this.y-this.vspd/2<=s){let i=t.vspd>0?t.vspd:0;this.moveByB(0,s-9-this.y),this.vspd=i,this.onPlat=!0,this.djump=this.jump}break}case 90:{let s=t.B[3];if(this.y+this.vspd/2>=s){let i=t.vspd<0?-t.vspd:0;this.moveByB(0,this.y-s-9),this.vspd=i,this.onPlat=!0,this.djump=this.jump}break}case 0:{let s=t.B[0];if(this.x-this.vspd/2<=s){let i=t.hspd>0?t.hspd:0;this.moveByB(0,s-9-this.x),this.vspd=i,this.onPlat=!0,this.djump=this.jump}break}case 180:{let s=t.B[2];if(this.x+this.vspd/2>=s){let i=t.hspd<0?-t.hspd:0;this.moveByB(0,this.x-s-9),this.vspd=i,this.onPlat=!0,this.djump=this.jump}break}}}if(this.x<0||this.y<0||this.x>=$R._r.w||this.y>=$R._r.h)return this.kill(!0);if(this.moved=i!==this.B[0]+.5<<0||h!==this.B[1]+.5<<0||e!==this.B[2]+.5<<0||r!==this.B[3]+.5<<0,this.meet0(2))return this.kill(!0);if(this.meet0(4)&&this.kill())return;if($R.plyX=this.x,$R.plyY=this.y,$C.keyPrs("s")){let s=this.meet0(7);s&&0===s.ind&&(s.ind=1.78125,s.ctx.clr=!1,$R.save())}let p=this.meet0(6);p&&(0===p.wr&&1===p.ws?(p.wx||p.wy?(this.x=p.wx,this.y=p.wy):($R._r.x||$R._r.y)&&(this.x=$R._r.x,this.y=$R._r.y),this.calcBox(),this.moved=!0):$R.warp(p.wr,p.ws,p.wx,p.wy)),this.spr!==this.pSpr&&(t=!0,this.pSpr=this.spr),(this.moved||t)&&(this.ctx.clr=!1)}kill(s=!1){this.colO.for(s=>{s&&(s.colS[0]=3,s.colO[0]=null)}),Au.play("dth");let t=new Core.ObjRun(0,400,304,11,$R._r.sprGO);Object.assign(t,$R._r.bobj.gov),t.cm=0,t.init(),t.draw=t.dGUI,t.ly.add(t),$R.addDth(),$R.player=null,this.ctx.clr=!1}draw(){let s=this.ctx;switch(this.gravDir){case 270:s.setTransform(this.scx,0,0,this.scy,this.x-s.vX,this.y-s.vY);break;case 90:s.setTransform(this.scx,0,0,-this.scy,this.x-s.vX,this.y-s.vY);break;case 0:s.setTransform(0,-this.scx,this.scy,0,this.x-s.vX,this.y-s.vY);break;case 180:s.setTransform(0,this.scx,-this.scy,0,this.x-s.vX,this.y-s.vY)}s.drawImage(this.spr[this.ind<<0],-this.ox,-this.oy),s.reset=!1}},Core.ObjBlt=class extends Core.Obj{constructor(s,t,i,h){super(s+.5<<0,t+.5<<0),this.des=40,this.spr=Res.spr.blt,this.ctx=$R.L[7].dyn,this.scx=i<0?-i:i,this.scy=this.scx,this.w=this.scx*this.spr.w+.5<<0,this.h=this.scy*this.spr.h+.5<<0;let e=this.w>>1,r=this.h>>1;switch(this.B=[s-e,t-r,s-e+this.w,t-r+this.h],$R.Col[1].obj.push(this),this.moved=!0,h){case 270:case 90:this.hspd=16*i<<0;break;case 0:this.vspd=16*-i<<0;break;case 180:this.vspd=16*i<<0}}meet(s){return $R.Col[s].meet(this,0,0,this.B[0],this.B[1],this.B[2],this.B[3])}step(){(this.meet(2)||this.meet(55)||this.meet(42))&&(this.des=0)}move(){this.B[0]+=this.hspd,this.B[1]+=this.vspd,this.B[2]+=this.hspd,this.B[3]+=this.vspd,this.V[0]=this.V[4]=this.B[0],this.V[1]=this.V[3]=this.B[1],this.V[2]=this.V[6]=this.B[2],this.V[5]=this.V[7]=this.B[3],this.ind=1-this.ind,this.des--,this.ctx.clr=!1}draw(){this.ctx.reset||this.ctx.resetC(),this.ctx.drawImage(this.spr[this.ind],this.B[0],this.B[1],this.w,this.h)}},Core.ObjPtc=class{constructor(s,t,i,h=7){this.x=s,this.y=t,this.spr=i,this.ind=0,this.w=i.w,this.h=i.h,this.angH=this.w>>1,this.angV=this.h>>1,this.ctx=$R.L[h].dyn,this._des=!1,$R.L[h].eff(this),this.al=1,this.scx=1,this.scy=1,this.ang=0,this.aspd=.1,this.xspd=0,this.yspd=0,this.hspd=0,this.vspd=0,this.grav=0,this.rot=0,this.dSpr=this.dSprN}init(){let s=1!==this.scx||1!==this.scy||this.xspd||this.yspd;this.ang||this.rot?this.dSpr=s?this.dSprEx:this.dSprAng:s&&(this.dSpr=this.dSprSc)}dSprN(s,t,i){s.reset||s.resetC(),s.drawImage(t[i],this.x-this.angH,this.y-this.angV)}dSprSc(s,t,i){let h=this.scx,e=this.scy;s.reset||s.resetC(),(Math.abs(h)<1||Math.abs(e)<1)&&(s.imageSmoothingEnabled=!0),s.drawImage(t[i],this.x-this.angH*h,this.y-this.angV*e,this.w*h,this.h*e),s.imageSmoothingEnabled&&(s.imageSmoothingEnabled=!1)}dSprAng(s,t,i){let h=this.ang*Math.DR,e=Math.cos(h),r=Math.sin(h);s.setTransform(e,-r,r,e,this.x-s.vX,this.y-s.vY),s.drawImage(t[i],-this.angH,-this.angV),s.reset=!1}dSprEx(s,t,i){let h=this.ang*Math.DR,e=Math.cos(h),r=Math.sin(h),a=this.scx,l=this.scy;(Math.abs(a)<1||Math.abs(l)<1)&&(s.imageSmoothingEnabled=!0),s.setTransform(e*a,-r*a,r*l,e*l,this.x-s.vX,this.y-s.vY),s.drawImage(t[i],-this.angH,-this.angV),s.imageSmoothingEnabled&&(s.imageSmoothingEnabled=!1),s.reset=!1}move(){this.vspd+=this.grav,this.x+=this.hspd,this.y+=this.vspd,this.al-=this.aspd,this.scx+=this.xspd,this.scy+=this.yspd,this.ang+=this.rot,(this.al<=0||this.scx<=0||this.scy<=0)&&(this._des=!0)}draw(){this.al<1&&(this.ctx.globalAlpha=this.al),this.dSpr(this.ctx,this.spr,this.ind),this.al<1&&(this.ctx.globalAlpha=1)}},Core.ObjSha=class extends Core.ObjPtc{constructor(s,t,i,h=7){super(s,t,i[0],h),this.spr=i,this.draw=Core.Obj.prototype.dNormal}static from(s){if(0===s.al||11!==s.obj&&s.hd||11===s.obj&&s.hd&&!s.lso)return;let t=new Core.ObjSha(0,0,s.spr);if(t.ind=s.ind<<0,t.scx=s.scx,t.scy=s.scy,t.ang=s.ang,t.draw=s.draw,s.ang){let i=s.scx,h=s.scy,e=s.x+(s.angH-s.spr[0].x)*i,r=s.y+(s.angV-s.spr[0].y)*h,a=s.ang*Math.DR,l=Math.cos(a),p=Math.sin(a);t.x=e+l*i*(t.angH-s.angH)+p*i*(t.angV-s.angV),t.y=r-p*h*(t.angH-s.angH)+l*h*(t.angV-s.angV)}else t.x=s.x+(t.angH-s.spr[0].x)*s.scx,t.y=s.y+(t.angV-s.spr[0].y)*s.scy;return s.tile?t.tile=s.tile:11===s.obj?(t.lso=s.lso,t.h=s.h):22===s.obj&&(t.len=s.len),t}};