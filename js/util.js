var Ipc={f:{},fin(e,t){this.f[e]?.(t,e),delete this.f[e]},send(e,t){console.log(t?e+":"+t:e)},dl(e,t,s,r,n=15e3){if("string"==typeof e){this.send("dl",JSON.stringify([e,t,s]));let o=setTimeout(()=>Ipc.fin(t,0),n);this.f[t]=(e,t)=>{clearTimeout(o),r(e,t)}}else{let n=URL.createObjectURL(e);$M.openURL(n,0,s+t),this.f[t]=e=>{URL.revokeObjectURL(n),r(e)}}},read(e,t,s){window._ipc.rd(e,t,s)},open(e){U$&&App.jump(JSON.parse($S.sget("args").replace(/\\/g,"\\\\")),e)},close(e=1){return this.on||(this.on=1,this.beforeClose?.(),e||this.closeMsg?UI.confirm(this.closeMsg||"0{1w}",1).then(e=>{e.i?this.on=0:this.send("close")}):this.send("close")),0},zip:window._ipc?.zip,cache(e){this.f.cache=e,this.send("cache")}};{let e=Array.prototype;e.for=function(e){for(let t=0,s=this.length;t<s;t++)e(this[t],t)},e.forv=function(e){for(let t=this.length;t--;)e(this[t])},e.bIns=function(e){let t=0,s=this.length;for(;t<s;){let r=t+s>>1;if(e===this[r])return;e>this[r]?t=r+1:s=r}this.splice(t,0,e)};let t=HTMLElement.prototype;t.ap=function(...e){return e.for(e=>this.append(e)),e[0]},t._c=function(...e){return e.for(e=>this.append(e)),this},t.tx=function(e){return this.innerText=e,this},t.hC=function(e){return this.classList.contains(e)},t.aC=function(e){this.classList.add(e)},t.rC=function(e){this.classList.remove(e)},t.pS=function(e=1){let t=this;for(;e--;)t=t.previousSibling;return t},t.nS=function(e=1){let t=this;for(;e--;)t=t.nextSibling;return t},t._h=function(){this.style.display="none"},t._s=function(){this.style.display=""},Object.defineProperties(t,{ch:{get(){return this.children}},pN:{get(){return this.parentNode}}})}const doc=document,$=e=>doc.getElementById(e),$c=(e,t=doc)=>[...t.getElementsByClassName(e)],$t=(e,t=doc)=>[...t.getElementsByTagName(e)],El=(e,t,s)=>{let r=doc.createElement(e);return t&&(r.className=t),s&&Object.assign(r,s),r},css=(e,t,s=-1,r)=>{if(e.style)Object.assign(e.style,t);else for(let n=e.length;n--;)Object.assign(e[n].style,n===s?r:t)},ac=(e,t="")=>css(e,{color:t,pointerEvents:""}),dac=(e,t="#aaa")=>css(e,{color:t,pointerEvents:"none"}),docReady=new Promise(e=>doc.fonts.ready.then(()=>{css($("wrap"),{opacity:1,pointerEvents:"auto"}),setTimeout(()=>{e(),new FontFace("emoji","url(/res/NotoColorEmoji.otf),url(/res/NotoColorEmoji.ttf)").load().then(e=>doc.fonts.add(e))},500)})),$M=Object.freeze({p:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA",w:"data:image/webp;base64,UklGR",c:e=>e.includes("data:")?"-"===e[0]?e.slice(1):e:"-"===e[0]?$M.p+e.slice(1):$M.w+e,m:e=>"p"===e[11]?"-"+e.replace($M.p,""):e.replace($M.w,""),id(e,t,s="0"){let r="";for(;e>=1;)r="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ@%"[e%64<<0]+r,e/=64;return t?r.padStart(t,s):r},rid(e=10){return this.id(Date.now(),e,this.id(3e5*Math.random(),1))},task(e,t=1){scheduler.postTask(e,{priority:["user-blocking","user-visible","background"][t]})},eq:(e,t)=>JSON.stringify(e)===JSON.stringify(t),cp(e){if(Array.isArray(e)){const t=[];for(let s=0;s<e.length;s++)"object"==typeof e[s]&&null!==e[s]?t[s]=$M.cp(e[s]):t[s]=e[s];return t}if("object"==typeof e&&null!==e){const t={};for(let s in e)"object"==typeof e[s]&&null!==e[s]?t[s]=$M.cp(e[s]):t[s]=e[s];return t}throw"Error Type"},freeze(e){if(Array.isArray(e))for(let t=0;t<e.length;t++)"object"==typeof e[t]&&null!==e[t]&&$M.freeze(e[t]);else for(let t in e)"object"==typeof e[t]&&null!==e[t]&&$M.freeze(e[t]);return Object.freeze(e)},b2u6(e){return e>64&&e<91?e-65:e>96&&e<123?e-71:e>47&&e<58?e+4:43===e?62:47===e?63:0},b2u8(e){let t=e.replace(/[^A-Za-z0-9\+\/]/g,""),s=t.length,r=3*s+1>>>2,n=new Uint8Array(r);for(let e,o,i=0,a=0,l=0;l<s;l++)if(o=3&l,i|=this.b2u6(t.charCodeAt(l))<<18-6*o,3===o||s-l==1){for(e=0;e<3&&a<r;e++,a++)n[a]=i>>>(16>>>e&24)&255;i=0}return n},b2b(e){return new Blob([this.b2u8(e)])},u2b(e){return new Blob([this.b2u8(e.split(",")[1])],{type:e.split(";")[0].slice(5)})},read(e,t="DataURL"){return new Promise((s,r)=>{let n=new FileReader;n["readAs"+t](e),n.onload=()=>s(n.result),n.onerror=r})},openURL(e,t,s){let r=doc.body.ap(El("a"));r.href=e,r._h(),t&&(r.target="_blank"),s&&(r.download=s),r.click(),r.remove()},xhr(e,t,s,r=null,n=30){return new Promise((o,i)=>{let a=new XMLHttpRequest;s&&(a.responseType=s),a.open(e,t),"POST"===e&&a.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),a.timeout=1e3*n,a.onload=()=>{a.status>399?(a.err=`${e} ${t} ERR_CODE: ${a.status}`,i(a)):o(a)},a.onerror=()=>{a.err=`Failed to ${e} ${t}`,i(a)},a.ontimeout=()=>{a.err=`${e} ${t} timeout`,i(a)},a.send(r)})},escTxt:(e,t)=>(t&&(e=e.replace("#","%23")),e.replaceAll("&","&amp;").replaceAll("<","&lt;")),reg:{email:/^[^@\s]+@[^@\s]+\.\w+/},async html2img(e,t,s){const r=new Image;return r.src=`data:image/svg+xml;utf-8,<svg xmlns='http://www.w3.org/2000/svg' width='${t}' height='${s}'><foreignObject x='0' y='0' width='${t}' height='${s}'><div xmlns='http://www.w3.org/1999/xhtml'>${e.replaceAll("#","%23")}</div></foreignObject></svg>`,await r.decode(),r}});Math.mM=function(e,t,s){return this.max(t,this.min(s,e))},Date.pad=e=>(e<10?"0":"")+e,Date.cD=e=>{if("number"==typeof e)e=new Date(e);else if(!e?.getDay)return e;return`${e.getFullYear()}-${Date.pad(e.getMonth()+1)}-${Date.pad(e.getDate())} ${Date.pad(e.getHours())}:${Date.pad(e.getMinutes())}`},Date.cT=e=>`${Date.pad(e/3600<<0)}:${Date.pad((e/60<<0)%60)}:${Date.pad(e%60)}`;const $S=Object.freeze({get(e,t=!0){let s=(t?localStorage:sessionStorage).getItem(e);return"0"===s||"1"===s?s<<=0:"undefined"===s?s=void 0:"null"===s&&(s=null),s},set(e,t,s=!0){"boolean"==typeof t&&(t<<=0),(s?localStorage:sessionStorage).setItem(e,t)},rm(e,t=!0){(t?localStorage:sessionStorage).removeItem(e)},sget(e){return this.get(e,0)},sset(e,t){return this.set(e,t,0)},srm(e){return this.rm(e,0)}}),CDN_BASE="https://cdn.jsdelivr.net/gh/vicklleall/ciw",CDN_LATEST=CDN_BASE+"/",SERVER_URL="https://api.ciw.vicklleall.com:1338/",App={cV(e){const t=e.split("."),s=$S.get("version").split(".");for(let e=0;e<3;e++){let r=0|t[e],n=0|s[e];if(r<n)break;if(r>n)return!0}return!1},chkUpd(e,t){const s=()=>UI.confirm("0{1x}",1,"是","否").then(t=>{t.i?($S.set("update",1),e(2)):e(1)});DB.Cloud.run("version",{v:$S.get("app")},null).then(t=>{$S.sset("lastCheck",Date.now()),$S.srm("offline"),$S.get("version")===t?($S.rm("update"),e(0)):s()},e=>{9===e.code?($S.sset("lastCheck",Date.now()),$S.srm("offline"),s()):t?t(e):DB.err(e)})},dlupd(){let e=$("l");e.tx("0{1y}"),$M.xhr("GET",SERVER_URL+"s/update.json","json").then(t=>{const s=t.response,r=CDN_BASE+"@"+s.build+"/";delete s.build,App.upd=0;for(let t in s)this.cV(s[t])&&(App.upd++,Ipc.dl(`${999==s[t]?r:CDN_LATEST}app/${t}`,t,2,t=>{t?0==--App.upd&&($S.rm("update"),e.className="",e.tx("0{1z}").style.width="auto",setTimeout(()=>{Ipc.f._u=e=>{UI.$a("0{20}")},Ipc.send("update")},1e3)):App.upd>0&&(App.upd=-1,App.updfail())}))}).catch(e=>{console.err(e.err),App.updfail()})},updfail(){let e=$("l");e.className="",e.tx("0{21}").style.width="auto",UI.$a("0{21}0{22}").then(()=>window.open("https://ciw.vicklleall.com/"))},config:{app:{rmb:1,msgPush:1},edit:{gridOpacity:.5,undoDepth:50,showInvis:1,autoSpk:0,start:0,autoSave:0},run:{vol:50,fps:60,smooth:1}},gC(e,t){return this.config[e][t]},sC(e,t,s){this.config[e][t]=s,this.saveConf(e)},loadConf(e){try{return JSON.parse($S.get(e+"Conf"))}catch{return null}},saveConf(e){$S.set(e+"Conf",JSON.stringify(this.config[e]))},getStorage(){try{this.stor=JSON.parse($S.get("storage"))??{}}catch{this.stor={}}},setStorage(e,t){this.stor[e]=t,$S.set("storage",JSON.stringify(this.stor))},addStorage(e,t){let s=(this.stor[e]??0)+t;this.setStorage(e,s)},hasMenu:"/"!==location.pathname&&"/update"!==location.pathname&&!location.pathname.startsWith("/runner"),setDarkMode(e,t=!0){let s=doc.body;s.className=e?"dark":"",t&&$S.set("theme",s.className),this.hasMenu&&$c("setpage",UI.menu)[1].set()},isFscr(e=!0){return e?$S.sget("fullscreen"):this._fscr},zoomWin(){if(this._fscr){let e=location.pathname;if(!e.startsWith("/doc")){let[t,s]=$S.sget("screen").split(","),r=1440,n=810;e.startsWith("/runner")&&(r=800,n=608),doc.body.style.zoom=Math.min(t/r,s/n)}}else doc.body.style.zoom=this._sc},setFscr(e=!0){let t=!this.isFscr(e);e&&$S.sset("fullscreen",t),this._fscr=t,t?Ipc.f.fscr=e=>{$S.sset("screen",e),App.zoomWin()}:this.zoomWin(),Ipc.send("fscr"),this.hasMenu&&$c("setpage",UI.menu)[1].set()},setWinSc(e,t=!0){this.isFscr(t)&&this.setFscr(t),t&&$S.set("zoom",e),this._sc=e,Ipc.send("sc",e),this.hasMenu&&$c("setpage",UI.menu)[1].set(),doc.body.style.zoom=e},initWin(){doc.body.className=$S.get("theme")??"",this._fscr=this.isFscr(),this._sc=$S.get("zoom")||1,this.zoomWin()},jump(e,t){for(let t of e.slice(1))if(/.+\.ciwp$/.test(t))return void("/make"===location.pathname?$E.open("_"+t):LOC("make?_"+encodeURIComponent(t),1));t&&LOC("home",1)},help(e){window.open(`/doc?${_lang}#${e??""}`)}};for(let e in App.config)Object.assign(App.config[e],App.loadConf(e));App.getStorage(),App.initWin();const $U={Lv:[0,10,25,40,60,90,120,160,200,250,300,360,420,480,540,600,660,720,800,900,1e3],getLv(e){let t=this.Lv;for(let s=0;s<t.length;s++)if(e>=t[s]&&e<(t[s+1]??Infinity))return[s,e-t[s],t[s+1]-t[s]||"??"]},getUsername(e,t){t||(t=El("div"));let s=e.get("w");return t.innerHTML=s?UI.ico("m-"+s.split(",")[0]):"",css(t.ap(El("span").tx(e.getUsername())),{userSelect:"text",marginLeft:(s?4:0)+"px"}),t},getUID(e){let t=El("div");return t.style.color="#789",t.ap(UI.span("UID:")),css([t.ap(UI.span(e)),t.ap(UI.copy(e))],{marginLeft:"4px"}),t},showUser(e){DB.Q(DB.User).select(["username","e","w","a","c"]).get(e).then(e=>{let t=El("div","rl"),s=t.ap(El("div","avatar")),r=t.ap(El("div","userInfo")),n=e.get("e"),o=e.get("a");o&&CIW.fetch(o.id,"UserAvatar","avatar").then(e=>s.style.background=`url(${e.d})`),r.ap(this.getUsername(e),this.getUID(e.id),UI.span(`0{23}${this.getLv(n)[0]} `),UI.span(`0{24} ${n} `),UI.span(`0{25} ${e.get("c")} `)),new UI.M(320).h("0{26}").ap(t).cb()})},chkName(e){if(e.length<2||e.length>20)return"0{27}";let t=e.match(/\d+/);if(t&&t[0]===e)return"0{28}";if(e.includes("@"))return"0{29}";if(["ciw","cloudiwanna","cloud i wanna"].includes(e.toLowerCase()))return"0{2a}";for(let t=0;t<e.length;t++)if(e.codePointAt(t)>65535)return"0{2b}"},pwDiag(e,t,s="",r="",n=""){new UI.M(400).t("0{2c}0{2d}").t("0{2e}").ip(s,"password").t("0{2f}").ip(r,"password").t("0{2g}").ip(n).b("0{5}","0{6}").then(function(s){if(s.i)return;let r,n=$t("input",this.box),o=$c("btn",this.box)[0];25!==n[2].value.length&&(r="0{2h}"),n[0].value!==n[1].value&&(r="0{2i}"),(n[0].value.length<6||n[0].value.length>16)&&(r="0{2j}");let i=n.map(e=>e.value);if(r)return UI.$a(r).then(()=>$U.pwDiag(e,t,...i));o.aC("gray");const a=s=>{let r=new URL(s.responseURL).searchParams,n=r.get("error");!n&&r.has("username")?($S.srm("p:"+e),UI.$a("0{2k}").then(()=>{"/login"!==location.pathname&&LOC("login")})):UI.$a(n.endsWith("invalid")?"0{2l}/0{2m}":"0{2n}").then(()=>$U.pwDiag(e,t,...i)),o.rC("gray")};$M.xhr("POST",DB.serverURL+"/apps/ciw-api/request_password_reset",0,`token=${encodeURIComponent(i[2])}&username=${encodeURIComponent(t)}&new_password=${encodeURIComponent(i[0])}`).then(a,a)})},resetPw(e){const t=e=>{console.error(e),UI.$a("0{2o}")};DB.Q(DB.User).equalTo("email",e).select("username").first().then(s=>{if(!s)return UI.$a("0{2p}");const r=s.get("username");Date.now()<$S.sget("p:"+e)?this.pwDiag(e,r):DB.User.requestPasswordReset(e).then(()=>{$S.sset("p:"+e,Date.now()+9e5),this.pwDiag(e,r)},t)}).catch(t)}};