$E.ThmLib={thm:El("div"),spr:El("div"),sprSrc:null,cid(t){let e=t.id.slice(0,-t.c.length);if(10!==e.length&&isNaN(Number(e)))throw"Error id";return e.length<10?Number(e):e},pv(t,e,s=32,r=32,i){let h=El("div","thm"),a=h.ap(El("div","thm-pv"));return css(a,{width:s+"px",height:r+"px"}),"string"==typeof e?css(a,{width:s+"px",height:r+"px",background:`url(${CDU(e)}),var(--bg32)`}):e.onload=()=>{let s,r,i=1;if("bg"===t.c)s=800,r=608,i=.25;else for(s=e.width/(t.n??1),r=e.height;s*i>256||r*i>152;)i/=2;css(a,{width:s+"px",height:r+"px",background:`url(${CDU(e.currentSrc)}),var(--bg32)`,zoom:i})},i?(h.ap(El("p").tx(i)),h.onclick=()=>{let e=$("thmSrc");e&&(e.id=""),this.thmSrc=t,h.id="thmSrc"}):(h.style.lineHeight=0,h.onclick=()=>{let e=$("thmSrc");e&&(e.id=""),this.sprSrc=this.cid(t),h.id="thmSrc"}),h},init(){["游戏中","资源库","收藏"].for(t=>this.thm.ap(El("div","setcat").tx(t),El("div","setpage"))),["游戏中","资源库","收藏","本地"].for(t=>this.spr.ap(El("div","setcat").tx(t),El("div","setpage"))),this.thm.style.height=this.spr.style.height="380px",UI.bindCat(this.thm),UI.bindCat(this.spr);let t=$c("setpage",this.thm);css(t,{bottom:"64px"}),t[0].set=()=>{t[0].innerHTML="",$E._R.for(e=>{let s=t[0].ap(El("div","thm").tx(e.name));s.onclick=()=>{let t=$("thmSrc");t&&(t.id=""),s.id="thmSrc",this.thmSrc={o:e.spr,c:e.col,b:e.bg}}})},t[1].set=()=>{this.thm.loaded||CIW.find("thm").then(e=>{let s=new Date(0);e.for(e=>{t[1].ap(this.pv(e,e.p,64,64,e.n));let r=new Date(e.createdAt);r>s&&(s=r)}),this.thm.loaded=!0,DB.Q("Theme").equalTo("s",0).greaterThan("createdAt",s).find().then(e=>e.for(e=>{let s=e.toJSON();s.id=s.objectId,delete s.objectId,delete s.ACL,delete s.updatedAt,t[1].ap(this.pv(s,s.p,64,64,s.n)),CIW.put("thm",s)}))})};let e=$c("setpage",this.spr);css(e,{bottom:"64px"}),this.spr.loaded={},e[0].set=()=>{e[0].innerHTML="",$E._R.for(t=>{let s=e[0].ap(El("div","thm").tx(t.name));s.onclick=()=>{let e=$("thmSrc");e&&(e.id=""),s.id="thmSrc",this.sprSrc=t.spr[Res.sprList.findIndex(t=>t.s===this.cSpr)]}})},e[1].set=()=>{e[1].opened||(e[1].innerHTML="",CIW.find("img","c="+this.cSpr).then(t=>{let s=[];if(t.for(t=>{if(t.t)e[1].ap(this.pv(t,t.d));else{let s=new Image;e[1].ap(this.pv(t,s)),s.src=t.d}s.push(this.cid(t))}),e[1].opened=!0,this.spr.loaded[this.cSpr])return;let r=this.cSpr;DB.Cloud.run("spr",{c:r}).then(t=>{if("bg"===r)for(let e=0;e<25;e++)t.push(e);t.for(t=>{s.includes(t)||Res.dlImg(t,r).then(([t,s])=>{if(t.t)e[1].ap(this.pv(t,t.d));else{let r={width:s.width,height:s.height,currentSrc:t.d};e[1].ap(this.pv(t,r)),r.onload()}})})}),this.spr.loaded[this.cSpr]=!0}))},e[3].ap(UI.B("选择本地图片").on(()=>UI.file("image/*","DataURL").then(([t])=>{let s=new Image;"bg"===this.cSpr?s.onload=async()=>{if(s.width>800||s.height>608)return UI.alert("图片大小不超过800×608");let r=this.drawPv(s.width,s.height,s),i=r.toDataURL("image/webp",1);if(t.length>>10>160&&i.length>>10>160)return UI.alert("图片文件过大，请尝试压缩（推荐使用tinypng.com）");{let h=await this.sim(s,"bg");-1===h?(e[3].lastChild.innerHTML="",e[3].lastChild.ap(r),this.sprSrc={d:i.length<t.length?i:t}):UI.confirm("画风库中存在相似/相同图片，是否使用？").then(t=>{t.i||(this.sprSrc=h,this.spr.nS().firstChild.click())})}}:s.onload=async()=>{let r=Lib.spr[this.cSpr],i=r.w*(r.n??1),h=r.W*(r.n??1),a=s.height;if((r.d?s.width%i!=0||s.width/i>20:r.w&&s.width!==i||r.W&&s.width>h)||r.h&&a!==r.h||r.H&&a>r.H||r.t&&!(32===s.width&&32===s.height||32===s.width&&64===s.height||64===s.width&&64===s.height||160===s.width&&128===s.height))return UI.alert("图片尺寸不符");i=r.n?s.width/r.n:r.w??s.width;let l=await this.sim(s,this.cSpr,i,a);if(-1!==l)return UI.confirm("画风库中存在相似/相同图片，是否使用？").then(t=>{t.i||(this.sprSrc=l,this.spr.nS().firstChild.click())});e[3].lastChild.innerHTML="";let d=e[3].lastChild.ap(this.drawPv(s.width,a,s)).ctx;if(this.sprSrc={c:this.cSpr,d:t,n:r.n??s.width/i,p:!!r.p,s:r.s??0,t:!!r.t,x:-1===r.x?i>>1:r.x||0,y:-1===r.y?a>>1:r.y||0},r.d&&this.sprSrc.n>1&&(this.sprSrc.s=8),!r.t){let t;if(r.b)t=[...r.b];else{t=[i,a,0,0];for(let e=0;e<this.sprSrc.n;e++){let s=d.getImageData(e*i,0,i,a).data;for(let e=0;e<a;e++)for(let r=0;r<i;r++)s[4*(e*i+r)+3]>80&&(r<t[0]&&(t[0]=r),r>t[2]&&(t[2]=r),e<t[1]&&(t[1]=e),e>t[3]&&(t[3]=e))}t[2]+=1-t[0],t[3]+=1-t[1]}(t[0]||t[1]||t[2]<i||t[3]<a)&&(this.sprSrc.b=t),this.showPro(e[3].lastChild,i,a)}},s.src=t})),UI.span("注 - 子图数量: 1，子图大小: 宽32px，高32px"),El("div","rl a-cen")),e[3].lastChild.style.marginTop="16px",e[3].set=()=>{if(e[3].lastChild.innerHTML="","bg"===this.cSpr){let t=$E._r.bg;return e[3].ch[1]._h(),void e[3].lastChild.ap(this.drawPv(t.i.width,t.i.height,t.i))}e[3].ch[1]._s();let t=Lib.spr[this.cSpr],s=Res.spr[this.cSpr].src,r=s.width,i=s.height,h="小于"+t.W,a="小于"+t.H;t.w&&(h=t.w),t.h&&(a=t.h),e[3].ch[1].tx(t.t?"注 - 贴图大小: 32×32、32×64、64×64、160×128)":`注 - 子图数量: ${t.d?"小于20":t.n??1}，子图大小: 宽${h}px，高${a}px`),e[3].lastChild.ap(this.drawPv(r,i,s)),t.t||this.showPro(e[3].lastChild,r/Res.spr[this.cSpr].length,i)}},dct(t,e){let s=[],r=[],i=[];for(let t=0;t<e;t++)for(let r=0;r<e;r++)s[t+r*e]=(t?Math.sqrt(2/e):Math.sqrt(1/e))*Math.cos((r+.5)*Math.PI*t/e);for(let h=0;h<2;h++){for(let i=0;i<e;i++)for(let a=0;a<e;a++){r[2*(i+a*e)+h]=0;for(let l=0;l<e;l++){let d;if(h)d=t[4*(i+l*e)+3];else{let s=4*(i+l*e);d=(Math.min(t[s],t[s+1],t[s+2])+Math.max(t[s],t[s+1],t[s+2]))/2}r[2*(i+a*e)+h]+=s[l+a*e]*d}}for(let t=0;t<e;t++)for(let a=0;a<e;a++){i[2*(t+a*e)+h]=0;for(let l=0;l<e;l++)i[2*(t+a*e)+h]+=r[2*(l+a*e)+h]*s[l+t*e]}}return i},hash(t,e){let s=this.dct(t.getImageData(0,0,e,e).data,e),r=[],i=[],h=0,a=0;for(let t=0;t<10;t++)for(let i=0;i<10;i++){if(t+i>10)continue;let a=s[2*(t+i*e)];h+=a,r.push(a)}h/=r.length;for(let t=r.length;t--;)r[t]=r[t]>h;for(let t=0;t<5;t++)for(let r=0;r<5;r++){if(t+r>=5)continue;let h=s[2*(t+r*e)+1];a+=h,i.push(h)}a/=i.length;for(let t=i.length;t--;)i[t]=i[t]>a;let l=r.concat(i);for(;l.length%5;)l.push(0);let d="";for(let t=0;t<l.length;t+=5)d+=(l[t]<<4|l[t+1]<<3|l[t+2]<<2|l[t+3]<<1|l[t+4]).toString(32);return d},bgHash:["laaklak58gk99ai2","laa5lah58gh93ai2","gm96hmp56mlbbai2","laa0h8o40gg91ai2","ss32o00620o1hg32","l8dat26nq1r0pai2","ha8gnaj56gk19ai2","laagl8k5agk93ai2","j6c6io5kp5tj3ai2","laalkak50kk93ai2","ljb0dkgs6tnr3ai2","laahl8g48gg93ai2","laakl2kc2gkbbai2","laaklal58gk99ai2","lb8qkcl52llbbai2","laallaldallbbai2","laakl8k58kk9bai2","laekham48gh1bai2","laall8l58glb3ai2","l6a0k2k500k1bai2","n204m01500k11ai2","jacgg004g0g11ai2","laakl8k5agg91ai2","laaklakdakkb3ai2","laal5ikd3jnfbai2"],sim(t,e,s,r){let i=El("canvas",0,{width:32,height:32}).getContext("2d");i.imageSmoothingEnabled=!0,i.imageSmoothingQuality="high",s?i.drawImage(t,0,0,s,r,0,0,Math.min(32,s),Math.min(32,r)):i.drawImage(t,0,0,Math.min(32,t.width),Math.min(32,t.height));let h=this.hash(i,32);return new Promise((t,s)=>{if("bg"===e){let e=this.bgHash.indexOf(h);if(-1!==e)return t(e)}DB.Q("Sprite").equalTo("h",h).equalTo("c",e).select([]).first().then(e=>t(e?e.id:-1),e=>t(-1))})},async save(t){let e=DB.O("Sprite");return t.b&&e.set("b",t.b),e.set("c",t.c),e.set("d",t.d.replace(PNG,"")),t.n>1&&e.set("n",t.n),t.p&&e.set("p",!0),t.s&&e.set("s",t.s),t.x&&e.set("x",t.x),t.y&&e.set("y",t.y),await e.save()},drawPv(t,e,s){let r=El("canvas","thm-cv",{width:t,height:e}),i=1;if(t>640||e>320)for(;t*i>640||e*i>320;)i/=2;else if(t<256&&e<100)for(;t*i<256&&e*i<100;)i+=1;return r.ctx=r.getContext("2d"),r.img=s,r.ctx.drawImage(s,0,0),r.style.zoom=i,r},drawMask(t,e,s){t.ctx.clearRect(0,0,t.width,t.height),t.ctx.drawImage(t.img,0,0),t.ctx.fillStyle="#f0f4";for(let r=0;r<t.width;r+=e)t.ctx.fillRect(r+s[0],s[1],s[2],s[3])},showPro(t,e,s){let r,i=1,h=0,a=0;if(this.sprSrc){let l=this.sprSrc;l.n&&(i=l.n),l.p&&(h=1),l.s&&(a=l.s),r=l.b??[0,0,e,s],ac(t)}else{let e=Res.spr[this.cSpr];i=e.length,e.px&&(h=1),e.ims&&(a=e.ims),r=[e.bL,e.bT,e.boxW,e.boxH],dac(t)}const l=r=>{r[0]||r[1]||r[2]<e||r[3]<s?this.sprSrc.b=r:delete this.sprSrc.b,this.drawMask(t.firstChild,e,r)};t.ap(El("br"),UI.span(`子图数量: ${i}，子图大小: ${e}×${s}，`),UI.I("动画帧间隔",{m:1,M:500,value:a}).on(t=>this.sprSrc&&(this.sprSrc.s=t)),El("br"),UI.S("精确碰撞",h,1).on(t=>this.sprSrc&&(this.sprSrc.p=t)),UI.I("，碰撞盒: 左",{m:0,M:e-1,value:r[0]}).on(r=>{let i=this.sprSrc.b??[0,0,e,s],h=i[0]-r;i[0]=r,i[2]+=h,t.ch[8].set(i[2]),l(i)}),UI.I("上",{m:0,M:s-1,value:r[1]}).on(r=>{let i=this.sprSrc.b??[0,0,e,s],h=i[1]-r;i[1]=r,i[3]+=h,t.ch[9].set(i[3]),l(i)}),UI.I("宽",{m:1,M:e,value:r[2]}).on(r=>{let i=this.sprSrc.b??[0,0,e,s];i[2]=r,r+i[0]>e&&t.ch[8].set(i[2]=e-i[0]),l(i)}),UI.I("高",{m:1,M:s,value:r[3]}).on(r=>{let i=this.sprSrc.b??[0,0,e,s];i[3]=r,r+i[1]>s&&t.ch[9].set(i[3]=s-i[1]),l(i)})),a||t.ch[3]._h(),t.ch[5].style.marginRight=0},show(){let t=new UI.M(800,466).h("画风库").cb().ap(this.thm).b("确定","取消");this.thm.firstChild.onclick();let e=$("thmSrc");e&&(e.id=""),t.then(t=>{if(t.i)return $E.ThmLib.thmSrc=null;$E.ThmLib.setThm()})},showSpr(t){let e=new UI.M(800,466).h("画风库").cb();if(e.ap(this.spr),e.b("确定","取消"),this.cSpr=t,"bg"!==t){let e=$E._r.spr[Res.sprList.findIndex(e=>e.s===t)];this.sprSrc="object"==typeof e?e:null}$c("setpage",this.spr).for(t=>t.opened=!1),this.spr.firstChild.onclick(),e.then(t=>{if(t.i)return $E.ThmLib.sprSrc=null;$E.ThmLib.setSpr()})},setThm(){this.thmSrc&&$E.loadTh({spr:"object"==typeof this.thmSrc.o?this.thmSrc.o:this.thmSrc.o.match(/-|[^-]{10}/g).map((t,e)=>"-"===t?Lib.thm[e]:t),col:this.thmSrc.c,bg:this.thmSrc.b})},setSpr(){if(null===this.sprSrc||void 0===this.sprSrc)return;if("bg"===this.cSpr){let t={id:this.sprSrc,m:$E._r.bg.m,g:$E._r.bg.g};return dac($("box"),""),Res.loadBg(t,1).then(t=>{$E._r.setBg(t),$E._r.drawBg(),$("loading")._h(),ac($("box"))},Res.fail)}let t=Res.sprList.findIndex(t=>t.s===this.cSpr);Res.loadSpr(this.cSpr,this.sprSrc,$E.tileCol.col).then(e=>{$E._r.spr[t]=this.sprSrc,$E.drawThn($("tile").spr[this.cSpr],e),$E.sfO.redraw()})},drawThm(){let t=El("canvas",0,{width:64,height:64}).getContext("2d",{alpha:!1,depth:!1,stencil:!0});switch(t.drawImage($E.sfB.canvas,352,288,128,128,0,0,64,64),t.drawImage(Res.spr.spk[0],32,32,16,16),t.drawImage(Res.spr.pf[0],48,32,16,Res.spr.pf.h/2),t.drawImage(Res.spr.wp[0],48,0,16,16),Res.spr.blk.length){case 1:t.drawImage(Res.spr.ply[0],0,32,16,16),t.drawImage(Res.spr.sp[0],16,32,16,16),t.drawImage(Res.spr.chr[0],27.5,10,10.5,12),t.drawImage(Res.spr.blk[0],0,48,16,16),t.drawImage(Res.spr.blk[0],16,48,16,16),t.drawImage(Res.spr.blk[0],32,48,16,16),t.drawImage(Res.spr.blk[0],48,48,16,16);break;case 2:t.drawImage(Res.spr.ply[0],0,16,16,16),t.drawImage(Res.spr.sp[0],16,16,16,16),t.drawImage(Res.spr.chr[0],35.5,10,10.5,12),t.drawImage(Res.spr.blk[0],0,32,16,16),t.drawImage(Res.spr.blk[0],16,32,16,16),t.drawImage(Res.spr.blk[1],0,48,16,16),t.drawImage(Res.spr.blk[1],16,48,16,16),t.drawImage(Res.spr.blk[0],32,48,16,16),t.drawImage(Res.spr.blk[0],48,48,16,16);break;case 4:t.drawImage(Res.spr.ply[0],0,32,16,16),t.drawImage(Res.spr.sp[0],16,32,16,16),t.drawImage(Res.spr.chr[0],27.5,10,10.5,12),t.drawImage(Res.spr.blk[0],0,48,16,16),t.drawImage(Res.spr.blk[1],16,48,16,16),t.drawImage(Res.spr.blk[1],32,48,16,16),t.drawImage(Res.spr.blk[0],48,48,16,16);break;case 20:t.drawImage(Res.spr.ply[0],0,16,16,16),t.drawImage(Res.spr.sp[0],16,16,16,16),t.drawImage(Res.spr.chr[0],35.5,10,10.5,12),t.drawImage(Res.spr.blk[5],0,32,16,16),t.drawImage(Res.spr.blk[6],16,32,16,16),t.drawImage(Res.spr.blk[9],0,48,16,16),t.drawImage(Res.spr.blk[11],16,48,16,16),t.drawImage(Res.spr.blk[3],32,48,16,16),t.drawImage(Res.spr.blk[2],48,48,16,16),t.drawImage(Res.spr.blk[17],16,48,16,16)}let e=c.toDataURL(),s=c.toDataURL("image/webp",1);return s.length<e.length?s:e},async saveThm(t,e,s=[]){let i=DB.O("Theme"),h="";i.set("n",e),i.set("p",MDU(this.drawThm())),t.col&&"{}"!==JSON.stringify(t.col)&&i.set("c",t.col),i.set("t",s);for(let e=0;e<t.spr.length;e++){let s=t.spr[e];s===Lib.thm[e]?h+="-":h+="object"==typeof s?(await this.save(s)).id:s}return i.set("o",h),"object"==typeof t.bg.id&&(t.bg.id=(await this.save({c:"bg",d:MDU(r.bg.id.d)})).id),i.set("b",t.bg),await i.save()}},$E.ThmLib.init();