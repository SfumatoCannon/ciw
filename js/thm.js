$E.ThmLib={thm:El("div"),spr:El("div"),detail:El("div","ab"),sprSrc:null,cid(t){let e="_"===t.id[0]?t.id:t.id.slice(0,-t.c.length);if(10!==e.length&&isNaN(Number(e)))throw"Error id";return e.length<10?Number(e):e},pv(t,e,i,s,a){let r=El("div","thm"),l=r.ap(El("div","thm-pv"));l.id="pv-"+t.id,r._h();let h=new Image;return h.src=$M.c(e),h.onload=()=>{let e=1;if("bg"===t.c)i=800,s=608,e=.25;else for(i=t.t?i??32:h.width/(t.n??1),s=t.t?s??32:h.height;i*e>256||s*e>152;)e/=2;r._s(),css(l,{width:i+"px",height:s+"px",background:`url(${h.currentSrc}),var(--bg32)`,zoom:e})},a?(r.ap(El("p").tx(a)),r.onclick=()=>{let e=$("thmSrc");e&&(e.id=""),this.thmSrc=t,r.id="thmSrc"}):("_"===t.id[0]?r.ap(El("p")).ap(UI.span(UI.ico("trash"))).onclick=e=>{e.stopPropagation(),UI.confirm("0{76}").then(e=>{e.i||(Res.loc.splice(Res.loc.indexOf(t),1),r.remove())})}:r.style.lineHeight=0,r.onclick=()=>{let e=$("thmSrc");if(e&&(e.id=""),this.sprSrc=this.cid(t),r.id="thmSrc","bg"===t.c)return;this.detail.lastChild.innerHTML="";let i=h.width,s=h.height;"_"===t.id[0]?this.detail.ch[1].rC("gray"):this.detail.ch[1].aC("gray"),this.detail.lastChild.ap(this.drawPv(i,s,h)),t.t||this.showPro(t,i/t.n,s),this.detail._s()}),r},init(){["0{77}","0{78}"].for(t=>this.thm.ap(El("div","setcat").tx(t),El("div","setpage"))),["0{77}","0{78}","0{79}"].for(t=>this.spr.ap(El("div","setcat").tx(t),El("div","setpage"))),this.thm.style.height=this.spr.style.height="384px",UI.bindCat(this.thm),UI.bindCat(this.spr);let t=$c("setpage",this.thm);css(t,{bottom:"64px"}),t[0].set=()=>{t[0].innerHTML="",$E._R.for(e=>{let i=t[0].ap(El("div","thm").tx(e.name));i.onclick=()=>{let t=$("thmSrc");t&&(t.id=""),i.id="thmSrc",this.thmSrc={o:e.spr,c:e.col,b:e.bg}}})},t[1].set=()=>{this.thm.loaded||CIW.find("thm").then(e=>{let i=new Date(0);e.for(e=>{t[1].ap(this.pv(e,e.p,64,64,e.n));let s=new Date(e.createdAt);s>i&&(i=s)}),this.thm.loaded=!0,DB.Q("Theme").equalTo("s",0).greaterThan("createdAt",i).find().then(e=>e.for(e=>{let i=e.toJSON();i.id=i.objectId,delete i.objectId,delete i.ACL,delete i.updatedAt,t[1].ap(this.pv(i,i.p,64,64,i.n)),CIW.put("thm",i)}))})};let e=$c("setpage",this.spr);css(e,{bottom:"64px"}),this.spr.loaded={},e[0].set=()=>{this.detail._h(),e[0].innerHTML="",$E._R.for(t=>{let i=e[0].ap(El("div","thm").tx(t.name));i.onclick=()=>{let e=$("thmSrc");e&&(e.id=""),i.id="thmSrc",this.sprSrc=t.spr[Res.sprList.findIndex(t=>t===this.cSpr)]}})},e[1].set=()=>{this.detail._h(),e[1].opened||(e[1].innerHTML="",CIW.find("img","c="+this.cSpr).then(t=>{let i=[];if(t.for(t=>{e[1].ap(this.pv(t,t.d)),i.push(this.cid(t))}),e[1].opened=!0,this.spr.loaded[this.cSpr])return;let s=this.cSpr;DB.Cloud.run("spr",{c:s}).then(t=>{if(this.spr.loaded[s]=!0,"bg"===s)for(let e=0;e<25;e++)t.push(e);t.for(t=>{i.includes(t)||Res.dlImg(t,s).then(t=>e[1].ap(this.pv(t,t.d)))})})}))},e[2].set=()=>{this.detail._h(),e[2].innerHTML="",css(e[2].ap(UI.B2(UI.ico("add")+"0{7a}").on(()=>{this.sprSrc=null,this.detail.ch[1].rC("gray"),"bg"===this.cSpr?this.detail.ch[1].click():(this.detail.lastChild.innerHTML="",this.detail._s())})),{verticalAlign:"top",marginTop:"8px"}),Res.loc.for(t=>{t.c===this.cSpr&&e[2].ap(this.pv(t,t.d))})},this.spr.ap(this.detail);let i=El("div","msg-cb");i.style.top=0,i.onclick=()=>this.detail._h(),this.detail.ap(i,UI.B("0{7b}").on(()=>UI.file("image/*","DataURL").then(([t])=>{let i=new Image;i.src=t,"bg"===this.cSpr?i.onload=async()=>{if(i.width>800||i.height>608)return UI.$a("0{7c}800×608");let s=this.drawPv(i.width,i.height,i).toDataURL("image/webp",1);if(t.length>>10>160&&s.length>>10>160)return UI.$a("0{7d}");{let a=await this.sim(i,"bg");if(16===a.length){let i;null===this.sprSrc?(i={id:"_"+$M.rid(9),c:"bg"},Res.loc.push(i)):(i=Res.loc.find(t=>t.id===this.sprSrc),$("pv-"+this.sprSrc).pN.remove()),i.d=s.length<t.length?s:t,i.h=a,e[2].ap(this.pv(i,i.d)).onclick()}else UI.confirm("0{7e}").then(t=>{t.i||(this.sprSrc=a,this.spr.nS().firstChild.click())})}}:i.onload=async()=>{let s=Lib.spr[this.cSpr],a=s.w*(s.n??1),r=s.W*(s.n??1),l=i.height;if((s.d?i.width%a!=0||i.width/a>20:s.w&&i.width!==a||s.W&&i.width>r)||s.h&&l!==s.h||s.H&&l>s.H||s.t&&!(32===i.width&&32===i.height||32===i.width&&64===i.height||64===i.width&&64===i.height||160===i.width&&128===i.height))return UI.$a("0{7f}");a=s.n?i.width/s.n:s.w??i.width;let h,d=await this.sim(i,this.cSpr,a,l);if(16!==d.length)return UI.confirm("0{7e}").then(t=>{t.i||(this.sprSrc=d,this.spr.nS().firstChild.click())});if(null===this.sprSrc?(h={id:"_"+$M.rid(9),c:this.cSpr},Res.loc.push(h)):(h=Res.loc.find(t=>t.id===this.sprSrc),$("pv-"+this.sprSrc).pN.remove()),Object.assign(h,{h:d,d:t,n:s.n??i.width/a,p:!!s.p,s:s.s??0,t:!!s.t,x:-1===s.x?a>>1:s.x||0,y:-2===s.y?l:-1===s.y?l>>1:s.y||0}),s.d&&h.n>1&&(h.s=8),!s.t){let t;if(s.b)t=[...s.b];else{let e=El("canvas",0,{width:i.width,height:l}).getContext("2d");e.drawImage(i,0,0),t=Res.sprBox(e,a,l,h.n,80),Res.fC(e.canvas)}(t[0]||t[1]||t[2]<a||t[3]<l)&&(h.b=t)}e[2].ap(this.pv(h,h.d)).onclick()}})),El("span"),El("div","rl a-cen")),css(this.detail,{inset:"64px 16px 64px 112px",background:"var(--bg)"}),this.detail.lastChild.style.marginTop="12px"},dct(t,e){let i=[],s=[],a=[];for(let t=0;t<e;t++)for(let s=0;s<e;s++)i[t+s*e]=(t?Math.sqrt(2/e):Math.sqrt(1/e))*Math.cos((s+.5)*Math.PI*t/e);for(let r=0;r<2;r++){for(let a=0;a<e;a++)for(let l=0;l<e;l++){s[2*(a+l*e)+r]=0;for(let h=0;h<e;h++){let d;if(r)d=t[4*(a+h*e)+3];else{let i=4*(a+h*e);d=(Math.min(t[i],t[i+1],t[i+2])+Math.max(t[i],t[i+1],t[i+2]))/2}s[2*(a+l*e)+r]+=i[h+l*e]*d}}for(let t=0;t<e;t++)for(let l=0;l<e;l++){a[2*(t+l*e)+r]=0;for(let h=0;h<e;h++)a[2*(t+l*e)+r]+=s[2*(h+l*e)+r]*i[h+t*e]}}return a},hash(t,e){let i=this.dct(t.getImageData(0,0,e,e).data,e),s=[],a=[],r=0,l=0;for(let t=0;t<10;t++)for(let a=0;a<10;a++){if(t+a>10)continue;let l=i[2*(t+a*e)];r+=l,s.push(l)}r/=s.length;for(let t=s.length;t--;)s[t]=s[t]>r;for(let t=0;t<5;t++)for(let s=0;s<5;s++){if(t+s>=5)continue;let r=i[2*(t+s*e)+1];l+=r,a.push(r)}l/=a.length;for(let t=a.length;t--;)a[t]=a[t]>l;let h=s.concat(a);for(;h.length%5;)h.push(0);let d="";for(let t=0;t<h.length;t+=5)d+=(h[t]<<4|h[t+1]<<3|h[t+2]<<2|h[t+3]<<1|h[t+4]).toString(32);return d},bgHash:["laaklak58gk99ai2","laa5lah58gh93ai2","gm96hmp56mlbbai2","laa0h8o40gg91ai2","ss32o00620o1hg32","l8dat26nq1r0pai2","ha8gnaj56gk19ai2","laagl8k5agk93ai2","j6c6io5kp5tj3ai2","laalkak50kk93ai2","ljb0dkgs6tnr3ai2","laahl8g48gg93ai2","laakl2kc2gkbbai2","laaklal58gk99ai2","lb8qkcl52llbbai2","laallaldallbbai2","laakl8k58kk9bai2","laekham48gh1bai2","laall8l58glb3ai2","l6a0k2k500k1bai2","n204m01500k11ai2","jacgg004g0g11ai2","laakl8k5agg91ai2","laaklakdakkb3ai2","laal5ikd3jnfbai2"],sim(t,e,i,s){let a=El("canvas",0,{width:32,height:32}),r=a.getContext("2d");r.imageSmoothingEnabled=!0,r.imageSmoothingQuality="high",i?r.drawImage(t,0,0,i,s,0,0,Math.min(32,i),Math.min(32,s)):r.drawImage(t,0,0,Math.min(32,t.width),Math.min(32,t.height));let l=this.hash(r,32);return Res.fC(a),new Promise(t=>{for(let i of Res.loc)if(i.c===e&&i.h===l)return t(i.id);if("bg"===e){let e=this.bgHash.indexOf(l);if(~e)return t(e)}DB.Q("Sprite").equalTo("h",l).equalTo("c",e).select([]).first().then(e=>t(e?e.id:l),e=>t(l))})},async save(t){let e=DB.O("Sprite");return t.b&&e.set("b",t.b),e.set("c",t.c),e.set("d",t.d.replace($M.p,"")),t.n>1&&e.set("n",t.n),t.p&&e.set("p",!0),t.s&&e.set("s",t.s),t.x&&e.set("x",t.x),t.y&&e.set("y",t.y),await e.save()},drawPv(t,e,i){let s=El("canvas","thm-cv",{width:t,height:e}),a=1;if(t>640||e>256)for(;t*a>640||e*a>256;)a/=2;else if(t<256&&e<100)for(;t*a<256&&e*a<100;)a+=1;return s.ctx=s.getContext("2d"),s.img=i,s.ctx.drawImage(i,0,0),s.style.zoom=a,s},drawMask(t,e,i){t.ctx.clearRect(0,0,t.width,t.height),t.ctx.drawImage(t.img,0,0),t.ctx.fillStyle="#f0f4";for(let s=0;s<t.width;s+=e)t.ctx.fillRect(s+i[0],i[1],i[2],i[3])},showPro(t,e,i){let s,a=this.detail.lastChild,r=1,l=0,h=0;t.n&&(r=t.n),t.p&&(l=1),t.s&&(h=t.s),s=t.b??[0,0,e,i],"_"===t.id[0]?ac(a):dac(a),t.b&&this.drawMask(a.firstChild,e,s);const d=s=>{s[0]||s[1]||s[2]<e||s[3]<i?t.b=s:delete t.b,this.drawMask(a.firstChild,e,s)};a.ap(El("br"),UI.span(`0{7g}: ${r}`),UI.I("，0{7h}",{m:1,M:500,value:h}).on(e=>t.s=e),UI.I(`，0{7i}: ${e}×${i}，0{7j}: x`,{m:0,M:e,value:t.x}).on(e=>t.x=e),UI.I("y",{m:0,M:i,value:t.y}).on(e=>t.y=e),El("br"),UI.S("0{7k}",l,1).on(e=>t.p=e),UI.I("，0{7l}: 0{7m}",{m:0,M:e-1,value:s[0]}).on(s=>{let r=t.b??[0,0,e,i],l=r[0]-s;r[0]=s,r[2]+=l,a.ch[10].set(r[2]),d(r)}),UI.I("1{7n}",{m:0,M:i-1,value:s[1]}).on(s=>{let r=t.b??[0,0,e,i],l=r[1]-s;r[1]=s,r[3]+=l,a.ch[11].set(r[3]),d(r)}),UI.I("0{7o}",{m:1,M:e,value:s[2]}).on(s=>{let r=t.b??[0,0,e,i];r[2]=s,s+r[0]>e&&a.ch[10].set(r[2]=e-r[0]),d(r)}),UI.I("0{7p}",{m:1,M:i,value:s[3]}).on(s=>{let r=t.b??[0,0,e,i];r[3]=s,s+r[1]>i&&a.ch[11].set(r[3]=i-r[1]),d(r)})),h||a.ch[3]._h(),a.ch[7].style.marginRight=0},show(){let t=new UI.M(800).h("0{7q}").cb().ap(this.thm).b("0{5}","0{6}");this.thm.firstChild.onclick();let e=$("thmSrc");e&&(e.id=""),t.then(t=>{if(t.i)return $E.ThmLib.thmSrc=null;$E.ThmLib.setThm()})},showSpr(t){let e=new UI.M(800).h("0{7q}").cb();if(e.ap(this.spr),e.b("0{5}","0{6}"),this.cSpr=t,this.sprSrc=null,"bg"!==t){let e=Lib.spr[t],i="0{7r}"+e.W,s="0{7r}"+e.H;e.w&&(i=e.w),e.h&&(s=e.h),this.detail.ch[2].tx(e.t?"0{7s}: 32×32 | 32×64 | 64×64 | 160×128":`0{7g}: ${e.d?"0{7r} 20":e.n??1}, 0{7i}: 0{7o} ${i}px, 0{7p} ${s}px`)}$c("setpage",this.spr).for(t=>t.opened=!1),this.spr.firstChild.onclick(),e.then(t=>{if(t.i)return $E.ThmLib.sprSrc=null;$E.ThmLib.setSpr()})},setThm(){this.thmSrc&&$E.loadTh({spr:Res.decSpr(this.thmSrc.o),col:this.thmSrc.c,bg:this.thmSrc.b})},setSpr(){if(null===this.sprSrc||void 0===this.sprSrc)return;if("bg"===this.cSpr){let t={id:this.sprSrc,m:$E._r.bg.m,g:$E._r.bg.g};return dac($("box"),""),Res.loadBg(t,1).then(t=>{$E._r.setBg(t),$E._r.drawBg(),$("loading")._h(),ac($("box"))},Res.fail)}let t=Res.sprList.findIndex(t=>t===this.cSpr);Res.loadSpr(this.cSpr,this.sprSrc,$E.tileCol.col).then(e=>{$E._r.spr[t]=this.sprSrc,$E.drawThn($("tile").spr[this.cSpr],e),$E.sfO.redraw()})},async drawThm(){let t=El("canvas",0,{width:64,height:64}),e=t.getContext("2d",{alpha:!1});switch($E._r.bg.m<3?e.drawImage($E.sfB.canvas,368,272,128,128,0,0,64,64):3===$E._r.bg.m?(e.fillStyle=$E._r.bg.c,e.fillRect(0,0,64,64)):e.drawImage(await $M.html2img(`<div style='position:absolute;left:-336px;top:-240px;width:800px;height:608px;background:${$E._r.bg.c}'></div>`,128,128),0,0,64,64),e.drawImage(Res.spr.spk[0],32,32,16,16),e.drawImage(Res.spr.pf[0],48,32,16,Res.spr.pf.h/2),e.drawImage(Res.spr.wp[0],48,0,16,16),Res.spr.blk.length){case 1:e.drawImage(Res.spr.ply[0],0,32,16,16),e.drawImage(Res.spr.sp[0],16,32,16,16),e.drawImage(Res.spr.chr[0],27.5,10,10.5,12),e.drawImage(Res.spr.blk[0],0,48,16,16),e.drawImage(Res.spr.blk[0],16,48,16,16),e.drawImage(Res.spr.blk[0],32,48,16,16),e.drawImage(Res.spr.blk[0],48,48,16,16);break;case 2:e.drawImage(Res.spr.ply[0],0,16,16,16),e.drawImage(Res.spr.sp[0],16,16,16,16),e.drawImage(Res.spr.chr[0],35.5,10,10.5,12),e.drawImage(Res.spr.blk[0],0,32,16,16),e.drawImage(Res.spr.blk[0],16,32,16,16),e.drawImage(Res.spr.blk[1],0,48,16,16),e.drawImage(Res.spr.blk[1],16,48,16,16),e.drawImage(Res.spr.blk[0],32,48,16,16),e.drawImage(Res.spr.blk[0],48,48,16,16);break;case 4:e.drawImage(Res.spr.ply[0],0,32,16,16),e.drawImage(Res.spr.sp[0],16,32,16,16),e.drawImage(Res.spr.chr[0],27.5,10,10.5,12),e.drawImage(Res.spr.blk[0],0,48,16,16),e.drawImage(Res.spr.blk[1],16,48,16,16),e.drawImage(Res.spr.blk[1],32,48,16,16),e.drawImage(Res.spr.blk[0],48,48,16,16);break;case 20:e.drawImage(Res.spr.ply[0],0,16,16,16),e.drawImage(Res.spr.sp[0],16,16,16,16),e.drawImage(Res.spr.chr[0],35.5,10,10.5,12),e.drawImage(Res.spr.blk[5],0,32,16,16),e.drawImage(Res.spr.blk[6],16,32,16,16),e.drawImage(Res.spr.blk[9],0,48,16,16),e.drawImage(Res.spr.blk[11],16,48,16,16),e.drawImage(Res.spr.blk[3],32,48,16,16),e.drawImage(Res.spr.blk[2],48,48,16,16),e.drawImage(Res.spr.blk[17],16,48,16,16)}let i=t.toDataURL(),s=t.toDataURL("image/webp",1);return Res.fC(t),s.length<i.length?s:i},async saveThm(t,e,i=[]){let s=DB.O("Theme");return s.set("n",e),s.set("p",$M.m(await this.drawThm())),t.col&&!$M.eq(t.col,{})&&s.set("c",t.col),s.set("t",i),s.set("o",Res.encSpr(t.spr)),s.set("b",t.bg),await s.save()}},docReady.then(()=>$E.ThmLib.init());