const userInit=()=>{$U.getUsername(USER,$("username"));let[e,t,a]=$U.getLv(USER.get("e")),s="??"===a?100:t/a*100,r=USER.get("a");$("level").firstChild.tx("Lv."+e),$("exp").tx(`${t}/${a}`),$("levelbar").style.background=`linear-gradient(90deg,#9cf ${s}%,#0000 ${s}%)`,r&&CIW.fetch(r.id,"UserAvatar","avatar").then(e=>$("avatar").style.background=`url(${e.d})`),profileBox=El("div","rl");let i=[0,,,,,],o=El("div","userInfo"),n=profileBox.ap(El("div","avatar hover"),o);n.id="cavatar",n.onclick=()=>UI.P(64,64,"设置头像",1).then(e=>{let t=DB.O("UserAvatar"),a=USER.get("a")?.id;t.set("d",e),USER.set("a",t),USER.save().then(t=>{$("cavatar").style.background=$("avatar").style.background=`url(${e})`,CIW.put("avatar",{id:t.id,d:e}),a&&(CIW.del("avatar",a),DB.O("UserAvatar",a).destroy())},e=>{UI.alert("设置失败"),console.error(e)})}),o.ap($U.getUsername(USER),$U.getUID(USER.id),UI.span("等级 "),UI.span("行为值 "),UI.span("创作值")),["经验值","通关数","作品数","作品评分"].for(e=>profileBox.ap(El("div","udata",{innerHTML:`<div class='ud-n'>${i18n(e)}</div><div class='ud-r'>${UI.ico("rank")}<span> --</span></div><div class='ud-s'>--</div>`})));let l=USER.get("p").get("m");if(l.length){let e=El("div","rl"),t=USER.get("w");profileBox.ap(UI.p("勋章","12px 0 8px 8px"),e),l.for((a,s)=>{let[r,i]=a.split(","),n=e.ap(El("div","medal"));n.innerHTML=UI.ico("m-"+r),n.ap(El("br"),UI.span(i,"#89a")),t&&r===t.split(",")[0]&&i===t.split(",")[1]&&css(n,{background:"var(--bgl)",borderColor:"#5af"}),n.i=s,n.onclick=function(){this.style.background?(css(this,{background:"",borderColor:""}),USER.unset("w"),USER.save()):(css($c("medal"),{background:"",borderColor:""},this.i,{background:"var(--bgl)",borderColor:"#5af"}),USER.set("w",l[this.i]),USER.save()),$U.getUsername(USER,o.firstChild),$U.getUsername(USER,$("username"))}})}else css(profileBox.ap(UI.p("勋章","12px 0 8px 8px")).ap(UI.span("无","#89a")),{marginLeft:"8px"});profileBox.set=async()=>{let e=o.ch;$U.getUsername(USER,e[0]),!$("cavatar").style.background&&r&&CIW.fetch(r.id,"UserAvatar","avatar").then(e=>$("cavatar").style.background=`url(${e.d})`),e[2].tx(`${i18n("等级 Lv.")}${$U.getLv(USER.get("e"))[0]}`),e[3].tx(`${i18n("行为值 ")}${USER.get("p").get("b")}`),e[4].tx(`${i18n("创作值")} ${USER.get("p").get("c")}`),void 0===i[2]&&(i[2]=await DB.Q(DB.User).greaterThan("e",USER.get("e")).count()+1,i[3]=await DB.Q(DB.User).greaterThan("c",USER.get("c")).count()+1);let t=$c("ud-s");t[0].tx(USER.get("e")),t[0].pS().lastChild.tx(" "+i[2]),t[1].tx(USER.get("c")),t[1].pS().lastChild.tx(" "+i[3]),t[2].tx(i[0]),void 0!==i[4]&&t[2].pS().lastChild.tx(" "+i[4]),void 0!==i[1]&&(t[3].lastChild.tx(i[1]),t[3].pS().lastChild.tx(" "+i[5]))};let c=$("userop").ch;c[0].onclick=()=>DB.User.logOut().then(()=>LOC("login"),()=>DB.User.logOut().then(()=>LOC("login"))),c[1].onclick=()=>UI.confirm("确定要修改密码？点击确定后系统会发送验证邮件到您的邮箱").then(e=>{e.i||$U.resetPw(USER.getEmail())})},fetchMsg=e=>{let t=e.get("t"),a=e.get("r"),s=e.get("a"),r=$S.get(USER.id+"msg")??0,i=[0,0,0],o=0;t.for(t=>{t.e&&t.e<Date.now()?(e.remove("t",t),o++):t.t>r&&(CIW.putS("msg",{u:USER.id,c:0,...t}),i[0]++,Date.now()-t.t>1296e6&&(e.remove("t",t),o++),$S.get("msgPush")||(new UI.M).t(t.m).ap(El("p","time").tx("系统通知 "+Date.cD(new Date(t.t)))).b("知道了"))}),a.for(t=>{t.t>r&&(CIW.putS("msg",{u:USER.id,c:1,...t}),i[1]++),Date.now()-t.t>864e6&&(e.remove("r",t),o++)}),s.for(t=>{t.t>r&&(CIW.putS("msg",{u:USER.id,c:2,...t}),i[2]++),Date.now()-t.t>6048e5&&(e.remove("a",t),o++)}),o&&e.save(),(i[0]||i[1]||i[2])&&$("notice").aC("new"),$S.set(USER.id+"msg",Date.now()),msgBox=El("div","tabBox rl"),msgBox.style.height="400px",["系统通知","回复我的","@ 我的","消息设置"].for(e=>msgBox.ap(El("div","setcat").tx(e),El("div","setpage"))),UI.bindCat(msgBox);let n=$c("setcat",msgBox).slice(0,3),l=$c("setpage",msgBox);l[3].style.padding="6px",i.for((e,t)=>{e&&(n[t].num=n[t].ap(El("div","msgNum").tx(Math.min(e,99))))}),l.for(e=>e.set=e=>{e&&e.num&&(e.num.remove(),delete e.num)}),l[3].ap(UI.S("系统通知推送",!$S.get("msgPush")).on(e=>$S.set("msgPush",!e)),UI.B("清空本地消息记录",1).on(e=>{e.set(),UI.confirm("确定要清空本地消息记录？").then(async t=>{if(t.i)return e.set(1);try{await CIW.clear("msg"),e.set(1),UI.alert("消息记录清空成功")}catch{UI.alert("消息记录清空失败")}})})),CIW.onready(()=>CIW.find("msg","u="+USER.id).then(e=>{e.sort((e,t)=>t.t-e.t),e.for(e=>{let t=El("div","rvbox");switch(e.c){case 0:t.tx(e.m);break;case 1:case 2:let a=El("a","link").tx(e.u);a.uid=e.U,a.onclick=function(){$U.showUser(this.uid)},t.ap(a,El("span").tx("在游戏"),El("a","link").tx(e.g),El("span").tx(`中${1==e.c?"回复":"@"}了你`))}t.ap(El("div","time").tx(Date.cD(new Date(e.t)))),l[e.c].ap(t)})}))};let profileBox,msgBox,nav=$c("navi"),page=$c("page"),board=$c("board").map(e=>$t("div",e));nav.for((e,t)=>{e.onclick=()=>{nav.for((e,a)=>a===t?e.aC("now"):e.rC("now")),css(page,{opacity:0,pointerEvents:"none"},t,{opacity:1,pointerEvents:""}),1===t&&LOC("play")}}),nav[0].click(),$("notice").onclick=function(){msgBox&&(this.rC("new"),new UI.M(640).h("我的消息").cb().ap(msgBox),$c("setcat",msgBox)[0].click())},$("profile").onclick=()=>{profileBox&&(new UI.M(330).h("个人信息").cb().ap(profileBox),profileBox.set())},$("copyright").innerHTML=`v${$S.get("version")}&emsp;build.${$S.get("build")}<br/>`,CIW.onready(()=>USER&&DB.off(async()=>{DB.Q(DB.User).descending("e").addAscending("createdAt").select(["username","e"]).limit(5).find().then(e=>{let t=board[1];e.for((e,a)=>{let s=El("span","username").tx(e.getUsername());s.u=e.id,s.onclick=function(){$U.showUser(this.u)},t[a].ap(El("span").tx(`Lv.${$U.getLv(e.get("e"))[0]}`),s).style.float="right"})}),$S.sget("fetch")?(setTimeout(userInit,0),fetchMsg(await USER.get("m").fetch())):(await USER.fetchWithInclude(["m","p"]),userInit(),fetchMsg(USER.get("m")),$S.sset("fetch",1))},()=>{userInit(),fetchMsg(USER.get("m"))}));