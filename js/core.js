let $R=null,saveCache=null;const _C={dSprN(t,e){$R.rr.draw(t[e],this.x,this.y,t.tx-this.sprX,t.ty-this.sprY,this.scx,this.scy,this.ang,this.al)},moveOxy(t,e,s){let i=(e-t.sprX)*t.scx,r=(s-t.sprY)*t.scy;if(i||r)if(t.sprX=e,t.sprY=s,t.ang){let e=t.ang*Math.DR,s=Math.cos(e),h=Math.sin(e);t.x+=s*i+h*r,t.y+=-h*i+s*r}else t.x+=i,t.y+=r},calcBox(t,e,s,i,r,h,a,n){let o=i*t.scx,l=r*t.scy,d=t.x-o,c=t.y-l;if(t.ang){let i=t.ang*Math.DR,r=Math.cos(i),a=Math.sin(i),n=e*r,p=e*a;h[0]=d+o*(1-r)-l*a,h[1]=c+o*a+l*(1-r),h[2]=h[0]+n,h[3]=h[1]-p,h[4]=h[0]+s*a,h[5]=h[1]+s*r,h[6]=h[4]+n,h[7]=h[5]-p}else h[0]=d,h[1]=c,h[2]=h[0]+e,h[3]=h[1],h[4]=h[0],h[5]=h[1]+s,h[6]=h[2],h[7]=h[5];let p=0,f=0,u=1,m=1;for(let t=0;t<8;t++)1&t?h[t]<h[u]?u=t:h[t]>h[m]&&(m=t):h[t]<h[p]?p=t:h[t]>h[f]&&(f=t);n[0]=p,n[1]=u,n[2]=f,n[3]=m,a[0]=Math.round(h[p]),a[1]=Math.round(h[u]),a[2]=Math.round(h[f]),a[3]=Math.round(h[m])},WR:class{#t;constructor(t){this.canvas=t,this.w=t.width,this.h=t.height,this.#t=[],this.#t.w=512,this.#t.s=0,this.cM=new Float32Array(6),this.vT(1,1),this.dC=!1,this.dO=!1,this.L=1e5}addSpr(t){this.#t.push(t),t.for(t=>{this.#t.s+=(t.width+1)*(t.height+1),t.width>this.#t.w&&(this.#t.w<<=1)})}#e(t){return 1<<Math.ceil(Math.log2(t))}textureMap(t){let e=Math.max(this.#t.w,this.#e(this.#t.s**.5))+1,s=0,i=0,r=[];const h=s=>s.for(s=>{const h=s.width+1,a=s.height+1;let n=r.find(t=>t.h>=a&&t.w>=h);n||(n={y:(r.at(-1)?.y??0)+a,h:a,w:e},r.push(n)),t.push(e-n.w,n.y-n.h,h-1,a-1),n.w-=h,s.id=i++});this.#t.for(t=>{32===t[0].height&&h(t)}),this.#t.for(t=>{32!==t[0].height&&h(t)}),s=this.#e(r.at(-1).y-1),console.log(`TextureMap: ${e-1}x${s}`);const a=new OffscreenCanvas(e-1,s),n=a.getContext("2d");return this.#t.for(e=>{for(let s=0;s<e.length;s++){const i=e[s].id;n.drawImage(e[s],t[4*i],t[4*i+1]),e[s].close?.(),e[s]=0|i}if("rp"===e.name){const s=t[4*e[0]],r=t[4*e[0]+1];for(let h=1;h<32;++h)t.push(s,r+32-h,e.w,h),e.push(i++)}}),this.#t.length=0,a}vC(t,e){t===this.cM[4]&&e===this.cM[5]||(this.cM[4]=t,this.cM[5]=e,this.dC=!0)}vT(t,e,s=0){if(t*=2/this.w,e*=-2/this.h,s){const i=s/180*Math.PI,r=Math.cos(i),h=Math.sin(i);this.cM[0]=r*t,this.cM[1]=h*t,this.cM[2]=-h*e,this.cM[3]=r*e}else this.cM[0]=t,this.cM[1]=0,this.cM[2]=0,this.cM[3]=e;this.dC=!0}updO(){this.dO=!0}}};_C.WG=class extends _C.WR{#s;#i;#r;#h;#a;#n;#o;#l;#d;#c;#p;#f=40;#u;#m;async init(){this.#i=this.canvas.getContext("webgpu");const t=await navigator.gpu.requestAdapter(),e=await t.requestDevice(),s=this.#i.getPreferredFormat(t);this.#s=e,this.#i.configure({device:e,format:s});const i={srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha",operation:"add"};this.#r=e.createRenderPipeline({vertex:{module:e.createShaderModule({code:_C.WG.VertWGSL}),entryPoint:"main"},fragment:{module:e.createShaderModule({code:_C.WG.FragWGSL}),entryPoint:"main",targets:[{format:s,blend:{color:i,alpha:i}}]},primitive:{topology:"triangle-strip",stripIndexFormat:"uint16"}}),this.#n=e.createBuffer({size:24,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});const r=e.createSampler({minFilter:"linear"}),h=[],a=this.textureMap(h);this.#u=e.createTexture({size:[a.width,a.height],format:s,usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT}),e.queue.copyExternalImageToTexture({source:a},{texture:this.#u},[a.width,a.height]),this.#m=e.createBuffer({size:4*h.length,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),e.queue.writeBuffer(this.#m,0,new Float32Array(h)),a.width=a.height=0,this.#o=new ArrayBuffer(this.#f*this.L),this.#l=new DataView(this.#o),this.#d=e.createBuffer({size:this.#f*this.L,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),this.#c=this.#p=0,this.#h=e.createBindGroup({layout:this.#r.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.#n}},{binding:1,resource:r},{binding:2,resource:this.#u.createView()},{binding:3,resource:{buffer:this.#m}},{binding:4,resource:{buffer:this.#d}}]}),this.#a={colorAttachments:[{loadValue:{r:0,g:0,b:0,a:0},storeOp:"store"}]}}destroy(){this.#n?.destroy(),this.#u?.destroy(),this.#m?.destroy(),this.#d?.destroy()}draw(t,e,s,i,r,h=1,a=1,n=0,o=1,l=0){if(this.#p>=this.L)return;const d=this.#c++*this.#f,c=this.#l;c.setUint32(d,t,!0),c.setUint32(d+4,l,!0),c.setFloat32(d+8,e,!0),c.setFloat32(d+12,s,!0),c.setFloat32(d+16,i,!0),c.setFloat32(d+20,r,!0),c.setFloat32(d+24,h,!0),c.setFloat32(d+28,a,!0),c.setFloat32(d+32,n,!0),c.setFloat32(d+36,o,!0)}render(){const t=this.#s;this.dC&&(t.queue.writeBuffer(this.#n,0,this.cM.buffer),this.dC=!1),this.dO&&(this.#p=this.#c,this.#c&&t.queue.writeBuffer(this.#d,0,this.#o,0,this.#p*this.#f),this.#c=0,this.dO=!1),this.#a.colorAttachments[0].view=this.#i.getCurrentTexture().createView();const e=t.createCommandEncoder(),s=e.beginRenderPass(this.#a);s.setPipeline(this.#r),s.setBindGroup(0,this.#h),s.setScissorRect(0,0,this.w,this.h),s.draw(4,this.#p,0,0),s.endPass(),t.queue.submit([e.finish()])}static VertWGSL="\n/*let vertexRect = array<vec2<f32>, 6>(\n  vec2<f32>(0., 0.),\n  vec2<f32>(1., 0.),\n  vec2<f32>(0., 1.),\n  vec2<f32>(1., 0.),\n  vec2<f32>(0., 1.),\n  vec2<f32>(1., 1.)\n);*/\n\n[[block]] struct Camera {\n  R: mat2x2<f32>;\n  t: vec2<f32>;\n};\n[[group(0), binding(0)]] var<uniform> camera: Camera;\n\nstruct SprUV {\n  xy: vec2<f32>;\n  wh: vec2<f32>;\n};\n[[block]] struct SprUVMap {\n  data: [[stride(16)]] array<SprUV>;\n};\n[[group(0), binding(3)]] var<storage, read> sprUVMap: SprUVMap;\n\nstruct Object {\n  spr: u32;\n  blend: u32;\n  oxy: vec2<f32>;\n  dxy: vec2<f32>;\n  scale: vec2<f32>;\n  rotate: f32;\n  alpha: f32;\n};\n[[block]] struct Objects {\n  data: [[stride(40)]] array<Object>;\n};\n[[group(0), binding(4)]] var<storage, read> objs: Objects;\n\nstruct VertexOutput {\n  [[builtin(position)]] Position: vec4<f32>;\n  [[location(0)]] uv: vec2<f32>;\n  [[location(1)]] color: vec4<f32>;\n};\n\n[[stage(vertex)]]\nfn main([[builtin(vertex_index)]] vertexIndex: u32,\n        [[builtin(instance_index)]] objIndex: u32) -> VertexOutput {\n  let obj = objs.data[objIndex];\n\n  let spr = sprUVMap.data[obj.spr];\n\n  let a = obj.rotate * 0.017453292519943295;//radians(obj.rotate);\n  let transform = mat2x2<f32>(\n    vec2<f32>(cos(a) * obj.scale[0], sin(a) * obj.scale[1]),\n    vec2<f32>(-sin(a) * obj.scale[0], cos(a) * obj.scale[1])\n  );\n\n  var vertexRect = array<vec2<f32>, 4>(\n    vec2<f32>(0., 0.),\n    vec2<f32>(1., 0.),\n    vec2<f32>(0., 1.),\n    //vec2<f32>(1., 0.),\n    //vec2<f32>(0., 1.),\n    vec2<f32>(1., 1.)\n  );\n\n  let vertex = vertexRect[vertexIndex] * spr.wh;\n\n  let pos = (vertex + obj.dxy) * transform + obj.oxy;\n\n  var output: VertexOutput;\n  output.Position = vec4<f32>((pos - camera.t) * camera.R, 0., 1.);\n  output.uv = vertex + spr.xy;//(vertex + spr.xy) / vec2<f32>(textureDimensions(sprTexture));\n  output.color = vec4<f32>(1., 1., 1., obj.alpha);\n  return output;\n}\n";static FragWGSL="\n[[group(0), binding(1)]] var sprSampler: sampler;\n[[group(0), binding(2)]] var sprTexture: texture_2d<f32>;\n\n[[stage(fragment)]]\nfn main([[location(0)]] uv: vec2<f32>,\n        [[location(1)]] color: vec4<f32>) -> [[location(0)]] vec4<f32> {\n  return textureSample(\n    sprTexture, sprSampler,\n    uv / vec2<f32>(textureDimensions(sprTexture))\n  ) * color;\n}\n"},_C.WL=class extends _C.WR{#i;#g;#v;#b;#x;#n;#o;#d;#c;#p;#f=12;#u;#m;#y(t,e){const s=this.#i,i=s.createShader(t);if(s.shaderSource(i,e),s.compileShader(i),!s.getShaderParameter(i,s.COMPILE_STATUS))throw s.getShaderInfoLog(i);return i}async init(){this.#i=this.canvas.getContext("webgl2");const t=this.#i;t.clearColor(0,0,0,0),t.enable(t.BLEND),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),this.#g=this.#y(t.VERTEX_SHADER,_C.WL.VertGLSL),this.#v=this.#y(t.FRAGMENT_SHADER,_C.WL.FragGLSL),this.#b=t.createProgram();const e=this.#b;if(t.attachShader(e,this.#g),t.attachShader(e,this.#v),t.linkProgram(e),!t.getProgramParameter(e,t.LINK_STATUS))throw t.getProgramInfoLog(e);t.useProgram(e),this.#x=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.#x),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint8Array([0,1,2,2,1,3]),t.STATIC_DRAW),this.#n=t.getUniformLocation(e,"camera"),t.uniform1i(t.getUniformLocation(e,"sampler"),0),this.#m=[];const s=this.textureMap(this.#m);this.#u=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.#u),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,s.width,s.height,0,t.RGBA,t.UNSIGNED_BYTE,s),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.activeTexture(t.TEXTURE0),this.#o=new Float32Array(this.#f*this.L),this.#d=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.#d),t.bufferData(t.ARRAY_BUFFER,this.#o,t.DYNAMIC_DRAW),this.#c=this.#p=0;const i=t.getAttribLocation(e,"spr");t.vertexAttribPointer(i,4,t.FLOAT,!1,4*this.#f,0),t.vertexAttribDivisor(i,1),t.enableVertexAttribArray(i);const r=t.getAttribLocation(e,"pos");t.vertexAttribPointer(r,4,t.FLOAT,!1,4*this.#f,16),t.vertexAttribDivisor(r,1),t.enableVertexAttribArray(r);const h=t.getAttribLocation(e,"trans");t.vertexAttribPointer(h,4,t.FLOAT,!1,4*this.#f,32),t.vertexAttribDivisor(h,1),t.enableVertexAttribArray(h)}draw(t,e,s,i,r,h=1,a=1,n=0,o=1){if(this.#p>=this.L)return;const l=this.#c++*this.#f,d=this.#o,c=this.#m,p=4*t;d[l]=c[p],d[l+1]=c[p+1],d[l+2]=c[p+2],d[l+3]=c[p+3],d[l+4]=e,d[l+5]=s,d[l+6]=i,d[l+7]=r,d[l+8]=h,d[l+9]=a,d[l+10]=n,d[l+11]=o}destroy(){const t=this.#i;t.deleteShader(this.#g),t.deleteShader(this.#v),t.deleteProgram(this.#b),t.deleteTexture(this.#u),t.deleteBuffer(this.#x),t.deleteBuffer(this.#d)}render(){const t=this.#i;this.dC&&(t.uniformMatrix3x2fv(this.#n,!1,this.cM),this.dC=!1),this.dO&&(this.#p=this.#c,this.#c&&(t.bindBuffer(t.ARRAY_BUFFER,this.#d),t.bufferSubData(t.ARRAY_BUFFER,0,this.#o.subarray(0,this.#p*this.#f))),this.#c=0,this.dO=!1),t.clear(t.COLOR_BUFFER_BIT),t.drawElementsInstanced(t.TRIANGLES,6,t.UNSIGNED_BYTE,0,this.#p)}static VertGLSL="#version 300 es\nvec2 vertexRect[4] = vec2[4](\n  vec2(0., 0.),\n  vec2(1., 0.),\n  vec2(0., 1.),\n  vec2(1., 1.)\n);\n\nuniform mat3x2 camera;\n\nin vec4 spr;\nin vec4 pos;\nin vec4 trans;\n\nout vec2 uv;\nout vec4 color;\n\nvoid main(void) {\n  float a = trans[2] * 0.017453292519943295;\n  mat2 transform = mat2(\n    vec2(cos(a) * trans[0], sin(a) * trans[1]),\n    vec2(-sin(a) * trans[0], cos(a) * trans[1])\n  );\n\n  vec2 vertex = vertexRect[gl_VertexID] * vec2(spr[2], spr[3]);\n\n  vec2 pos = (vertex + vec2(pos[2], pos[3])) * transform + vec2(pos[0], pos[1]);\n\n  gl_Position = vec4((pos - camera[2]) * mat2(camera[0], camera[1]), 0., 1.);\n  uv = vertex + vec2(spr[0], spr[1]);\n  color = vec4(1., 1., 1., trans[3]);\n}\n";static FragGLSL="#version 300 es\n#pragma vscode_glsllint_stage:frag\nprecision highp float;\n\nuniform sampler2D sampler;\n\nin vec2 uv;\nin vec4 color;\nout vec4 fragColor;\n\nvoid main(void) {\n  fragColor = texture(sampler, uv / vec2(textureSize(sampler, 0))) * color;\n}\n"},_C.dec={rStr:"",setFlag(t){let e=(t??"").padEnd(6,"-|(~");this.bias=e.charCodeAt(0),this.iObj=e[1],this.iLay=e[2],this.iStr=e[3],this.iArr=e[4],this.iPro=e[5]},n(t){return t.charCodeAt(0)-this.bias},key(t){let e="",s=this.n(t);if(s<0)throw"decode key "+s;for(;s;)e+=String.fromCharCode(s%32+96),s>>=5;return e},num(t){let e=this.n(t),s=e/1e4<<0,i=s<3?1:-1;for(e%=1e4;s%3;)i*=10,s--;return e/i},str(t,e){let s="";for(;t[e]!==this.iStr;)if(s+=t.at(e++).replace(this.rStr,this.iStr),e>=t.length)throw"decode str at pos "+e;return[s,e+1]},arr(t,e){let s=[];for(let i=this.n(t[e++]);i--;){let i=this.val(t,e);if(s.push(i[0]),(e=i[1])>=t.length)throw"decode arr at pos "+e}return[s,e]},val(t,e){let s=t[e++];if(e>=t.length)throw"decode val at pos "+e;return s==this.iStr?this.str(t,e):s==this.iArr?this.arr(t,e):[this.num(s),e]},obj(t,e,s){let i={...Lib.obj[s]??{add:{}}};if(i.add=$M.cp(i.add),t.at(e)===this.iPro){for(e++;t.at(e)!==this.iPro;){let s=this.key(t.at(e++));if([i.add[s],e]=this.val(t,e),e>=t.length)throw"decode pro at pos "+e}e++}return[i,e]},room(t,e,s){let i=0,r=0;for(e(r);i<t.length;){let h=t.at(i++);if(h===this.iObj){let e=this.n(t.at(i++));for(;i<t.length&&t.at(i)!==this.iObj&&t.at(i)!==this.iLay;){let h,a=i,n=this.num(t.at(i++)),o=this.num(t.at(i++));[h,i]=this.obj(t,i,e),h.add.dep=r,s({x:n,y:o,prop:h,code:t.slice(a,i)})}}else h===this.iLay&&e(++r)}}},_C.L=class{constructor(t){this.i=t,this.o=[],this.a=[],this.del=[],this.e=[],this.draw=t<11?this.#w:this.#R}push(t){return this.o.push(t)-1}add(t){t.$d(),this.a.push(t)}eff(t){this.e.push(t)}clear(){this.a.length=0,this.o.length=0,this.e.length=0}iter(t){for(let e=0;e<this.a.length;e++)this.a[e]._des?this.del.bIns(e):t(this.a[e])}gc(){if(this.del.length&&(this.del.forv(t=>{let e=this.a[t].oid;for(this.a.splice(t,1),this.o.splice(e,1);e<this.o.length;e++)this.o[e].oid=e}),this.del.length=0),this.e.length){this.upd=!0;for(let t=this.e.length;t--;)this.e[t].move(),this.e[t]._des&&this.e.splice(t,1)}}#w(){if(0===this.i){const t=$R._r.bg,e=t.c.w,s=t.c.h;switch(t.m){case 0:let i=($R.vX/e|0)*e-$R.vX,r=($R.vY/s|0)*s-$R.vY;for(;r<608;r+=s)for(let s=i;s<800;s+=e)$R.rr.draw(t.c[0],$R.vX,$R.vY,s,r);break;case 1:let h=400-(e>>1),a=304-(s>>1);for(;h>0;)h-=e;for(;a>0;)a-=s;for(;a<608;a+=s)for(let s=h;s<800;s+=e)$R.rr.draw(t.c[0],$R.vX,$R.vY,s,a);break;case 2:$R.rr.draw(t.c[0],0,0,0,0,$R._r.w/e,$R._r.h/s)}}else if(7===this.i){$R.$&&$R.$.draw();const t=$R.Col[1].obj;for(let e=0;e<t.length;e++)t[e].draw()}for(let t=0;t<this.e.length;t++)this.e[t].draw();for(let t=0;t<this.a.length;t++)this.a[t].draw();this.upd=!1}#R(){const t=$R.vX,e=$R.vY;for(let s=0;s<this.e.length;s++)this.e[s].x+=t,this.e[s].y+=e,this.e[s].draw(),this.e[s].x-=t,this.e[s].y-=e;for(let s=0;s<this.a.length;s++)this.a[s].x+=t,this.a[s].y+=e,this.a[s].draw(),this.a[s].x-=t,this.a[s].y-=e;this.upd=!1}},_C.$R=class{#T;#S;#C;#M;#B;#L;#P;#j;#_;#I;#A;#D;#U;static rS=Date.now();constructor(t,e){this.G=Object.freeze(t),this.startR=0,this.endR=this.G.R.findIndex(t=>1===t.type);let s=$("screen");this.BG=s.ap(El("div","surf"));const i=()=>s.ap(El("canvas","surf",{width:800,height:608})).transferControlToOffscreen();this.gC=i(),this.rr=1===App.gC("run","render")?new _C.WG(this.gC):new _C.WL(this.gC),this.GUI=s.ap(El("div","surf")),this.GUI.id="GUI",this.sfM=i().getContext("2d"),this.sfM.imageSmoothingEnabled=!1,this.sfM.clr=!1,this.vMargin=192,this.#A=e,this.#I=Infinity,this.startMode=0,this.saveMode=Math.log2(t.S||1),this.#j=0,this.sTime=$("g-time"),this.sTime.val=0,this.sTime.tx("00:00:00"),this.sDth=$("g-dth"),this.sDth.tx("0"),this.sRoom=$("g-room"),this.sRoom?(this.sPlyX=$("g-plyX"),this.sPlyY=$("g-plyY"),this.sPlyA=$("g-plyA"),this.sFps=$("g-fps"),this.sRps=$("g-rps"),this.sPer=$("g-per"),this.sPerD=$("g-perD"),this.fps=-1,this.rps=0,this.per=0,this.perD=0,this.fpsT=0,this.#_=this.mRun.bind(this),this.draw=this.mDraw.bind(this)):(this.#_=this.main.bind(this),this.draw=this.#G.bind(this))}init(t){$("loading").style.background="";let e=0,s={},i=[],r=[],h=[],a=[],n=Res.sndList.slice(0,4);this.resPool=[i,h,s];let o=1,l=1;const d=e=>{o&&(o=0,e&&(console.error(e),UI.$a("游戏资源加载失败，请检查网络连接").then(()=>t(e))))},c=()=>{l&&(l=0,UI.$a("部分音乐资源加载失败"))},p=["pli","plr","plj","plf","plt","plb"];n.for(t=>{Res.snd[t]||(e++,Res.loadSnd(t))}),this.bgm=new Au.Bgm(1),this.bgmSrc={},this.G.R.for(n=>{let l=n.bg.m+(n.bg.id??0)+(n.bg.g??"");s[l]?n.bg=s[l]:(++e,s[l]=n.bg,Res.loadBg(n.bg,0,1).catch(d)),n.Spr={},n.spr.for(t=>{let[i,r]=t.split(":"),h="";for(let t in n.col)if(n.col[t].split("|").includes(i)){h=t;break}r||(r=Lib.thm[Res.sprList.indexOf(i)]);let a=i+r+h;if(s[a]||"ply"===i&&s["pli"+a])"ply"===i?p.for(t=>n.Spr[t]=s[t+a]):n.Spr[i]=s[a];else{e++,n.Spr[i]=s[a]=[];let t=Res.loadSpr(i,r,h,1,s[a],1);"ply"===i&&(p.for(t=>n.Spr[t]=s[t+a]=[]),t.then(t=>p.for((e,i)=>{let r=i<2?4*i:2*i+4;n.Spr[e].push(...t.slice(r,i<2?r+4:r+2)),delete s[a],delete n.Spr.ply}))),t.catch(d)}}),n._o=[],n.grp=[];try{_C.dec.setFlag(n.flag),_C.dec.room(n.obj,t=>n._o[t]=[],({x:t,y:s,prop:i})=>{let r=i.ind;if(0===r)return n.x=t+17,void(n.y=s+23);if(void 0===r)return;let o={ind:r,x:t,y:s,dep:i.add.dep};if(delete i.add.dep,o.add=i.add,i.add.tml&&(o.tml=JSON.stringify(i.add.tml),delete o.add.tml),i.add.trg&&(o.trg=JSON.stringify(i.add.trg),delete o.add.trg),["blk","tile"].includes(i.spr[0])&&(o.add.tile=!0,o.add.til>=1e3&&(o.add.til-=1e3),o.add.tb=15&o.add.til,o.add.tc=o.add.til>>4&15),i.def&&(o.add.def=i.def),n._o[o.dep].push(o),10===r){let t={m:o.add.gpm[0],i:i.add.gid,o:[]};switch(o.add._gid=n.grp.push(t)-1,t.m){case 0:t.p=[];break;case 1:t.p=o.add._gp=_C.D.circle(o.add.gpm[1],o.add.gpm[2]);break;case 2:t.p=o.add._gp=_C.D.polygon(o.add.gpm[1],o.add.gpm[3],o.add.gpm[2],0)}}else if(42===r){let t=o.add,s="";for(let e in Lib._o[42].add)s+="key"+t[e];let i=a.indexOf(s);if(-1===i){e++;let i=new Image,r=[El("canvas",0,{width:t.w,height:t.h})];r.x=r.y=0,r.w=t.w,r.h=t.h,r.px=!0,h.push(r),a.push(s),o.spr=[r],i.src=Res.svgTxt(t),i.decode().then(()=>{let t=r[0].getContext("2d");t.drawImage(i,0,0);let e=t.getImageData(0,0,r.w,r.h).data;[r.bL,r.bT,r.boxW,r.boxH]=Res.sprBox(e,r.w,r.h,1,127),r.boxL=-r.bL,r.boxT=-r.bT,r.mask=[[]];for(let t=0;t<r.boxH;t++)for(let s=0;s<r.boxW;s++)r.mask[0].push(e[4*((t+r.bT)*r.w+s+r.bL)+3]>127?1:0);Res.trimSpr(r,e).then(()=>Res.push("svg text"))}).catch(d)}else o.spr=[h[i]]}else o.spr=i.spr.map(t=>n.Spr[t])})}catch(s){return console.error(s),o&&UI.$a("房间内容解析错误").then(()=>t(s)),e++,d()}if(n._o.for(t=>t.for(t=>{if(t.add.gpi){let e=n.grp.findIndex(e=>t.add.gpi.startsWith(e.i));if(-1===e)delete t.add.gpi;else{let s=n.grp[e];t.add._gi=e,t.add._gn=0|t.add.gpi.slice(s.i.length),0===s.m&&(s.p[t.add._gn]={x:t.x,y:t.y}),t.add.grpX=t.add.grpY=0}}$M.freeze(t.add)})),Object.freeze(n.grp),n.grp.for(t=>$M.freeze(t.p)),n.type){n.bobj=JSON.parse(n.bobj);for(let t in n.bobj)n.bobj[t]=n.bobj[t].add;if(n.bobj.gov){let t={...n.bobj.gov};delete t.tml,delete t.mov;let s=JSON.stringify(t),h=r.indexOf(s);if(-1===h){e++;let h=new Image,a=[El("canvas",0,{width:800,height:608})];a.boxL=a.x=400,a.boxT=a.y=304,a.boxW=a.w=800,a.boxH=a.h=608,a.bT=a.bL=0,n.sprGO=a,i.push(a),r.push(s),h.src=Res.svgGO(t),h.decode().then(()=>{let t=a[0].getContext("2d");t.drawImage(h,0,0),Res.trimSpr(a,t.getImageData(0,0,a.w,a.h).data).then(()=>Res.push("svg text"))}).catch(d)}else n.sprGO=i[h]}}if(n.bgm.m>1){n.bgm={...n.bgm};let t=n.bgm.i;switch(n.bgm.m){case 2:this.bgmSrc[t]||(e++,this.bgmSrc[t]="0",crypto.subtle.digest("SHA-1",(new TextEncoder).encode(t)).then(e=>Res.loadBgm(Array.from(new Uint8Array(e)).map(t=>t.toString(16).padStart(2,"0")).join(""),t)).then(e=>this.bgmSrc[t]=e).catch(c));break;case 3:this.bgmSrc[t]||(e++,this.bgmSrc[t]="0",Res.loadBgm(t,`https://music.163.com/song/media/outer/url?id=${t}.mp3`).then(e=>this.bgmSrc[t]=e).catch(c))}n.bgm.a=0!==n.bgm.a,n.bgm.l=0!==n.bgm.l}n.vM=2===n.view});const f=Res.loadUp;Res.reset(e),Res.loadUp=()=>{this.resPool.slice(0,2).for(t=>t.for(t=>this.rr.addSpr(t)));for(let t in this.resPool[2]){let e=this.resPool[2][t];e.length?this.rr.addSpr(e):e.m<3&&(e.c=[e.c],e.c.w=e.c[0].width,e.c.h=e.c[0].height,this.rr.addSpr(e.c))}this.rr.init().then(()=>{Res.loadUp=f,f()}).catch(e=>{console.error(e),UI.$a("渲染引擎初始化失败").then(()=>t(e))})}}exit(){Object.values(this.bgmSrc).for(t=>URL.revokeObjectURL(t)),this.bgm.destroy(),$c("surf",$("screen")).for(t=>t.remove()),this.rr.destroy(),this.G=null,this.end(),$R=null}async start(t,e){this.#P=e,this.#P&&(this.#L=saveCache),this.L=[];for(let t=0;t<12;t++)this.L[t]=new _C.L(t);this.Col=[{meet:(t,e,s,i,r,h,a)=>{if(this.$){let e=Math.round(this.$.B[0]),s=Math.round(this.$.B[1]),n=Math.round(this.$.B[2]),o=Math.round(this.$.B[3]);if(h>e&&a>s&&i<n&&r<o&&this.$._meet(0,0,e,s,n,o,t))return this.$}}},{obj:[],meet(t,e,s,i,r,h,a){for(let e=0;e<this.obj.length;e++){let s=this.obj[e],n=s.B[0],o=s.B[1],l=s.B[2],d=s.B[3];if(h>n&&a>o&&i<l&&r<d&&s._meet(0,0,n,o,l,d,t))return s}}}],this.outStk=[],$C.kRA(),this.anm=0,this.fpsCount=0,this.anmInt=1e3/App.gC("run","fps"),this.dvX=this.dvY=Infinity,this.#C=0,this.#M=Date.now(),this.#B=0,this.room=-1,this.fls=0,this.VAR={...this.G.VAR},-1===t?this.#L?this.load():this.roomTo(0):this.roomTo(t??this.startR),this.main(),(this.plyX||this.plyY)&&this.save(),this.spd=20,this.draw()}end(){cancelAnimationFrame(this.drawId),clearInterval(this.run),this.run=0}save(t=!0,e,s){if(this._r&&0!==this._r.type&&4!==this._r.type&&(t||this.#L)){if(t&&(this.#L={r:this._r.id,x:e??this.plyX,y:s??this.plyY,v:{...this.VAR}},this.$)){let t=this._r.bobj.ply;t.sJump&&(this.#L.j=this.$.jump),t.sGravDir&&(this.#L.gd=this.$.g_)}return Object.assign(this.#L,{time:this.#C,death:this.#B}),this.#P&&(saveCache=this.#L),!0}}load(){let t=this.#L;if(!t)return;this.VAR={...t.v},this.#C=t.time,this.#B=t.death,this.sDth.innerText=this.#B;let e=this.G.R.findIndex(e=>e.id===t.r);if(this.G.R[e]){let s=this.G.R[e].type;if(0===s||4===s)return;this.roomTo(e,t.x,t.y)}}pause(){this.run&&(clearInterval(this.run),this.run=0)}resume(){this.run=setInterval(this.#_,this.#I)}initPly(t){let e=this._r.bobj.ply;t.jump=e.sJump?this.#L?.j??e.jump:e.jump,t.g_=e.sGravDir?this.#L?.gd??e.g_:e.g_,t.conShoot=e.conShoot,t.adMove=e.adMove,t._grav=.4,t._moveSpd=3}dec(t){t.grp.for(t=>t.o.length=0);for(let e=0;e<this.L.length;e++)this.L[e].clear(),t._o[e].for(e=>{let s=new _C.R(e.ind,e.x,e.y,e.dep,e.spr);if(Object.assign(s,e.add),e.tml&&(s.tml=JSON.parse(e.tml)),e.trg&&(s.trg=JSON.parse(e.trg)),s.gpi&&(s.grp=t.grp[s._gi],s.grp.o.push(s)),10===e.ind){let i=t.grp[s._gid];i.c=s,s.grpO=i.o,0===i.m&&(s._gp=[],i.p.for((t,i)=>{t&&(s._gp[i]={x:t.x-e.x,y:t.y-e.y})}))}});if(2===t.out&&[[0,-32,t.w/32,1],[-32,-32,1,t.h/32+2],[0,t.h,t.w/32,1],[t.w,-32,1,t.h/32+2]].for(e=>{let s=new _C.R(3,e[0],e[1],7,Lib._o[3].spr.map(e=>t.Spr[e]));s.hd=1,s.cm=2,s.scx=e[2],s.scy=e[3]}),0===t.type&&(t.x=t.y=0),this.#T||this.#S)this.$=new _C.Y(this.#T,this.#S);else if(t.x||t.y){this.$=new _C.Y(t.x,t.y);let e=this.$.g_;270!==e&&(this.$.g_=270,this.$.setGrav(e))}else this.$=null;this.updView(1),this.activate(1)}roomTo(t,e=0,s=0){console.time("Room"+t);let i=this.G.R[t];this.room!==t&&(1===i.bgm.m?this.bgm.stop():i.bgm.m>1&&(this.bgm.vol=i.bgm.v??100,this._r&&this._r.bgm.i===i.bgm.i?this._r.bgm.l!==i.bgm.l&&(this.bgm.loop=i.bgm.l,i.bgm.a&&i.bgm.l&&0===this.bgm.state&&this.bgm.play()):(this.bgm.url=this.bgmSrc[i.bgm.i],this.bgm.loop=i.bgm.l,i.bgm.a&&this.bgm.play())),this.room=t,this._r=i,i.bg.m>2?this.BG.style.background=i.bg.c:this.BG.style.background="#000"),this.plyX=0,this.plyY=0,this._vX=0,this._vY=0,this.sfX=0,this.sfY=0,this.trg=[],this.warpTimer=-1,this.Col.length=2,this.Col[1].obj.length=0;for(let t=0;t<Lib._o.length+4;t++)this.Col.push(new _C.C(i.w,i.h,t+2));this.#T=e,this.#S=s,this.dec(i),this.vC=!1,this.#L?(1===i.type&&(this.#L.clr=1),this.#j=1+(this.#L.clr??0)):this.#j=0,this.bgmTime=this.bgm.time,this.sRoom&&(this.sRoom.innerText=this._r.name),console.timeEnd("Room"+t)}warp(t,e=0,s=0,i=0){let r=128===t?this.room+1:this.G.R.findIndex(e=>e.id===this._r.id+t);if(this.G.R[r])if(this.$&&(this.$.frozen=!0),1===e)if(r===this.room){if(s||i)this.$=new _C.Y(s,i);else if(this._r.x||this._r.y){this.$=new _C.Y(this._r.x,this._r.y);let t=this.$.g_;270!==t&&(this.$.g_=270,this.$.setGrav(t))}}else this.roomTo(r,s,i);else this.warpTo=r,this.warpS=e,this.warpX=s,this.warpY=i,0===e&&(this.flash("#000",0,1,25),this.warpTimer=30)}flash(t,e,s,i){this.sfM.fillStyle=t,this.flf=e,this.flt=s,this.fls=(s-e)/i}get vX(){return Math.round(this._vX)}set vX(t){let e=Math.round(t)!==Math.round(this._vX);this._vX=t,e&&(this.vC=!0)}get vY(){return Math.round(this._vY)}set vY(t){let e=Math.round(t)!==Math.round(this._vY);this._vY=t,e&&(this.vC=!0)}updView(t=0){let e=this._r;if(e.vM){let s=Math.mM(this.plyX-400,0,e.w-800),i=Math.mM(this.plyY-304,0,e.h-608);t?(this.sfX=Math.round(this._vX=s),this.sfY=Math.round(this._vY=i)):(this._vX+=(s-this._vX)/10,this._vY+=(i-this._vY)/10,(Math.abs(this._vX-this.sfX)>this.vMargin-32||Math.abs(this._vY-this.sfY)>this.vMargin-32)&&(this.sfX=Math.round(this._vX),this.sfY=Math.round(this._vY),this.vC=!0))}else this.sfX=this.vX=800*(this.plyX/800<<0),this.sfY=this.vY=608*(this.plyY/608<<0)}activate(t=0){let e=this._r.vM?this.vMargin:32,s=this.vX,i=this.vY;this.upd=!0,s-=e,i-=e;let r=s+800+2*e,h=i+608+2*e;if(t)for(let t=0;t<this.L.length;t++){const e=this.L[t].o;for(let t=0;t<e.length;t++)e[t].init(),e[t].activate(s,i,r,h)}else for(let t=0;t<this.L.length;t++){this.L[t].a.length=0;const e=this.L[t].o;for(let t=0;t<e.length;t++)e[t].activate(s,i,r,h)}}get time(){return this.#C}get dth(){return this.#B}addDth(){this.sDth.innerText=++this.#B}get svS(){return 0|this.#j}get tSec(){return this.#C/1e3<<0}get tMin(){return this.tSec/60<<0}get saveX(){return this.#L?.x}get saveY(){return this.#L?.y}get spd(){return this.#I}set spd(t){this.#I!==t&&(this.#A||this.#U)&&(this.#I=t,this.run&&clearInterval(this.run),this.run=setInterval(this.#_,t))}get god(){return this.#D}set god(t){this.#A&&(this.#D=t)}dragPly(t,e){this.#A&&this.$&&!this.$.frozen&&(this.$=new _C.Y(Math.round(t+this._vX),Math.round(e+this._vY)))}newGame(){let t=()=>{this.G.R[this.room+1]&&(this.$&&(this.$.frozen=!0),this.flash("#000",0,1,40),this.warpTimer=50,this.startMode=1,this.#L=null)};this.#L?UI.confirm("确定要重新开始游戏？").then(e=>{e.i||t()}):t()}loadGame(){this.#L&&(this.$&&(this.$.frozen=!0),this.flash("#000",0,1,40),this.warpTimer=50,this.startMode=2)}main(){if((this.warpTimer>0||UI.bg.n)&&$C.kPA(),-1===this.warpTimer)this._r.type&&($C.P("f2")?(this.$&&(this.$.frozen=!0),this.flash("#000",0,1,40),this.warpTimer=50,this.warpTo=this.startR,this.warpS=this.warpX=this.warpY=0):1!==this._r.type&&$C.P("r")&&(4===this._r.type?this.roomTo(this.room):(this.save(!1),this.load())));else if(0===this.warpTimer)switch(this.save(!1),this.startMode){case 0:switch(this.roomTo(this.warpTo,this.warpX,this.warpY),this.warpS){case 0:case 3:this.flash("#000",1,0,25)}break;case 2:this.startMode=0,this.load(),this.flash("#000",1,0,25);break;case 1:this.startMode=0,this.roomTo(this.room+1),this.flash("#000",1,0,25),this._r.type&&(this.plyX||this.plyY)&&this.save()}else this.warpTimer--;let t=this.Col[1].obj;for(let t=0;t<this.L.length;t++)this.L[t].iter(t=>t.step0());for(let t=0;t<this.L.length;t++)this.L[t].iter(t=>t.timer());for(let t=0;t<this.L.length;t++)this.L[t].iter(t=>t.step1());t.for(t=>t.step()),this.$&&this.$.step();for(let t=0;t<this.L.length;t++)this.L[t].iter(t=>t.move());this._r.grp.for(t=>{!t.c.moved||t.c.gpi&&t.c.grp.c.moved||t.c.updGrp()}),this.$&&this.$.move();for(let e=t.length;e--;)t[e].move(),t[e].des<0&&t.splice(e,1);for(let t=0;t<this.L.length;t++)this.L[t].iter(t=>t.step2());for(let t=0;t<this.L.length;t++)this.L[t].iter(t=>t.resetState());this.$&&this.$.resetState();for(let t=0;t<this.L.length;t++)this.L[t].gc();const e=this.trg;for(let t=e.length;t--;)1===e[t]?e[t]=2:3===e[t]&&(e[t]=0);this.fls&&(Math.abs(this.flt-this.flf)>Math.abs(this.fls)?this.flf+=this.fls:(this.flf=this.flt,this.fls=0)),this._r.bgm.m>1&&this._r.bgm.s&&1===this.bgm.state?(Math.abs(this.bgmTime-this.bgm.time)>.2&&(this.bgm.time=this.bgmTime),this.bgmTime+=.02,this.bgm.len&&this.bgmTime>this.bgm.len&&(this.bgmTime-=this.bgm.len)):this.bgmTime&&0===this.bgm.state&&(this.bgmTime=0),$C.kCA(),this.updView(),this.vC&&(this.vC=!1,this.activate());let s=Date.now();2!==this._r.type||this.#L?.clr||(this.#C+=s-this.#M);let i=this.tSec;i!==this.sTime.val&&(this.sTime.val=i,this.sTime.innerText=Date.cT(i)),this.#M=s}mRun(){let t=performance.now();this.main(),this.fps++,this.per+=performance.now()-t;let e=Date.now()-this.fpsT;if(e>=1e3){if(this.fps){this.sFps.innerText=this.fps,this.sRps.innerText=this.rps;let t=Math.round(this.per/5);this.sPer.style.color=t>50?"#d00":"",this.sPer.innerText=t+"%",t=Math.round(this.perD/5),this.sPerD.style.color=t>50?"#d00":"",this.sPerD.innerText=t+"%",this.fps=0,this.rps=0,this.per=0,this.perD=0}this.fpsT+=e>1500?e:1e3}if(this.sPlyX.val!==this.plyX){this.sPlyX.val=this.plyX,this.sPlyX.innerText=this.plyX.toFixed(2);let t=this.plyX%3;this.sPlyA.val!==t&&(this.sPlyA.val=t,this.sPlyA.innerText=t.toFixed(2))}this.sPlyY.val!==this.plyY&&(this.sPlyY.val=this.plyY,this.sPlyY.innerText=this.plyY.toFixed(2))}#G(t){let e=t-this.anm;if(Math.round(e)>=this.anmInt<<0){if(e-this.anmInt<=1||e-this.anmInt>=this.anmInt?this.anm=t:this.anm+=this.anmInt,this.sfM.clr&&(this.sfM.clearRect(0,0,800,608),this.sfM.clr=!1),this.flf>0&&(this.sfM.globalAlpha=this.flf,this.sfM.fillRect(0,0,800,608),this.sfM.clr=!0,this.flf>=1&&this.run))return void(this.drawId=window.requestAnimationFrame(this.draw));let s=this.vX,i=this.vY,r=this.dvX!==s||this.dvY!==i,h=this.upd||this.L.some(t=>t.upd);r&&this.rr.vC(s+400,i+304),this.upd=!1,this.dvX=s,this.dvY=i,h&&(this.L.for(t=>t.draw()),this.rr.updO()),(r||h)&&(this.rr.render(),this.rps++)}this.run&&(this.drawId=window.requestAnimationFrame(this.draw))}mDraw(t){let e=performance.now();this.#G(t),this.perD+=performance.now()-e}},_C.Q=class{constructor(t,e,s,i,r){this.L=t,this.T=e,this.W=s,this.H=i,this.R=t+s,this.B=e+i,this.ch=[null,null,null,null],this.len=4,this.obj=[],this.ind=r}expand(){let t=this.W>>6<<5,e=this.H>>6<<5;t<32||e<32||(this.ch[0]=new _C.Q(this.L,this.T,t,e,this.ind),this.ch[1]=new _C.Q(this.L+t,this.T,this.W-t,e,this.ind),this.ch[2]=new _C.Q(this.L,this.T+e,t,this.H-e,this.ind),this.ch[3]=new _C.Q(this.L+t,this.T+e,this.W-t,this.H-e,this.ind),this.obj.splice(0).for(t=>{t.colP[this.ind]=null,this.add(t)}))}loc(t){let e=this.ch;if(e[0])for(let s=0;s<this.len;s++)if(t.B[0]>=e[s].L&&t.B[1]>=e[s].T&&t.B[2]<=e[s].R&&t.B[3]<=e[s].B)return e[s].loc(t);return this}add(t){let e=this.ch;if(!e[0]&&this.obj.length>16&&this.expand(),e[0])for(let s=0;s<this.len;s++)if(t.B[0]>=e[s].L&&t.B[1]>=e[s].T&&t.B[2]<=e[s].R&&t.B[3]<=e[s].B)return e[s].add(t);t.colP[this.ind]=this.obj,t.colId[this.ind]=this.obj.push(t)-1}meet(t,e,s,i,r,h,a){let n=this.ch;if(n[0])for(let o=0;o<this.len;o++)if(h>n[o].L&&a>n[o].T&&i<n[o].R&&r<n[o].B){let l=n[o].meet(t,e,s,i,r,h,a);if(l)return l}for(let n=this.obj.length;n--;){let o=this.obj[n];if(o!==t&&(o.calcBox(),h>o.B[0]&&a>o.B[1]&&i<o.B[2]&&r<o.B[3]&&o.h&&t._meet(e,s,i,r,h,a,o)))return o}}find(t,e,s,i,r){let h=this.ch;if(h[0])for(let a=0;a<this.len;a++)s>h[a].L&&i>h[a].T&&t<h[a].R&&e<h[a].B&&h[a].find(t,e,s,i,r);for(let h=this.obj.length;h--;){let a=this.obj[h];a.calcBox(),s>a.B[0]&&i>a.B[1]&&t<a.B[2]&&e<a.B[3]&&a.h&&r.push(a)}}},_C.C=class extends _C.Q{constructor(t,e,s){super(0,0,0,0,0),this.ch.length=0,this.ind=s>5?0:1;let i=t/800<<0,r=e/608<<0;for(let s=0;s<r;s++){let h=s===r-1?e-608*s:608;for(let e=0;e<i;e++)this.ch.push(new _C.Q(800*e,608*s,e===i-1?t-800*e:800,h,this.ind))}this.len=this.ch.length,this.meet=this.find=this.skip}add(t){if(this.meet=this.__proto__.meet,this.find=this.__proto__.find,!t.colMov)for(let e=0,s=this.ch;e<this.len;e++)if(t.B[0]>=s[e].L&&t.B[1]>=s[e].T&&t.B[2]<=s[e].R&&t.B[3]<=s[e].B)return s[e].add(t);t.colP[this.ind]=this.obj,t.colId[this.ind]=this.obj.push(t)-1}upd(t){let e=this.loc(t),s=t.colP[this.ind],i=e.obj;if(i!==s){let r=t.colId[this.ind];for(s.splice(r,1);r<s.length;r++)s[r].colId[this.ind]=r;!e.ch[0]&&i.length>16?e.add(t):(t.colP[this.ind]=i,t.colId[this.ind]=i.push(t)-1)}}findAll(t,e,s,i){let r=[];return this.find(t,e,s,i,r),r}skip(){}};