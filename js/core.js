let $R=null,saveCache=null;const Core={dSprN(t,s,i){t.reset&&t.resetC(),t.drawImage(s[i],Math.round(this.x)-this.sprX+s.tx,Math.round(this.y)-this.sprY+s.ty)},dSprSc(t,s,i){let e=this.scx,h=this.scy;(Math.abs(e)<1||Math.abs(h)<1)&&(t.imageSmoothingEnabled=!0),t.setTransform(e,0,0,h,Math.round(this.x)-t.vX,Math.round(this.y)-t.vY),t.drawImage(s[i],s.tx-this.sprX,s.ty-this.sprY),t.imageSmoothingEnabled&&(t.imageSmoothingEnabled=!1),t.reset=!0},dSprAng(t,s,i){let e=this.ang*Math.DR,h=Math.cos(e),r=Math.sin(e);t.setTransform(h,-r,r,h,Math.round(this.x)-t.vX,Math.round(this.y)-t.vY),t.drawImage(s[i],s.tx-this.sprX,s.ty-this.sprY),t.reset=!0},dSprEx(t,s,i){let e=this.ang*Math.DR,h=Math.cos(e),r=Math.sin(e),a=this.scx,l=this.scy;(Math.abs(a)<1||Math.abs(l)<1)&&(t.imageSmoothingEnabled=!0),t.setTransform(h*a,-r*a,r*l,h*l,Math.round(this.x)-t.vX,Math.round(this.y)-t.vY),t.drawImage(s[i],s.tx-this.sprX,s.ty-this.sprY),t.imageSmoothingEnabled&&(t.imageSmoothingEnabled=!1),t.reset=!0},moveOxy(t,s,i){let e=(s-t.sprX)*t.scx,h=(i-t.sprY)*t.scy;if(e||h)if(t.sprX=s,t.sprY=i,t.ang){let s=t.ang*Math.DR,i=Math.cos(s),r=Math.sin(s);t.x+=i*e+r*h,t.y+=-r*e+i*h}else t.x+=e,t.y+=h},calcBox(t,s,i,e,h,r,a,l){let o=e*t.scx,n=h*t.scy,d=t.x-o,p=t.y-n;if(t.ang){let e=t.ang*Math.DR,h=Math.cos(e),a=Math.sin(e),l=s*h,g=s*a;r[0]=d+o*(1-h)-n*a,r[1]=p+o*a+n*(1-h),r[2]=r[0]+l,r[3]=r[1]-g,r[4]=r[0]+i*a,r[5]=r[1]+i*h,r[6]=r[4]+l,r[7]=r[5]-g}else r[0]=d,r[1]=p,r[2]=r[0]+s,r[3]=r[1],r[4]=r[0],r[5]=r[1]+i,r[6]=r[2],r[7]=r[5];let g=0,f=0,m=1,c=1;for(let t=0;t<8;t++)1&t?r[t]<r[m]?m=t:r[t]>r[c]&&(c=t):r[t]<r[g]?g=t:r[t]>r[f]&&(f=t);l[0]=g,l[1]=m,l[2]=f,l[3]=c,a[0]=Math.round(r[g]),a[1]=Math.round(r[m]),a[2]=Math.round(r[f]),a[3]=Math.round(r[c])}};Core.dec={rStr:"",setFlag(t){let s=(t??"").padEnd(6,"-|(~");this.bias=s.charCodeAt(0),this.iObj=s[1],this.iLay=s[2],this.iStr=s[3],this.iArr=s[4],this.iPro=s[5]},n(t){return t.charCodeAt(0)-this.bias},key(t){let s="",i=this.n(t);if(i<0)throw"decode key "+i;for(;i;)s+=String.fromCharCode(i%32+96),i>>=5;return s},num(t){let s=this.n(t),i=s/1e4<<0,e=i<3?1:-1;for(s%=1e4;i%3;)e*=10,i--;return s/e},str(t,s){let i="";for(;t[s]!==this.iStr;)if(i+=t.at(s++).replace(this.rStr,this.iStr),s>=t.length)throw"decode str at pos "+s;return[i,s+1]},arr(t,s){let i=[];for(let e=this.n(t[s++]);e--;){let e=this.val(t,s);if(i.push(e[0]),(s=e[1])>=t.length)throw"decode arr at pos "+s}return[i,s]},val(t,s){let i=t[s++];if(s>=t.length)throw"decode val at pos "+s;return i==this.iStr?this.str(t,s):i==this.iArr?this.arr(t,s):[this.num(i),s]},room(t,s,i){let e=0,h=0;for(;e<t.length;){let r=t.at(e++);if(r===this.iObj){let s=this.n(t.at(e++));for(;e<t.length&&t.at(e)!==this.iObj&&t.at(e)!==this.iLay;){let r=this.num(t.at(e++)),a=this.num(t.at(e++)),l={...Lib.obj[s]};if(l.add=$M.cp(l.add),t.at(e)===this.iPro){for(e++;t.at(e)!==this.iPro;){let s=this.key(t.at(e++));if([l.add[s],e]=this.val(t,e),e>=t.length)throw"decode pro at pos "+e}e++}l.add.dep=h,i(r,a,l)}}else r===this.iLay&&s(++h)}}},Core.L=class{constructor(t){this.i=t,this.sta=$R.sf[2*t+1],this.dyn=$R.sf[2*t+2],this.clr=!1,this.o=[],this.a=[],this.del=[],this.e=[]}push(t){return this.o.push(t)-1}add(t){t.$d(),this.a.push(t)}eff(t){this.e.push(t)}clear(){this.a.length=0,this.o.length=0,this.e.length=0}iter(t){for(let s=0;s<this.a.length;s++)this.a[s]._des?this.del.bIns(s):t(this.a[s])}gc(){if(this.del.length&&(this.del.forv(t=>{let s=this.a[t].oid;for(this.a.splice(t,1),this.o.splice(s,1);s<this.o.length;s++)this.o[s].oid=s}),this.del.length=0),this.e.length){this.dyn.upd=!0;for(let t=this.e.length;t--;)this.e[t].move(),this.e[t]._des&&this.e.splice(t,1)}}draw(){if(this.dyn.upd||this.sta.upd){if(7===this.i&&this.dyn.upd){$R.$&&$R.$.draw();let t=$R.Col[1].obj;t.length&&t.for(t=>t.draw())}this.e.for(t=>t.draw()),this.a.for(t=>{t.ctx.upd&&t.draw()})}}},Core.$R=class{#t;#s;#i;#e;#h;#r;#a;#l;#o;#n;#d;#p;#g;static rS=Date.now();constructor(t,s){this.G=Object.freeze(t),this.startR=0,this.endR=this.G.R.findIndex(t=>1===t.type);let i=$("screen");App.gC("run","smooth")?i.style.imageRendering="":i.style.imageRendering="pixelated",this.sfMargin=192,this.tS=i.ap(El("canvas","surf",{width:800,height:608})).transferControlToOffscreen().getContext("2d",{alpha:!1}),this.tS.imageSmoothingEnabled=!1,this.sf=[];const e=(t,s,i=!0)=>new OffscreenCanvas(t,s).getContext("2d",{alpha:i});for(let t=0;t<26;t++){let s;t>22?(25===t&&(this.GUI=i.ap(El("div")),this.GUI.id="GUI"),s=e(800,608)):s=e(800+2*this.sfMargin,608+2*this.sfMargin,0!==t),s.vX=s.vY=0,s.reset=!0,s.clr=!1,s.draw=!1,s.upd=!1,s.resetC=function(){this.setTransform(1,0,0,1,-this.vX,-this.vY),this.reset=!1},s.imageSmoothingEnabled=!1,this.sf.push(s)}this.#d=s,this.#n=Infinity,this.startMode=0,this.saveMode=Math.log2(t.S||1),this.#l=0,this.sTime=$("g-time"),this.sTime.val=0,this.sTime.tx("00:00:00"),this.sDth=$("g-dth"),this.sDth.tx("0"),this.sRoom=$("g-room"),this.sRoom?(this.sPlyX=$("g-plyX"),this.sPlyY=$("g-plyY"),this.sPlyA=$("g-plyA"),this.sFps=$("g-fps"),this.sRps=$("g-rps"),this.sPer=$("g-per"),this.sPerD=$("g-perD"),this.fps=-1,this.rps=0,this.per=0,this.perD=0,this.fpsT=0,this.#o=this.mRun.bind(this),this.draw=this.mDraw.bind(this)):(this.#o=this.main.bind(this),this.draw=this.#f.bind(this))}init(t){$("loading").style.background="";let s=0,i={},e=[],h=[],r=[],a=[],l=Res.sndList.slice(0,4);this.resPool=[e,r,i];let o=1,n=1;const d=s=>{o&&(o=0,s&&(console.error(s),UI.$a("游戏资源加载失败，请检查网络连接").then(()=>t(s))))},p=()=>{n&&(n=0,UI.$a("部分音乐资源加载失败"))},g=["pli","plr","plj","plf","plt","plb"];l.for(t=>{Res.snd[t]||(s++,Res.loadSnd(t))}),this.bgm=new Au.Bgm(1),this.bgmSrc={},this.G.R.for(l=>{let n=l.bg.m+(l.bg.id??0)+(l.bg.g??"");i[n]?l.bg=i[n]:(s+=2,i[n]=l.bg,Res.loadBg(l.bg,0,1).then(async t=>{t.c&&(t.c=await createImageBitmap(t.c)),3!==t.m&&(t.fill=this.sf[0].createPattern(t.c,"repeat")),Res.push("background")}).catch(d)),l.Spr={},l.spr.for(t=>{let[e,h]=t.split(":"),r="";for(let t in l.col)if(l.col[t].split("|").includes(e)){r=t;break}h||(h=Lib.thm[Res.sprList.indexOf(e)]);let a=e+h+r;if(i[a])"ply"===e&&g.for(t=>l.Spr[t]=i[t+a]),l.Spr[e]=i[a];else{s++,l.Spr[e]=i[a]=[];let t=Res.loadSpr(e,h,r,1,i[a]);"ply"===e&&(g.for(t=>l.Spr[t]=i[t+a]=[]),t.then(t=>g.for((s,i)=>{let e=i<2?4*i:2*i+4;l.Spr[s].push(...t.slice(e,i<2?e+4:e+2))}))),t.catch(d)}}),l._o=[[]],l.grp=[];try{Core.dec.setFlag(l.flag),Core.dec.room(l.obj,t=>l._o[t]=[],(t,i,e)=>{let h=e.ind;if(0===h)return l.x=t+17,void(l.y=i+23);let o={ind:h,x:t,y:i,dep:e.add.dep};if(delete e.add.dep,o.add={...e.add},e.add.tml&&(o.tml=JSON.stringify(e.add.tml),delete o.add.tml),e.add.trg&&(o.trg=JSON.stringify(e.add.trg),delete o.add.trg),["blk","tile"].includes(e.spr[0])&&(o.add.tile=!0,o.add.til>=1e3&&(o.add.til-=1e3),o.add.tb=15&o.add.til,o.add.tc=o.add.til>>4&15),e.def&&(o.add.def=e.def),l._o[o.dep].push(o),10===h){let t={m:o.add.gpm[0],i:e.add.gid,o:[]};switch(o.add._gid=l.grp.push(t)-1,t.m){case 0:t.p=[];break;case 1:t.p=o.add._gp=Core.D.circle(o.add.gpm[1],o.add.gpm[2]);break;case 2:t.p=o.add._gp=Core.D.polygon(o.add.gpm[1],o.add.gpm[3],o.add.gpm[2],0)}}else if(42===h){let t=o.add,i="";for(let s in Lib._o[42].add)i+="key"+t[s];let e=a.indexOf(i);if(-1===e){s++;let e=new Image,h=[El("canvas",0,{width:t.w,height:t.h})];h.x=h.y=0,h.w=t.w,h.h=t.h,h.px=!0,r.push(h),a.push(i),o.spr=[h],e.src=Res.svgTxt(t),e.decode().then(()=>{let t=h[0].getContext("2d");t.drawImage(e,0,0);let s=t.getImageData(0,0,h.w,h.h).data;[h.bL,h.bT,h.boxW,h.boxH]=Res.sprBox(s,h.w,h.h,1,127),h.boxL=-h.bL,h.boxT=-h.bT,h.mask=[[]];for(let t=0;t<h.boxH;t++)for(let i=0;i<h.boxW;i++)h.mask[0].push(s[4*((t+h.bT)*h.w+i+h.bL)+3]>127?1:0);Res.trimSpr(h,s).then(()=>Res.push("svg text"))}).catch(d)}else o.spr=[r[e]]}else o.spr=e.spr.map(t=>l.Spr[t])})}catch(i){return console.error(i),o&&UI.$a("房间内容解析错误").then(()=>t(i)),s++,d()}if(l._o.for(t=>t.for(t=>{if(t.add.gpi){let s=l.grp.findIndex(s=>t.add.gpi.startsWith(s.i));if(-1===s)delete t.add.gpi;else{let i=l.grp[s];t.add._gi=s,t.add._gn=0|t.add.gpi.slice(i.i.length),0===i.m&&(i.p[t.add._gn]={x:t.x,y:t.y}),t.add.grpX=t.add.grpY=0}}$M.freeze(t.add)})),Object.freeze(l.grp),l.grp.for(t=>$M.freeze(t.p)),l.type){l.bobj=JSON.parse(l.bobj);for(let t in l.bobj)l.bobj[t]=l.bobj[t].add;if(l.bobj.gov){let t={...l.bobj.gov};delete t.tml,delete t.mov;let i=JSON.stringify(t),r=h.indexOf(i);if(-1===r){s++;let r=new Image,a=[El("canvas",0,{width:800,height:608})];a.boxL=a.x=400,a.boxT=a.y=304,a.boxW=a.w=800,a.boxH=a.h=608,a.bT=a.bL=0,l.sprGO=[a],e.push(l.sprGO),h.push(i),r.src=Res.svgGO(t),r.decode().then(()=>{let t=a[0].getContext("2d");t.drawImage(r,0,0),Res.trimSpr(a,t.getImageData(0,0,a.w,a.h).data).then(()=>Res.push("svg text"))}).catch(d)}else l.sprGO=e[r]}}if(l.bgm.m>1){l.bgm={...l.bgm};let t=l.bgm.i;switch(l.bgm.m){case 2:this.bgmSrc[t]||(s++,this.bgmSrc[t]="0",crypto.subtle.digest("SHA-1",(new TextEncoder).encode(t)).then(s=>Res.loadBgm(Array.from(new Uint8Array(s)).map(t=>t.toString(16).padStart(2,"0")).join(""),t)).then(s=>this.bgmSrc[t]=s).catch(p));break;case 3:this.bgmSrc[t]||(s++,this.bgmSrc[t]="0",Res.loadBgm(t,`https://music.163.com/song/media/outer/url?id=${t}.mp3`).then(s=>this.bgmSrc[t]=s).catch(p))}l.bgm.a=0!==l.bgm.a,l.bgm.l=0!==l.bgm.l}l.vM=2===l.view}),Res.reset(s)}exit(){this.resPool[0].for(t=>t[0][0].close()),this.resPool[1].for(t=>t[0].close());for(let t in this.resPool[2]){let s=this.resPool[2][t];s.length?s.for(t=>t.close()):s.c&&s.c.close()}Object.values(this.bgmSrc).for(t=>URL.revokeObjectURL(t)),this.bgm.destroy(),$c("surf",$("screen")).for(t=>t.remove()),this.GUI.remove(),this.sf.for(t=>{let s=t.canvas;t.resetTransform(),t.clearRect(0,0,s.width,s.height),s.width=s.height=0}),this.sf=null,this.G=null,this.end(),$R=null}start(t,s){this.#a=s,this.#a&&(this.#r=saveCache),this.#i=0,this.#e=Date.now(),this.#h=0,this.room=-1,this.fls=0,this.VAR={...this.G.VAR},this.L=[];for(let t=0;t<12;t++)this.L[t]=new Core.L(t);this.Col=[{meet:(t,s,i,e,h,r,a)=>{if(this.$){let s=Math.round(this.$.B[0]),i=Math.round(this.$.B[1]),l=Math.round(this.$.B[2]),o=Math.round(this.$.B[3]);if(r>s&&a>i&&e<l&&h<o&&this.$._meet(0,0,s,i,l,o,t))return this.$}}},{obj:[],meet(t,s,i,e,h,r,a){for(let s=0;s<this.obj.length;s++){let i=this.obj[s],l=i.B[0],o=i.B[1],n=i.B[2],d=i.B[3];if(r>l&&a>o&&e<n&&h<d&&i._meet(0,0,l,o,n,d,t))return i}}}],this.outStk=[],$C.kRA(),-1===t?this.#r?this.load():this.roomTo(0):this.roomTo(t??this.startR),this.main(),(this.plyX||this.plyY)&&this.save(),this.spd=20,this.anm=0;let i=App.gC("run","fps");this.autoFps=i<0,this.fpsCount=0,this.anmInt=this.autoFps?100/6:1e3/i,this.dvX=this.dvY=0,this.draw()}end(){cancelAnimationFrame(this.drawId),clearInterval(this.run),this.run=0}save(t=!0,s,i){if(this._r&&0!==this._r.type&&4!==this._r.type&&(t||this.#r)){if(t&&(this.#r={r:this._r.id,x:s??this.plyX,y:i??this.plyY,v:{...this.VAR}},this.$)){let t=this._r.bobj.ply;t.sJump&&(this.#r.j=this.$.jump),t.sGravDir&&(this.#r.gd=this.$.g_)}return Object.assign(this.#r,{time:this.#i,death:this.#h}),this.#a&&(saveCache=this.#r),!0}}load(){let t=this.#r;if(!t)return;this.VAR={...t.v},this.#i=t.time,this.#h=t.death,this.sDth.innerText=this.#h;let s=this.G.R.findIndex(s=>s.id===t.r);if(this.G.R[s]){let i=this.G.R[s].type;if(0===i||4===i)return;this.roomTo(s,t.x,t.y)}}pause(){this.run&&(clearInterval(this.run),this.run=0)}resume(){this.run=setInterval(this.#o,this.#n)}initPly(t){let s=this._r.bobj.ply;t.jump=s.sJump?this.#r?.j??s.jump:s.jump,t.g_=s.sGravDir?this.#r?.gd??s.g_:s.g_,t.conShoot=s.conShoot,t.adMove=s.adMove,t._grav=.4,t._moveSpd=3}dec(t){t.grp.for(t=>t.o.length=0);for(let s=0;s<this.L.length;s++)this.L[s].clear(),t._o[s].for(s=>{let i=new Core.R(s.ind,s.x,s.y,s.dep,s.spr);if(Object.assign(i,s.add),s.tml&&(i.tml=JSON.parse(s.tml)),s.trg&&(i.trg=JSON.parse(s.trg)),i.gpi&&(i.grp=t.grp[i._gi],i.grp.o.push(i)),10===s.ind){let e=t.grp[i._gid];e.c=i,i.grpO=e.o,0===e.m&&(i._gp=[],e.p.for((t,e)=>{t&&(i._gp[e]={x:t.x-s.x,y:t.y-s.y})}))}});if(2===t.out&&[[0,-32,t.w/32,1],[-32,-32,1,t.h/32+2],[0,t.h,t.w/32,1],[t.w,-32,1,t.h/32+2]].for(s=>{let i=new Core.R(3,s[0],s[1],7,Lib._o[3].spr.map(s=>t.Spr[s]));i.hd=1,i.cm=2,i.scx=s[2],i.scy=s[3]}),0===t.type&&(t.x=t.y=0),this.#t||this.#s)this.$=new Core.Y(this.#t,this.#s);else if(t.x||t.y){this.$=new Core.Y(t.x,t.y);let s=this.$.g_;270!==s&&(this.$.g_=270,this.$.setGrav(s))}else this.$=null;this.updView(1),this.activate(1)}roomTo(t,s=0,i=0){console.time("Room"+t);let e=this.G.R[t];if(this.room!==t){1===e.bgm.m?this.bgm.stop():e.bgm.m>1&&(this.bgm.vol=e.bgm.v??100,this._r&&this._r.bgm.i===e.bgm.i?this._r.bgm.l!==e.bgm.l&&(this.bgm.loop=e.bgm.l,e.bgm.a&&e.bgm.l&&0===this.bgm.state&&this.bgm.play()):(this.bgm.url=this.bgmSrc[e.bgm.i],this.bgm.loop=e.bgm.l,e.bgm.a&&this.bgm.play())),this.room=t,this._r=e;let s=this.sf[0];switch(e.bg.m){case 0:s.fillStyle=e.bg.fill;break;case 2:break;case 3:s.resetTransform(),s.fillStyle=e.bg.g,s.fillRect(0,0,800,608);break;default:s.resetTransform(),s.fillStyle=e.bg.fill,s.fillRect(0,0,800,608)}}this.plyX=0,this.plyY=0,this._vX=0,this._vY=0,this.sfX=0,this.sfY=0,this.trg=[],this.warpTimer=-1,this.Col.length=2,this.Col[1].obj.length=0;for(let t=0;t<Lib._o.length+4;t++)this.Col.push(new Core.C(e.w,e.h,t+2));this.#t=s,this.#s=i,this.dec(e),this.vC=!1,this.#r?(1===e.type&&(this.#r.clr=1),this.#l=1+(this.#r.clr??0)):this.#l=0,this.bgmTime=this.bgm.time,this.sRoom&&(this.sRoom.innerText=this._r.name),console.timeEnd("Room"+t)}warp(t,s=0,i=0,e=0){let h=128===t?this.room+1:this.G.R.findIndex(s=>s.id===this._r.id+t);if(this.G.R[h])if(this.$&&(this.$.frozen=!0),1===s)if(h===this.room){if(i||e)this.$=new Core.Y(i,e);else if(this._r.x||this._r.y){this.$=new Core.Y(this._r.x,this._r.y);let t=this.$.g_;270!==t&&(this.$.g_=270,this.$.setGrav(t))}}else this.roomTo(h,i,e);else this.warpTo=h,this.warpS=s,this.warpX=i,this.warpY=e,0===s&&(this.flash("#000",0,1,25),this.warpTimer=30)}flash(t,s,i,e){this.sf[25].fillStyle=t,this.sf[25].clr=!1,this.flf=s,this.flt=i,this.fls=(i-s)/e}get vX(){return Math.round(this._vX)}set vX(t){let s=Math.round(t)!==Math.round(this._vX);this._vX=t,s&&(this.vC=!0)}get vY(){return Math.round(this._vY)}set vY(t){let s=Math.round(t)!==Math.round(this._vY);this._vY=t,s&&(this.vC=!0)}updView(t=0){let s=this._r;if(s.vM){let i=Math.mM(this.plyX-400,0,s.w-800),e=Math.mM(this.plyY-304,0,s.h-608);t?(this.sfX=Math.round(this._vX=i),this.sfY=Math.round(this._vY=e)):(this._vX+=(i-this._vX)/10,this._vY+=(e-this._vY)/10,(Math.abs(this._vX-this.sfX)>this.sfMargin-32||Math.abs(this._vY-this.sfY)>this.sfMargin-32)&&(this.sfX=Math.round(this._vX),this.sfY=Math.round(this._vY),this.vC=!0))}else this.sfX=this.vX=800*(this.plyX/800<<0),this.sfY=this.vY=608*(this.plyY/608<<0)}activate(t=0){let s=this._r.vM?this.sfMargin:32,i=this.vX,e=this.vY;this.upd=!0;for(let t=0;t<25;t++){let s=this.sf[t];t<23&&(s.vX=i-this.sfMargin,s.vY=e-this.sfMargin,s.reset=!0),s.clr=!0}i-=s,e-=s;let h=i+800+2*s,r=e+608+2*s;t?this.L.for(t=>t.o.for(t=>{t.init(),t.activate(i,e,h,r)})):this.L.for(t=>{t.a.length=0,t.o.for(t=>t.activate(i,e,h,r))})}get time(){return this.#i}get dth(){return this.#h}addDth(){this.sDth.innerText=++this.#h}get svS(){return this.#l}get tSec(){return this.#i/1e3<<0}get tMin(){return this.tSec/60<<0}get saveX(){return this.#r?.x}get saveY(){return this.#r?.y}get spd(){return this.#n}set spd(t){this.#n!==t&&(this.#d||this.#g)&&(this.#n=t,this.run&&clearInterval(this.run),this.run=setInterval(this.#o,t))}get god(){return this.#p}set god(t){this.#d&&(this.#p=t)}dragPly(t,s){this.#d&&this.$&&!this.$.frozen&&(this.$=new Core.Y(Math.round(t+this._vX),Math.round(s+this._vY)))}newGame(){let t=()=>{this.G.R[this.room+1]&&(this.$&&(this.$.frozen=!0),this.flash("#000",0,1,40),this.warpTimer=50,this.startMode=1,this.#r=null)};this.#r?UI.confirm("确定要重新开始游戏？").then(s=>{s.i||t()}):t()}loadGame(){this.#r&&(this.$&&(this.$.frozen=!0),this.flash("#000",0,1,40),this.warpTimer=50,this.startMode=2)}main(){if((this.warpTimer>0||UI.bg.n)&&$C.kPA(),-1===this.warpTimer)this._r.type&&($C.P("f2")?(this.$&&(this.$.frozen=!0),this.flash("#000",0,1,40),this.warpTimer=50,this.warpTo=this.startR,this.warpS=this.warpX=this.warpY=0):1!==this._r.type&&$C.P("r")&&(4===this._r.type?this.roomTo(this.room):(this.save(!1),this.load())));else if(0===this.warpTimer)switch(this.save(!1),this.startMode){case 0:switch(this.roomTo(this.warpTo,this.warpX,this.warpY),this.warpS){case 0:case 3:this.flash("#000",1,0,25)}break;case 2:this.startMode=0,this.load(),this.flash("#000",1,0,25);break;case 1:this.startMode=0,this.roomTo(this.room+1),this.flash("#000",1,0,25),this._r.type&&(this.plyX||this.plyY)&&this.save()}else this.warpTimer--;let t=this.Col[1].obj;for(this.L.for(t=>t.iter(t=>t.step0())),this.L.for(t=>t.iter(t=>t.timer())),this.L.for(t=>t.iter(t=>t.step1())),t.for(t=>t.step()),this.$&&this.$.step(),this.L.for(t=>t.iter(t=>t.move())),this._r.grp.for(t=>{!t.c.moved||t.c.gpi&&t.c.grp.c.moved||t.c.updGrp()}),this.L.for(t=>t.iter(t=>t.collision()));this.outStk.length;){for(let t=0;t<this.outStk.length;t++)if(3===this.outStk[t].test){let s=this.outStk[t];this.outStk.splice(t--,1),s.outSld()}let t=1;for(let s=0;s<this.outStk.length;s++)2===this.outStk[s].test&&(this.outStk[s].test=3,t=0);t&&(this.outStk.length=0)}this.$&&this.$.move();for(let s=t.length;s--;)t[s].move(),t[s].des<0&&t.splice(s,1);this.L.for(t=>t.iter(t=>t.step2())),this.L.for(t=>t.iter(t=>t.resetStatus())),this.$&&this.$.resetStatus(),this.L.for(t=>t.gc());let s=this.trg;for(let t=s.length;t--;)1===s[t]?s[t]=2:3===s[t]&&(s[t]=0);this.fls&&(Math.abs(this.flt-this.flf)>Math.abs(this.fls)?this.flf+=this.fls:(this.flf=this.flt,this.fls=0)),this._r.bgm.m>1&&this._r.bgm.s&&1===this.bgm.state?(Math.abs(this.bgmTime-this.bgm.time)>.2&&(this.bgm.time=this.bgmTime),this.bgmTime+=.02,this.bgm.len&&this.bgmTime>this.bgm.len&&(this.bgmTime-=this.bgm.len)):this.bgmTime&&0===this.bgm.state&&(this.bgmTime=0),$C.kCA(),this.updView(),this.vC&&(this.vC=!1,this.activate());let i=Date.now();2!==this._r.type||this.#r?.clr||(this.#i+=i-this.#e);let e=this.tSec;e!==this.sTime.val&&(this.sTime.val=e,this.sTime.innerText=Date.cT(e)),this.#e=i}mRun(){let t=performance.now();this.main(),this.fps++,this.per+=performance.now()-t;let s=Date.now()-this.fpsT;if(s>=1e3){if(this.fps){this.sFps.innerText=this.fps,this.sRps.innerText=this.rps;let t=Math.round(this.per/5);this.sPer.style.color=t>50?"#d00":"",this.sPer.innerText=t+"%",t=Math.round(this.perD/5),this.sPerD.style.color=t>50?"#d00":"",this.sPerD.innerText=t+"%",this.fps=0,this.rps=0,this.per=0,this.perD=0}this.fpsT+=s>1500?s:1e3}if(this.sPlyX.val!==this.plyX){this.sPlyX.val=this.plyX,this.sPlyX.innerText=this.plyX.toFixed(2);let t=this.plyX%3;this.sPlyA.val!==t&&(this.sPlyA.val=t,this.sPlyA.innerText=t.toFixed(2))}this.sPlyY.val!==this.plyY&&(this.sPlyY.val=this.plyY,this.sPlyY.innerText=this.plyY.toFixed(2))}#f(t){let s=t-this.anm;if(Math.round(s)>=this.anmInt<<0){let i=this.vX,e=this.vY,h=this.dvX!==i||this.dvY!==e,r=this.sf[25];if(r.clr&&(r.clearRect(0,0,800,608),r.clr=!1,h=!0),this.flf>0&&(r.globalAlpha=this.flf,r.fillRect(0,0,800,608),r.clr=!0,this.flf>=1&&this.run))return this.tS.drawImage(r.canvas,0,0),void(this.drawId=window.requestAnimationFrame(this.draw));if(this.upd){h=!0;let t=this.sf[0],s=this._r.bg;switch(s.m){case 0:t.resetC(),t.fillRect(0,0,this._r.w,this._r.h);break;case 2:t.resetC(),t.drawImage(s.c,0,0,this._r.w,this._r.h)}}for(let t=1;t<25;t++){let s=this.sf[t];(s.upd||s.clr&&s.draw)&&(s.draw&&(s.reset&&s.resetC(),s.clearRect(s.vX,s.vY,s.canvas.width,s.canvas.height),s.draw=!1),s.clr=!1,h=!0)}if(this.L.for(t=>t.draw()),h){let t=-this.sfMargin+this.sfX-i,s=-this.sfMargin+this.sfY-e;0===this._r.bg.m||2===this._r.bg.m?this.tS.drawImage(this.sf[0].canvas,t,s):this.tS.drawImage(this.sf[0].canvas,0,0);for(let i=1;i<25;i++){let e=this.sf[i];e.upd&&(e.upd=!1,e.draw=!0),e.draw&&(i>22?this.tS.drawImage(e.canvas,0,0):this.tS.drawImage(e.canvas,t,s))}this.flf>0&&this.tS.drawImage(this.sf[25].canvas,0,0),this.rps++}this.upd=!1,this.dvX=i,this.dvY=e,s-this.anmInt<=1||s-this.anmInt>=this.anmInt?this.anm=t:this.anm+=this.anmInt}this.run&&(this.drawId=window.requestAnimationFrame(this.draw))}mDraw(t){let s=performance.now();this.#f(t),this.perD+=performance.now()-s}},Core.Q=class{constructor(t,s,i,e,h){this.L=t,this.T=s,this.W=i,this.H=e,this.R=t+i,this.B=s+e,this.ch=[null,null,null,null],this.len=4,this.obj=[],this.ind=h}expand(){let t=this.W>>6<<5,s=this.H>>6<<5;t<32||s<32||(this.ch[0]=new Core.Q(this.L,this.T,t,s,this.ind),this.ch[1]=new Core.Q(this.L+t,this.T,this.W-t,s,this.ind),this.ch[2]=new Core.Q(this.L,this.T+s,t,this.H-s,this.ind),this.ch[3]=new Core.Q(this.L+t,this.T+s,this.W-t,this.H-s,this.ind),this.obj.splice(0).for(t=>{t.colP[this.ind]=null,this.add(t)}))}loc(t){let s=this.ch;if(s[0])for(let i=0;i<this.len;i++)if(t.B[0]>=s[i].L&&t.B[1]>=s[i].T&&t.B[2]<=s[i].R&&t.B[3]<=s[i].B)return s[i].loc(t);return this}add(t){let s=this.ch;if(!s[0]&&this.obj.length>16&&this.expand(),s[0])for(let i=0;i<this.len;i++)if(t.B[0]>=s[i].L&&t.B[1]>=s[i].T&&t.B[2]<=s[i].R&&t.B[3]<=s[i].B)return s[i].add(t);t.colP[this.ind]=this.obj,t.colId[this.ind]=this.obj.push(t)-1}meet(t,s,i,e,h,r,a){let l=this.ch;if(l[0])for(let o=0;o<this.len;o++)if(r>l[o].L&&a>l[o].T&&e<l[o].R&&h<l[o].B){let n=l[o].meet(t,s,i,e,h,r,a);if(n)return n}for(let l=this.obj.length;l--;){let o=this.obj[l];if(o!==t&&(o.calcBox(),r>o.B[0]&&a>o.B[1]&&e<o.B[2]&&h<o.B[3]&&o.h&&t._meet(s,i,e,h,r,a,o)))return o}}find(t,s,i,e,h){let r=this.ch;if(r[0])for(let a=0;a<this.len;a++)i>r[a].L&&e>r[a].T&&t<r[a].R&&s<r[a].B&&r[a].find(t,s,i,e,h);for(let r=this.obj.length;r--;){let a=this.obj[r];a.calcBox(),i>a.B[0]&&e>a.B[1]&&t<a.B[2]&&s<a.B[3]&&a.h&&h.push(a)}}},Core.C=class extends Core.Q{constructor(t,s,i){super(0,0,0,0,0),this.ch.length=0,this.ind=i>5?0:1;let e=t/800<<0,h=s/608<<0;for(let i=0;i<h;i++){let r=i===h-1?s-608*i:608;for(let s=0;s<e;s++)this.ch.push(new Core.Q(800*s,608*i,s===e-1?t-800*s:800,r,this.ind))}this.len=this.ch.length,this.meet=this.find=this.skip}add(t){if(this.meet=this.__proto__.meet,this.find=this.__proto__.find,!t.colMov)for(let s=0,i=this.ch;s<this.len;s++)if(t.B[0]>=i[s].L&&t.B[1]>=i[s].T&&t.B[2]<=i[s].R&&t.B[3]<=i[s].B)return i[s].add(t);t.colP[this.ind]=this.obj,t.colId[this.ind]=this.obj.push(t)-1}upd(t){let s=this.loc(t),i=t.colP[this.ind],e=s.obj;if(e!==i){let h=t.colId[this.ind];for(i.splice(h,1);h<i.length;h++)i[h].colId[this.ind]=h;!s.ch[0]&&e.length>16?s.add(t):(t.colP[this.ind]=e,t.colId[this.ind]=e.push(t)-1)}}findAll(t,s,i,e){let h=[];return this.find(t,s,i,e,h),h}skip(){}};