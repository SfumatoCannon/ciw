let $R=null,saveCache=null;const _C={dSprN(t,e){$R.rr.draw(t[e],this.x,this.y,t.tx-this.sprX,t.ty-this.sprY,this.scx,this.scy,this.ang,this.al)},moveOxy(t,e,s){let i=(e-t.sprX)*t.scx,h=(s-t.sprY)*t.scy;if(i||h)if(t.sprX=e,t.sprY=s,t.ang){let e=t.ang*Math.DR,s=Math.cos(e),r=Math.sin(e);t.x+=s*i+r*h,t.y+=-r*i+s*h}else t.x+=i,t.y+=h},calcBox(t,e,s,i,h,r,a,n){let o=i*t.scx,l=h*t.scy,d=t.x-o,c=t.y-l;if(t.ang){let i=t.ang*Math.DR,h=Math.cos(i),a=Math.sin(i),n=e*h,p=e*a;r[0]=d+o*(1-h)-l*a,r[1]=c+o*a+l*(1-h),r[2]=r[0]+n,r[3]=r[1]-p,r[4]=r[0]+s*a,r[5]=r[1]+s*h,r[6]=r[4]+n,r[7]=r[5]-p}else r[0]=d,r[1]=c,r[2]=r[0]+e,r[3]=r[1],r[4]=r[0],r[5]=r[1]+s,r[6]=r[2],r[7]=r[5];let p=0,m=0,g=1,f=1;for(let t=0;t<8;t++)1&t?r[t]<r[g]?g=t:r[t]>r[f]&&(f=t):r[t]<r[p]?p=t:r[t]>r[m]&&(m=t);n[0]=p,n[1]=g,n[2]=m,n[3]=f,a[0]=Math.round(r[p]),a[1]=Math.round(r[g]),a[2]=Math.round(r[m]),a[3]=Math.round(r[f])},WR:class{#t;#e=1;constructor(t){this.canvas=t,this.w=t.width,this.h=t.height,this.#t=[],this.#t.w=512,this.#t.s=0,this.cM=new Float32Array(6),this.dC=!1,this.dO=!1,this.L=1e5}addSpr(t){this.#t.push(t),t.for(t=>{this.#t.s+=(t.width+this.#e)*(t.height+this.#e),t.width>this.#t.w&&(this.#t.w<<=1)})}#s(t){return 1<<Math.ceil(Math.log2(t))}textureMap(t){let e=Math.max(this.#t.w,this.#s(this.#t.s**.5))+this.#e,s=0,i=0,h=[];const r=s=>s.for(s=>{const r=s.width+this.#e,a=s.height+this.#e;let n=h.find(t=>t.h>=a&&t.w>=r);n||(n={y:(h.at(-1)?.y??0)+a,h:a,w:e},h.push(n)),t.push(e-n.w,n.y-n.h,r-this.#e,a-this.#e),n.w-=r,s.id=i++});this.#t.for(t=>{32===t[0].height&&r(t)}),this.#t.for(t=>{32!==t[0].height&&r(t)}),s=this.#s(h.at(-1).y-this.#e),e-=this.#e,console.log(`TextureMap: ${e}x${s}`);const a=new OffscreenCanvas(e,s),n=a.getContext("2d");return this.#t.for(e=>{for(let s=0;s<e.length;s++){const i=e[s].id;n.drawImage(e[s],t[4*i],t[4*i+1]),e[s].close?.(),e[s]=0|i}if("rp"===e.name){const s=t[4*e[0]],h=t[4*e[0]+1];for(let r=1;r<32;++r)t.push(s,h+32-r,e.w,r),e.push(i++)}}),this.#t.length=0,this.#t.w=512,this.#t.s=0,a}vC(t,e){t===this.cM[4]&&e===this.cM[5]||(this.cM[4]=t,this.cM[5]=e,this.dC=!0)}vT(t,e,s=0){if(t*=2/this.w,e*=-2/this.h,s){const i=s/180*Math.PI,h=Math.cos(i),r=Math.sin(i);this.cM[0]=h*t,this.cM[1]=r*t,this.cM[2]=-r*e,this.cM[3]=h*e}else this.cM[0]=t,this.cM[1]=0,this.cM[2]=0,this.cM[3]=e;this.dC=!0}updO(){this.dO=!0}}};_C.WL=class extends _C.WR{#i;#h;#r;#a;#n;#o;#l;#d;#c;#p;#m=12;#g;#f;#u;constructor(t){super(t),t.addEventListener("webglcontextcreationerror",t=>{t.statusMessage&&console.error(t.statusMessage)}),t.addEventListener("webglcontextrestored",t=>{this.#i=null,this.#v()})}#b(t,e){const s=this.#i,i=s.createShader(t);if(s.shaderSource(i,e),s.compileShader(i),!s.getShaderParameter(i,s.COMPILE_STATUS))throw s.getShaderInfoLog(i);return i}#v(){if(this.#i){const t=this.#i;return void t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.#g.width,this.#g.height,0,t.RGBA,t.UNSIGNED_BYTE,this.#g)}this.#i=this.canvas.getContext("webgl2",{depth:!1,stencil:!1});const t=this.#i;if(!t)throw"Failed to get WebGL context";t.clearColor(0,0,0,0),t.enable(t.BLEND),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),this.#h=this.#b(t.VERTEX_SHADER,_C.WL.VertGLSL),this.#r=this.#b(t.FRAGMENT_SHADER,_C.WL.FragGLSL),this.#a=t.createProgram();const e=this.#a;if(t.attachShader(e,this.#h),t.attachShader(e,this.#r),t.linkProgram(e),!t.getProgramParameter(e,t.LINK_STATUS))throw t.getProgramInfoLog(e);t.useProgram(e),this.#n=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.#n),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint8Array([0,1,2,3]),t.STATIC_DRAW),this.#o=t.getUniformLocation(e,"camera"),t.uniform1i(t.getUniformLocation(e,"sampler"),0),this.#f=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.#f),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.#g.width,this.#g.height,0,t.RGBA,t.UNSIGNED_BYTE,this.#g),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.activeTexture(t.TEXTURE0),this.#d=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.#d),t.bufferData(t.ARRAY_BUFFER,this.#l,t.DYNAMIC_DRAW),["spr","pos","trans"].for((s,i)=>{const h=t.getAttribLocation(e,s);t.vertexAttribPointer(h,4,t.FLOAT,!1,4*this.#m,16*i),t.vertexAttribDivisor(h,1),t.enableVertexAttribArray(h)})}async init(){this.vT(1,1),this.#u=[],this.#g=this.textureMap(this.#u),this.#l??=new Float32Array(this.#m*this.L),this.#c=this.#p=0,this.#v()}draw(t,e,s,i,h,r=1,a=1,n=0,o=1){if(this.#p>=this.L)return;const l=this.#c++*this.#m,d=this.#l,c=this.#u,p=4*t;d[l]=c[p],d[l+1]=c[p+1],d[l+2]=c[p+2],d[l+3]=c[p+3],d[l+4]=e,d[l+5]=s,d[l+6]=i,d[l+7]=h,d[l+8]=r,d[l+9]=a,d[l+10]=n,d[l+11]=o}free(){const t=this.#i;t&&!t.isContextLost()&&t.clear(t.COLOR_BUFFER_BIT),this.dC=!1,this.dO=!1}render(){const t=this.#i;t.isContextLost()||(this.dC&&(t.uniformMatrix3x2fv(this.#o,!1,this.cM),this.dC=!1),this.dO&&(this.#p=this.#c,this.#c&&t.bufferSubData(t.ARRAY_BUFFER,0,this.#l.subarray(0,this.#p*this.#m)),this.#c=0,this.dO=!1),t.clear(t.COLOR_BUFFER_BIT),t.drawElementsInstanced(t.TRIANGLE_STRIP,4,t.UNSIGNED_BYTE,0,this.#p))}static VertGLSL="#version 300 es\nvec2 vertexRect[4] = vec2[4](\n  vec2(0., 0.),\n  vec2(1., 0.),\n  vec2(0., 1.),\n  vec2(1., 1.)\n);\n\nuniform mat3x2 camera;\n\nin vec4 spr;\nin vec4 pos;\nin vec4 trans;\n\nout vec2 uv;\nout vec4 color;\n\nvoid main(void) {\n  float a = radians(trans[2]);\n  mat2 transform = mat2(\n    vec2(cos(a) * trans[0], sin(a) * trans[1]),\n    vec2(-sin(a) * trans[0], cos(a) * trans[1])\n  );\n\n  vec2 vertex = vertexRect[gl_VertexID] * vec2(spr[2], spr[3]);\n\n  vec2 pos = (vertex + vec2(pos[2], pos[3])) * transform + vec2(pos[0], pos[1]);\n\n  gl_Position = vec4((pos - camera[2]) * mat2(camera[0], camera[1]), 0., 1.);\n  uv = vertex + vec2(spr[0], spr[1]);\n  color = vec4(1., 1., 1., trans[3]);\n}\n";static FragGLSL="#version 300 es\n#pragma vscode_glsllint_stage:frag\nprecision lowp float;\n\nuniform sampler2D sampler;\n\nin vec2 uv;\nin vec4 color;\nout vec4 fragColor;\n\nvoid main(void) {\n  fragColor = texture(sampler, uv / vec2(textureSize(sampler, 0))) * color;\n}\n"},_C.dec={rStr:"",setFlag(t){let e=(t??"").padEnd(6,"-|(~");this.bias=e.charCodeAt(0),this.iObj=e[1],this.iLay=e[2],this.iStr=e[3],this.iArr=e[4],this.iPro=e[5]},set(t,e){this.code=t,this.p=0,this.setFlag(e)},n(){return this.code.charCodeAt(this.p++)-this.bias},k(){let t="",e=this.n();if(e<0)throw"decode key "+e;for(;e;)t+=String.fromCharCode(e%32+96),e>>=5;return t},N(){let t=this.n(),e=t/1e4<<0,s=e<3?1:-1;for(t%=1e4;e%3;)s*=10,--e;return t/s},s(){++this.p;let t="";for(;this.code[this.p]!==this.iStr;)if(t+=this.code[this.p++].replace(this.rStr,this.iStr),this.p>=this.code.length)throw"decode str at pos "+this.p;return++this.p,t},a(){++this.p;const t=[];let e=this.n();for(;e--;)if(t.push(this.v()),this.p>=this.code.length)throw"decode arr at pos "+this.p;return t},v(){switch(this.code[this.p]){case this.iStr:return this.s();case this.iArr:return this.a();default:return this.N()}},o(t){let e=Lib.obj[t];if(e?(e={...e},e.add=$M.cp(e.add)):e={add:{}},this.code[this.p]===this.iPro){for(++this.p;this.code[this.p]!==this.iPro;){const t=this.k();if(e.add[t]=this.v(),this.p>=this.code.length)throw"decode pro at pos "+this.p}++this.p}return e},r(t,e){let s=0;for(t(s);this.p<this.code.length;){const i=this.code[this.p++];if(i===this.iObj){let t=this.n();for(;this.p<this.code.length&&this.code[this.p]!==this.iObj&&this.code[this.p]!==this.iLay;){const i=this.p,h=this.N(),r=this.N(),a=this.o(t);a.add.dep=s,e({x:h,y:r,prop:a,start:i,end:this.p})}}else i===this.iLay&&t(++s)}}},_C.L=class{constructor(t){this.i=t,this.o=[],this.a=[],this.del=[],this.e=[],this.draw=t<11?this.#y:this.#x}push(t){return this.o.push(t)-1}add(t){t.$d(),this.a.push(t)}eff(t){this.e.push(t)}clear(){this.a.length=0,this.o.length=0,this.e.length=0}iter(t){for(let e=0;e<this.a.length;e++)this.a[e]._des?this.del.bIns(e):t(this.a[e])}gc(){if(this.del.length&&(this.del.forv(t=>{let e=this.a[t].oid;for(this.a.splice(t,1),this.o.splice(e,1);e<this.o.length;e++)this.o[e].oid=e}),this.del.length=0),this.e.length){this.upd=!0;for(let t=this.e.length;t--;)this.e[t].move(),this.e[t]._des&&this.e.splice(t,1)}}#y(){if(0===this.i){const t=$R._r.bg,e=t.c.w,s=t.c.h;switch(t.m){case 0:let i=($R.vX/e|0)*e-$R.vX,h=($R.vY/s|0)*s-$R.vY;for(;h<608;h+=s)for(let s=i;s<800;s+=e)$R.rr.draw(t.c[0],$R.vX,$R.vY,s,h);break;case 1:let r=400-(e>>1),a=304-(s>>1);for(;r>0;)r-=e;for(;a>0;)a-=s;for(;a<608;a+=s)for(let s=r;s<800;s+=e)$R.rr.draw(t.c[0],$R.vX,$R.vY,s,a);break;case 2:$R.rr.draw(t.c[0],0,0,0,0,$R._r.w/e,$R._r.h/s)}}else if(7===this.i){$R.$&&$R.$.draw();const t=$R.Col[1].obj;for(let e=0;e<t.length;e++)t[e].draw()}for(let t=0;t<this.e.length;t++)this.e[t].draw();for(let t=0;t<this.a.length;t++)this.a[t].draw();this.upd=!1}#x(){const t=$R.vX,e=$R.vY;for(let s=0;s<this.e.length;s++)this.e[s].x+=t,this.e[s].y+=e,this.e[s].draw(),this.e[s].x-=t,this.e[s].y-=e;for(let s=0;s<this.a.length;s++)this.a[s].x+=t,this.a[s].y+=e,this.a[s].draw(),this.a[s].x-=t,this.a[s].y-=e;this.upd=!1}},_C.$R=class{static rS;static#R;static#w;static#T;static#M;static#S;static#C;static#L(){if(this.#R)return;const t=()=>El("canvas","surf",{width:800,height:608});this.#R=El("div","surf"),this.#w=t(),this.#C=new _C.WL(this.#w),this.#T=El("div","surf"),this.#T.id="GUI",this.#M=t().getContext("2d"),this.#M.imageSmoothingEnabled=!1,this.#M.clr=!1}#_;#B;#I;#D;#E;#A;#P;#j;#X;#G;#Y;#F;#U;constructor(t,e){_C.$R.rS=Math.randS(),this.G=Object.freeze(t),this.startR=0,this.endR=this.G.R.findIndex(t=>1===t.type),_C.$R.#L(),this.BG=_C.$R.#R,this.gC=_C.$R.#w,this.GUI=_C.$R.#T,this.sfM=_C.$R.#M,$("screen").ap(this.BG,this.gC,this.GUI,this.sfM.canvas),this.rr=_C.$R.#C,this.vMargin=192,this.#Y=e,this.#G=Infinity,this.startMode=0,this.saveMode=Math.log2(t.S||1),this.#j=0,this.sTime=$("g-time"),this.sTime.val=0,this.sTime.tx("00:00:00"),this.sDth=$("g-dth"),this.sDth.tx("0"),this.sRoom=$("g-room"),this.sRoom?(this.sPlyX=$("g-plyX"),this.sPlyY=$("g-plyY"),this.sPlyA=$("g-plyA"),this.sFps=$("g-fps"),this.sRps=$("g-rps"),this.sPer=$("g-per"),this.sPerD=$("g-perD"),this.fps=-1,this.rps=0,this.per=0,this.perD=0,this.fpsT=0,this.#X=this.mRun.bind(this),this.draw=this.mDraw.bind(this)):(this.#X=this.main.bind(this),this.draw=this.#O.bind(this))}init(t){console.time("Init"),$("loading").style.background="";let e=0,s={},i=[],h=[],r=[],a=[],n=Res.sndList.slice(0,4);this.resPool=[i,r,s];let o=1,l=1;const d=e=>{o&&(o=0,e&&(console.error(e),UI.$a("游戏资源加载失败，请检查网络连接").then(()=>t(e))))},c=()=>{l&&(l=0,UI.$a("部分音乐资源加载失败"))},p=["pli","plr","plj","plf","plt","plb"];this.bgm=new Au.Bgm(1),this.bgmSrc={},this.G.R.for(l=>{let m=l.bg.m+(l.bg.id??0)+(l.bg.g??"");s[m]?l.bg=s[m]:(++e,s[m]=l.bg,Res.loadBg(l.bg,0,1).catch(d)),l.Spr={},l.spr.for(t=>{let[i,h]=t.split(":"),r="";for(let t in l.col)if(l.col[t].split("|").includes(i)){r=t;break}h||(h=Lib.thm[Res.sprList.indexOf(i)]);let a=i+h+r;if(s[a]||"ply"===i&&s["pli"+a])"ply"===i?p.for(t=>l.Spr[t]=s[t+a]):l.Spr[i]=s[a];else{e++,l.Spr[i]=s[a]=[];let t=Res.loadSpr(i,h,r,1,s[a],1);"ply"===i&&(p.for(t=>l.Spr[t]=s[t+a]=[]),t.then(t=>p.for((e,i)=>{let h=i<2?4*i:2*i+4;l.Spr[e].push(...t.slice(h,i<2?h+4:h+2)),delete s[a],delete l.Spr.ply}))),t.catch(d)}}),l._o=[],l.grp=[];try{_C.dec.set(l.obj,l.flag),_C.dec.r(t=>l._o[t]=[],({x:t,y:s,prop:i})=>{let h=i.ind;if(0===h)return l.x=t+17,void(l.y=s+23);if(void 0===h)return;let n={ind:h,x:t,y:s,dep:i.add.dep};if(delete i.add.dep,n.add=i.add,i.add.tml&&(n.tml=JSON.stringify(i.add.tml),delete n.add.tml),i.add.trg&&(n.trg=JSON.stringify(i.add.trg),delete n.add.trg),["blk","tile"].includes(i.spr[0])&&(n.add.tile=!0,n.add.til>=1e3&&(n.add.til-=1e3),n.add.tb=15&n.add.til,n.add.tc=n.add.til>>4&15),i.def&&(n.add.def=i.def),l._o[n.dep].push(n),10===h){let t={m:n.add.gpm[0],i:i.add.gid,o:[]};switch(n.add._gid=l.grp.push(t)-1,t.m){case 0:t.p=[];break;case 1:t.p=n.add._gp=_C.D.circle(n.add.gpm[1],n.add.gpm[2]);break;case 2:t.p=n.add._gp=_C.D.polygon(n.add.gpm[1],n.add.gpm[3],n.add.gpm[2],0)}}else if(42===h){let t=n.add,s="";for(let e in Lib._o[42].add)s+="key"+t[e];let i=a.indexOf(s);if(-1===i){e++;let i=new Image,h=[El("canvas",0,{width:t.w,height:t.h})];h.x=h.y=0,h.w=t.w,h.h=t.h,h.px=!0,r.push(h),a.push(s),n.spr=[h],i.src=Res.svgTxt(t),i.decode().then(()=>{let t=h[0].getContext("2d");t.drawImage(i,0,0);let e=t.getImageData(0,0,h.w,h.h).data;[h.bL,h.bT,h.boxW,h.boxH]=Res.sprBox(e,h.w,h.h,1,127),h.boxL=-h.bL,h.boxT=-h.bT,h.mask=[[]];for(let t=0;t<h.boxH;t++)for(let s=0;s<h.boxW;s++)h.mask[0].push(e[4*((t+h.bT)*h.w+s+h.bL)+3]>127?1:0);Res.trimSpr(h,e).then(()=>Res.push("svg text"))}).catch(d)}else n.spr=[r[i]]}else n.spr=i.spr.map(t=>l.Spr[t])})}catch(s){return console.error(s),o&&UI.$a("房间内容解析错误").then(()=>t(s)),e++,d()}if(l._o.for(t=>t.for(t=>{if(t.add.gpi){let e=l.grp.findIndex(e=>t.add.gpi.startsWith(e.i));if(-1===e)delete t.add.gpi;else{let s=l.grp[e];t.add._gi=e,t.add._gn=0|t.add.gpi.slice(s.i.length),0===s.m&&(s.p[t.add._gn]={x:t.x,y:t.y}),t.add.grpX=t.add.grpY=0}}$M.freeze(t.add)})),Object.freeze(l.grp),l.grp.for(t=>$M.freeze(t.p)),l.type){l.bobj=JSON.parse(l.bobj);for(let t in l.bobj)l.bobj[t]=l.bobj[t].add;if(l.bobj.gov){let t={...l.bobj.gov};delete t.tml,delete t.mov;let s=JSON.stringify(t),r=h.indexOf(s);if(-1===r){e++;let r=new Image,a=[El("canvas",0,{width:800,height:608})];a.boxL=a.x=400,a.boxT=a.y=304,a.boxW=a.w=800,a.boxH=a.h=608,a.bT=a.bL=0,l.sprGO=a,i.push(a),h.push(s),r.src=Res.svgGO(t),r.decode().then(()=>{let t=a[0].getContext("2d");t.drawImage(r,0,0),Res.trimSpr(a,t.getImageData(0,0,a.w,a.h).data).then(()=>Res.push("svg text"))}).catch(d)}else l.sprGO=i[r]}}if(n.for(t=>{Res.snd[t]||(e++,Res.loadSnd(t))}),l.snd?.for(t=>{Res.snd[t]||n.includes(t)||(e++,n.push(t),Res.loadSnd(t))}),l.bgm.m>1){l.bgm={...l.bgm};let t=l.bgm.i;switch(l.bgm.m){case 2:this.bgmSrc[t]||(e++,this.bgmSrc[t]="0",crypto.subtle.digest("SHA-1",(new TextEncoder).encode(t)).then(e=>Res.loadBgm(Array.from(new Uint8Array(e)).map(t=>t.toString(16).padStart(2,"0")).join(""),t)).then(e=>this.bgmSrc[t]=e).catch(c));break;case 3:this.bgmSrc[t]||(e++,this.bgmSrc[t]="0",Res.loadBgm(t,`https://music.163.com/song/media/outer/url?id=${t}.mp3`).then(e=>this.bgmSrc[t]=e).catch(c))}l.bgm.a=0!==l.bgm.a,l.bgm.l=0!==l.bgm.l}l.vM=2===l.view});const m=Res.loadUp;Res.reset(e),Res.loadUp=()=>{this.resPool.slice(0,2).for(t=>t.for(t=>this.rr.addSpr(t)));for(let t in this.resPool[2]){let e=this.resPool[2][t];e.length?this.rr.addSpr(e):e.m<3&&(e.c=[e.c],e.c.w=e.c[0].width,e.c.h=e.c[0].height,this.rr.addSpr(e.c))}this.rr.init().then(()=>{Res.loadUp=m,m()}).catch(e=>{Res.loadUp=m,console.error(e),UI.$a("渲染引擎初始化失败").then(()=>t(e))})},console.timeEnd("Init")}exit(){Object.values(this.bgmSrc).for(t=>URL.revokeObjectURL(t)),this.bgm.destroy(),$c("surf",$("screen")).for(t=>t.remove()),this.rr.free(),this.G=null,this.end(),$R=null}start(t,e){this.#P=e,this.#P&&(this.#A=saveCache),this.L=[];for(let t=0;t<12;t++)this.L[t]=new _C.L(t);this.Col=[{meet:(t,e,s,i,h,r,a)=>{if(this.$){let e=Math.round(this.$.B[0]),s=Math.round(this.$.B[1]),n=Math.round(this.$.B[2]),o=Math.round(this.$.B[3]);if(r>e&&a>s&&i<n&&h<o&&this.$._meet(0,0,e,s,n,o,t))return this.$}}},{obj:[],meet(t,e,s,i,h,r,a){for(let e=0;e<this.obj.length;e++){let s=this.obj[e],n=s.B[0],o=s.B[1],l=s.B[2],d=s.B[3];if(r>n&&a>o&&i<l&&h<d&&s._meet(0,0,n,o,l,d,t))return s}}}],this.outStk=[],$C.kRA(),this.anm=0,this.fpsCount=0,this.anmInt=1e3/App.gC("run","fps"),this.dvX=this.dvY=Infinity,this.#I=0,this.#D=Date.now(),this.#E=0,this.room=-1,this.fls=0,this.VAR={...this.G.VAR},-1===t?this.#A?this.load():this.roomTo(0):this.roomTo(t??this.startR),this.main(),(this.plyX||this.plyY)&&this.save(),this.spd=20,this.draw()}end(){cancelAnimationFrame(this.drawId),clearInterval(this.run),this.run=0}save(t=!0,e,s){if(this._r&&0!==this._r.type&&4!==this._r.type&&(t||this.#A)){if(t&&(this.#A={r:this._r.id,x:e??this.plyX,y:s??this.plyY,v:{...this.VAR}},this.$)){let t=this._r.bobj.ply;t.sJump&&(this.#A.j=this.$.jump),t.sGravDir&&(this.#A.gd=this.$.g_)}return Object.assign(this.#A,{time:this.#I,death:this.#E}),this.#P&&(saveCache=this.#A),!0}}load(){let t=this.#A;if(!t)return;this.VAR={...t.v},this.#I=t.time,this.#E=t.death,this.sDth.innerText=this.#E;let e=this.G.R.findIndex(e=>e.id===t.r);if(this.G.R[e]){let s=this.G.R[e].type;if(0===s||4===s)return;this.roomTo(e,t.x,t.y)}}pause(){this.run&&(clearInterval(this.run),this.run=0)}resume(){this.run=setInterval(this.#X,this.#G)}initPly(t){let e=this._r.bobj.ply;t.jump=e.sJump?this.#A?.j??e.jump:e.jump,t.g_=e.sGravDir?this.#A?.gd??e.g_:e.g_,t.conShoot=e.conShoot,t.adMove=e.adMove,t._grav=.4,t._moveSpd=3}dec(t){t.grp.for(t=>t.o.length=0);for(let e=0;e<this.L.length;e++)this.L[e].clear(),t._o[e].for(e=>{let s=new _C.R(e.ind,e.x,e.y,e.dep,e.spr);if(Object.assign(s,e.add),e.tml&&(s.tml=JSON.parse(e.tml)),e.trg&&(s.trg=JSON.parse(e.trg)),s.gpi&&(s.grp=t.grp[s._gi],s.grp.o.push(s)),10===e.ind){let i=t.grp[s._gid];i.c=s,s.grpO=i.o,0===i.m&&(s._gp=[],i.p.for((t,i)=>{t&&(s._gp[i]={x:t.x-e.x,y:t.y-e.y})}))}});if(2===t.out&&[[0,-32,t.w/32,1],[-32,-32,1,t.h/32+2],[0,t.h,t.w/32,1],[t.w,-32,1,t.h/32+2]].for(e=>{let s=new _C.R(3,e[0],e[1],7,Lib._o[3].spr.map(e=>t.Spr[e]));s.hd=1,s.cm=2,s.scx=e[2],s.scy=e[3]}),0===t.type&&(t.x=t.y=0),this.#_||this.#B)this.$=new _C.Y(this.#_,this.#B);else if(t.x||t.y){this.$=new _C.Y(t.x,t.y);let e=this.$.g_;270!==e&&(this.$.g_=270,this.$.setGrav(e))}else this.$=null;this.updView(1),this.activate(1)}roomTo(t,e=0,s=0){console.time("Room"+t);let i=this.G.R[t];this.room!==t&&(1===i.bgm.m?this.bgm.stop():i.bgm.m>1&&(this.bgm.vol=i.bgm.v??100,this._r&&this._r.bgm.i===i.bgm.i?this._r.bgm.l!==i.bgm.l&&(this.bgm.loop=i.bgm.l,i.bgm.a&&i.bgm.l&&0===this.bgm.state&&this.bgm.play()):(this.bgm.url=this.bgmSrc[i.bgm.i],this.bgm.loop=i.bgm.l,i.bgm.a&&this.bgm.play())),this.room=t,this._r=i,i.bg.m>2?this.BG.style.background=i.bg.c:this.BG.style.background="#000"),this.plyX=0,this.plyY=0,this._vX=0,this._vY=0,this.sfX=0,this.sfY=0,this.trg=[],this.warpTimer=-1,this.Col.length=2,this.Col[1].obj.length=0;for(let t=0;t<Lib._o.length+4;t++)this.Col.push(new _C.C(i.w,i.h,t+2));this.#_=e,this.#B=s,this.dec(i),this.vC=!1,this.#A?(1===i.type&&(this.#A.clr=1),this.#j=1+(this.#A.clr??0)):this.#j=0,this.bgmTime=this.bgm.time,this.sRoom&&(this.sRoom.innerText=this._r.name),console.timeEnd("Room"+t)}warp(t,e=0,s=0,i=0){let h=128===t?this.room+1:this.G.R.findIndex(e=>e.id===this._r.id+t);if(this.G.R[h])if(this.$&&(this.$.frozen=!0),1===e)if(h===this.room){if(s||i)this.$=new _C.Y(s,i);else if(this._r.x||this._r.y){this.$=new _C.Y(this._r.x,this._r.y);let t=this.$.g_;270!==t&&(this.$.g_=270,this.$.setGrav(t))}}else this.roomTo(h,s,i);else this.warpTo=h,this.warpS=e,this.warpX=s,this.warpY=i,0===e&&(this.flash("#000",0,1,25),this.warpTimer=30)}flash(t,e,s,i){this.sfM.fillStyle=t,this.flf=e,this.flt=s,this.fls=(s-e)/i}get vX(){return Math.round(this._vX)}set vX(t){let e=Math.round(t)!==Math.round(this._vX);this._vX=t,e&&(this.vC=!0)}get vY(){return Math.round(this._vY)}set vY(t){let e=Math.round(t)!==Math.round(this._vY);this._vY=t,e&&(this.vC=!0)}updView(t=0){let e=this._r;if(e.vM){let s=Math.mM(this.plyX-400,0,e.w-800),i=Math.mM(this.plyY-304,0,e.h-608);t?(this.sfX=Math.round(this._vX=s),this.sfY=Math.round(this._vY=i)):(this._vX+=(s-this._vX)/10,this._vY+=(i-this._vY)/10,(Math.abs(this._vX-this.sfX)>this.vMargin-32||Math.abs(this._vY-this.sfY)>this.vMargin-32)&&(this.sfX=Math.round(this._vX),this.sfY=Math.round(this._vY),this.vC=!0))}else this.sfX=this.vX=800*(this.plyX/800<<0),this.sfY=this.vY=608*(this.plyY/608<<0)}activate(t=0){let e=this._r.vM?this.vMargin:32,s=this.vX,i=this.vY;this.upd=!0,s-=e,i-=e;let h=s+800+2*e,r=i+608+2*e;if(t)for(let t=0;t<this.L.length;t++){const e=this.L[t].o;for(let t=0;t<e.length;t++)e[t].init(),e[t].activate(s,i,h,r)}else for(let t=0;t<this.L.length;t++){this.L[t].a.length=0;const e=this.L[t].o;for(let t=0;t<e.length;t++)e[t].activate(s,i,h,r)}}get time(){return this.#I}get dth(){return this.#E}addDth(){this.sDth.innerText=++this.#E}get svS(){return 0|this.#j}get tSec(){return this.#I/1e3<<0}get tMin(){return this.tSec/60<<0}get saveX(){return this.#A?.x}get saveY(){return this.#A?.y}get spd(){return this.#G}set spd(t){this.#G!==t&&(this.#Y||this.#U)&&(this.#G=t,this.run&&clearInterval(this.run),this.run=setInterval(this.#X,t))}get god(){return this.#F}set god(t){this.#Y&&(this.#F=t)}dragPly(t,e){this.#Y&&this.$&&!this.$.frozen&&(this.$=new _C.Y(Math.round(t+this._vX),Math.round(e+this._vY)))}newGame(){let t=()=>{this.G.R[this.room+1]&&(this.$&&(this.$.frozen=!0),this.flash("#000",0,1,40),this.warpTimer=50,this.startMode=1,this.#A=null)};this.#A?UI.confirm("确定要重新开始游戏？").then(e=>{e.i||t()}):t()}loadGame(){this.#A&&(this.$&&(this.$.frozen=!0),this.flash("#000",0,1,40),this.warpTimer=50,this.startMode=2)}main(){if((this.warpTimer>0||UI.bg.n)&&$C.kPA(),-1===this.warpTimer)this._r.type&&($C.P("f2")?(this.$&&(this.$.frozen=!0),this.flash("#000",0,1,40),this.warpTimer=50,this.warpTo=this.startR,this.warpS=this.warpX=this.warpY=0):1!==this._r.type&&$C.P("r")&&(4===this._r.type?this.roomTo(this.room):(this.save(!1),this.load())));else if(0===this.warpTimer)switch(this.save(!1),this.startMode){case 0:switch(this.roomTo(this.warpTo,this.warpX,this.warpY),this.warpS){case 0:case 3:this.flash("#000",1,0,25)}break;case 2:this.startMode=0,this.load(),this.flash("#000",1,0,25);break;case 1:this.startMode=0,this.roomTo(this.room+1),this.flash("#000",1,0,25),this._r.type&&(this.plyX||this.plyY)&&this.save()}else this.warpTimer--;let t=this.Col[1].obj;for(let t=0;t<this.L.length;t++)this.L[t].iter(t=>t.step0());for(let t=0;t<this.L.length;t++)this.L[t].iter(t=>t.timer());for(let t=0;t<this.L.length;t++)this.L[t].iter(t=>t.step1());t.for(t=>t.step()),this.$&&this.$.step();for(let t=0;t<this.L.length;t++)this.L[t].iter(t=>t.move());this._r.grp.for(t=>{!t.c.moved||t.c.gpi&&t.c.grp.c.moved||t.c.updGrp()}),this.$&&this.$.move();for(let e=t.length;e--;)t[e].move(),t[e].des<0&&t.splice(e,1);for(let t=0;t<this.L.length;t++)this.L[t].iter(t=>t.step2());for(let t=0;t<this.L.length;t++)this.L[t].iter(t=>t.resetState());this.$&&this.$.resetState();for(let t=0;t<this.L.length;t++)this.L[t].gc();const e=this.trg;for(let t=e.length;t--;)1===e[t]?e[t]=2:3===e[t]&&(e[t]=0);this.fls&&(Math.abs(this.flt-this.flf)>Math.abs(this.fls)?this.flf+=this.fls:(this.flf=this.flt,this.fls=0)),this._r.bgm.m>1&&this._r.bgm.s&&1===this.bgm.state?(Math.abs(this.bgmTime-this.bgm.time)>.2&&(this.bgm.time=this.bgmTime),this.bgmTime+=.02,this.bgm.len&&this.bgmTime>this.bgm.len&&(this.bgmTime-=this.bgm.len)):this.bgmTime&&0===this.bgm.state&&(this.bgmTime=0),$C.kCA(),this.updView(),this.vC&&(this.vC=!1,this.activate());let s=Date.now();2!==this._r.type||this.#A?.clr||(this.#I+=s-this.#D);let i=this.tSec;i!==this.sTime.val&&(this.sTime.val=i,this.sTime.innerText=Date.cT(i)),this.#D=s}mRun(){let t=performance.now();this.main(),this.fps++,this.per+=performance.now()-t;let e=Date.now()-this.fpsT;if(e>=1e3){if(this.fps){this.sFps.innerText=this.fps,this.sRps.innerText=this.rps;let t=Math.round(this.per/5);this.sPer.style.color=t>50?"#d00":"",this.sPer.innerText=t+"%",t=Math.round(this.perD/5),this.sPerD.style.color=t>50?"#d00":"",this.sPerD.innerText=t+"%",this.fps=0,this.rps=0,this.per=0,this.perD=0}this.fpsT+=e>1500?e:1e3}if(this.sPlyX.val!==this.plyX){this.sPlyX.val=this.plyX,this.sPlyX.innerText=this.plyX.toFixed(2);let t=this.plyX%3;this.sPlyA.val!==t&&(this.sPlyA.val=t,this.sPlyA.innerText=t.toFixed(2))}this.sPlyY.val!==this.plyY&&(this.sPlyY.val=this.plyY,this.sPlyY.innerText=this.plyY.toFixed(2))}#O(t){let e=t-this.anm;if(Math.round(e)>=this.anmInt<<0){if(e-this.anmInt<=1||e-this.anmInt>=this.anmInt?this.anm=t:this.anm+=this.anmInt,this.sfM.clr&&(this.sfM.clearRect(0,0,800,608),this.sfM.clr=!1),this.flf>0&&(this.sfM.globalAlpha=this.flf,this.sfM.fillRect(0,0,800,608),this.sfM.clr=!0,this.flf>=1&&this.run))return void(this.drawId=window.requestAnimationFrame(this.draw));let s=this.vX,i=this.vY,h=this.dvX!==s||this.dvY!==i,r=this.upd||this.L.some(t=>t.upd);h&&this.rr.vC(s+400,i+304),this.upd=!1,this.dvX=s,this.dvY=i,r&&(this.L.for(t=>t.draw()),this.rr.updO()),(h||r)&&(this.rr.render(),this.rps++)}this.run&&(this.drawId=window.requestAnimationFrame(this.draw))}mDraw(t){let e=performance.now();this.#O(t),this.perD+=performance.now()-e}},_C.Q=class{constructor(t,e,s,i,h){this.L=t,this.T=e,this.W=s,this.H=i,this.R=t+s,this.B=e+i,this.ch=[null,null,null,null],this.len=4,this.obj=[],this.ind=h}expand(){let t=this.W>>6<<5,e=this.H>>6<<5;t<32||e<32||(this.ch[0]=new _C.Q(this.L,this.T,t,e,this.ind),this.ch[1]=new _C.Q(this.L+t,this.T,this.W-t,e,this.ind),this.ch[2]=new _C.Q(this.L,this.T+e,t,this.H-e,this.ind),this.ch[3]=new _C.Q(this.L+t,this.T+e,this.W-t,this.H-e,this.ind),this.obj.splice(0).for(t=>{t.colP[this.ind]=null,this.add(t)}))}loc(t){let e=this.ch;if(e[0])for(let s=0;s<this.len;s++)if(t.B[0]>=e[s].L&&t.B[1]>=e[s].T&&t.B[2]<=e[s].R&&t.B[3]<=e[s].B)return e[s].loc(t);return this}add(t){let e=this.ch;if(!e[0]&&this.obj.length>16&&this.expand(),e[0])for(let s=0;s<this.len;s++)if(t.B[0]>=e[s].L&&t.B[1]>=e[s].T&&t.B[2]<=e[s].R&&t.B[3]<=e[s].B)return e[s].add(t);t.colP[this.ind]=this.obj,t.colId[this.ind]=this.obj.push(t)-1}meet(t,e,s,i,h,r,a){let n=this.ch;if(n[0])for(let o=0;o<this.len;o++)if(r>n[o].L&&a>n[o].T&&i<n[o].R&&h<n[o].B){let l=n[o].meet(t,e,s,i,h,r,a);if(l)return l}for(let n=this.obj.length;n--;){let o=this.obj[n];if(o!==t&&(o.calcBox(),r>o.B[0]&&a>o.B[1]&&i<o.B[2]&&h<o.B[3]&&o.h&&t._meet(e,s,i,h,r,a,o)))return o}}find(t,e,s,i,h){let r=this.ch;if(r[0])for(let a=0;a<this.len;a++)s>r[a].L&&i>r[a].T&&t<r[a].R&&e<r[a].B&&r[a].find(t,e,s,i,h);for(let r=this.obj.length;r--;){let a=this.obj[r];a.calcBox(),s>a.B[0]&&i>a.B[1]&&t<a.B[2]&&e<a.B[3]&&a.h&&h.push(a)}}},_C.C=class extends _C.Q{constructor(t,e,s){super(0,0,0,0,0),this.ch.length=0,this.ind=s>5?0:1;let i=t/800<<0,h=e/608<<0;for(let s=0;s<h;s++){let r=s===h-1?e-608*s:608;for(let e=0;e<i;e++)this.ch.push(new _C.Q(800*e,608*s,e===i-1?t-800*e:800,r,this.ind))}this.len=this.ch.length,this.meet=this.find=this.skip}add(t){if(this.meet=this.__proto__.meet,this.find=this.__proto__.find,!t.colMov)for(let e=0,s=this.ch;e<this.len;e++)if(t.B[0]>=s[e].L&&t.B[1]>=s[e].T&&t.B[2]<=s[e].R&&t.B[3]<=s[e].B)return s[e].add(t);t.colP[this.ind]=this.obj,t.colId[this.ind]=this.obj.push(t)-1}upd(t){let e=this.loc(t),s=t.colP[this.ind],i=e.obj;if(i!==s){let h=t.colId[this.ind];for(s.splice(h,1);h<s.length;h++)s[h].colId[this.ind]=h;!e.ch[0]&&i.length>16?e.add(t):(t.colP[this.ind]=i,t.colId[this.ind]=i.push(t)-1)}}findAll(t,e,s,i){let h=[];return this.find(t,e,s,i,h),h}skip(){}};