const Res={snd:{},spr:{},font:{},sndList:["jp","st","dth","wj","brk","ej","gj","lj","spk","chr","spr","hit","bc","coin","bst","dash"],sprList:[],fontList:["Default","Averia Sans Libre","Bangers","Grenze","Joti One","Jua","Limelight","MadLines","Marcellus SC","Orbitron","Quicksand","Righteous","Saira Stencil One","SetoFont","HappyZcool","Hanalei Fill","Lobster","MedievalSharp","Pacifico","Play","Karmatic Arcade","Origami Mommy","Press Start 2P"],fontSC(t){return 0===t||13===t||14===t},loadMax:0,loadNow:0,push(){this.loadNow++,$("loadp").style.width=this.loadNow/this.loadMax*100+"%",this.loadNow===this.loadMax&&this.loadUp?.()},fail(){UI.alert("资源加载失败，请检查网络连接"),$("loading")._h(),ac($("box"))},reset(t){this.loadMax=t??this.sprList.length+1,this.loadNow=0,$("loading")._s(),$("loadp").style.width=0,dac($("box"),"")},color:{rgb2hsl(t,e,i){let s,a,r=Math.max(t,e,i),o=Math.min(t,e,i),l=(r+o)/510;if(r===o)s=a=0;else{let n=r-o;a=n/(l>.5?510-r-o:r+o),r===t?s=(e-i)/n+(e<i?6:0):r===e?s=(i-t)/n+2:r===i&&(s=(t-e)/n+4)}return[s,a,l]},hsl2rgb(t,e,i){let s,a,r;if(e=Math.mM(e,0,1),i=Math.mM(i,0,1),0===e)s=a=r=i;else{const o=(t,e,i)=>(i+=i<0?6:i>6?-6:0)<1?t+(e-t)*i:i<3?e:i<4?t+(e-t)*(4-i):t;let l=i<.5?i*(1+e):i+e-i*e,n=2*i-l;s=o(n,l,t+2),a=o(n,l,t),r=o(n,l,t-2)}return[Math.round(255*s),Math.round(255*a),Math.round(255*r)]},draw(t,e,i){let s=i.split(","),a=t.width,r=t.height,o=t.getContext("2d"),l=s[0]/60,n=""===s[1]?0:s[1]/50-1,h=""===s[2]?0:s[2]/50-1,f=""===s[3]||void 0===s[3]?1:s[3]/50;if(o.clearRect(0,0,a,r),o.drawImage(e,0,0),0===l&&0===n&&0===h&&1===f)return;f>1?f=2*f-1:f<-1&&(f=2*f+1);let d=o.getImageData(0,0,a,r),c=d.data;for(let t=a*r;t--;){let e=t<<2,[i,s,a]=this.rgb2hsl(c[e],c[e+1],c[e+2]),[r,o,d]=this.hsl2rgb(i+l,s+n,(a-.5)*f+.5+h);c[e]=r,c[e+1]=o,c[e+2]=d}o.putImageData(d,0,0)}},loadSnd(t){return new Promise((e,i)=>Au.onready(()=>{const s=s=>Au.ctx.decodeAudioData(s,i=>{let s={src:i};this.snd[t]=s,this.push("sound "+t),e(s)},i);CIW.onready(()=>CIW.get("snd",t).then(t=>t.b.arrayBuffer().then(s,i),e=>$M.xhr("GET",ROOT+"snd/"+t+".ogg","blob").then(e=>{e.response.arrayBuffer().then(i=>{CIW.put("snd",{id:t,b:e.response}),s(i)}).catch(i)}).catch(i)))}))},initSpr(t,e){e||(e={}),t.x=e.x??0,t.y=e.y??0,t.n=e.n??1,t.px=!!e.p,t.ims=e.s??0,t.tile="blk"===e.c||"tile"===e.c,e.b&&(t.bL=e.b[0],t.bT=e.b[1],t.boxW=e.b[2],t.boxH=e.b[3],t.boxL=t.x-t.bL,t.boxT=t.y-t.bT,t.b=e.b),"ply"===e.c&&(t.n=16)},loadSpr(t,e,i,s){return new Promise((a,r)=>{let o,l=new Image;o=s?[]:this.spr[t]?this.spr[t]:this.spr[t]=[],o.name=t,o.f=[],o.on=t=>o.f.push(t),CIW.onready(()=>{if("object"==typeof e)return this.initSpr(o,e),void(l.src=e.d);CIW.get("img",e+t).then(t=>{this.initSpr(o,t),l.src=t.d},i=>{"number"==typeof e?(l.src=`${ROOT}img/thm/${e}/${t}.png`,this.initSpr(o,Lib.spr[t])):DB.O("Sprite",e).fetch().then(t=>{let e=t.toJSON();this.initSpr(o,e),l.src=PNG+e.d},r),l.isNew=!0})}),l.onload=async()=>{let s=l.width,r=l.height,n=El("canvas",0,{width:s,height:r}),h=n.getContext("2d");if(h.drawImage(l,0,0),l.isNew&&CIW.put("img",{id:e+t,c:t,d:n.toDataURL(),x:o.x,y:o.y,n:o.n,p:o.px,s:o.ims,t:o.tile,b:o.b}),delete o.b,i&&this.color.draw(n,l,i),o.src=l,o.length&&(o.length=0),o.tile){160===s&&(s=128),o.w=o.h=32;for(let t=0;t<r;t+=32)for(let e=0;e<s;e+=32)o.push(await createImageBitmap(n,e,t,32,32));if(128===s)for(let t=0;t<r;t+=32)o.push(await createImageBitmap(n,128,t,32,32))}else{s/=o.n,o.w=s,o.h=r;for(let t=0;t<o.n;t++)o.push(await createImageBitmap(n,t*s,0,s,r))}o.boxW||(o.bL=o.bT=0,o.boxW=o.w,o.boxH=o.h,o.boxL=o.x,o.boxT=o.y),o.mask=[];for(let t=0;t<o.n;t++)if(o.mask[t]=[],o.px){let e=h.getImageData(t*s+o.bL,o.bT,o.boxW,o.boxH).data;for(let i=0,s=o.boxW*o.boxH;i<s;i++)o.mask[t][i]=e[4*i+3]>80?1:0}else for(let e=0,i=o.boxW*o.boxH;e<i;e++)o.mask[t][e]=1;o.ready=!0,this.push("sprite "+t),o.f.for(t=>t(o)),o.f.length=0,a(o)},l.onerror=r})},async colSpr(t,e){let i=t.src,s=El("canvas",0,{width:i.width,height:i.height});if(this.color.draw(s,i,e),t.length=0,t.tile){let e=i.width,a=i.height;160===e&&(e=128);for(let i=0;i<a;i+=32)for(let a=0;a<e;a+=32)t.push(await createImageBitmap(s,a,i,32,32));if(128===e)for(let e=0;e<a;e+=32)t.push(await createImageBitmap(s,128,e,32,32))}else for(let e=0;e<i.width;e+=t.w)t.push(await createImageBitmap(s,e,0,t.w,t.h))},loadBg(t,e){return new Promise((i,s)=>{if(3===t.m)this.push("background color"),i({...t});else if(t.m>3){let e,s,a=El("canvas",0,{width:800,height:608}),r=a.getContext("2d"),o=t.g.split(",");if(4===t.m){let i=t.g.indexOf(":"),a=t.g.slice(0,i)*Math.PI/180;o[0]=o[0].slice(i+1),e=400*Math.cos(a),s=304*Math.sin(a)}let l=4===t.m?r.createLinearGradient(400-e,304+s,400+e,304-s):r.createRadialGradient(400,304,0,400,304,500);o.for(t=>l.addColorStop(Number(t.slice(7)),"#"+t.slice(0,6))),r.fillStyle=l,r.fillRect(0,0,800,608),this.push("background gradient"),i({...t,c:a})}else{let a=new Image;CIW.onready(()=>{"object"!=typeof t.id?CIW.get("img",t.id+"bg").then(t=>a.src=t.d,e=>{$("loading")._s(),"number"==typeof t.id?a.src=`${ROOT}img/thm/${t.id}.png`:DB.O("Sprite",t.id).fetch().then(t=>a.src=CDU(t.get("d")),s),a.isNew=!0}):a.src=t.id.d}),a.onload=()=>{let s={...t,c:El("canvas",0,{width:a.width,height:a.height}),i:a};s.c.getContext("2d").drawImage(a,0,0),a.isNew&&CIW.put("img",{id:t.id+"bg",c:"bg",d:s.c.toDataURL()}),t.g&&this.color.draw(s.c,a,t.g),e||this.push("background image"),i(s)},a.onerror=s}})},loadFont(t){return new Promise((e,i)=>{if(this.font[t])return this.push("font "+t),e(t);CIW.onready(()=>CIW.get("font",t).then(i=>{this.font[t]=i.d,this.push("font "+t),e(t)},s=>$M.xhr("GET",ROOT+"font/"+t+".woff2","blob").then(i=>{let s=new FileReader;s.readAsDataURL(i.response),s.onload=()=>{this.font[t]=s.result,CIW.put("font",{id:t,d:s.result}),this.push("font "+t),e(t)}},i)))})},svgTxt(t){let e=this.fontSC(t.ftf)?"":`@font-face{font-family:d;src:url(${Res.font.Default})}`;return`data:image/svg+xml;utf-8,<svg xmlns='http://www.w3.org/2000/svg' width='${t.w}' height='${t.h}'><style>@font-face{font-family:f;src:url(${Res.font[Res.fontList[t.ftf]]})}${e}</style><foreignObject x='0' y='0' width='${t.w}' height='${t.h}'><div xmlns='http://www.w3.org/1999/xhtml' style='white-space:pre-wrap;font:${t.ftt?"italic ":""}${t.fts}px f,d;text-align:${0===t.fta?"left":1===t.fta?"center":"right"};color:%23${t.ftc.slice(1)};${t.fsd?"text-shadow:0 0 "+t.fsd+"px %23"+t.fsc.slice(1)+";":""}${t.fst?"-webkit-text-stroke:"+t.fst+"px %23"+t.fkc.slice(1)+";":""}margin:8px 16px'>${t.txt.replaceAll("&","&amp;").replaceAll("<","&lt;")}</div></foreignObject></svg>`},svgGO(t){let e=this.fontSC(t.ftf1)||this.fontSC(t.ftf2)?"":`@font-face{font-family:d;src:url(${Res.font.Default})}`,i=t.ftf2===t.ftf1?"":`@font-face{font-family:f2;src:url(${Res.font[Res.fontList[t.ftf2]]})}`;return`data:image/svg+xml;utf-8,<svg xmlns='http://www.w3.org/2000/svg' width='800' height='608'><style>@font-face{font-family:f1;src:url(${Res.font[Res.fontList[t.ftf1]]})}${i}${e}</style><foreignObject x='0' y='0' width='800' height='608'><div xmlns='http://www.w3.org/1999/xhtml' style='position:absolute;width:800px;top:50%;transform:translateY(-50%)'><div style='white-space:pre-wrap;font:${t.ftt1?"italic ":""}${t.fts1}px f1,f2,d;text-align:${0===t.fta1?"left":1===t.fta1?"center":"right"};color:%23${t.ftc1.slice(1)};${t.fsd1?"text-shadow:0 0 "+t.fsd1+"px %23"+t.fsc1.slice(1)+";":""}${t.fst1?"-webkit-text-stroke:"+t.fst1+"px %23"+t.fkc1.slice(1)+";":""}'>${t.txt1.replaceAll("&","&amp;").replaceAll("<","&lt;")}</div><div style='white-space:pre-wrap;font:${t.ftt2?"italic ":""}${t.fts2}px f2,f1,d;text-align:${0===t.fta2?"left":1===t.fta2?"center":"right"};color:%23${t.ftc2.slice(1)};${t.fsd2?"text-shadow:0 0 "+t.fsd2+"px %23"+t.fsc2.slice(1)+";":""}${t.fst2?"-webkit-text-stroke:"+t.fst2+"px %23"+t.fkc2.slice(1)+";":""}'>${t.txt2.replaceAll("&","&amp;").replaceAll("<","&lt;")}</div></div></foreignObject></svg>`},dlImg(t,e){return new Promise((i,s)=>{let a={},r=new Image;"number"==typeof t?"bg"===e?r.src=`${ROOT}img/thm/${t}.png`:(r.src=`${ROOT}img/thm/${t}/${e}.png`,this.initSpr(a,Lib.spr[e])):DB.O("Sprite",t).fetch().then(t=>{let i=t.toJSON();this.initSpr(a,i),r.src="bg"===e?CDU(i.d):PNG+i.d},s),r.onload=()=>{let o=El("canvas",0,{width:r.width,height:r.height});o.getContext("2d").drawImage(r,0,0);let l={id:t+e,c:e,d:o.toDataURL(),x:a.x,y:a.y,n:a.n,p:a.px,s:a.ims,t:a.tile,b:a.b};for(let t in l)void 0===l[t]&&delete l[t];CIW.put("img",l).then(()=>i([l,r]),s)},r.onerror=s})},checkSnd(t){},checkImg(t,e){return new Promise((i,s)=>CIW.onready(()=>{if("object"==typeof t)return this.push(),i();CIW.get("img",t+e).then(()=>(this.push(),i()),()=>{this.dlImg(t,e).then(()=>{this.push(),i()},s)})}))},checkBgm(t){return new Promise((e,i)=>CIW.onready(()=>CIW.get("bgm",t).then(()=>{this.push(),e()},()=>Ipc.dl(`https://music.163.com/song/media/outer/url?id=${t}.mp3`,t+".mp3",(t,s)=>{if(!t)return i();CIW.put("bgm",{id:s,b:$M.u2b(t)}).then(()=>{this.push(),e()},i)}))))},async check(t,e){if(!t)throw 0;$("loading").style.background="";let i=[],s=1;return t.for(t=>{s++;for(let e=t.spr.length;e--;)s++,i.push(this.checkImg(t.spr[e],this.sprList[e].s));t.bg.m<3&&i.push(this.checkImg(t.bg.id,"bg")),e&&t.bgm&&i.push(this.checkBgm(t.bgm))}),this.reset(i.length+s),await Promise.all(i)}},Au={init(){this.ctx=new AudioContext,this.gain=this.ctx.createGain(),this.gain.connect(this.ctx.destination),this.ready.for(t=>t()),delete this.ready,this.rd=!0},rd:!1,ready:[],onready(t){this.rd?t():this.ready.push(t)},setVol(t){this.gain.gain.value=t/100},play(t,e){let i=Res.snd[t];if(!i)return;let s=this.ctx.createBufferSource();s.buffer=i.src,e&&(s.playbackRate.value=e),s.connect(this.gain),s.start(0)}};